#! /bin/bash

if [[ -z "$MSF_PATH" ]]; then
  path=`dirname $0`

  # check for ./docker/msfconsole.rc
  if [[ ! -f $path/../msfconsole.rc ]] ; then

    # we are not inside the project
    realpath --version > /dev/null 2>&1 || { echo >&2 "I couldn't find where metasploit is. Set \$MSF_PATH or execute this from the project root"; exit 1 ;}

    # determine script path
    pushd $(dirname $(realpath $0)) > /dev/null
    path=$(pwd)
    popd > /dev/null
  fi
  MSF_PATH=$(dirname $(dirname $path))
fi

cd $MSF_PATH

PARAMS="$@"

if [[ $PARAMS == *"--rebuild"* ]]; then
  echo "Rebuilding image"
  docker-compose build
  exit $?
fi

# workaround if current user id is not the same as in the container.
# Otherwise the ~/.msf4 folder is not writeable
if [[ $EUID -ne 1000 ]]; then
  docker-compose run --rm -u root --service-ports ms ./msfconsole -r docker/msfconsole.rc "$PARAMS"
else
  docker-compose run --rm --service-ports ms ./msfconsole -r docker/msfconsole.rc "$PARAMS"
fi
