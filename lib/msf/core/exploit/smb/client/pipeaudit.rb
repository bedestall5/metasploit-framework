module Msf

module Exploit::Remote::SMB::Client::PipeAudit
  include Msf::Exploit::Remote::SMB::Client

  def initialize(info = {})
    super
  end

  def connect_to_pipe()
    accessible_pipes||=[]
    a_pipe_handles||=[]
    target_pipes = [
                'netlogon',
                'lsarpc',
                'samr',
                'browser',
                'atsvc',
                'DAV RPC SERVICE',
                'epmapper',
                'eventlog',
                'InitShutdown',
                'keysvc',
                'lsass',
                'LSM_API_service',
                'ntsvcs',
                'plugplay',
                'protected_storage',
                'router',
                'SapiServerPipeS-1-5-5-0-70123',
                'scerpc',
                'srvsvc',
                'tapsrv',
                'trkwks',
                'W32TIME_ALT',
                'wkssvc',
                'PIPE_EVENTROOT\CIMV2SCM EVENT PROVIDER',
                'db2remotecmd'
    ]
		
    target_pipes.each do |pipe|
       begin
         pipe_name = "#{pipe}"
         pipe_handle = self.simple.create_pipe(pipe_name, 'o')
         print_status("Accessible pipe found: #{pipe_name}")
	 pipe_found = 1
	 ret_pipe = pipe_name
	 accessible_pipes << pipe_name
       rescue Rex::Proto::SMB::Exceptions::ErrorCode => e
	 vprint_status("Inaccessible named pipe #{pipe_name} - #{e.message}")
       
       end
       if pipe_found == 1
	       vprint_status("Returning #{ret_pipe} with handle #{pipe_handle.to_s}to exploit")
	       return ret_pipe, pipe_handle
       end
    end
  end
end
end

