# -*- coding: binary -*-

module Msf
  module Exploit::Remote::SMB::Server
    module Share
      module Command
        module Trans2
          # This mixin provides methods to handle TRAN2_QUERY_FILE_INFORMATION subcommands
          module QueryFileInformation

            def smb_cmd_trans2_query_file_information(c, buff)
              #dprint("[smb_cmd_trans2_query_file_information]")
              #ar = Rex::Text.to_hex(buff, '').to_s
              #loi = ar[148..151].unpack('n*').reverse.pack('n*').to_i(16)

              params = CONST::SMB_QUERY_FILE_TRANS2_PARAMETERS.make_struct
              params.from_s(buff)

              loi = params.v['InformationLevel']
              fid = params.v['FID']

              case loi
              when CONST::SMB_QUERY_FILE_STANDARD_INFO, CONST::SMB_QUERY_FILE_STANDARD_INFO_ALIAS
                #dprint("\t\t[smb_cmd_trans_query_file_info_standard]")
                smb_cmd_trans_query_file_info_standard(c, fid)
              when CONST::SMB_QUERY_FILE_BASIC_INFO, CONST::SMB_QUERY_FILE_BASIC_INFO_ALIAS, CONST::SMB_SET_FILE_BASIC_INFO_ALIAS
                #dprint("\t\t[smb_cmd_trans_query_file_info_basic]")
                smb_cmd_trans_query_file_info_basic(c, fid)
              #when CONST::SMB_QUERY_FILE_NETWORK_OPEN_INFO
                #dprint("\t\t[smb_cmd_trans_query_file_info_network]")
                #smb_cmd_trans_query_file_info_network(c, fid)
              else
                dprint("\t\tUnknown LOI [smb_cmd_trans2_query_file_information] - #{loi.to_s}")
                # SEND success with the hope of going ahead...
                smb_error(CONST::SMB_COM_TRANSACTION2, c, CONST::SMB_STATUS_SUCCESS)
              end
            end

=begin
# OLD DISPATCHING
            def smb_cmd_trans2_query_file_information(c, buff)
              #dprint("[smb_cmd_trans2_query_file_information]")
              ar = Rex::Text.to_hex(buff, '').to_s
              loi = ar[148..151].unpack('n*').reverse.pack('n*').to_i(16)
              case loi
              when 0x03ed
                dprint("[smb_cmd_trans_query_path_info_standard]")
                smb_cmd_trans_query_path_info_standard(c, buff)
              when 0x03ec
                dprint("[smb_cmd_trans_query_file_info_basic]")
                smb_cmd_trans_query_file_info_basic(c, buff)
              when 0x040a
                dprint("[smb_cmd_trans_query_file_info_network]")
                smb_cmd_trans_query_file_info_network(c, buff)
              else
                dprint("Unknown LOI [smb_cmd_trans_query_path_info_standard] - #{loi.to_s}")
                smb_cmd_trans_query_file_info_standard(c, buff)
              end
            end
=end
          end
        end
      end
    end
  end
end
