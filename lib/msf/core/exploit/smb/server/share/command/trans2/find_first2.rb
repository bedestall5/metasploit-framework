# -*- coding: binary -*-

module Msf
  module Exploit::Remote::SMB::Server
    module Share
      module Command
        module Trans2
          # This mixin provides methods to handle TRAN2_FIND_FIRST2 subcommands
          module FindFirst2

            def smb_cmd_trans2_find_first2(c, buff)

              params = CONST::SMB_TRANS2_FIND_FIRST2_PARAMETERS.make_struct
              params.from_s(buff)

              loi = params.v['InformationLevel']
              search_path = Rex::Text.to_ascii(params.v['FileName']).downcase
              search_path.gsub!(/[\x00]*/, '') #delete padding
              search_path.gsub!(/\\x([0-9a-f]{2})/i, '') # delete hex chars

              # Do some managing for wildcards
              # TODO: Make it better / complete
              search_path.gsub!(/<\./, '*.') # manage wildcards
              extension = File.extname(file_name)
              if search_path == "#{path_name}*#{extension}"
                search_path = "#{path_name}#{file_name}"
              end

              case loi
              when CONST::SMB_FIND_FILE_NAMES_INFO
                smb_cmd_find_file_names_info(c, search_path)
              when CONST::SMB_FIND_FILE_BOTH_DIRECTORY_INFO
                smb_cmd_find_file_both_directory_info(c, search_path)
              when CONST::SMB_FIND_FILE_FULL_DIRECTORY_INFO
                smb_cmd_find_file_full_directory_info(c, search_path)
              else
                # Send STATUS_SUCCESS with the hope of going ahead
                smb_error(CONST::SMB_COM_TRANSACTION2, c, CONST::SMB_STATUS_SUCCESS)
              end
            end
          end
        end
      end
    end
  end
end
