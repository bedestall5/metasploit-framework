# -*- coding: binary -*-

module Msf
  module Exploit::Remote::SMB::Server
    module Share
      module Command
        module Trans2
          require 'msf/core/exploit/smb/server/share/command/trans2/find_first2'
          require 'msf/core/exploit/smb/server/share/command/trans2/query_file_information'
          require 'msf/core/exploit/smb/server/share/command/trans2/query_path_information'

          #
          # Responds to client TRANSACTION2 requests and dispatches the request off to
          # other functions dependent on what the sub_command is. Commands supported
          # include:
          #  QUERY_FILE_INFO (Basic, Standard and Internal)
          #  QUERY_PATH_INFO (Basic and Standard)
          #
          def smb_cmd_trans(c, buff)
            #dprint("[SMB_CMD_TRANS]")
            # Client socket is c
            pkt = CONST::SMB_TRANS2_PKT.make_struct
            pkt.from_s(buff)

            #sub_command = pkt['Payload'].v['SetupData'].unpack('v')[0]

            data_trans2 = CONST::SMB_DATA_TRANS2.make_struct
            data_trans2.from_s(pkt['Payload'].v['SetupData'])

            sub_command = data_trans2.v['SubCommand']

            case sub_command
            when CONST::TRANS2_QUERY_FILE_INFO
              smb_cmd_trans2_query_file_information(c, buff)
            when CONST::TRANS2_QUERY_PATH_INFO
              smb_cmd_trans2_query_path_information(c, buff)
            when CONST::TRANS2_FIND_FIRST2
              puts "TRANS2_FIND_FIRST2"
              puts "#{Rex::Text.to_hex_dump(pkt['Payload'].v['SetupData'])}"
              #smb_cmd_trans2_find_first2(c, buff)
              parameters = data_trans2.v['Parameters'].gsub(/^[\x00]*/, '') #delete padding
              puts "TRANS2_FIND_FIRST2 parameters"
              puts "#{Rex::Text.to_hex_dump(parameters)}"
              smb_cmd_trans2_find_first2(c, parameters)
            else
              dprint("\t[Unsupported/Unknown command] SUB_COMMAND: #{sub_command}")
              pkt = CONST::SMB_TRANS_RES_PKT.make_struct
              smb_set_defaults(c, pkt)
              pkt['Payload']['SMB'].v['Command'] = CONST::SMB_COM_TRANSACTION2
              pkt['Payload']['SMB'].v['Flags1'] = 0x88
              pkt['Payload']['SMB'].v['Flags2'] = FLAGS2
              pkt['Payload']['SMB'].v['ErrorClass'] = 0xc0000225 # NT_STATUS_NOT_FOUND
              c.put(pkt.to_s)
            end
          end

        end
      end
    end
  end
end
