# -*- coding: binary -*-

module Msf
  module Exploit::Remote::SMB::Server
    module Share
      module InformationLevel
        # This mixin provides methods to handle TRAN2_QUERY_PATH_INFORMATION subcommands
        module Query

          def smb_cmd_trans_query_file_info_standard(c, buff)
            trans2_params = CONST::SMB_TRANS2_QUERY_PATH_INFORMATION_RES_PARAMETERS.make_struct
            trans2_params.v['EaErrorOffset'] = 0

            query_path_info = CONST::SMB_QUERY_FILE_STANDARD_INFO_HDR.make_struct
            query_path_info.v['AllocationSize'] = 1048576
            query_path_info.v['EndOfFile'] = exe_contents.length
            query_path_info.v['NumberOfLinks'] = 1
            query_path_info.v['DeletePending'] = 0
            query_path_info.v['Directory'] = 0 #isdir == false

            pkt = CONST::SMB_TRANS_RES_PKT.make_struct
            smb_set_defaults(c, pkt)

            pkt['Payload']['SMB'].v['Command'] = CONST::SMB_COM_TRANSACTION2
            pkt['Payload']['SMB'].v['Flags1'] = 0x88
            pkt['Payload']['SMB'].v['Flags2'] = FLAGS2
            pkt['Payload']['SMB'].v['WordCount'] = 10
            pkt['Payload'].v['ParamCountTotal'] = 2
            pkt['Payload'].v['DataCountTotal'] = 24
            pkt['Payload'].v['ParamCount'] = 2
            pkt['Payload'].v['ParamOffset'] = 56
            pkt['Payload'].v['DataCount'] = 24
            pkt['Payload'].v['DataOffset'] = 60
            pkt['Payload'].v['Payload'] =
              "\x00" + # Padding
              trans2_params.to_s +
              "\x00\x00" + # Padding
              query_path_info.to_s +
              "\x00\x00" # Unknown

            c.put(pkt.to_s)
          end

          #
          # Responds to QUERY_FILE_INFO (Basic) requests
          #
          def smb_cmd_trans_query_file_info_basic(c, buff)
            dprint("[smb_cmd_trans_query_file_info_basic]")

            pkt = CONST::SMB_TRANS2_PKT.make_struct
            pkt.from_s(buff)

            # we don't know how to parse it.... better object name not found
            if pkt['Payload'].v['SetupCount'] != 1
              pkt = CONST::SMB_TRANS_RES_PKT.make_struct
              smb_set_defaults(c, pkt)
              pkt['Payload']['SMB'].v['Command'] = CONST::SMB_COM_TRANSACTION2
              pkt['Payload']['SMB'].v['ErrorClass'] = 0xC0000034 # OBJECT_NAME_NOT_FOUND
              pkt['Payload']['SMB'].v['Flags1'] = 0x88
              pkt['Payload']['SMB'].v['Flags2'] = FLAGS2
              c.put(pkt.to_s)
              return
            end

            smb_data = CONST::SMB_DATA_TRANS2.make_struct
            smb_data.from_s(pkt['Payload'].v['SetupData'])

            params = smb_data.v['Parameters']
            params.gsub!(/^[\x00]*/, '') #remove padding

            trans_params = CONST::SMB_TRANS2_PARAMETERS.make_struct
            trans_params.from_s(params)

            puts "#{Rex::Text.to_hex_dump(trans_params.v['FileName'])}"
            path = Rex::Text.to_ascii(trans_params.v['FileName'])
            puts "#{Rex::Text.to_hex_dump(path)}"

            pkt = CONST::SMB_TRANS_RES_PKT.make_struct
            smb_set_defaults(c, pkt)

            if path && path.include?(file_name) #TODO: do it better
              attrib = CONST::SMB_EXT_FILE_ATTR_NORMAL # File attributes => file
            elsif path && path == path_name
              # QUERY_PATH_INFO_PARAMETERS doesn't include a file name, return a Directory answer
              attrib = CONST::SMB_EXT_FILE_ATTR_DIRECTORY # File attributes => directory
            elsif path.nil? || path.empty? || path == "\x00" # empty path
              # QUERY_PATH_INFO_PARAMETERS doesn't include a file name, return a Directory answer
              attrib = CONST::SMB_EXT_FILE_ATTR_DIRECTORY # File attributes => directory
            else
              pkt['Payload']['SMB'].v['Command'] = CONST::SMB_COM_TRANSACTION2
              pkt['Payload']['SMB'].v['ErrorClass'] = 0xC0000034 # OBJECT_NAME_NOT_FOUND
              pkt['Payload']['SMB'].v['Flags1'] = 0x88
              pkt['Payload']['SMB'].v['Flags2'] = FLAGS2
              c.put(pkt.to_s)
              return
            end

            trans2_params = CONST::SMB_TRANS2_QUERY_PATH_INFORMATION_RES_PARAMETERS.make_struct
            trans2_params.v['EaErrorOffset'] = 0

            query_path_info = CONST::SMB_QUERY_FILE_BASIC_INFO_HDR.make_struct
            query_path_info.v['loCreationTime'] = lo
            query_path_info.v['hiCreationTime'] = hi
            query_path_info.v['loLastAccessTime'] = lo
            query_path_info.v['hiLastAccessTime'] = hi
            query_path_info.v['loLastWriteTime'] = lo
            query_path_info.v['hiLastWriteTime'] = hi
            query_path_info.v['loLastChangeTime'] = lo
            query_path_info.v['hiLastChangeTime'] = hi
            query_path_info.v['ExtFileAttributes'] = attrib

            pkt['Payload']['SMB'].v['Command'] = CONST::SMB_COM_TRANSACTION2
            pkt['Payload']['SMB'].v['Flags1'] = 0x88
            pkt['Payload']['SMB'].v['Flags2'] = FLAGS2
            pkt['Payload']['SMB'].v['WordCount'] = 10
            pkt['Payload'].v['ParamCountTotal'] = 2
            pkt['Payload'].v['DataCountTotal'] = 40
            pkt['Payload'].v['ParamCount'] = 2
            pkt['Payload'].v['ParamOffset'] = 56
            pkt['Payload'].v['DataCount'] = 40
            pkt['Payload'].v['DataOffset'] = 60
            pkt['Payload'].v['Payload'] =
              "\x00" + # Padding
              trans2_params.to_s +
              "\x00\x00" + # Padding
              query_path_info.to_s
            c.put(pkt.to_s)
          end

          #
          # Responds to QUERY_PATH_INFO (Basic) requests
          #
          def smb_cmd_trans_query_path_info_basic(c, buff)
            dprint("[smb_cmd_trans_query_path_info_basic]")
            pkt = CONST::SMB_TRANS2_PKT.make_struct
            pkt.from_s(buff)

            # we don't know how to parse it.... better object name not found
            if pkt['Payload'].v['SetupCount'] != 1
              pkt = CONST::SMB_TRANS_RES_PKT.make_struct
              smb_set_defaults(c, pkt)
              pkt['Payload']['SMB'].v['Command'] = CONST::SMB_COM_TRANSACTION2
              pkt['Payload']['SMB'].v['ErrorClass'] = 0xC0000034 # OBJECT_NAME_NOT_FOUND
              pkt['Payload']['SMB'].v['Flags1'] = 0x88
              pkt['Payload']['SMB'].v['Flags2'] = FLAGS2
              c.put(pkt.to_s)
              return
            end

            smb_data = CONST::SMB_DATA_TRANS2.make_struct
            smb_data.from_s(pkt['Payload'].v['SetupData'])

            params = smb_data.v['Parameters']
            params.gsub!(/^[\x00]*/, '') #remove padding

            trans_params = CONST::SMB_TRANS2_PARAMETERS.make_struct
            trans_params.from_s(params)

            puts "#{Rex::Text.to_hex_dump(trans_params.v['FileName'])}"
            path = Rex::Text.to_ascii(trans_params.v['FileName'])
            puts "#{Rex::Text.to_hex_dump(path)}"

            pkt = CONST::SMB_TRANS_RES_PKT.make_struct
            smb_set_defaults(c, pkt)

            if path && path.include?(file_name) #TODO: do it better
              attrib = CONST::SMB_EXT_FILE_ATTR_NORMAL # File attributes => file
            elsif path && path == path_name
              # QUERY_PATH_INFO_PARAMETERS doesn't include a file name, return a Directory answer
              attrib = CONST::SMB_EXT_FILE_ATTR_DIRECTORY # File attributes => directory
            elsif path.nil? || path.empty? || path == "\x00" # empty path
              # QUERY_PATH_INFO_PARAMETERS doesn't include a file name, return a Directory answer
              attrib = CONST::SMB_EXT_FILE_ATTR_DIRECTORY # File attributes => directory
            else
              pkt['Payload']['SMB'].v['Command'] = CONST::SMB_COM_TRANSACTION2
              pkt['Payload']['SMB'].v['ErrorClass'] = 0xC0000034 # OBJECT_NAME_NOT_FOUND
              pkt['Payload']['SMB'].v['Flags1'] = 0x88
              pkt['Payload']['SMB'].v['Flags2'] = FLAGS2
              c.put(pkt.to_s)
              return
            end

            trans2_params = CONST::SMB_TRANS2_QUERY_PATH_INFORMATION_RES_PARAMETERS.make_struct
            trans2_params.v['EaErrorOffset'] = 0

            query_path_info = CONST::SMB_QUERY_FILE_BASIC_INFO_HDR.make_struct
            query_path_info.v['loCreationTime'] = lo
            query_path_info.v['hiCreationTime'] = hi
            query_path_info.v['loLastAccessTime'] = lo
            query_path_info.v['hiLastAccessTime'] = hi
            query_path_info.v['loLastWriteTime'] = lo
            query_path_info.v['hiLastWriteTime'] = hi
            query_path_info.v['loLastChangeTime'] = lo
            query_path_info.v['hiLastChangeTime'] = hi
            query_path_info.v['ExtFileAttributes'] = attrib

            # If payload contains our file, send the response
            #if payload.downcase.eql?(file.downcase) or payload.length.to_s.eql?('4') or payload.downcase.include?(file.downcase)
            # At the moment we just support '\\' path always send a SUCCESS...
            pkt['Payload']['SMB'].v['Command'] = CONST::SMB_COM_TRANSACTION2
            pkt['Payload']['SMB'].v['Flags1'] = 0x88
            pkt['Payload']['SMB'].v['Flags2'] = FLAGS2
            pkt['Payload']['SMB'].v['WordCount'] = 10
            pkt['Payload'].v['ParamCountTotal'] = 2
            pkt['Payload'].v['DataCountTotal'] = 40
            pkt['Payload'].v['ParamCount'] = 2
            pkt['Payload'].v['ParamOffset'] = 56
            pkt['Payload'].v['DataCount'] = 40
            pkt['Payload'].v['DataOffset'] = 60
            pkt['Payload'].v['Payload'] =
              "\x00" + # Padding
              trans2_params.to_s +
              "\x00\x00" + # Padding
              query_path_info.to_s

            c.put(pkt.to_s)
          end

          #
          # Responds to QUERY_PATH_INFO (Standard) requests
          #
          # At the moment we just support '\\' path always send a SUCCESS...
          def smb_cmd_trans_query_path_info_standard(c, buff)
            dprint("[smb_cmd_trans_query_path_info_standard]")
            #smb = @state[c]
            #pkt = CONST::SMB_TRANS2_PKT.make_struct
            #pkt.from_s(buff)

            #payload = pkt['Payload'].v['SetupData'].gsub(/\x00/, '').gsub(/.*\\/, '').chomp.strip
            #ar = Rex::Text.to_hex(buff, '').to_s
            #fid = ar[144..147].unpack('n*').reverse.pack('n*')

            # If FileID matches or matches file, send file response
            #if ( fid.hex.eql?(smb[:file_id].to_i) or payload.length.eql?(file_name.length) )
            #attrib2 = 0 # IsFile
            #else
            # Otherwise return a Directory answer
            attrib2 = 1 # IsDir
            #end

            trans2_params = CONST::SMB_TRANS2_QUERY_PATH_INFORMATION_RES_PARAMETERS.make_struct
            trans2_params.v['EaErrorOffset'] = 0

            query_path_info = CONST::SMB_QUERY_FILE_STANDARD_INFO_HDR.make_struct
            query_path_info.v['AllocationSize'] = 1048576
            query_path_info.v['EndOfFile'] = exe_contents.length
            query_path_info.v['NumberOfLinks'] = 1
            query_path_info.v['DeletePending'] = 0
            query_path_info.v['Directory'] = attrib2

            pkt = CONST::SMB_TRANS_RES_PKT.make_struct
            smb_set_defaults(c, pkt)

            pkt['Payload']['SMB'].v['Command'] = CONST::SMB_COM_TRANSACTION2
            pkt['Payload']['SMB'].v['Flags1'] = 0x88
            pkt['Payload']['SMB'].v['Flags2'] = FLAGS2
            pkt['Payload']['SMB'].v['WordCount'] = 10
            pkt['Payload'].v['ParamCountTotal'] = 2
            pkt['Payload'].v['DataCountTotal'] = 24
            pkt['Payload'].v['ParamCount'] = 2
            pkt['Payload'].v['ParamOffset'] = 56
            pkt['Payload'].v['DataCount'] = 24
            pkt['Payload'].v['DataOffset'] = 60
            pkt['Payload'].v['Payload'] =
              "\x00" + # Padding
              trans2_params.to_s +
              "\x00\x00" + # Padding
              query_path_info.to_s +
              "\x00\x00" # Unknown
            c.put(pkt.to_s)
          end
        end
      end
    end
  end
end
