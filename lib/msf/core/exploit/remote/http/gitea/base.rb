# -*- coding: binary -*-

module Msf::Exploit::Remote::HTTP::Gitea::Base
  # Checks if the site is online and running gitea
  #
  # @return [Rex::Proto::Http::Response,nil] the HTTP response if the site is
  # online and running gitea, nil otherwise
  def gitea_and_online?
    unless datastore['GITEACHECK']
      vprint_status 'Skipping Gitea check...'
      return true
    end

    gitea_detect_regexes = [
      /i_like_gitea=\w+/,
    ]

    res = send_request_cgi({
      'method' => 'GET',
      'uri' => normalize_uri(target_uri.path)
    })

    return res if res && res.code == 200 && gitea_detect_regexes.any? { |r| res.get_cookies =~ r }

    return nil
  rescue ::Rex::ConnectionRefused, ::Rex::HostUnreachable, ::Rex::ConnectionTimeout => e
    print_error("Error connecting to #{target_uri}: #{e}")
    return nil
  end
end
