# -*- coding: binary -*-

module Msf::Exploit::Remote::HTTP::Gitea::Login
  # performs a gitea login
  #
  # @param user [String] Username
  # @param pass [String] Password
  # @param timeout [Integer] The maximum number of seconds to wait before the
  # request times out
  # @return [HttpCookie,AuthenticationError] the session cookies as a single
  # string on successful login, raise AuthenticationError otherwise
  def gitea_login(user, pass, timeout = 20)
    res = send_request_cgi({
      'uri' => gitea_url_login,
      'keep_cookies' => true
    }, timeout)
    return nil unless res

    csrf = gitea_get_csrf(res)
    raise Msf::Exploit::Remote::HTTP::Gitea::Error::CsrfError.new unless csrf

    res = send_request_cgi(
      'method' => 'POST',
      'uri' => normalize_uri(gitea_url_login),
      'vars_post' => gitea_helper_login_post_data(user, pass, csrf),
      'keep_cookies' => true
    )

    raise Msf::Exploit::Remote::HTTP::Gitea::Error::AuthenticationError.new if res&.code != 302

    cookies = cookie_jar.cookies
    cookie_jar.clear
    store_valid_credential(user: user, private: pass)
    return cookies
  end
end
