# -*- coding: binary -*-

module Msf::Exploit::Remote::HTTP::NagiosXi::Version
  # Extracts the Nagios XI version information from index.php
  #
  # @param cookies [String] cookies obtained from an HTTP response
  # @return [String, Msf::Exploit::CheckCode], String containing the Nagios XI version if successful, otherwise Msf::Exploit::CheckCode
  def nagios_xi_version_index(cookies)
    res_backend = send_request_cgi({
      'method' => 'GET',
      'uri' => nagios_xi_backend_url,
      'cookie' => cookies
    })

    unless res_backend
      return Msf::Exploit::CheckCode::Unknown('Connection failed')
    end

    unless res_backend.code == 200 && res_backend.body.include?("id='lid-menu-home-homedashboard'>Home Dashboard</a>")
      return Msf::Exploit::CheckCode::Unknown('Received unexpected response while trying to visit the Nagios XI dashboard') # it is unlcear why this would happen
    end

    version = res_backend.body.scan(/product=nagiosxi&version=(\d+\.\d+\.\d+)&/).flatten.first rescue ''
    if version.blank?
      return Msf::Exploit::CheckCode::Detected('Unable to obtain the Nagios XI version from the dashboard')
    end

    version
  end
end
