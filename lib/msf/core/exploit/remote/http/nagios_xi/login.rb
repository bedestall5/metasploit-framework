# -*- coding: binary -*-

module Msf::Exploit::Remote::HTTP::NagiosXi::Login
  # performs a Naxios XI login
  #
  # @param user [String] Username
  # @param pass [String] Password
  # @return [String, Msf::Exploit::CheckCode] String containing the session cookies on successful login, Msf::Exploit::CheckCode otherwise
  def nagios_xi_login(user, pass)
    # empty the cookie jar, otherwise the module will start failing if it is run multiple times in a short timespan
    self.cookie_jar = [].to_set

    # visit the login page in order to obtain the cookies and the `nsp_str` token required for authentication
    res_pre_login = send_request_cgi({
      'method' => 'GET',
      'uri' => nagios_xi_login_url,
      'keep_cookies' => true,
    })

    unless res_pre_login
      return Msf::Exploit::CheckCode::Unknown('Connection failed')
    end

    unless res_pre_login.code == 200 && res_pre_login.body.include?('<b>Nagios XI</b>')
      return Msf::Exploit::CheckCode::Safe('Target is not a Nagios XI application')
    end

    nsp = get_nsp(res_pre_login)

    if nsp.blank?
      return Msf::Exploit::CheckCode::Unknown('Unable to obtain the value of the `nsp_str` token required for authentication')
    end

    # authenticate
    res_login = send_request_cgi({
      'method' => 'POST',
      'uri' => nagios_xi_login_url,
      'keep_cookies' => true,
      'vars_post' => {
        'nsp' => nsp,
        'pageopt' => 'login',
        'username' => user,
        'password' => pass
      }
    })

    unless res_login
      return Msf::Exploit::CheckCode::Unknown('Connection failed')
    end

    unless res_login.code == 302 && res_login.headers['Location'] == 'index.php'
      return Msf::Exploit::CheckCode::Detected('Received unexpected reply while trying to authenticate')
    end

    # keep only the most recent cookie, otherwise the session will time out
    auth_cookies = cookie_jar.to_a[1]
    self.cookie_jar = auth_cookies.split.to_set

    # visit the index page to verify we successfully authenticated
    res_index = send_request_cgi({
      'method' => 'GET',
      'uri' => nagios_xi_backend_url,
    })

    unless res_index
      return Msf::Exploit::CheckCode::Unknown('Connection failed')
    end

    unless res_index.code == 200 && res_index.body.include?("id='lid-menu-home-homedashboard'>Home Dashboard</a>")
      return Msf::Exploit::CheckCode::Detected('Received unexpected reply while trying to acess the NagiosXI home dashboard after authenticating.')
    end

    nsp = get_nsp(res_index)

    if nsp.blank?
      return Msf::Exploit::CheckCode::Unknown('Unable to obtain the value of the `nsp_str` token required for authentication')
    end
    
    auth_cookies
  end

  # Grabs the nsp_str value from an HTTP response using regex
  #
  # @param res [Rex::Proto::Http::Response] HTTP response
  # @return [String] nsp_str value
  def get_nsp(res)
    nsp = res.body.scan(/nsp_str = "([a-z0-9]+)/).flatten.first rescue ''
  end
end
