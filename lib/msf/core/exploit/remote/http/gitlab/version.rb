# -*- coding: binary -*-

# GitLab version mixin
module Msf::Exploit::Remote::HTTP::Gitlab::Version
  # Used to check if the version is correct: must contain at least one dot
  GITLAB_VERSION_PATTERN = '(\d+\.\d+(?:\.\d+)*)'.freeze

  # Extracts the Gitlab version information from various sources
  #
  # @return [String,nil] Gitlab version if found, nil otherwise
  def gitlab_version
    res = send_request_cgi({
      'method' => 'GET',
      'uri' => '/api/v4/version',
      'keep_cookies' => true
    })

    raise Msf::Exploit::Remote::HTTP::Gitlab::Error::VersionError unless res&.code == 200

    version = Rex::Version.new(
      JSON.parse(
        res.body
      )['version'][Regexp.new(GITLAB_VERSION_PATTERN), 1]
    )

    return version if version

    nil
  end
end
