require 'msf/core/modules/external/bridge'

class MetasploitModule < Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::Exploit::CmdStager

  def initialize(info = {})
    super(update_info(info,
      'Name'        => <%= meta[:name] %>,
      'Description' => <%= meta[:description] %>,
      'Author'      =>
        [
          <%= meta[:authors] %>
        ],
      'License'     => MSF_LICENSE,
      'References'  =>
        [
          <%= meta[:references] %>
        ],
      'DisclosureDate' => <%= meta[:date] %>,
      'Privileged'     => <%= meta[:privileged] %>,
      'Platform'       => [<%= meta[:platform] %>],
      'Payload'        =>
        {
          'DisableNops' => true
        },
      'Targets'        =>
        [
          <%= meta[:targets] %>
        ],
      'DefaultTarget'  => 0,
      'DefaultOptions' => { 'WfsDelay' => <%= meta[:delay] %> }
      ))

      register_options([
        <%= meta[:options] %>
      ])
  end

  def execute_command(cmd, opts)
    mod = Msf::Modules::External::Bridge.open(<%= meta[:path] %>)
    mod.run(datastore.merge(command: cmd))
    wait_status(mod)
    true
  end

  def exploit
    print_status("Exploiting...")
    execute_cmdstager({:flavor  => :wget})
  end

  def wait_status(mod)
    while mod.running
      m = mod.get_status
      if m
        case m['level']
        when 'error'
          print_error m['message']
        when 'warning'
          print_warning m['message']
        when 'good'
          print_good m['message']
        when 'info'
          print_status m['message']
        when 'debug'
          vprint_status m['message']
        else
          print_status m['message']
        end
      end
    end
  end
end
