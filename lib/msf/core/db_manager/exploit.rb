module Msf::DBManager::Exploit

  def exploits(opts)
    search_results = []
    metadata = Msf::Modules::Metadata::Cache.instance.get_metadata
    metadata.each { |module_metadata|
      if is_match(module_metadata, opts)
        search_results << module_metadata.full_name
      end
    }
    search_results
  end

  def is_match(metadata, params)
    match = true
    params.each do |param, value|

      r = Regexp.new(Regexp.escape(value), true)

      case param
      when :app
        (match = match && value == 'client') if metadata.is_client
        (match = match && value == 'server') if metadata.is_server
      when :author
        match = match && metadata.author.any? { |a| a =~ r}
      when :bid
        match = match && metadata.references.any? { |ref| ref =~ /^bid\-/i and ref =~ r }
      when :cve
        match = match && metadata.references.any? { |ref| ref =~ /^cve\-/i and ref =~ r }
      when :edb
        match = match && metadata.references.any? { |ref| ref =~ /^edb\-/i and ref =~ r }
      when :name
        match = match && metadata.name =~ r
      when :os, :platform
        target_match = metadata.targets ? metadata.targets.any? { |target| target =~ r} : false
        platform_match = (metadata.platform =~ r or metadata.arch =~ r)
        match = match && (platform_match || target_match)
      when :path
        match = match && metadata.full_name =~ r
      when :port
        match = match && metadata.rport =~ r
      when :ref
        match = match && metadata.reference.any? { |ref| ref =~ r }
      when :text
        terms = [metadata.name, metadata.full_name, metadata.description] + metadata.references + metadata.author
        if metadata.targets
          terms = terms + metadata.targets
        end
        match = match && terms.any? { |term| term =~ r}
      when :type
        match = match && (Msf::MODULE_TYPES.any? { |type| value == type and metadata.type == type })
      end
    end
    match
  end



end
