##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Local
  Rank = ExcellentRanking

  include Msf::Post::File
  include Msf::Post::Linux::Priv
  include Msf::Post::Linux::System
  include Msf::Post::Linux::Kernel
  include Msf::Exploit::EXE
  include Msf::Exploit::FileDropper

  def initialize(info = {})
    super(update_info(info,
                      'Name'           => 'Exim 4.87 - 4.91 Privilege Escalation',
                      'Description'    => %q{},
                        'License'        => MSF_LICENSE,
                        'Author'         =>
                      [
                        'Guillaume Andre' # Metasploit module
                      ],
                      'DisclosureDate' => '2019-06-17',
                      'Platform'       => [ 'linux' ],
                      'Arch'           => [ ARCH_X86, ARCH_X64 ],
                      'SessionTypes'   => [ 'shell', 'meterpreter' ],
                      'Targets'        =>
                      [
                        ['Exim 4.87 - 4.91',
                         lower_version: Gem::Version.new('4.87'),
                         upper_version: Gem::Version.new('4.91')
                      ]
                      ],
                      'References'     =>
                      [
                        [ 'CVE', '2019-10149' ],
                      ]
                     ))
    register_advanced_options [
    ]
  end

  def check
    res = cmd_exec 'exim -bV'
    if (res =~ /Exim version ([0-9\.]*) /i) # Maybe improve the regex
      version = Gem::Version.new($1)
      if (version >= target[:lower_version] && version <= target[:upper_version])
        return CheckCode::Appears
      end
    end
    CheckCode::Unknown
  end

  def exploit
  end
end
