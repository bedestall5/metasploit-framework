## Vulnerable Application

### Description

This module exploits a authentication bypass vulnerability in the
F5 iControl REST service to execute commands on an affected BIG-IP
trough the endpoint `/mgmt/tm/util/bash`.
This vulnerability is known as CVE-2022-1388.

The vulnerability lies in The F5 has a custom Apache module `mod_auth_pam.so`
that is responsible for some of the client authentication. It checks the request
headers for the presence the `X-F5-Auth-Token`. If the header is found it
goes onto eventually allow the request to be sent to the iControl REST service.
Otherwise, the Authorization header is processed and the request is rejected
if the credentials are invalid.

It turns out that the check for the `X-F5-Auth-Token` header in `mod_auth_pam.so`
is done before the Connection header is processed. This means that by adding
`X-F5-Auth-Token` as a value for the Connection header, one can skip the
basic authorization checks by `mod_auth_pam.so` and have the `X-F5-Auth-Token`
header removed from our request before it gets passed to the iControl REST service
and then access `/mgmt/tm/util/bash` to execute arbitrary system commands as root.

CVE-2022-1388 affects the following F5 BIG-IP versions:

* 16.1.x versions prior to 16.1.2.2
* 15.1.x versions prior to 15.1.5.1
* 14.1.x versions prior to 14.1.4.6
* 13.1.x versions prior to 13.1.5
* all 12.1.x and 11.6.x

### Setup

Import a vulnerable BIG-IP or BIG-IQ OVA, such as
`BIGIP-16.0.1-0.0.3.ALL-vmware.ova`, into your desired hypervisor. Boot
the virtual appliance, and it should be exploitable out of the box once
it's up.

## Verification Steps

Follow [Setup](#setup) and [Scenarios](#scenarios).

## Targets

### 0

This executes a Unix command.

### 1

This uses a Linux dropper to execute code.

## Options

### USERNAME

Set this to a valid admin username. Defaults to `admin`.

### TARGETURI

Set this to base path to the iControl installation. Defaults to `/`.

## Scenarios

### BIG-IP 12.1.5.3 (cmd/unix/generic)

```
msf6 exploit(linux/http/f5_icontrol_rce) > run

[+] tmsh show sys version
[!] AutoCheck is disabled, proceeding with exploitation
[*] Executing Unix Command for cmd/unix/generic
[*] Executing command: eval $(echo dG1zaCBzaG93IHN5cyB2ZXJzaW9u | base64 -d)
[+] Successfully executed command

Sys::Version
Main Package
  Product     BIG-IP
  Version     12.1.5.3
  Build       0.16.5
  Edition     Engineering Hotfix
  Date        Tue Mar  9 12:02:22 PST 2021

Hotfix List
ID625156-1


[*] Exploit completed, but no session was created.
msf6 exploit(linux/http/f5_icontrol_rce) > 
```
